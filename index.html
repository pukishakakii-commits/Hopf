<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Flappy Cucumber ü•í</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;background:#050f09;overflow:hidden;font-family:'Nunito',sans-serif;touch-action:none;}
#wrap{position:fixed;inset:0;overflow:hidden;}
#gameCanvas{position:absolute;inset:0;width:100%;height:100%;display:block;}
#ui{position:absolute;inset:0;pointer-events:none;}

/* ‚îÄ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ */
/* Score: top-center, above lvl bar */
#hud-score{position:absolute;top:calc(env(safe-area-inset-top,0px)+60px);left:50%;transform:translateX(-50%);color:#fff;font-size:28px;text-shadow:0 0 20px rgba(74,222,128,.9),2px 2px 0 #000;}
/* Cukes + gold: top-left */
#hud-currency{position:absolute;top:calc(env(safe-area-inset-top,0px)+14px);left:12px;display:flex;flex-direction:column;gap:3px;}
#hud-cukes-row{color:#7fffb0;font-size:11px;text-shadow:0 0 8px rgba(74,222,128,.7);display:flex;align-items:center;gap:3px;}
#hud-gold-row{color:#FFD700;font-size:11px;text-shadow:0 0 8px rgba(255,215,0,.7);display:flex;align-items:center;gap:3px;}
/* Level: centered between currency and score */
#hud-lvl-wrap{position:absolute;top:calc(env(safe-area-inset-top,0px)+8px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);border:1px solid rgba(251,191,36,.4);border-radius:10px;padding:4px 10px;display:flex;flex-direction:column;gap:3px;align-items:center;line-height:1;min-width:100px;}
#hud-lvl-text{color:#fbbf24;font-size:11px;white-space:nowrap;line-height:1;font-weight:800;}
#hud-xpbar{width:90px;height:7px;background:rgba(255,255,255,.15);border-radius:4px;overflow:hidden;}
#hud-xpfill{height:7px;background:linear-gradient(90deg,#fbbf24,#f97316);border-radius:4px;transition:width .3s;}
/* Combo: center-bottom */
#hud-combo{position:absolute;bottom:calc(env(safe-area-inset-bottom,0px)+8px);left:50%;transform:translateX(-50%);font-size:11px;color:#fbbf24;text-shadow:0 0 12px #fbbf24;opacity:0;transition:opacity .3s;text-align:center;}
/* Boosters: right-center */
#hud-boosters{position:absolute;top:50%;right:10px;transform:translateY(-50%);display:flex;flex-direction:column;gap:8px;pointer-events:all;}
.hud-boost-btn{width:46px;height:46px;border-radius:12px;border:2px solid rgba(255,255,255,.2);background:rgba(0,0,0,.72);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;pointer-events:all;}
.hud-boost-btn .bcnt{position:absolute;top:-5px;right:-5px;background:#ef4444;color:#fff;font-size:11px;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Nunito',sans-serif;font-weight:900;}
.hud-boost-btn.on-shield{border-color:#38bdf8;box-shadow:0 0 14px #38bdf8;}
.hud-boost-btn.on-magnet{border-color:#fbbf24;box-shadow:0 0 14px #fbbf24;}
.hud-boost-btn.on-turbo{border-color:#fb923c;box-shadow:0 0 14px #fb923c;}
.hud-boost-btn.on-mega{border-color:#a78bfa;box-shadow:0 0 18px #a78bfa;animation:megaPulse .4s infinite;}
@keyframes megaPulse{0%,100%{box-shadow:0 0 14px #a78bfa}50%{box-shadow:0 0 28px #a78bfa,0 0 48px rgba(167,139,250,.4)}}
/* Shoot button: bottom-right */
#hud-shoot{position:absolute;bottom:calc(env(safe-area-inset-bottom,0px)+8px);right:10px;width:52px;height:52px;border-radius:14px;border:2px solid rgba(255,200,100,.4);background:rgba(0,0,0,.72);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:all;}
/* Chest timer */
#hud-chest{position:absolute;top:calc(env(safe-area-inset-top,0px)+14px);right:68px;background:rgba(0,0,0,.6);border:1px solid rgba(139,92,246,.4);border-radius:8px;padding:4px 7px;font-size:11px;color:#a78bfa;pointer-events:all;cursor:pointer;text-align:center;}
#hud-pause{position:absolute;top:calc(env(safe-area-inset-top,0px)+10px);right:10px;background:rgba(0,0,0,.7);border:2px solid rgba(255,255,255,.3);border-radius:12px;padding:6px 10px;font-size:22px;color:#fff;pointer-events:all;cursor:pointer;text-align:center;display:flex;align-items:center;justify-content:center;width:48px;height:48px;box-shadow:0 4px 12px rgba(0,0,0,.4);}
#pause-overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:150;gap:12px;pointer-events:all;}
.pause-title{font-size:32px;font-weight:900;color:#fff;text-shadow:0 0 20px rgba(74,222,128,.6);margin-bottom:8px;}
/* Crazy/event labels */
#game-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px;text-align:center;opacity:0;pointer-events:none;z-index:50;}
@keyframes labelPop{0%,100%{opacity:0;transform:translate(-50%,-50%) scale(.8)}40%,60%{opacity:1;transform:translate(-50%,-50%) scale(1.05)}}
/* Sticker album notification */
#sticker-notif{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.85);border:2px solid #fbbf24;border-radius:16px;padding:14px 20px;text-align:center;font-size:11px;color:#fbbf24;opacity:0;pointer-events:none;z-index:100;transition:opacity .4s;}
#sticker-notif.show{opacity:1;}

.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:all;padding:16px;padding-top:calc(env(safe-area-inset-top,0px)+16px);padding-bottom:calc(env(safe-area-inset-bottom,0px)+16px);overflow-y:auto;gap:0;}
.hidden{display:none!important;}

/* START */
#start-screen{background:transparent;overflow:hidden;}
#start-bg-canvas{position:absolute;inset:0;width:100%;height:100%;z-index:0;}
#start-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;padding:16px;padding-top:calc(env(safe-area-inset-top,0px)+16px);padding-bottom:calc(env(safe-area-inset-bottom,0px)+16px);}
.game-title{font-size:34px;color:#4ade80;line-height:1.3;text-align:center;font-family:'Nunito',sans-serif;font-weight:900;text-shadow:0 0 20px #4ade80,2px 2px 0 #000;margin-bottom:8px;margin-top:calc(env(safe-area-inset-top,0px) + 8px);flex-shrink:0;letter-spacing:-1px;}
@keyframes glow{0%,100%{text-shadow:0 0 20px #4ade80,2px 2px 0 #000}50%{text-shadow:0 0 45px #4ade80,0 0 80px rgba(74,222,128,.3),2px 2px 0 #000}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
#hero-wrap{width:38px;height:60px;flex-shrink:0;filter:drop-shadow(0 0 10px rgba(74,222,128,.6));animation:hfloat 1.8s ease-in-out infinite;margin-bottom:6px;}
@keyframes hfloat{0%,100%{transform:translateY(0) rotate(-4deg)}50%{transform:translateY(-8px) rotate(4deg)}}
.player-rank{font-size:11px;margin-bottom:4px;flex-shrink:0;}
.xp-bar-wrap{width:170px;height:7px;background:rgba(255,255,255,.1);border-radius:4px;margin-bottom:3px;flex-shrink:0;border:1px solid rgba(255,255,255,.08);}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f97316);border-radius:4px;transition:width .5s;}
.xp-label{font-size:11px;color:#94a3b8;margin-bottom:7px;flex-shrink:0;}
.cur-bar{display:flex;gap:10px;flex-shrink:0;background:rgba(0,0,0,.35);border-radius:10px;padding:5px 14px;border:1px solid rgba(74,222,128,.2);margin-bottom:9px;}
.cur-item{font-size:11px;color:#94a3b8;text-align:center;}
.cur-item .ico{font-size:11px;display:block;margin-bottom:1px;}
.cur-item .val{font-size:11px;}
.cur-item .val.g{color:#4ade80;}.cur-item .val.gd{color:#FFD700;}

/* chest bar */
/* chest-bar defined below */

.btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:340px;flex-shrink:0;}
.btn{background:linear-gradient(145deg,#22c55e,#16a34a);color:#fff;border:none;padding:15px 10px;font-family:'Nunito',sans-serif;font-size:14px;font-weight:900;border-radius:18px;cursor:pointer;box-shadow:0 6px 0 #14532d,inset 0 1px 0 rgba(255,255,255,.3),0 0 24px rgba(34,197,94,.25);transition:transform .1s,box-shadow .1s;pointer-events:all;white-space:nowrap;width:100%;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.3);}
.btn:active{transform:translateY(6px);box-shadow:0 0 0 #14532d,inset 0 1px 0 rgba(255,255,255,.2);}
.btn.gold{background:linear-gradient(145deg,#fbbf24,#d97706);box-shadow:0 6px 0 #92400e,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(251,191,36,.2);}
.btn.gold:active{box-shadow:0 0 0 #92400e,inset 0 1px 0 rgba(255,255,255,.2);}
.btn.blue{background:linear-gradient(145deg,#38bdf8,#0284c7);box-shadow:0 6px 0 #075985,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(56,189,248,.2);}
.btn.blue:active{box-shadow:0 0 0 #075985;}
.btn.purple{background:linear-gradient(145deg,#a78bfa,#7c3aed);box-shadow:0 6px 0 #4c1d95,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(167,139,250,.2);}
.btn.purple:active{box-shadow:0 0 0 #4c1d95;}
.btn.pink{background:linear-gradient(145deg,#f472b6,#be185d);box-shadow:0 6px 0 #831843,inset 0 1px 0 rgba(255,255,255,.3);}
.btn.orange{background:linear-gradient(145deg,#fb923c,#ea580c);box-shadow:0 6px 0 #9a3412,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(251,146,60,.2);}
.btn.orange:active{box-shadow:0 0 0 #9a3412;}
.btn.teal{background:linear-gradient(145deg,#2dd4bf,#0d9488);box-shadow:0 6px 0 #134e4a,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(45,212,191,.2);}
.btn.red{background:linear-gradient(145deg,#f87171,#dc2626);box-shadow:0 6px 0 #7f1d1d,inset 0 1px 0 rgba(255,255,255,.3);}
.btn.wide{grid-column:1/-1;}
.btn.crazy-btn{background:linear-gradient(145deg,#ff00ff,#7c3aed);box-shadow:0 6px 0 #4c1d95,inset 0 1px 0 rgba(255,255,255,.3);animation:crazyB .5s infinite;}
@keyframes crazyB{0%,100%{filter:hue-rotate(0deg)}50%{filter:hue-rotate(180deg)}}
.tap-hint{color:#3d6b4f;font-size:12px;font-weight:700;animation:blink 1.3s infinite;margin-top:7px;flex-shrink:0;}

/* MODE SELECT */
#mode-screen{background:linear-gradient(170deg,#061a10,#0d2b1a,#061a10);overflow-y:auto;}
.mode-title{font-size:11px;color:#4ade80;margin-bottom:12px;text-shadow:0 0 15px #4ade80;flex-shrink:0;}
.mode-card{width:100%;max-width:300px;padding:11px 14px;border-radius:12px;border:2px solid rgba(255,255,255,.1);margin-bottom:8px;cursor:pointer;transition:all .2s;flex-shrink:0;}
.mode-card:active{transform:scale(.97);}
.mode-card.easy{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.4);}
.mode-card.normal{background:rgba(74,222,128,.1);border-color:rgba(74,222,128,.4);}
.mode-card.hard{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4);}
.mode-card.insane{background:rgba(168,85,247,.1);border-color:rgba(168,85,247,.4);}
.mode-card.crazy{background:rgba(255,0,255,.1);border-color:rgba(255,0,255,.4);animation:crazybrd 1s infinite;}
@keyframes crazybrd{0%,100%{border-color:rgba(255,0,255,.4)}50%{border-color:rgba(0,255,255,.6)}}
.mode-card.flip{background:rgba(56,189,248,.1);border-color:rgba(56,189,248,.4);}
.mode-card.zen{background:rgba(167,243,208,.07);border-color:rgba(110,231,183,.4);}
.mode-lock{font-size:11px!important;text-align:center;padding:6px;line-height:1.3;}
/* ‚îÄ‚îÄ‚îÄ NEW INFO PANEL ‚îÄ‚îÄ‚îÄ */
.info-panel{width:100%;max-width:340px;background:rgba(0,0,0,.45);border:1px solid rgba(74,222,128,.25);border-radius:18px;padding:14px 16px 12px;margin-bottom:10px;flex-shrink:0;}
.info-row{display:flex;align-items:center;justify-content:space-around;margin-bottom:12px;}
.info-item{display:flex;flex-direction:column;align-items:center;gap:2px;}
.info-ico{font-size:22px;line-height:1;}
.info-val{font-size:20px;font-weight:900;line-height:1;}
.info-val.g{color:#4ade80;text-shadow:0 0 10px rgba(74,222,128,.5);}
.info-val.gd{color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,.4);}
.info-val.xp{color:#a78bfa;text-shadow:0 0 10px rgba(167,139,250,.4);}
.info-lbl{font-size:11px;font-weight:700;color:#475569;}
.info-divider{width:1px;height:40px;background:rgba(255,255,255,.1);}
.lvl-bar-wrap{width:100%;}
.lvl-bar-label{font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:5px;text-align:center;}
.lvl-bar-outer{height:12px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.1);}
.lvl-bar-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f97316,#ef4444);border-radius:6px;transition:width .5s;position:relative;z-index:1;}
.lvl-bar-glow{height:100%;background:linear-gradient(90deg,rgba(251,191,36,.5),transparent);border-radius:6px;position:absolute;top:0;left:0;filter:blur(4px);}
/* Chest bar redesign */
.chest-bar{display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(139,92,246,.2),rgba(79,70,229,.15));border:2px solid rgba(139,92,246,.5);border-radius:16px;padding:12px 16px;margin-bottom:12px;flex-shrink:0;cursor:pointer;pointer-events:all;width:100%;max-width:340px;transition:all .2s;}
.chest-bar:active{transform:scale(.97);}
.chest-icon{font-size:28px;}
.chest-info{flex:1;font-size:13px;font-weight:800;color:#c4b5fd;line-height:1.4;}
.chest-arrow{font-size:22px;color:#a78bfa;font-weight:900;}
/* Play button */
.play-btn{font-size:22px!important;padding:18px 8px!important;background:linear-gradient(145deg,#22c55e,#16a34a)!important;box-shadow:0 8px 0 #14532d,inset 0 2px 0 rgba(255,255,255,.4),0 0 30px rgba(34,197,94,.3)!important;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,.3);}
/* Hero wrap bigger */
#hero-wrap{width:56px;height:88px;flex-shrink:0;animation:hfloat 1.8s ease-in-out infinite;margin-bottom:6px;}
/* PETS screen */
#pets-screen{background:linear-gradient(170deg,#0a0a1a,#1a0a2e);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;padding-top:calc(env(safe-area-inset-top,0px)+14px);}
.pets-title{font-size:18px;font-weight:900;color:#f472b6;text-shadow:0 0 14px #f472b6;margin-bottom:8px;flex-shrink:0;}
.pets-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:340px;flex-shrink:0;margin-bottom:10px;}
.pet-card{background:rgba(255,255,255,.04);border:2px solid rgba(255,255,255,.1);border-radius:14px;padding:12px 8px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.pet-card:active{transform:scale(.96);}
.pet-card.owned{border-color:rgba(74,222,128,.4);}
.pet-card.selected{border-color:#FFD700;background:rgba(255,215,0,.08);box-shadow:0 0 18px rgba(255,215,0,.2);}
.pet-emoji{font-size:36px;display:block;margin-bottom:5px;}
.pet-name{font-size:13px;font-weight:800;color:#e2e8f0;margin-bottom:3px;}
.pet-effect{font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:4px;line-height:1.3;}
.pet-price{font-size:13px;font-weight:800;color:#FFD700;}
.pet-price.sel{color:#FFD700;}
.pet-price.owned-lbl{color:#64748b;}
/* Shop add pets tab */


/* SHOP / CAROUSEL */
#shop-screen,#trail-screen,#boost-screen,#upgrade-screen{background:linear-gradient(170deg,#0a0a1a,#1a0a2e,#0a0a1a);overflow-y:auto;gap:0;justify-content:center;align-items:center;padding-top:calc(env(safe-area-inset-top,0px)+14px);}
/* ACHIEVEMENTS / STICKERS - center content */
#achiev-screen{background:linear-gradient(170deg,#0a0a1a,#1a0a2e);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;}
.shop-title{font-size:18px;font-weight:900;color:#a78bfa;text-shadow:0 0 14px #a78bfa;margin-bottom:7px;flex-shrink:0;}
.shop-bal{display:flex;gap:10px;margin-bottom:7px;flex-shrink:0;background:rgba(255,255,255,.04);border-radius:9px;padding:6px 14px;border:1px solid rgba(255,255,255,.07);}
.bal-item{font-size:13px;font-weight:800;color:#94a3b8;display:flex;align-items:center;gap:5px;}
.bal-val{color:#4ade80;font-weight:900;}.bal-val.gd{color:#FFD700;}
.skin-name{font-size:14px;font-weight:800;color:#e2e8f0;margin-bottom:5px;}
.skin-price{font-size:13px;font-weight:800;color:#4ade80;}
.skin-price.lbl-owned{color:#64748b;font-size:12px;}
.skin-price.lbl-selected{color:#FFD700;}
.mode-name{font-size:15px;font-weight:900;color:#e2e8f0;margin-bottom:3px;}
.mode-desc{font-size:12px;font-weight:700;color:#94a3b8;line-height:1.5;}
.mode-reward{font-size:12px;font-weight:800;color:#fbbf24;margin-top:3px;}
.boost-name{font-size:12px;font-weight:800;color:#e2e8f0;margin-bottom:2px;}
.boost-desc{font-size:11px;font-weight:700;color:#64748b;margin-bottom:3px;line-height:1.4;}
.boost-cnt-txt{font-size:15px;font-weight:900;color:#4ade80;margin-bottom:3px;}
.boost-price{font-size:12px;font-weight:800;color:#fbbf24;margin-bottom:4px;}
.upg-name{font-size:12px;font-weight:800;color:#e2e8f0;margin-bottom:3px;line-height:1.4;}
.upg-desc{font-size:11px;font-weight:700;color:#64748b;margin-bottom:4px;line-height:1.4;}
.upg-level{font-size:13px;color:#4ade80;font-weight:800;}
.upg-price{font-size:12px;font-weight:800;color:#fbbf24;margin-top:2px;}
.achiev-name{font-size:12px;font-weight:800;color:#e2e8f0;margin-bottom:2px;line-height:1.4;}
.achiev-desc{font-size:11px;font-weight:700;color:#64748b;line-height:1.4;}
.achiev-reward{font-size:12px;font-weight:800;color:#4ade80;margin-top:2px;}
.sticker-name{font-size:11px;font-weight:800;color:#e2e8f0;margin-bottom:2px;line-height:1.4;}
.sticker-req{font-size:11px;font-weight:700;color:#64748b;line-height:1.4;}
.shop-tabs{display:flex;gap:5px;margin-bottom:7px;flex-shrink:0;width:100%;max-width:340px;}
.shop-tab{flex:1;padding:8px 4px;font-size:12px;font-weight:800;border-radius:12px;cursor:pointer;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#94a3b8;font-family:'Nunito',sans-serif;}
.shop-tab.active{border-color:#a78bfa;background:rgba(167,139,250,.15);color:#e2e8f0;}
.carousel-outer{width:100%;max-width:340px;flex-shrink:0;position:relative;margin-bottom:5px;}
.carousel-vp{width:100%;overflow:hidden;border-radius:12px;}
.carousel-track{display:flex;transition:transform .3s cubic-bezier(.4,0,.2,1);}
.carousel-slide{min-width:100%;display:flex;justify-content:center;align-items:center;padding:0 3px;}
.skin-card{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:16px;padding:11px 18px;text-align:center;width:100%;position:relative;}
.skin-card.owned{border-color:#22c55e;background:rgba(74,222,128,.07);}
.skin-card.selected{border-color:#FFD700;background:rgba(255,215,0,.1);box-shadow:0 0 22px rgba(255,215,0,.2);}
.skin-canvas-wrap{width:68px;height:105px;margin:0 auto 7px;}
.skin-canvas-wrap canvas{width:100%;height:100%;}
/* skin card */
.skin-price{font-size:11px;color:#4ade80;}
.skin-price.lbl-owned{color:#64748b;font-size:11px;}
.skin-price.lbl-selected{color:#FFD700;}
.skin-badge{position:absolute;top:-6px;right:-6px;padding:3px 6px;border-radius:6px;font-size:11px;color:#fff;}
.carr-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.6);border:2px solid rgba(255,255,255,.15);color:#fff;width:30px;height:30px;border-radius:50%;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;pointer-events:all;}
.carr-arrow.left{left:-5px;}.carr-arrow.right{right:-5px;}
.carr-dots{display:flex;gap:5px;justify-content:center;margin-bottom:7px;flex-shrink:0;}
.dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.2);cursor:pointer;transition:all .2s;}
.dot.active{background:#a78bfa;}
.shop-actions{display:flex;gap:7px;flex-shrink:0;width:100%;max-width:340px;}
.shop-actions .btn{flex:1;}

/* UPGRADES */
.upgrade-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;max-width:340px;flex-shrink:0;margin-bottom:8px;}
.upgrade-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:9px;text-align:center;cursor:pointer;transition:all .2s;}
.upgrade-card:active{transform:scale(.96);}
.upgrade-card.maxed{border-color:rgba(74,222,128,.4);opacity:.7;}
/* upg icon */
.upg-icon{font-size:26px;display:block;margin-bottom:5px;}
/* ‚îÄ‚îÄ‚îÄ UNIFIED CARD SYSTEM ‚îÄ‚îÄ‚îÄ */
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:9px;text-align:center;cursor:pointer;transition:transform .15s;}
.card:active{transform:scale(.96);}
.card.gold{border-color:rgba(251,191,36,.4);background:rgba(251,191,36,.06);}
.card.gold.selected{border-color:#FFD700;background:rgba(255,215,0,.1);}
.card.green{border-color:rgba(74,222,128,.4);background:rgba(74,222,128,.06);}
.card.green.selected{border-color:#4ade80;background:rgba(74,222,128,.1);}
.card.blue{border-color:rgba(56,189,248,.4);background:rgba(56,189,248,.06);}
.card.purple{border-color:rgba(167,139,250,.4);background:rgba(167,139,250,.06);}
.card.locked{opacity:.4;}
.card-icon{font-size:26px;display:block;margin-bottom:5px;}
.card-done{position:absolute;top:3px;right:3px;font-size:11px;}


/* BOOST SHOP */
.boost-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;width:100%;max-width:340px;flex-shrink:0;margin-bottom:10px;}
.boost-card{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 5px;text-align:center;}
/* boost icon */
.boost-icon{font-size:26px;display:block;margin-bottom:4px;}
.boost-buy-btn{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border:none;padding:7px 4px;font-family:'Nunito',sans-serif;font-size:11px;font-weight:800;border-radius:8px;cursor:pointer;width:100%;}

/* STICKERS */
/* sticker-screen merged into achiev-screen */
.sticker-title{font-size:11px;color:#fbbf24;text-shadow:0 0 14px #fbbf24;margin-bottom:10px;flex-shrink:0;}
.sticker-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;max-width:340px;flex-shrink:0;}
.sticker-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:10px 6px;text-align:center;}
.sticker-card.got{border-color:rgba(251,191,36,.5);background:rgba(251,191,36,.07);}
.sticker-card.locked{opacity:.35;}
/* sticker */
.sticker-emoji{font-size:32px;display:block;margin-bottom:5px;}

/* LEADERBOARD */
#leaderboard-screen{background:linear-gradient(170deg,#0a1628,#0f2044);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;}
.lb-title{font-size:22px;font-weight:900;color:#38bdf8;text-shadow:0 0 14px #38bdf8;margin-bottom:12px;flex-shrink:0;}
.lb-list{width:100%;max-width:340px;flex-shrink:0;}
.lb-entry{display:flex;align-items:center;background:rgba(255,255,255,.04);border-radius:12px;padding:9px 12px;margin-bottom:7px;border:1px solid rgba(255,255,255,.07);gap:10px;}
.lb-entry.me{border-color:#38bdf8;background:rgba(56,189,248,.08);box-shadow:0 0 14px rgba(56,189,248,.1);}
.lb-rank{font-size:16px;font-weight:900;width:26px;color:#475569;}
.lb-rank.r1{color:#FFD700;text-shadow:0 0 8px #FFD700;}.lb-rank.r2{color:#C0C0C0;}.lb-rank.r3{color:#CD7F32;}
.lb-sp{width:26px;height:26px;flex-shrink:0;}
.lb-name{flex:1;font-size:13px;font-weight:800;color:#e2e8f0;}
.lb-score{font-size:16px;font-weight:900;color:#4ade80;text-shadow:0 0 6px #4ade80;}
/* Nickname modal */
#nick-modal{position:absolute;inset:0;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;z-index:500;pointer-events:all;}
.nick-box{background:linear-gradient(160deg,#0a1a10,#061810);border:2px solid rgba(74,222,128,.4);border-radius:22px;padding:32px 28px;text-align:center;max-width:300px;width:90%;}
.nick-title{font-size:22px;font-weight:900;color:#4ade80;text-shadow:0 0 14px #4ade80;margin-bottom:8px;}
.nick-sub{font-size:13px;color:#94a3b8;margin-bottom:20px;font-weight:700;line-height:1.5;}
.nick-input{width:100%;background:rgba(255,255,255,.08);border:2px solid rgba(74,222,128,.3);border-radius:12px;padding:12px 16px;color:#fff;font-size:18px;font-weight:800;font-family:'Nunito',sans-serif;outline:none;text-align:center;margin-bottom:16px;}
.nick-input:focus{border-color:#4ade80;box-shadow:0 0 12px rgba(74,222,128,.3);}
.nick-input::placeholder{color:#475569;}

@keyframes chestBounce{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-6px) rotate(5deg)}}
/* Combined Achievements + Ranks screen */
#achiev-screen{background:linear-gradient(170deg,#0a0a1a,#1a0a2e,#0a1010);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;}
.achiev-ranks-tabs{display:flex;gap:6px;width:100%;max-width:340px;margin-bottom:10px;flex-shrink:0;}
.ar-tab{flex:1;padding:10px 6px;font-size:13px;font-weight:800;border-radius:12px;cursor:pointer;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#94a3b8;font-family:'Nunito',sans-serif;text-align:center;}
.ar-tab.active{border-color:#fbbf24;background:rgba(251,191,36,.15);color:#fbbf24;}

.achiev-title{font-size:11px;color:#fbbf24;text-shadow:0 0 14px #fbbf24;margin-bottom:10px;flex-shrink:0;}
.achiev-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;width:100%;max-width:340px;flex-shrink:0;}
.achiev-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:11px;padding:8px;text-align:center;position:relative;}
.achiev-card.unlocked{border-color:rgba(251,191,36,.4);background:rgba(251,191,36,.07);}
.achiev-card.locked{opacity:.4;}
/* achiev */
.achiev-icon{font-size:26px;display:block;margin-bottom:3px;}
.achiev-done{position:absolute;top:3px;right:3px;font-size:11px;}

/* RANKS */
/* ranks merged into achiev-screen */
.ranks-title{font-size:22px;font-weight:900;color:#fbbf24;text-shadow:0 0 14px #fbbf24;margin-bottom:14px;flex-shrink:0;font-family:'Nunito',sans-serif;}
.rank-entry{display:flex;align-items:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:11px 14px;margin-bottom:8px;gap:12px;width:100%;max-width:340px;flex-shrink:0;}
.rank-entry.cur{border-color:#fbbf24;background:rgba(251,191,36,.1);box-shadow:0 0 16px rgba(251,191,36,.15);}
.rank-entry.done{border-color:rgba(74,222,128,.3);}
.rank-ico{font-size:26px;flex-shrink:0;}
.rank-nm{font-size:14px;font-weight:800;color:#e2e8f0;margin-bottom:2px;}
.rank-xpreq{font-size:11px;color:#64748b;font-weight:700;}

/* WHEEL */
#wheel-screen{background:radial-gradient(ellipse at center,#1a0a3e 0%,#0a0014 60%,#000 100%);overflow-y:auto;}
.wheel-title{font-size:24px;font-weight:900;color:#FFD700;text-shadow:0 0 20px #FFD700,0 0 40px rgba(255,215,0,.5);margin-bottom:8px;flex-shrink:0;text-align:center;letter-spacing:1px;}
.wheel-container{position:relative;width:min(92vw,420px);height:min(92vw,420px);flex-shrink:0;margin-bottom:16px;margin-top:4px;}
.wheel-ring{position:absolute;inset:-10px;border-radius:50%;background:linear-gradient(135deg,#FFD700,#f59e0b,#b8860b,#FFD700);animation:ringRotate 20s linear infinite;}
.wheel-ring-inner{position:absolute;inset:-4px;border-radius:50%;background:rgba(180,140,0,.5);animation:ringRotate 8s linear infinite reverse;}
@keyframes ringRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.wheel-wrap{position:absolute;inset:12px;border-radius:50%;overflow:hidden;}
#wheel-canvas{width:100%;height:100%;}
.wheel-ptr{position:absolute;top:-30px;left:50%;transform:translateX(-50%);font-size:44px;filter:drop-shadow(0 0 14px #FFD700) drop-shadow(0 2px 6px rgba(0,0,0,.9));z-index:20;animation:ptrBob .5s ease-in-out infinite alternate;}
.wheel-btn{background:linear-gradient(145deg,#FFD700,#f59e0b);color:#1a0a00;border:none;padding:18px 52px;font-family:'Nunito',sans-serif;font-size:20px;font-weight:900;border-radius:18px;cursor:pointer;box-shadow:0 8px 0 #92400e,inset 0 3px 0 rgba(255,255,255,.6),0 0 40px rgba(255,215,0,.4);margin-bottom:6px;letter-spacing:.5px;text-shadow:0 1px 0 rgba(255,255,255,.4);transition:transform .1s,box-shadow .1s;}
.wheel-btn:active{transform:translateY(6px);box-shadow:0 2px 0 #92400e;}
.wheel-btn:disabled{opacity:.4;cursor:not-allowed;}
.wheel-result{font-size:22px;font-weight:900;color:#FFD700;text-align:center;min-height:28px;margin-bottom:6px;text-shadow:0 0 16px #FFD700;transition:all .3s;}
.wheel-result.rare{animation:rareGlow .6s infinite;}
@keyframes rareGlow{0%,100%{color:#FFD700;text-shadow:0 0 20px #FFD700,0 0 40px rgba(255,215,0,.8)}50%{color:#fff;text-shadow:0 0 40px #FFD700,0 0 80px rgba(255,215,0,1)}}
@keyframes ptrBob{0%{transform:translateX(-50%) translateY(0)}100%{transform:translateX(-50%) translateY(7px)}}
.wheel-prize-anim{position:fixed;inset:0;pointer-events:none;z-index:5000;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s;}
.wheel-prize-anim.show{opacity:1;}
.wheel-prize-anim .prize-text{font-size:60px;font-weight:900;color:#FFD700;text-shadow:0 0 30px #FFD700,0 0 60px rgba(255,215,0,.6);animation:prizePop .6s cubic-bezier(.34,1.56,.64,1);}
@keyframes prizePop{0%{transform:scale(0) rotate(-20deg);opacity:0}100%{transform:scale(1) rotate(0deg);opacity:1}}

/* GAMEOVER */
#gameover-screen{background:rgba(0,0,0,.9);}
.go-title{font-size:18px;color:#ef4444;text-align:center;text-shadow:0 0 14px #ef4444,2px 2px 0 #000;margin-bottom:10px;animation:goShake .4s ease;flex-shrink:0;}
@keyframes goShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}60%{transform:translateX(8px)}}
.go-box{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.12);border-radius:14px;padding:12px 26px;text-align:center;margin-bottom:10px;flex-shrink:0;}
.go-lbl{font-size:11px;color:#64748b;margin-bottom:3px;}
.go-val{font-size:26px;color:#4ade80;text-shadow:0 0 16px #4ade80;}
.go-best{font-size:11px;color:#FFD700;margin-top:3px;}
.go-earned{font-size:11px;color:#7fffb0;margin-top:3px;}
.go-rank{font-size:11px;color:#fbbf24;margin-top:3px;}
.go-sticker{font-size:11px;color:#a78bfa;margin-top:3px;animation:glow 1s infinite;}
.go-unlock{font-size:11px;color:#a78bfa;margin-top:3px;animation:glow 1s infinite;}

/* CHEST MODAL */
#chest-modal{position:absolute;inset:0;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;z-index:200;pointer-events:all;}
.chest-box{background:linear-gradient(160deg,#1a0a3e,#0a1a3e);border:2px solid rgba(139,92,246,.5);border-radius:20px;padding:22px 24px 20px;text-align:center;max-width:300px;width:90%;position:relative;overflow:hidden;}
.chest-box-title{font-size:18px;font-weight:900;color:#a78bfa;text-shadow:0 0 14px #a78bfa;margin-bottom:6px;}
.chest-reward-text{font-size:18px;font-weight:900;color:#fbbf24;margin-bottom:14px;min-height:28px;text-shadow:0 0 12px #fbbf24;}
@keyframes chestRewardPop{0%{opacity:0;transform:scale(.3)}70%{transform:scale(1.1)}100%{opacity:1;transform:scale(1)}}
@keyframes coinFloat{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-70px) scale(.4)}}
.chest-coin-fx{position:absolute;font-size:20px;animation:coinFloat .9s ease-out forwards;pointer-events:none;}
/* QUESTS */
#quests-modal{position:absolute;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:200;pointer-events:all;}
.quests-box{background:linear-gradient(160deg,#0a1a0a,#1a0a0a);border:2px solid rgba(251,191,36,.5);border-radius:20px;padding:20px 18px;max-width:320px;width:92%;}
.quests-title{font-size:20px;font-weight:900;color:#fbbf24;text-align:center;margin-bottom:14px;text-shadow:0 0 16px #fbbf24;}
.quest-card{background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;}
.quest-card.done{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.08);}
.quest-icon{font-size:26px;flex-shrink:0;}
.quest-info{flex:1;min-width:0;}
.quest-name{font-size:13px;font-weight:900;color:#fff;margin-bottom:2px;}
.quest-progress{font-size:11px;color:#94a3b8;margin-bottom:5px;}
.quest-bar-wrap{height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;}
.quest-bar-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f97316);border-radius:3px;transition:width .4s;}
.quest-reward{font-size:11px;color:#fbbf24;font-weight:900;flex-shrink:0;}
.quest-card.done .quest-name{color:#4ade80;}
/* SEASON PASS */
#season-modal{position:absolute;inset:0;background:linear-gradient(160deg,rgba(5,3,20,.98),rgba(15,5,40,.98));display:flex;align-items:flex-start;justify-content:center;z-index:200;pointer-events:all;overflow-y:auto;padding:0;}
.season-box{background:linear-gradient(160deg,#0a0818,#140a30,#0a0818);border:0;border-radius:0;padding:0;max-width:100%;width:100%;margin:0;min-height:100%;display:flex;flex-direction:column;}
.season-header{background:linear-gradient(135deg,rgba(124,58,237,.8),rgba(167,139,250,.4));padding:calc(env(safe-area-inset-top,0px)+16px) 20px 16px;flex-shrink:0;border-bottom:2px solid rgba(167,139,250,.3);}
.season-title{font-size:28px;font-weight:900;color:#fff;margin-bottom:2px;text-shadow:0 0 20px #a78bfa,0 0 40px rgba(167,139,250,.4);letter-spacing:-.5px;}
.season-sub{font-size:13px;color:rgba(255,255,255,.75);margin-bottom:12px;font-weight:700;}
.season-xp-bar{height:16px;background:rgba(0,0,0,.4);border-radius:8px;margin-bottom:6px;overflow:hidden;border:1px solid rgba(167,139,250,.3);box-shadow:inset 0 2px 4px rgba(0,0,0,.3);}
.season-xp-fill{height:100%;background:linear-gradient(90deg,#5b21b6,#7c3aed,#a78bfa,#c4b5fd);border-radius:8px;transition:width .6s ease;position:relative;overflow:hidden;}
.season-xp-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.35) 50%,transparent 100%);border-radius:8px;animation:xpShimmer 2s linear infinite;}
@keyframes xpShimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.season-body{padding:20px 16px;flex:1;}
.season-rewards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;margin-top:4px;}
@media(max-width:340px){.season-rewards{grid-template-columns:repeat(3,1fr);}}
.season-reward{text-align:center;padding:16px 4px 12px;border-radius:18px;border:1.5px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);cursor:pointer;transition:all .2s;position:relative;min-height:106px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.season-reward:active{transform:scale(.92);}
.season-reward.claimed{border-color:rgba(34,197,94,.5);background:rgba(34,197,94,.1);}
.season-reward.claimed::after{content:'‚úì';position:absolute;top:5px;right:7px;font-size:13px;font-weight:900;color:#4ade80;}
.season-reward.current{border-color:rgba(167,139,250,.9);background:rgba(124,58,237,.2);box-shadow:0 0 20px rgba(167,139,250,.35),inset 0 0 20px rgba(124,58,237,.15);}
.season-reward.locked{opacity:.3;filter:grayscale(.7);}
.season-reward.rare-reward{border-color:rgba(255,215,0,.6);background:rgba(255,215,0,.07);box-shadow:0 0 16px rgba(255,215,0,.2);}
.sr-icon{font-size:36px;display:block;margin-bottom:5px;line-height:1;}
.sr-lv{font-size:11px;color:rgba(255,255,255,.4);margin-bottom:3px;font-weight:800;letter-spacing:.5px;}
.sr-val{font-size:11px;color:#fbbf24;font-weight:900;line-height:1.3;word-break:break-word;}
.season-track{display:flex;align-items:center;margin-bottom:14px;overflow-x:auto;padding:6px 0;gap:0;-ms-overflow-style:none;scrollbar-width:none;}
.season-track::-webkit-scrollbar{display:none;}
.season-milestone{display:flex;align-items:center;gap:0;flex-shrink:0;}
.sm-dot{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,.2);background:#1e1040;flex-shrink:0;transition:all .3s;}
.sm-dot.done{background:#a78bfa;border-color:#c4b5fd;box-shadow:0 0 8px #a78bfa,0 0 16px rgba(167,139,250,.4);}
.sm-line{width:22px;height:4px;background:rgba(255,255,255,.08);flex-shrink:0;border-radius:2px;}
.sm-line.done{background:linear-gradient(90deg,#7c3aed,#a78bfa);}

/* TOAST */
#toast{position:absolute;bottom:calc(env(safe-area-inset-bottom,0px)+65px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,.87);border:1px solid rgba(74,222,128,.4);border-radius:11px;padding:8px 16px;font-size:11px;color:#4ade80;white-space:nowrap;opacity:0;transition:opacity .3s;pointer-events:none;z-index:300;}
#toast.show{opacity:1;}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:2px}

/* ‚îÄ‚îÄ‚îÄ NEW SCREEN STYLES ‚îÄ‚îÄ‚îÄ */
#bestrun-screen,#leagues-screen,#streak-screen{background:linear-gradient(170deg,#061a10,#0d2b1a,#061a10);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;padding-top:calc(env(safe-area-inset-top,0px)+14px);}
#leagues-screen,#streak-screen{padding-bottom:calc(env(safe-area-inset-bottom,0px)+16px);}
#countdown-overlay{background:rgba(0,0,0,.65);}
</style>

</head>
<body>
<div id="wrap">
<canvas id="gameCanvas"></canvas>
<div id="ui">
  <div id="hud-score" class="hidden">0</div>
  <div id="hud-currency" class="hidden">
    <div id="hud-cukes-row">ü•í <span id="hud-cukes">0</span></div>
    <div id="hud-gold-row">‚ú® <span id="hud-gold">0</span></div>
  </div>
  <div id="hud-lvl-wrap" class="hidden">
    <div id="hud-lvl-text">LVL 1</div>
    <div id="hud-xpbar"><div id="hud-xpfill" style="width:0%"></div></div>
  </div>
  <div id="hud-combo" class="hidden"></div>
  <!-- Pet display during game -->
  <div id="hud-pet" class="hidden" style="position:absolute;bottom:calc(env(safe-area-inset-bottom,0px)+8px);left:10px;font-size:26px;opacity:0.85;pointer-events:none;filter:drop-shadow(0 0 6px rgba(255,255,255,.3));"></div>
  <div id="hud-boosters" class="hidden">
    <div class="hud-boost-btn" id="btn-shield">üõ°Ô∏è<div class="bcnt" id="cnt-shield">0</div></div>
    <div class="hud-boost-btn" id="btn-magnet">üß≤<div class="bcnt" id="cnt-magnet">0</div></div>
    <div class="hud-boost-btn" id="btn-turbo">‚ö°<div class="bcnt" id="cnt-turbo">0</div></div>
    <div class="hud-boost-btn" id="btn-mega">üí•<div class="bcnt" id="cnt-mega">0</div></div>
  </div>
  <div id="hud-shoot" class="hidden">üå±</div>
  <div id="hud-pause" class="hidden">‚è∏</div>
  <div id="pause-overlay" class="hidden">
    <div class="pause-title">‚è∏ –ü–ê–£–ó–ê</div>
    <button class="btn" style="width:200px;" id="btn-pause-resume">‚ñ∂ –ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
    <button class="btn blue" style="width:200px;" id="btn-pause-menu">üè† –í –ú–ï–ù–Æ</button>
  </div>
  <div id="game-label"></div>
  <div id="sticker-notif"></div>
</div>

<!-- START -->

<div class="screen" id="start-screen">
  <canvas id="start-bg-canvas"></canvas>
  <div id="start-content">
  <div class="game-title">ü•í FLAPPY<br>CUCUMBER</div>
  <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px;flex-shrink:0;">
    <div id="hero-wrap"><canvas id="hero-canvas" width="56" height="88"></canvas></div>
    <span id="hero-pet-display" style="font-size:28px;display:none;filter:drop-shadow(0 0 8px rgba(255,200,100,.6));"></span>
  </div>
  <div class="player-rank" id="player-rank-display">ü•í –ù–ê–ß–ò–ù–ê–Æ–©–ò–ô</div>

  <!-- Big info panel -->
  <div class="info-panel">
    <div class="info-row">
      <div class="info-item">
        <span class="info-ico">ü•í</span>
        <div class="info-val g" id="main-cukes">0</div>
        <div class="info-lbl">–û–≥—É—Ä—á–∏–∫–∏</div>
      </div>
      <div class="info-divider"></div>
      <div class="info-item">
        <span class="info-ico">‚ú®</span>
        <div class="info-val gd" id="main-gold">0</div>
        <div class="info-lbl">–ó–æ–ª–æ—Ç–æ</div>
      </div>
      <div class="info-divider"></div>
      <div class="info-item">
        <span class="info-ico">‚≠ê</span>
        <div class="info-val xp" id="main-xp">0</div>
        <div class="info-lbl">XP</div>
      </div>
    </div>
    <!-- Level bar -->
    <div class="lvl-bar-wrap">
      <div class="lvl-bar-label" id="menu-xp-label">0 / 100 XP ¬∑ –£—Ä–æ–≤–µ–Ω—å 1</div>
      <div class="lvl-bar-outer">
        <div class="lvl-bar-fill" id="menu-xp-fill" style="width:0%"></div>
        <div class="lvl-bar-glow" id="menu-xp-fill-glow" style="width:0%"></div>
      </div>
    </div>
  </div>



  <!-- Hidden canvases for JS compatibility -->
  <div style="display:none;">
    <canvas id="qs-skin-canvas" width="36" height="56"></canvas>
    <div id="qs-world-preview"><canvas id="qs-world-canvas" width="50" height="36"></canvas></div>
    <span id="qs-pet-emoji">ü•ö</span>
    <div id="qs-pet-name">–ù–µ—Ç</div>
    <canvas id="qs-trail-canvas" width="36" height="36"></canvas>
    <div id="qs-skin-name">–î–µ—Ñ–æ–ª—Ç</div>
    <div id="qs-world-name">–õ–µ—Å</div>
    <div id="qs-trail-name">–ù–µ—Ç</div>
  </div>

  <div class="btn-grid">
    <button class="btn play-btn wide" id="btn-play">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
    <button class="btn gold" id="btn-shop">üõí –ú–ê–ì–ê–ó–ò–ù</button>
    <button class="btn teal" id="btn-improvements">‚öôÔ∏è –£–õ–£–ß–®–ï–ù–ò–Ø</button>
    <button class="btn blue" id="btn-lb">üèÜ –†–ï–ô–¢–ò–ù–ì</button>
    <button class="btn purple" id="btn-achiev">üìä –ü–†–û–ì–†–ï–°–°</button>
    <button class="btn" id="btn-wheel" style="background:linear-gradient(145deg,#a855f7,#6d28d9);box-shadow:0 6px 0 #3b0764,inset 0 1px 0 rgba(255,255,255,.3);">üé° –ö–û–õ–ï–°–û</button>
    <button class="btn" id="btn-quests" style="background:linear-gradient(145deg,#f59e0b,#b45309);box-shadow:0 6px 0 #78350f,inset 0 1px 0 rgba(255,255,255,.3);" id="quests-btn">üéØ –ó–ê–î–ê–ù–ò–Ø</button>
    <button class="btn" id="btn-season" style="background:linear-gradient(145deg,#7c3aed,#4c1d95);box-shadow:0 6px 0 #2e1065,inset 0 1px 0 rgba(255,255,255,.3);" class="btn wide">‚≠ê –°–ï–ó–û–ù</button>
  </div>

  <!-- Hidden elements for JS compatibility -->
  <div style="display:none;">
    <canvas id="mini-skin-canvas" width="28" height="44"></canvas>
    <canvas id="mini-world-canvas" width="40" height="30"></canvas>
    <span id="active-pet-emoji">ü•ö</span>
    <span id="mini-trail-preview">‚ú®</span>
  </div>

  <div class="tap-hint">–¢–ê–ü / –ü–†–û–ë–ï–õ = –ü–†–´–ñ–û–ö ¬∑ F = üå±</div>
  </div>
</div>

<!-- MODE SELECT -->

<div class="screen hidden" id="mode-screen">
  <div class="mode-title">–í–´–ë–û–† –†–ï–ñ–ò–ú–ê</div>
  <div class="mode-card easy" id="mc-easy"><div class="mode-name">üòå –õ–Å–ì–ö–ò–ô</div><div class="mode-desc">–ú–µ–¥–ª–µ–Ω–Ω–æ, —à–∏—Ä–æ–∫–∏–µ –ø—Ä–æ—Ö–æ–¥—ã.</div><div class="mode-reward">x0.8 ü•í</div></div>
  <div class="mode-card normal" id="mc-normal"><div class="mode-name">ü•í –û–ë–´–ß–ù–´–ô</div><div class="mode-desc">–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–±—ã –ø–æ—Å–ª–µ 15 –±–∞—à–µ–Ω. –ë–æ—Å—Å—ã. –Ø—â–∏–∫–∏.</div><div class="mode-reward">x1.0 ü•í</div></div>
  <div class="mode-card hard" id="mc-hard"><div class="mode-name">üî• –°–õ–û–ñ–ù–´–ô</div><div class="mode-desc">–£–∑–∫–∏–µ –ø—Ä–æ—Ö–æ–¥—ã, –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–≥–æ–Ω.</div><div class="mode-reward">x1.5 ü•í</div></div>
  <div class="mode-card insane" id="mc-insane"><div class="mode-name">üíÄ –ë–ï–ó–£–ú–ò–ï</div><div class="mode-desc">–ö–∞–º–µ—Ä–∞ —Ç—Ä—è—Å—ë—Ç—Å—è. –≠–∫—Å—Ç—Ä–∏–º.</div><div class="mode-reward">x2.0 ü•í</div></div>
  <div class="mode-card crazy" id="mc-crazy"><div class="mode-name">üåÄ –•–ê–û–°</div><div class="mode-desc">–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è, —Ñ–æ–Ω –∏ —Ç—Ä—É–±—ã —Å—Ö–æ–¥—è—Ç —Å —É–º–∞!</div><div class="mode-reward">x3.0 ü•í</div></div>

  <button class="btn blue" style="margin-top:8px;width:100%;max-width:300px;flex-shrink:0;" id="btn-mode-back">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- PETS SCREEN -->
<div class="screen hidden" id="pets-screen">
  <div class="pets-title">üêæ –ü–ò–¢–û–ú–¶–´</div>
  <div class="shop-bal">
    <div class="bal-item">‚ú® <span class="bal-val gd" id="pets-gold">0</span> –∑–æ–ª–æ—Ç–æ</div>
  </div>
  <div class="pets-grid" id="pets-grid"></div>
  <button class="btn blue" style="width:100%;max-width:340px;flex-shrink:0;margin-top:4px;" id="btn-pets-back">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- SHOP -->

<div class="screen hidden" id="shop-screen">
  <div class="shop-title">üõí –ú–ê–ì–ê–ó–ò–ù</div>
  <div class="shop-bal">
    <div class="bal-item">ü•í <span class="bal-val" id="shop-cukes">0</span></div>
    <div class="bal-item">‚ú® <span class="bal-val gd" id="shop-gold">0</span> –∑–æ–ª–æ—Ç–æ</div>
  </div>
  <div class="shop-tabs">
    <button class="shop-tab active" id="stab-skins" >ü•í –°–ö–ò–ù–´</button>
    <button class="shop-tab" id="stab-worlds" >üåç –ú–ò–†–´</button>
    <button class="shop-tab" id="stab-trails" >‚ú® –°–õ–ï–î–´</button>
    <button class="shop-tab" id="stab-upg" >‚¨ÜÔ∏è –ê–ü–ì–†–ï–ô–î–´</button>
    <button class="shop-tab" id="stab-pets" >üêæ –ü–ò–¢–û–ú–¶–´</button>
  </div>
  <div class="carousel-outer" id="shop-carr-outer">
    <button class="carr-arrow left" id="btn-car-prev">‚Äπ</button>
    <div class="carousel-vp"><div class="carousel-track" id="carousel-track"></div></div>
    <button class="carr-arrow right" id="btn-car-next">‚Ä∫</button>
  </div>
  <div class="carr-dots" id="carousel-dots"></div>
  <div class="shop-actions">
    <button class="btn purple" id="shop-action-btn" id="btn-shop-action">–í–´–ë–†–ê–¢–¨</button>
    <button class="btn" id="btn-shop-close">‚Üê –ù–ê–ó–ê–î</button>
  </div>
</div>

<!-- BOOST SHOP -->

<div class="screen hidden" id="boost-screen">
  <div class="shop-title" style="color:#2dd4bf;text-shadow:0 0 14px #2dd4bf;">‚öôÔ∏è –£–õ–£–ß–®–ï–ù–ò–Ø</div>
  <div style="display:flex;gap:6px;width:100%;max-width:340px;margin-bottom:10px;flex-shrink:0;">
    <button class="shop-tab active" id="impr-tab-boost">üíä –ë–£–°–¢–ï–†–´</button>
    <button class="shop-tab" id="impr-tab-upg">‚¨ÜÔ∏è –ê–ü–ì–†–ï–ô–î–´</button>
  </div>
  <div id="impr-boost-pane">
  <div class="shop-bal"><div class="bal-item">ü•í <span class="bal-val" id="boost-cukes">0</span></div></div>
  <div class="boost-grid">
    <div class="boost-card" style="border-color:rgba(56,189,248,.3);"><span class="boost-icon">üõ°Ô∏è</span><div class="boost-name">–©–ò–¢</div><div class="boost-desc">1 —Å–ø–∞—Å–µ–Ω–∏–µ –æ—Ç —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è</div><div class="boost-cnt-txt">x<span id="sh-n">0</span></div><div class="boost-price">ü•í 50</div><button class="boost-buy-btn" id="btn-buy-shield">–ö–£–ü–ò–¢–¨</button></div>
    <div class="boost-card" style="border-color:rgba(251,191,36,.3);"><span class="boost-icon">üß≤</span><div class="boost-name">–ú–ê–ì–ù–ò–¢</div><div class="boost-desc">–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –º–æ–Ω–µ—Ç—ã 10—Å</div><div class="boost-cnt-txt">x<span id="mg-n">0</span></div><div class="boost-price">ü•í 75</div><button class="boost-buy-btn" id="btn-buy-magnet">–ö–£–ü–ò–¢–¨</button></div>
    <div class="boost-card" style="border-color:rgba(249,115,22,.3);"><span class="boost-icon">‚ö°</span><div class="boost-name">–¢–£–†–ë–û</div><div class="boost-desc">+30% —Å–∫–æ—Ä–æ—Å—Ç—å 8—Å</div><div class="boost-cnt-txt">x<span id="tb-n">0</span></div><div class="boost-price">ü•í 60</div><button class="boost-buy-btn" id="btn-buy-turbo">–ö–£–ü–ò–¢–¨</button></div>
    <div class="boost-card" style="border-color:rgba(167,139,250,.3);" id="mega-boost-card"><span class="boost-icon">ü•íüí•</span><div class="boost-name">–ú–ï–ì–ê-–û–ì–£–†–ï–¶</div><div class="boost-desc">–†–∞–∑—Ä—É—à–∞–π —Ç—Ä—É–±—ã 5—Å!</div><div class="boost-cnt-txt">x<span id="mega-n">0</span></div><div class="boost-price">ü•í 150</div><button class="boost-buy-btn" id="btn-buy-mega">–ö–£–ü–ò–¢–¨</button></div>
  </div>
  </div><!-- /impr-boost-pane -->
  <div id="impr-upg-pane" class="hidden" style="width:100%;max-width:340px;flex-shrink:0;">
    <div class="shop-bal"><div class="bal-item">ü•í <span class="bal-val" id="impr-upg-cukes">0</span></div></div>
    <div class="upgrade-grid" id="impr-upg-grid" style="max-height:55vh;overflow-y:auto;"></div>
  </div>
  <button class="btn blue" style="margin-top:8px;width:100%;max-width:280px;flex-shrink:0;" id="btn-boost-back">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- STICKER SCREEN REMOVED - merged into achievements -->

<!-- LEADERBOARD -->

<div class="screen hidden" id="leaderboard-screen">
  <div class="lb-title">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</div>
  <div class="lb-list" id="lb-list"></div>
  <button class="btn blue" style="margin-top:10px;width:100%;max-width:300px;flex-shrink:0;" id="btn-lb-back">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- ACHIEVEMENTS + RANKS COMBINED -->

<div class="screen hidden" id="achiev-screen">
  <div style="font-size:20px;font-weight:900;color:#fbbf24;text-shadow:0 0 14px #fbbf24;margin-bottom:10px;flex-shrink:0;padding-top:calc(env(safe-area-inset-top,0px)+10px);">üìä –ü–†–û–ì–†–ï–°–°</div>
  <div class="achiev-ranks-tabs">
    <div class="ar-tab active" id="ar-tab-achiev" >üèÖ –ê–ß–ò–í–ö–ò</div>
    <div class="ar-tab" id="ar-tab-ranks" >üéñÔ∏è –†–ê–ù–ì–ò</div>
    <div class="ar-tab" id="ar-tab-stickers" >üè∑Ô∏è –ù–ê–ö–õ–ï–ô–ö–ò</div>
  </div>
  <!-- Achiev pane -->
  <div id="ar-achiev-pane" class="achiev-grid" id="achiev-grid"></div>
  <!-- Ranks pane -->
  <div id="ar-ranks-pane" class="hidden" style="width:100%;max-width:340px;flex-shrink:0;" id="ranks-list"></div>
  <!-- Stickers pane -->
  <div id="ar-stickers-pane" class="hidden sticker-grid" id="sticker-grid2"></div>
  <button class="btn blue" style="margin-top:12px;margin-bottom:calc(env(safe-area-inset-bottom,0px)+8px);width:100%;max-width:340px;flex-shrink:0;" id="btn-achiev-back">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- WHEEL RARE PRIZE OVERLAY -->
<div class="hidden" id="wheel-prize-overlay" style="position:fixed;inset:0;pointer-events:none;z-index:5000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:rgba(0,0,0,.6);">
  <div id="wheel-prize-emoji" style="font-size:100px;animation:prizePop .6s cubic-bezier(.34,1.56,.64,1);"></div>
  <div id="wheel-prize-label" style="font-size:32px;font-weight:900;color:#FFD700;text-shadow:0 0 40px #FFD700,0 0 80px rgba(255,215,0,.6);text-align:center;animation:prizePop .6s .1s cubic-bezier(.34,1.56,.64,1) both;"></div>
  <div style="font-size:14px;color:#fbbf24;font-weight:700;opacity:.8;">üéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! üéâ</div>
</div>
<div class="screen hidden" id="wheel-screen">
  <div class="wheel-title">üé° –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´</div>
  <div class="wheel-container">
    <div class="wheel-ring"></div>
    <div class="wheel-ring-inner"></div>
    <div class="wheel-wrap">
      <canvas id="wheel-canvas" width="400" height="400"></canvas>
    </div>
    <div class="wheel-ptr">‚ñº</div>
  </div>
  <div class="wheel-result" id="wheel-result"></div>
  <button class="wheel-btn" id="wheel-spin-btn" id="btn-spin-real">üé∞ –ö–†–£–¢–ò–¢–¨!</button>
  <div style="font-size:12px;color:#94a3b8;margin-top:4px;font-weight:700;" id="wheel-info">üéÅ –†–∞–∑ –≤ –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
  <button class="btn blue" style="margin-top:10px;width:100%;max-width:260px;flex-shrink:0;" id="btn-wheel-back">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- GAMEOVER -->

<div class="screen hidden" id="gameover-screen">
  <div class="go-title">üíÄ –û–ì–£–†–ï–¶ –£–ú–ï–†!</div>
  <canvas id="dead-canvas" width="38" height="60" style="margin-bottom:8px;flex-shrink:0;filter:drop-shadow(0 0 12px rgba(239,68,68,.5));"></canvas>
  <div class="go-box">
    <div class="go-lbl">–°–ß–Å–¢</div>
    <div class="go-val" id="go-score">0</div>
    <div class="go-best" id="go-best"></div>
    <div class="go-earned" id="go-earned"></div>
    <div class="go-rank" id="go-rank"></div>
    <div class="go-sticker" id="go-sticker"></div>
    <div class="go-unlock" id="go-unlock"></div>
  </div>
  <div class="btn-grid" style="max-width:270px;">
    <button class="btn" id="btn-restart">üîÑ –ï–©–Å –†–ê–ó</button>
    <button class="btn blue" id="btn-gomenu">üè† –ú–ï–ù–Æ</button>
    <button class="btn wide" style="background:linear-gradient(135deg,#0088cc,#005fa3);box-shadow:0 4px 0 #003d6b;" id="btn-share">üì§ –ü–û–î–ï–õ–ò–¢–¨–°–Ø –í TELEGRAM</button>
  </div>
</div>

<!-- NICKNAME MODAL -->
<div id="nick-modal" class="hidden">
  <div class="nick-box">
    <div class="nick-title">üëã –ü—Ä–∏–≤–µ—Ç!</div>
    <div class="nick-sub">–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?<br>–¢–≤–æ—ë –∏–º—è –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</div>
    <input class="nick-input" id="nick-input" type="text" placeholder="–í–≤–µ–¥–∏ –Ω–∏–∫–Ω–µ–π–º..." maxlength="16" autocomplete="off">
    <button class="btn wide" id="nick-save-btn" id="btn-nick-save">‚úÖ –°–û–•–†–ê–ù–ò–¢–¨</button>
  </div>
</div>

<!-- chest removed -->

<!-- QUESTS MODAL -->
<div id="quests-modal" class="hidden">
  <div class="quests-box">
    <div class="quests-title">üéØ –ó–ê–î–ê–ù–ò–Ø</div>
    <div id="quests-list"></div>
    <div style="font-size:10px;color:#475569;text-align:center;margin-bottom:12px;" id="quests-reset-txt"></div>
    <button class="btn blue wide" id="btn-quests-close">–ó–ê–ö–†–´–¢–¨</button>
  </div>
</div>

<!-- SEASON PASS MODAL -->
<div id="season-modal" class="hidden">
  <div class="season-box">
    <div class="season-header">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div class="season-title">‚≠ê –°–ï–ó–û–ù 1</div>
        <button class="btn blue" style="width:auto;padding:8px 16px;font-size:13px;flex-shrink:0;" id="btn-season-close">‚úï</button>
      </div>
      <div class="season-sub">–ò–≥—Ä–∞–π, –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π XP –∏ –ø–æ–ª—É—á–∞–π —ç–ø–∏—á–µ—Å–∫–∏–µ –Ω–∞–≥—Ä–∞–¥—ã!</div>
      <div id="season-xp-label" style="font-size:13px;color:#c4b5fd;margin-bottom:8px;font-weight:800;"></div>
      <div class="season-xp-bar"><div class="season-xp-fill" id="season-xp-fill"></div></div>
      <div class="season-track" id="season-track" style="margin-top:10px;"></div>
    </div>
    <div class="season-body">
      <div class="season-rewards" id="season-rewards-grid"></div>
      <button class="btn purple" style="width:100%;margin-top:4px;margin-bottom:calc(env(safe-area-inset-bottom,0px)+8px);" id="btn-season-claim">üéÅ –ó–ê–ë–†–ê–¢–¨ –ù–ê–ì–†–ê–î–´</button>
    </div>
  </div>
</div>

<div id="toast"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
let W,H;
function resizeCanvas(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
resizeCanvas();
window.addEventListener('resize',()=>{resizeCanvas();if(gameState==='menu')drawBg();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RANKS + CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RANKS=[
  {icon:'ü•í',name:'–ù–ê–ß–ò–ù–ê–Æ–©–ò–ô',xpRequired:0,   color:'#4ade80'},
  {icon:'üå±',name:'–†–û–°–¢–û–ö',    xpRequired:100,  color:'#22c55e'},
  {icon:'ü•ó',name:'–°–ê–õ–ê–¢–û–í–´–ô', xpRequired:300,  color:'#84cc16'},
  {icon:'‚öîÔ∏è', name:'–ë–û–ï–¶',     xpRequired:700,  color:'#fbbf24'},
  {icon:'üèÖ',name:'–û–ü–´–¢–ù–´–ô',   xpRequired:1500, color:'#f97316'},
  {icon:'üî•',name:'–≠–õ–ò–¢–ê',     xpRequired:3000, color:'#ef4444'},
  {icon:'üíé',name:'–ê–õ–ú–ê–ó–ù–´–ô',  xpRequired:6000, color:'#38bdf8'},
  {icon:'üëë',name:'–õ–ï–ì–ï–ù–î–ê',   xpRequired:12000,color:'#a78bfa'},
  {icon:'üåü',name:'DIVINE',    xpRequired:25000,color:'#FFD700'},
];
const XP_PER_LEVEL=[100,150,200,300,450,650,900,1200,2000];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STICKER DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STICKERS=[
  {id:'s_firstfly',  emoji:'üê£', name:'–ü–µ—Ä–≤—ã–π –ø–æ–ª—ë—Ç',   req:'–°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—É—é –∏–≥—Ä—É',         check:()=>totalGames>=1},
  {id:'s_inertia',   emoji:'ü™Å', name:'–ò–Ω–µ—Ä—Ü–∏—è',          req:'–ü—Ä–æ–π–¥–∏ 5 —Ç—Ä—É–± –±–µ–∑ –ø—Ä—ã–∂–∫–∞',  check:()=>maxNoJump>=5},
  {id:'s_zenmaster', emoji:'üçÉ', name:'–î–∑–µ–Ω-–º–∞—Å—Ç–µ—Ä',      req:'–ü—Ä–æ–ª–µ—Ç–∏ 60—Å –≤ –î–∑–µ–Ω-—Ä–µ–∂–∏–º–µ', check:()=>zenSeconds>=60},
  {id:'s_combofever',emoji:'üå∂Ô∏è', name:'–û–≥—É—Ä–µ—á–Ω–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞',req:'–ê–∫—Ç–∏–≤–∏—Ä—É–π –∫–æ–º–±–æ x5',      check:()=>combosActivated>=1},
  {id:'s_bossslayer',emoji:'üëπ', name:'–£–±–∏–π—Ü–∞ –±–æ—Å—Å–æ–≤',    req:'–ü–æ–±–µ–¥–∏ 5 –±–æ—Å—Å–æ–≤',            check:()=>bossesDefeated>=5},
  {id:'s_richcuke',  emoji:'üí∞', name:'–ë–æ–≥–∞—á',             req:'–°–æ–±–µ—Ä–∏ 500 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',    check:()=>totalCoins>=500},
  {id:'s_divine',    emoji:'‚ú®', name:'Divine',            req:'–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π Divine —Å–∫–∏–Ω',   check:()=>ownedSkins.includes('secret')},
  {id:'s_shooter',   emoji:'üå±', name:'–°–Ω–∞–π–ø–µ—Ä',           req:'–†–∞–∑—Ä—É—à–∏ 20 —è—â–∏–∫–æ–≤',         check:()=>boxesDestroyed>=20},
  {id:'s_portal',    emoji:'üåÄ', name:'–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫',   req:'–í–æ–π–¥–∏ –≤ 3 –ø–æ—Ä—Ç–∞–ª–∞',         check:()=>portalsUsed>=3},
  {id:'s_megapower', emoji:'üí•', name:'–ú–µ–≥–∞-—Å–∏–ª–∞',        req:'–†–∞–∑—Ä—É—à–∏ 5 —Ç—Ä—É–± –ú–µ–≥–∞-–æ–≥—É—Ä—Ü–æ–º',check:()=>megaPipesSmashed>=5},
  {id:'s_chestloot', emoji:'üì¶', name:'–°–±–æ—Ä—â–∏–∫',          req:'–û—Ç–∫—Ä–æ–π 10 —Å—É–Ω–¥—É–∫–æ–≤',        check:()=>chestsOpened>=10},
  {id:'s_crazy100',  emoji:'üåÄ', name:'–•–∞–æ—Ç–∏–∫',            req:'–í—ã–∂–∏–≤–∏ 25 –±–∞—à–µ–Ω –≤ –•–∞–æ—Å–µ',  check:()=>crazySurvived>=25},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPGRADES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UPGRADES=[
  {id:'u_coin_chance',  icon:'ü™ô', name:'–ú–û–ù–ï–¢–ù–ê–Ø –£–î–ê–ß–ê',  desc:'+5% —à–∞–Ω—Å –º–æ–Ω–µ—Ç—ã –∑–∞ —É—Ä–æ–≤–µ–Ω—å',    maxLevel:5, baseCost:80,  costMult:1.8, effect:'coinChance'},
  {id:'u_lucky_save',   icon:'üçÄ', name:'–°–ß–ê–°–¢–õ–ò–í–ß–ò–ö',     desc:'1% —à–∞–Ω—Å –≤—ã–∂–∏—Ç—å –ø—Ä–∏ —É–¥–∞—Ä–µ',       maxLevel:3, baseCost:200, costMult:2.5, effect:'luckySave'},
  {id:'u_magnet_range', icon:'üß≤', name:'–ú–û–©–ù–´–ô –ú–ê–ì–ù–ò–¢',   desc:'+30 –µ–¥. –¥–∞–ª—å–Ω–æ—Å—Ç—å –º–∞–≥–Ω–∏—Ç–∞',     maxLevel:3, baseCost:120, costMult:1.9, effect:'magnetRange'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD / SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSave(){
  try{const s=localStorage.getItem('fc_save');if(s)return JSON.parse(s);}catch(e){}
  return null;
}
const _s=loadSave();
const def=(k,d)=>_s&&_s[k]!==undefined?_s[k]:d;

let cucumbers     = def('cukes',   0);
let goldCukes     = def('gold',    0);
let bestScore     = def('best',    0);
let ownedSkins    = def('owned',   ['default']);
let selectedSkin  = def('skin',    'default');
let leaderboard   = def('lb',      []);
let unlockedAchievs= def('achiev', []);
let ownedTrails   = def('trails',  ['none']);
let selectedTrail = def('trail',   'none');
let lastWheelDate = def('wheelDate','');
let totalGames    = def('games',   0);
let totalCoins    = def('totalCoins',0);
let selectedWorld = def('world',   'forest');
let ownedWorlds   = def('worlds',  ['forest']);
let playerXP      = def('xp',      0);
let playerLevel   = def('level',   0);
let boosters      = def('boosters',{shield:0,magnet:0,turbo:0,mega:0});
let crazySurvived = def('crazy',   0);
let bossesDefeated= def('bosses',  0);
let upgradelevels = def('upglvls', {u_coin_chance:0,u_lucky_save:0,u_magnet_range:0});
let unlockedStickers=def('stickers',[]);
let lastChestTime = def('lastChest',0);
let chestsOpened  = def('chestsOpened',0);
let maxNoJump     = def('maxNoJump',0);
let zenSeconds    = def('zenSeconds',0);
let combosActivated=def('combosActivated',0);
let boxesDestroyed= def('boxesDestroyed',0);
let portalsUsed   = def('portalsUsed',0);
let megaPipesSmashed=def('megaPipesSmashed',0);
let playerNickname= def('nickname','');

function save(){
  try{
    // Split into micro-keys for faster reads/writes
    localStorage.setItem('fc_core',JSON.stringify({cukes:cucumbers,gold:goldCukes,best:bestScore,skin:selectedSkin,world:selectedWorld,trail:selectedTrail,nickname:playerNickname,pet:selectedPet}));
    localStorage.setItem('fc_progress',JSON.stringify({xp:playerXP,level:playerLevel,achiev:unlockedAchievs,stickers:unlockedStickers,games:totalGames,totalCoins,crazy:crazySurvived,bosses:bossesDefeated,maxNoJump,zenSeconds,combosActivated,boxesDestroyed,portalsUsed,megaPipesSmashed}));
    localStorage.setItem('fc_items',JSON.stringify({owned:ownedSkins,worlds:ownedWorlds,trails:ownedTrails,boosters,upglvls:upgradelevels,ownedPets}));
    localStorage.setItem('fc_meta',JSON.stringify({wheelDate:lastWheelDate,lastChest:lastChestTime,chestsOpened,lb:leaderboard}));
    // Keep legacy key for compatibility
    const data={cukes:cucumbers,gold:goldCukes,best:bestScore,owned:ownedSkins,skin:selectedSkin,
      lb:leaderboard,achiev:unlockedAchievs,trails:ownedTrails,trail:selectedTrail,
      wheelDate:lastWheelDate,games:totalGames,totalCoins,world:selectedWorld,worlds:ownedWorlds,
      xp:playerXP,level:playerLevel,boosters,crazy:crazySurvived,bosses:bossesDefeated,
      upglvls:upgradelevels,stickers:unlockedStickers,lastChest:lastChestTime,chestsOpened,
      maxNoJump,zenSeconds,combosActivated,boxesDestroyed,portalsUsed,megaPipesSmashed,
      nickname:playerNickname,pet:selectedPet,ownedPets};
    localStorage.setItem('fc_save',JSON.stringify(data));
    // Save to shared leaderboard key
    if(playerNickname&&bestScore>0){
      const lbKey='fc_global_lb';
      let glb=[];try{glb=JSON.parse(localStorage.getItem(lbKey)||'[]');}catch(e){}
      const myId=tgUserId||('guest_'+playerNickname.toLowerCase());
      const existing=glb.find(e=>e.uid===myId);
      if(existing){if(bestScore>existing.score){existing.score=bestScore;existing.rank=getRank().icon;existing.skin=selectedSkin;}}
      else{glb.push({uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon});}
      glb.sort((a,b)=>b.score-a.score);glb=glb.slice(0,50);
      try{localStorage.setItem(lbKey,JSON.stringify(glb));}catch(e){}
    }
  }catch(e){console.warn('save err',e);}
}
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='hidden'){if(gameState==='playing'&&score>bestScore){bestScore=score;}save();}});
window.addEventListener('pagehide',()=>save());
window.addEventListener('beforeunload',()=>save());
// Save only on key moments (death, purchase, hide) - removed interval to prevent microfreezes

// ‚îÄ‚îÄ‚îÄ Nickname system ‚îÄ‚îÄ‚îÄ
function checkNicknameOnStart(){
  if(!playerNickname){
    setTimeout(()=>{
      document.getElementById('nick-modal').classList.remove('hidden');
      const inp=document.getElementById('nick-input');
      inp.focus();
      inp.onkeydown=e=>{if(e.key==='Enter')saveNickname();};
    },800);
  }
}
function saveNickname(){
  const inp=document.getElementById('nick-input');
  const val=(inp.value||'').trim().replace(/[<>"']/g,'').slice(0,16);
  if(!val||val.length<2){inp.style.borderColor='#ef4444';setTimeout(()=>inp.style.borderColor='rgba(74,222,128,.3)',1000);return;}
  playerNickname=val;save();
  document.getElementById('nick-modal').classList.add('hidden');
  showToast('üëã –ü—Ä–∏–≤–µ—Ç, '+playerNickname+'!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL LEADERBOARD (via Anthropic API as shared storage)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GLOBAL_LB_KEY='fc_global_lb_v2';
// We store leaderboard in localStorage under a shared key.
// For true multi-user sharing: all users share the same localStorage key via
// the artifact's persistent storage. When running as Telegram WebApp, we can
// additionally post scores to a shared namespace.
function getGlobalLB(){
  try{return JSON.parse(localStorage.getItem(GLOBAL_LB_KEY)||'[]');}catch(e){return[];}
}
function saveGlobalLB(lb){
  try{localStorage.setItem(GLOBAL_LB_KEY,JSON.stringify(lb));}catch(e){}
}
async function pushMyScore(){
  if(!playerNickname||bestScore<=0)return;
  const myId=String(tgUserId||('g_'+playerNickname.replace(/\s/g,'_').toLowerCase()));
  let glb=getGlobalLB();
  const existing=glb.find(e=>e.uid===myId);
  const entry={uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon,ts:Date.now()};
  if(existing){if(bestScore>existing.score)Object.assign(existing,entry);}
  else glb.push(entry);
  glb.sort((a,b)=>b.score-a.score);glb=glb.slice(0,100);
  saveGlobalLB(glb);
  // Try to fetch remote leaderboard from artifact storage
  try{
    const res=await window.storage?.get('fc_lb_v1',true);
    if(res&&res.value){
      let remote=JSON.parse(res.value);
      remote=remote.filter(e=>e.uid!==myId);
      remote.push(entry);
      remote.sort((a,b)=>b.score-a.score);
      remote=remote.slice(0,100);
      await window.storage?.set('fc_lb_v1',JSON.stringify(remote),true);
      saveGlobalLB(remote);
    } else {
      await window.storage?.set('fc_lb_v1',JSON.stringify(glb),true);
    }
  }catch(e){}
}
async function loadGlobalLB(){
  try{
    const res=await window.storage?.get('fc_lb_v1',true);
    if(res&&res.value){
      const remote=JSON.parse(res.value);
      // Merge with local
      const local=getGlobalLB();
      const merged=Object.values([...local,...remote].reduce((m,e)=>{
        if(!m[e.uid]||e.score>m[e.uid].score)m[e.uid]=e;return m;},{})
      );
      merged.sort((a,b)=>b.score-a.score);
      saveGlobalLB(merged.slice(0,100));
      return merged;
    }
  }catch(e){}
  return getGlobalLB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TELEGRAM STATS (–∞–Ω–æ–Ω–∏–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - —Ç–æ–ª—å–∫–æ Telegram ID)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tgUserId=null,tgUsername=null;
const ADMIN_IDS=[5557580974, 363001588, 5488225835];
function checkAdminMode(uid){
  if(!ADMIN_IDS.includes(uid))return;
  function _applyAdmin(){
    if(cucumbers<10000){cucumbers=10000;}
    if(goldCukes<10000){goldCukes=10000;}
    if(playerXP<10000){playerXP=10000;}
    try{save();}catch(e){}
    try{updateHUD();}catch(e){}
    // Append inside #wrap to avoid fixed-position coordinate issues in Telegram WebView
    if(!document.getElementById('admin-stat-btn')){
      const wrap=document.getElementById('wrap')||document.body;
      const statsEl=document.createElement('button');
      statsEl.id='admin-stat-btn';
      statsEl.style.cssText='position:absolute;bottom:80px;left:10px;z-index:999;font-size:12px;font-weight:900;font-family:Nunito,sans-serif;padding:8px 14px;width:auto;border:none;border-radius:12px;background:linear-gradient(145deg,#38bdf8,#0284c7);color:#fff;box-shadow:0 4px 0 #075985;cursor:pointer;touch-action:manipulation;pointer-events:all;';
      statsEl.textContent='üìä –°–¢–ê–¢';
      statsEl.addEventListener('click',showAdminStats);
      statsEl.addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();showAdminStats();});
      wrap.appendChild(statsEl);
    }
    // Admin mode disable button
    if(!document.getElementById('admin-disable-btn')){
      const wrap=document.getElementById('wrap')||document.body;
      const disBtn=document.createElement('button');
      disBtn.id='admin-disable-btn';
      disBtn.style.cssText='position:absolute;bottom:130px;left:10px;z-index:999;font-size:12px;font-weight:900;font-family:Nunito,sans-serif;padding:8px 14px;width:auto;border:none;border-radius:12px;background:linear-gradient(145deg,#f87171,#dc2626);color:#fff;box-shadow:0 4px 0 #7f1d1d;cursor:pointer;touch-action:manipulation;pointer-events:all;';
      disBtn.textContent='‚ùå –í–´–ô–¢–ò (ADMIN)';
      disBtn.addEventListener('click',disableAdminMode);
      disBtn.addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();disableAdminMode();});
      wrap.appendChild(disBtn);
    }
    showToast('üëë –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
  }
  setTimeout(_applyAdmin, 1000);
}
let _isAdminMode=false;
function disableAdminMode(){
  _isAdminMode=false;
  // Hide admin buttons but keep stats button (admins retain stats access)
  const disBtn=document.getElementById('admin-disable-btn');if(disBtn)disBtn.remove();
  showToast('‚úÖ –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–∫–ª—é—á—ë–Ω. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞.');
  // Note: stats button remains visible for admins even after disabling admin mode
}
function initTelegram(){
  if(window.Telegram?.WebApp){
    const tg=window.Telegram.WebApp;tg.ready();tg.expand();
    // After expand, the viewport changes - trigger resize to fix touch coordinate alignment
    setTimeout(()=>{if(typeof resizeCanvas==='function')resizeCanvas();},300);
    setTimeout(()=>{if(typeof resizeCanvas==='function')resizeCanvas();},800);
    const u=tg.initDataUnsafe?.user;
    if(u){
      tgUserId=u.id;
      tgUsername=u.username||u.first_name||('user_'+u.id);
      const statsKey='fc_stats';
      let stats=[];
      try{stats=JSON.parse(localStorage.getItem(statsKey)||'[]');}catch(e){}
      const now=Date.now();
      const existing=stats.find(s=>s.id===tgUserId);
      if(existing){
        existing.last=now;existing.sessions=(existing.sessions||1)+1;
        existing.name=tgUsername;existing.best=Math.max(existing.best||0,bestScore);
      } else {
        stats.push({id:tgUserId,name:tgUsername,first:now,last:now,sessions:1,best:bestScore});
      }
      if(stats.length>500)stats=stats.slice(-500);
      try{localStorage.setItem(statsKey,JSON.stringify(stats));}catch(e){}
      // Try push to shared storage
      try{if(window.storage){
        window.storage.get('fc_tg_users',true).then(res=>{
          let arr=[];try{arr=JSON.parse(res?.value||'[]');}catch(e){}
          const ex=arr.find(s=>s.id===tgUserId);
          if(ex){ex.last=now;ex.sessions=(ex.sessions||1)+1;ex.name=tgUsername;ex.best=Math.max(ex.best||0,bestScore);}
          else arr.push({id:tgUserId,name:tgUsername,first:now,last:now,sessions:1,best:bestScore});
          if(arr.length>500)arr=arr.slice(-500);
          window.storage.set('fc_tg_users',JSON.stringify(arr),true);
        }).catch(()=>{});
      }}catch(e){}
      checkAdminMode(tgUserId);
    }
  }
  let titleTaps=0;
  document.querySelector('.game-title')?.addEventListener('click',()=>{
    titleTaps++;
    if(titleTaps>=5){
      titleTaps=0;
      const id=parseInt(prompt('Admin ID:'));
      if(!isNaN(id)&&ADMIN_IDS.includes(id)){tgUserId=id;checkAdminMode(id);}
      else showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID');
    }
  });
}
function showAdminStats(){
  let stats=[];
  try{stats=JSON.parse(localStorage.getItem('fc_stats')||'[]');}catch(e){}
  const total=stats.length;
  const now=Date.now();
  const day=86400000;
  const today=stats.filter(s=>(now-s.last)<day).length;
  const week=stats.filter(s=>(now-s.last)<7*day).length;
  const avgSessions=(stats.reduce((a,s)=>a+(s.sessions||1),0)/(total||1)).toFixed(1);
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:10000;display:flex;align-items:center;justify-content:center;font-family:Nunito,sans-serif;';
  modal.innerHTML=`<div style="background:#0a1a0a;border:2px solid #4ade80;border-radius:16px;padding:24px;max-width:320px;width:90%;color:#4ade80;text-align:center;">
    <div style="font-size:10px;margin-bottom:16px;">üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
    <div style="font-size:7px;line-height:2.5;color:#e2e8f0;">
      üë• –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: <span style="color:#4ade80">${total}</span><br>
      üìÖ –°–µ–≥–æ–¥–Ω—è –∞–∫—Ç–∏–≤–Ω—ã—Ö: <span style="color:#fbbf24">${today}</span><br>
      üìÜ –ó–∞ –Ω–µ–¥–µ–ª—é: <span style="color:#38bdf8">${week}</span><br>
      üîÑ –°—Ä. —Å–µ—Å—Å–∏–π/–∏–≥—Ä–æ–∫: <span style="color:#a78bfa">${avgSessions}</span><br>
      üóì –ü–µ—Ä–≤—ã–π –∏–≥—Ä–æ–∫: <span style="color:#94a3b8;font-size:5px">${stats.length?new Date(Math.min(...stats.map(s=>s.first))).toLocaleDateString('ru'):'-'}</span>
    </div>
    <div style="font-size:5px;color:#475569;margin-top:12px;line-height:1.8;">–•—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–Ω–æ–Ω–∏–º–Ω—ã–µ ID.<br>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è.</div>
    <button onclick="this.parentElement.parentElement.remove()" style="margin-top:14px;background:#22c55e;color:#fff;border:none;padding:8px 20px;font-family:Nunito,sans-serif;font-size:6px;border-radius:8px;cursor:pointer;">–ó–ê–ö–†–´–¢–¨</button>
  </div>`;
  document.body.appendChild(modal);
}
// initTelegram() is called inside init() after load() so admin gets correct data

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getRank(){for(let i=RANKS.length-1;i>=0;i--)if(playerXP>=RANKS[i].xpRequired)return RANKS[i];return RANKS[0];}
function getLevelProgress(){
  let xp=playerXP,lv=0;
  for(let i=0;i<XP_PER_LEVEL.length;i++){if(xp<XP_PER_LEVEL[i]){lv=i;break;}xp-=XP_PER_LEVEL[i];lv=i+1;}
  const need=XP_PER_LEVEL[Math.min(lv,XP_PER_LEVEL.length-1)]||9999;
  return{level:lv,progress:xp,need};
}
function addXP(amt){
  const before=getLevelProgress().level;
  playerXP+=amt;
  const after=getLevelProgress().level;
  playerLevel=after;
  if(after>before){const rw=after*25;cucumbers+=rw;showToast(`üéâ –£—Ä–æ–≤–µ–Ω—å ${after+1}! +${rw}ü•í`);}
  save();updateHUD();
}
function getUpgradeEffect(id){
  const u=UPGRADES.find(u=>u.id===id);if(!u)return 0;
  return upgradelevels[id]||0;
}
function getUpgradeCost(id){
  const u=UPGRADES.find(u=>u.id===id);if(!u)return 999999;
  const lv=upgradelevels[id]||0;
  return Math.floor(u.baseCost*Math.pow(u.costMult,lv));
}
function lighten(hex,a){const n=parseInt(hex.replace('#',''),16);return`rgb(${Math.min(255,(n>>16)+Math.floor(255*a))},${Math.min(255,((n>>8)&255)+Math.floor(255*a))},${Math.min(255,(n&255)+Math.floor(255*a))})`;}
function darken(hex,a){const n=parseInt(hex.replace('#',''),16);return`rgb(${Math.max(0,(n>>16)-Math.floor(255*a))},${Math.max(0,((n>>8)&255)-Math.floor(255*a))},${Math.max(0,(n&255)-Math.floor(255*a))})`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SKINS / WORLDS / TRAILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SKINS=[
  {id:'default',name:'–û–ì–£–†–ï–¶',    price:0,    priceGold:0,  color:'#4ade80',accent:'#16a34a',eyes:'#1a1a1a',special:null,       desc:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –æ–≥—É—Ä–µ—Ü'},
  {id:'fire',   name:'–û–ì–û–ù–¨',     price:120,  priceGold:0,  color:'#ff5500',accent:'#991b1b',eyes:'#fff8e0',special:'fire',      desc:'–ü—ã–ª–∞–µ—Ç –æ–≥–Ω—ë–º!'},
  {id:'cool',   name:'–ö–†–£–¢–û–ô',    price:200,  priceGold:0,  color:'#38bdf8',accent:'#0369a1',eyes:'#fff',   special:'glasses',   desc:'–í—Å–µ–≥–¥–∞ –≤ –æ—á–∫–∞—Ö'},
  {id:'alien',  name:'–ü–†–ò–®–ï–õ–ï–¶',  price:350,  priceGold:0,  color:'#818cf8',accent:'#4338ca',eyes:'#00ff88',special:'alien',     desc:'–° –¥—Ä—É–≥–æ–π –ø–ª–∞–Ω–µ—Ç—ã'},
  {id:'king',   name:'–¶–ê–†–¨',      price:500,  priceGold:0,  color:'#fbbf24',accent:'#b45309',eyes:'#1a1a1a',special:'crown',     desc:'–ù–æ—Å–∏—Ç –∫–æ—Ä–æ–Ω—É'},
  {id:'ghost',  name:'–ü–†–ò–ó–†–ê–ö',   price:700,  priceGold:0,  color:'#f0fdfa',accent:'#99f6e4',eyes:'#0f766e',special:'ghost',     desc:'–ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π'},
  {id:'ninja',  name:'–ù–ò–ù–î–ó–Ø',    price:1000, priceGold:0,  color:'#1e293b',accent:'#0f172a',eyes:'#ef4444',special:'ninja',     desc:'–ú–∞—Å—Ç–µ—Ä —Ç–µ–Ω–µ–π'},
  {id:'secret', name:'DIVINE',    price:0,    priceGold:0,  color:'#FFD700',accent:'#fbbf24',eyes:'#fff',   special:'divine',    secret:true, desc:'–ù–∞–±–µ–π 50 –±–∞—à–µ–Ω'},
  {id:'cyber',  name:'–ö–ò–ë–ï–†',     price:0,    priceGold:50, color:'#00ffff',accent:'#0088ff',eyes:'#ff00ff',special:'cyber',     goldOnly:true,desc:'–ò–∑ –±—É–¥—É—â–µ–≥–æ'},
  {id:'zombie', name:'–ó–û–ú–ë–ò',     price:0,    priceGold:30, color:'#86efac',accent:'#166534',eyes:'#dc2626',special:'zombie',    goldOnly:true,desc:'–í–æ—Å—Å—Ç–∞–ª –∏–∑ –º—ë—Ä—Ç–≤—ã—Ö'},
  {id:'robot',  name:'–†–û–ë–û–¢',     price:0,    priceGold:40, color:'#94a3b8',accent:'#334155',eyes:'#38bdf8',special:'robot',     goldOnly:true,desc:'–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π'},
  {id:'dragon', name:'–î–†–ê–ö–û–ù',    price:0,    priceGold:80, color:'#15803d',accent:'#052e16',eyes:'#fbbf24',special:'dragon',    goldOnly:true,desc:'–û–≥–Ω–µ–¥—ã—à–∞—â–∏–π'},
];
const WORLDS=[
  {id:'forest', name:'–õ–ï–°',        price:0,    priceGold:0,  bg:['#061810','#0a2918','#061810'],ground:'#14532d',groundTop:'#4ade80',pipe:['#14532d','#4ade80','#22c55e','#052e16'],pipeCap:'#4ade80',star:'rgba(200,255,220,{a})'},
  {id:'candy',  name:'–ö–û–ù–§–ï–¢–´',    price:300,  priceGold:0,  bg:['#1a0628','#2d0a3a','#1a0628'],ground:'#7c3aed',groundTop:'#a78bfa',pipe:['#5b21b6','#c4b5fd','#a78bfa','#4c1d95'],pipeCap:'#c4b5fd',star:'rgba(220,200,255,{a})'},
  {id:'lava',   name:'–õ–ê–í–ê',       price:500,  priceGold:0,  bg:['#1c0a00','#2d1200','#1c0a00'],ground:'#7f1d1d',groundTop:'#ef4444',pipe:['#7f1d1d','#f97316','#ef4444','#450a0a'],pipeCap:'#f97316',star:'rgba(255,200,100,{a})'},
  {id:'ocean',  name:'–û–ö–ï–ê–ù',      price:700,  priceGold:0,  bg:['#022c50','#064e7a','#022c50'],ground:'#0c4a6e',groundTop:'#38bdf8',pipe:['#075985','#38bdf8','#0ea5e9','#023455'],pipeCap:'#38bdf8',star:'rgba(180,230,255,{a})'},
  {id:'space',  name:'–ö–û–°–ú–û–°',     price:1000, priceGold:0,  bg:['#000010','#05051a','#000010'],ground:'#0f172a',groundTop:'#a78bfa',pipe:['#1e1b4b','#818cf8','#6366f1','#0f0e2e'],pipeCap:'#818cf8',star:'rgba(200,200,255,{a})'},
  {id:'cyber_w',name:'–ö–ò–ë–ï–†–ü–ê–ù–ö',  price:0,    priceGold:30, bg:['#0a0014','#140028','#0a0014'],ground:'#1a0040',groundTop:'#ff00ff',pipe:['#300060','#ff00ff','#00ffff','#1a0040'],pipeCap:'#ff00ff',star:'rgba(255,0,255,{a})',goldOnly:true},
  {id:'galaxy', name:'–ì–ê–õ–ê–ö–¢–ò–ö–ê',  price:0,    priceGold:55, bg:['#000008','#06001a','#000008'],ground:'#100030',groundTop:'#a5b4fc',pipe:['#1e1b6b','#a5b4fc','#818cf8','#080028'],pipeCap:'#c7d2fe',star:'rgba(180,180,255,{a})',goldOnly:true},
  {id:'crystal',name:'–ö–†–ò–°–¢–ê–õ–¨–ù–´–ô',price:0,    priceGold:80, bg:['#001820','#002a3a','#001820'],ground:'#093050',groundTop:'#67e8f9',pipe:['#0e4070','#67e8f9','#22d3ee','#062030'],pipeCap:'#a5f3fc',star:'rgba(180,240,255,{a})',goldOnly:true},
];
const TRAILS=[
  {id:'none',      name:'–ù–ï–¢',        price:0,   priceGold:0,  color:null,   desc:'–ß–∏—Å—Ç—ã–π –ø–æ–ª—ë—Ç'},
  {id:'rainbow',   name:'–†–ê–î–£–ì–ê',     price:80,  priceGold:0,  color:['#ef4444','#f97316','#fbbf24','#4ade80','#38bdf8','#a78bfa'],desc:'–†–∞–¥—É–∂–Ω—ã–π —Å–ª–µ–¥'},
  {id:'fire',      name:'–ü–õ–ê–ú–Ø',      price:150, priceGold:0,  color:['#ef4444','#f97316','#fbbf24','#fef3c7'],desc:'–û–≥–Ω–µ–Ω–Ω—ã–π —Å–ª–µ–¥'},
  {id:'bubbles',   name:'–ü–£–ó–´–†–ò',     price:120, priceGold:0,  color:['#bfdbfe','#93c5fd','#60a5fa','#dbeafe'],desc:'–ü—É–∑—ã—Ä—å–∫–æ–≤—ã–π —Å–ª–µ–¥'},
  {id:'stars',     name:'–ó–í–Å–ó–î–´',     price:200, priceGold:0,  color:['#fef3c7','#fde68a','#fbbf24','#fff'],desc:'–ó–≤—ë–∑–¥–Ω—ã–π —Å–ª–µ–¥'},
  {id:'ghost',     name:'–ü–†–ò–ó–†–ê–ö',    price:180, priceGold:0,  color:['#e2e8f0','#cbd5e1','#94a3b8','#f8fafc'],desc:'–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π —Å–ª–µ–¥'},
  {id:'candy',     name:'–ö–û–ù–§–ï–¢–¢–ò',   price:220, priceGold:0,  color:['#f472b6','#a78bfa','#38bdf8','#4ade80','#fbbf24'],desc:'–¶–≤–µ—Ç–Ω–æ–π —Å–ª–µ–¥'},
  {id:'lightning', name:'–ú–û–õ–ù–ò–Ø',     price:0,   priceGold:20, color:['#fbbf24','#fff','#fde68a','#fef3c7'],goldOnly:true,desc:'–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π —Å–ª–µ–¥'},
  {id:'plasma',    name:'–ü–õ–ê–ó–ú–ê',     price:0,   priceGold:35, color:['#c084fc','#818cf8','#38bdf8','#a78bfa','#fff'],goldOnly:true,desc:'–ü–ª–∞–∑–º–µ–Ω–Ω—ã–π –≤–∏—Ö—Ä—å'},
  {id:'diamond',   name:'–ê–õ–ú–ê–ó',      price:0,   priceGold:50, color:['#e0f2fe','#bae6fd','#fff','#38bdf8','#f0fdff'],goldOnly:true,desc:'–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π —Å–ª–µ–¥'},
];

// ‚îÄ‚îÄ‚îÄ PETS ‚îÄ‚îÄ‚îÄ
const PETS=[
  {id:'none',   name:'–ù–ï–¢',         priceGold:0,   emoji:'',    desc:'–ë–µ–∑ –ø–∏—Ç–æ–º—Ü–∞',color:'#475569'},
  {id:'bug',    name:'–ñ–£–ß–û–ö',       priceGold:10,  emoji:'üêõ',  desc:'–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –º–æ–Ω–µ—Ç—ã', color:'#22c55e'},
  {id:'frog',   name:'–õ–Ø–ì–£–®–ö–ê',     priceGold:20,  emoji:'üê∏',  desc:'+10% –∫ –æ—á–∫–∞–º',       color:'#4ade80'},
  {id:'dragon2',name:'–î–†–ê–ö–û–ù–ß–ò–ö',   priceGold:40,  emoji:'üêâ',  desc:'–ò–Ω–æ–≥–¥–∞ —Å—Ç—Ä–µ–ª—è–µ—Ç',    color:'#ef4444'},
  {id:'star_p', name:'–ó–í–Å–ó–î–û–ß–ö–ê',   priceGold:30,  emoji:'‚≠ê',  desc:'–û—Å—Ç–∞–≤–ª—è–µ—Ç –∑–≤—ë–∑–¥–Ω—ã–π —Å–ª–µ–¥',color:'#fbbf24'},
  {id:'alien_p',name:'–ò–ù–û–ü–õ–ê–ù–ï–¢–ï–¶', priceGold:45,  emoji:'üëΩ',  desc:'–¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–æ–Ω–µ—Ç—ã',color:'#818cf8'},
  {id:'ghost_p',name:'–ü–†–ò–ó–†–ê–ö',     priceGold:35,  emoji:'üëª',  desc:'–ü—É–≥–∞–µ—Ç —Ç—Ä—É–±—ã',        color:'#e2e8f0'},
  {id:'angel',  name:'–ê–ù–ì–ï–õ–û–ß–ï–ö',   priceGold:80,  emoji:'üòá',  desc:'–ê–≤—Ç–æ—â–∏—Ç —Ä–∞–∑ –≤ 10 –±–∞—à–µ–Ω',color:'#fde68a'},
  {id:'phoenix',name:'–§–ï–ù–ò–ö–°',      priceGold:120, emoji:'ü¶Ö',  desc:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü!',color:'#f97316'},
];
let selectedPet=def('pet','none');
let ownedPets=def('ownedPets',['none']);
function getSkin(){return SKINS.find(s=>s.id===selectedSkin)||SKINS[0];}
function getWorld(){return WORLDS.find(w=>w.id===selectedWorld)||WORLDS[0];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW CUCUMBER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawCucumber(c,x,y,size,skinId,angle=0,frame=0){
  const skin=SKINS.find(s=>s.id===skinId)||SKINS[0];
  c.save();c.translate(x,y);c.rotate(angle);
  const rX=size*.18,rY=size*.46,tipR=rX*.6;
  function cucPath(){c.beginPath();c.moveTo(0,-rY);c.bezierCurveTo(rX*1.1,-rY*.85,rX*1.2,-rY*.3,rX*1.15,0);c.bezierCurveTo(rX*1.2,rY*.3,rX*1.1,rY*.8,0,rY);c.bezierCurveTo(-rX*1.1,rY*.8,-rX*1.2,rY*.3,-rX*1.15,0);c.bezierCurveTo(-rX*1.2,-rY*.3,-rX*1.1,-rY*.85,0,-rY);c.closePath();}
  const bg=c.createLinearGradient(-rX*1.2,-rY,rX*1.2,rY);
  if(skin.special==='divine'){bg.addColorStop(0,'#fffde0');bg.addColorStop(.25,'#FFD700');bg.addColorStop(.6,'#fbbf24');bg.addColorStop(1,'#92400e');}
  else if(skin.special==='ghost'){bg.addColorStop(0,'#ffffff');bg.addColorStop(.5,'#e2e8f0');bg.addColorStop(1,'#94a3b8');}
  else if(skin.special==='fire'){bg.addColorStop(0,'#fef9c3');bg.addColorStop(.3,'#fbbf24');bg.addColorStop(.65,'#ef4444');bg.addColorStop(1,'#7f1d1d');}
  else if(skin.special==='cyber'){bg.addColorStop(0,'#00ffff');bg.addColorStop(.4,'#0088ff');bg.addColorStop(.8,'#0000aa');bg.addColorStop(1,'#1a0050');}
  else if(skin.special==='alien'){bg.addColorStop(0,'#c4b5fd');bg.addColorStop(.4,'#8b5cf6');bg.addColorStop(1,'#4c1d95');}
  else if(skin.special==='ninja'){bg.addColorStop(0,'#334155');bg.addColorStop(.5,'#1e293b');bg.addColorStop(1,'#0f172a');}
  else if(skin.special==='crown'){bg.addColorStop(0,'#fde68a');bg.addColorStop(.4,'#fbbf24');bg.addColorStop(1,'#d97706');}
  else if(skin.special==='glasses'){bg.addColorStop(0,'#bfdbfe');bg.addColorStop(.4,'#60a5fa');bg.addColorStop(1,'#2563eb');}
  else{bg.addColorStop(0,lighten(skin.color,.35));bg.addColorStop(.45,skin.color);bg.addColorStop(1,skin.accent);}
  c.shadowColor=skin.special==='cyber'?'#00ffff':skin.special==='fire'?'#f97316':skin.special==='divine'?'#FFD700':'rgba(0,0,0,.4)';
  c.shadowBlur=(skin.special==='cyber'||skin.special==='divine'||skin.special==='fire')?12:5;
  c.shadowOffsetY=(skin.special==='cyber'||skin.special==='divine')?0:2;
  cucPath();c.fillStyle=bg;c.fill();c.shadowBlur=0;c.shadowOffsetY=0;
  cucPath();c.strokeStyle='rgba(0,0,0,.25)';c.lineWidth=1.5;c.stroke();
  // Textures
  if(skin.special===null||skin.special==='glasses'){
    c.save();cucPath();c.clip();
    c.strokeStyle=skin.accent+'88';c.lineWidth=1.1;
    for(let i=-2;i<=2;i++){c.beginPath();c.moveTo(i*rX*.42,-rY*.85);c.lineTo(i*rX*.42,rY*.85);c.stroke();}
    c.fillStyle='rgba(0,0,0,.07)';
    for(let row=-3;row<=3;row++){for(let col=-1;col<=1;col++){c.beginPath();c.arc(col*rX*.6,row*rY*.28,rX*.12,0,Math.PI*2);c.fill();}}
    c.restore();
  }
  if(skin.special==='cyber'){
    c.save();cucPath();c.clip();c.strokeStyle='rgba(0,255,255,.45)';c.lineWidth=1;
    for(let i=-3;i<=3;i++){c.beginPath();c.moveTo(i*rX*.35,-rY);c.lineTo(i*rX*.35,rY);c.stroke();}
    c.beginPath();c.moveTo(-rX,0);c.lineTo(rX,0);c.stroke();
    c.restore();
    c.shadowColor='#00ffff';c.shadowBlur=14;c.strokeStyle='rgba(0,255,255,.6)';c.lineWidth=1.5;cucPath();c.stroke();c.shadowBlur=0;
  }
  if(skin.special==='fire'){c.save();cucPath();c.clip();c.strokeStyle='rgba(255,150,0,.5)';c.lineWidth=1;for(let i=-1;i<=1;i++){c.beginPath();c.moveTo(i*rX*.6,-rY*.7);c.lineTo(i*rX*.4,-rY*.2);c.lineTo(i*rX*.7,rY*.2);c.stroke();}c.restore();}
  if(skin.special==='alien'){c.save();cucPath();c.clip();c.fillStyle='rgba(0,255,136,.12)';for(let i=0;i<5;i++){c.beginPath();c.arc(Math.sin(i*1.7)*rX*.7,Math.cos(i*1.3)*rY*.5,rX*.22,0,Math.PI*2);c.fill();}c.restore();}
  if(skin.special==='ninja'){c.save();cucPath();c.clip();c.strokeStyle='rgba(239,68,68,.2)';c.lineWidth=1.8;for(let i=-4;i<=4;i++){c.beginPath();c.moveTo(i*rX*.5-rX,-rY);c.lineTo(i*rX*.5+rX,rY);c.stroke();}c.restore();}
  if(skin.special==='divine'){c.save();cucPath();c.clip();c.fillStyle='rgba(255,255,255,.18)';for(let i=0;i<6;i++){c.beginPath();c.arc(Math.sin(i*2.1)*rX*.7,Math.cos(i*1.8)*rY*.5,rX*.1,0,Math.PI*2);c.fill();}c.restore();}
  if(skin.special==='crown'){c.save();cucPath();c.clip();c.fillStyle='rgba(255,255,255,.13)';for(let i=-2;i<=2;i++){c.beginPath();c.arc(i*rX*.5,0,rX*.15,0,Math.PI*2);c.fill();}c.restore();}
  // Bumps
  if(skin.special!=='ghost'&&skin.special!=='divine'){c.fillStyle='rgba(0,0,0,.1)';[[-rX*.9,-rY*.42],[rX*.9,-rY*.18],[rX*.85,rY*.18],[-rX*.88,rY*.38]].forEach(([bx,by])=>{c.beginPath();c.arc(bx,by,rX*.2,0,Math.PI*2);c.fill();});}
  // Tips
  c.fillStyle=skin.special==='divine'?'#d97706':darken(skin.accent,.25);
  c.beginPath();c.ellipse(0,-rY,tipR,tipR*.65,0,0,Math.PI*2);c.fill();
  c.beginPath();c.ellipse(0,rY,tipR*.75,tipR*.55,0,0,Math.PI*2);c.fill();
  // Eyes
  const eyeY=-rY*.35,eyeX=rX*.65;
  if(skin.special!=='alien'&&skin.special!=='ninja'){
    c.fillStyle='#fff';c.shadowColor='rgba(0,0,0,.3)';c.shadowBlur=2;
    c.beginPath();c.arc(-eyeX,eyeY,size*.057,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(eyeX,eyeY,size*.057,0,Math.PI*2);c.fill();c.shadowBlur=0;
  }
  c.fillStyle=skin.special==='cyber'?'#ff00ff':skin.eyes;
  c.beginPath();c.arc(-eyeX+.8,eyeY+.8,size*.032,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(eyeX+.8,eyeY+.8,size*.032,0,Math.PI*2);c.fill();
  if(skin.special!=='alien'&&skin.special!=='ninja'){c.fillStyle='rgba(255,255,255,.85)';c.beginPath();c.arc(-eyeX-.5,eyeY-.5,size*.012,0,Math.PI*2);c.fill();c.beginPath();c.arc(eyeX-.5,eyeY-.5,size*.012,0,Math.PI*2);c.fill();}
  if(skin.special==='alien'){c.fillStyle='rgba(0,0,0,.7)';c.shadowColor='#00ff88';c.shadowBlur=8;c.beginPath();c.ellipse(-eyeX,eyeY,size*.1,size*.065,.2,0,Math.PI*2);c.fill();c.beginPath();c.ellipse(eyeX,eyeY,size*.1,size*.065,-.2,0,Math.PI*2);c.fill();c.fillStyle='#00ff88';c.beginPath();c.arc(-eyeX+1,eyeY+1,size*.036,0,Math.PI*2);c.fill();c.beginPath();c.arc(eyeX+1,eyeY+1,size*.036,0,Math.PI*2);c.fill();c.shadowBlur=0;}
  // Smile
  c.strokeStyle='rgba(0,0,0,.45)';c.lineWidth=1.4;c.lineCap='round';c.beginPath();c.arc(0,eyeY+size*.09,size*.07,.2,Math.PI-.2);c.stroke();
  // Glasses
  if(skin.special==='glasses'){
    c.fillStyle='rgba(0,0,0,.8)';c.shadowColor='#1e40af';c.shadowBlur=4;
    c.beginPath();c.roundRect(-eyeX-size*.1,eyeY-size*.058,size*.2,size*.12,4);c.fill();
    c.beginPath();c.roundRect(eyeX-size*.1,eyeY-size*.058,size*.2,size*.12,4);c.fill();
    c.strokeStyle='#60a5fa';c.lineWidth=1.5;c.beginPath();c.moveTo(-eyeX+size*.1,eyeY);c.lineTo(eyeX-size*.1,eyeY);c.stroke();
    c.fillStyle='rgba(255,255,255,.35)';c.beginPath();c.roundRect(-eyeX-size*.05,eyeY-size*.05,size*.08,size*.055,2);c.fill();c.beginPath();c.roundRect(eyeX-size*.05,eyeY-size*.05,size*.08,size*.055,2);c.fill();c.shadowBlur=0;
  }
  // Crown
  if(skin.special==='crown'||skin.special==='divine'){
    const cy=-rY-size*.02,cw=rX*1.45,crownCol=skin.special==='divine'?'#fff':'#FFD700';
    c.fillStyle=crownCol;c.shadowColor=crownCol;c.shadowBlur=10;
    c.beginPath();c.moveTo(-cw,cy);c.lineTo(-cw,cy-size*.15);c.lineTo(-cw*.5,cy-size*.07);c.lineTo(0,cy-size*.19);c.lineTo(cw*.5,cy-size*.07);c.lineTo(cw,cy-size*.15);c.lineTo(cw,cy);c.closePath();c.fill();c.shadowBlur=0;
    const gems=skin.special==='divine'?['#ff6b9d','#00ffff','#ff6b00']:['#ef4444','#22c55e','#38bdf8'];
    gems.forEach((g,i)=>{c.fillStyle=g;c.beginPath();c.arc(-cw*.5+i*cw*.5,cy-size*.06,rX*.22,0,Math.PI*2);c.fill();});
  }
  // Ninja mask + headband
  if(skin.special==='ninja'){
    c.save();cucPath();c.clip();c.fillStyle='#1e293b';c.fillRect(-rX*1.3,eyeY-size*.06,rX*2.6,size*.1);c.restore();
    c.fillStyle='#ef4444';c.shadowColor='#ef4444';c.shadowBlur=5;
    c.beginPath();c.rect(-eyeX-size*.055,eyeY-size*.025,size*.11,size*.04);c.fill();
    c.beginPath();c.rect(eyeX-size*.055,eyeY-size*.025,size*.11,size*.04);c.fill();
    c.fillStyle='#ef4444';c.shadowBlur=0;c.beginPath();c.rect(-rX*1.2,-rY*.85,rX*2.4,size*.065);c.fill();
    c.fillStyle='#fff';c.font=`bold ${Math.floor(rX*.7)}px Nunito`;c.textAlign='center';c.textBaseline='middle';c.fillText('‚òØ',0,-rY*.82+size*.03);
  }
  // Ghost wavy bottom
  if(skin.special==='ghost'){c.fillStyle='rgba(248,250,252,.7)';c.beginPath();c.moveTo(-rX*1.1,rY-4);for(let i=0;i<=4;i++){const cx2=-rX*1.1+(rX*2.2/4)*i,wav=Math.sin(frame*.08+i)*3;if(i%2===0)c.quadraticCurveTo(cx2+rX*.3,rY+9+wav,cx2+rX*.55,rY-2);else c.quadraticCurveTo(cx2+rX*.3,rY+3,cx2+rX*.55,rY-2);}c.closePath();c.fill();}
  // Divine halo
  if(skin.special==='divine'){const haloY=-rY-size*.28;c.strokeStyle='rgba(255,255,200,.95)';c.lineWidth=2.5;c.shadowColor='#fff';c.shadowBlur=14;c.beginPath();c.ellipse(0,haloY,rX*1.15,size*.058,0,0,Math.PI*2);c.stroke();c.shadowBlur=0;}
  // Fire flames
  if(skin.special==='fire'){const ft=frame*.12;for(let i=-1;i<=1;i++){const fx=i*rX*.5,fh=size*(.22+Math.sin(ft+i)*.08);const fg=c.createLinearGradient(fx,rY,fx,rY+fh*2.5);fg.addColorStop(0,'#ef4444');fg.addColorStop(.4,'#fbbf24');fg.addColorStop(1,'transparent');c.fillStyle=fg;c.beginPath();c.moveTo(fx-rX*.15,rY);c.quadraticCurveTo(fx+Math.sin(ft+i)*rX*.2,rY+fh,fx+rX*.08,rY+fh*2.5);c.quadraticCurveTo(fx-Math.sin(ft+i)*rX*.2,rY+fh,fx+rX*.15,rY);c.fill();}}
  if(skin.special==='zombie'){
    // Stitches across body
    c.save();cucPath();c.clip();
    c.strokeStyle='#166534';c.lineWidth=1.4;
    for(let i=-1;i<=1;i++){c.beginPath();c.moveTo(i*rX*.6,-rY*.3+i*rY*.2);c.lineTo(i*rX*.6+rX*.3,rY*.1+i*rY*.1);c.stroke();}
    // X marks (stitches)
    c.lineWidth=1;c.strokeStyle='#15803d';
    [[0,-rY*.4],[rX*.4,rY*.2],[-rX*.5,rY*.1]].forEach(([sx,sy])=>{
      c.beginPath();c.moveTo(sx-3,sy-3);c.lineTo(sx+3,sy+3);c.moveTo(sx+3,sy-3);c.lineTo(sx-3,sy+3);c.stroke();});
    c.restore();
    // Red zombie eyes
    c.fillStyle='#dc2626';c.shadowColor='#dc2626';c.shadowBlur=8;
    c.beginPath();c.arc(-eyeX,eyeY,size*.045,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(eyeX,eyeY,size*.045,0,Math.PI*2);c.fill();
    c.shadowBlur=0;
  }
  if(skin.special==='robot'){
    // Metal panel lines
    c.save();cucPath();c.clip();
    c.strokeStyle='rgba(148,163,184,.6)';c.lineWidth=1.2;
    c.beginPath();c.moveTo(-rX,0);c.lineTo(rX,0);c.stroke();
    c.beginPath();c.moveTo(-rX*1.1,-rY*.3);c.lineTo(rX*1.1,-rY*.3);c.stroke();
    c.beginPath();c.moveTo(-rX*1.1,rY*.3);c.lineTo(rX*1.1,rY*.3);c.stroke();
    c.restore();
    // Visor / eyes - rectangular
    c.fillStyle='#0ea5e9';c.shadowColor='#38bdf8';c.shadowBlur=10;
    c.beginPath();c.roundRect(-eyeX-size*.06,eyeY-size*.032,size*.12,size*.064,2);c.fill();
    c.beginPath();c.roundRect(eyeX-size*.06,eyeY-size*.032,size*.12,size*.064,2);c.fill();
    c.shadowBlur=0;
    // Antenna
    c.strokeStyle='#94a3b8';c.lineWidth=1.5;
    c.beginPath();c.moveTo(0,-rY);c.lineTo(0,-rY-size*.18);c.stroke();
    c.fillStyle='#38bdf8';c.shadowColor='#38bdf8';c.shadowBlur=6;
    c.beginPath();c.arc(0,-rY-size*.18,size*.03,0,Math.PI*2);c.fill();c.shadowBlur=0;
  }
  if(skin.special==='dragon'){
    // Dragon scales pattern
    c.save();cucPath();c.clip();
    c.fillStyle='rgba(5,46,22,.4)';
    for(let row=-3;row<=3;row++){for(let col=-1;col<=1;col++){
      const sx=col*rX*.55+(row%2)*rX*.28,sy=row*rY*.3;
      c.beginPath();c.ellipse(sx,sy,rX*.28,rY*.14,0,0,Math.PI*2);c.fill();
    }}
    c.restore();
    // Glowing gold eyes
    c.fillStyle='#fbbf24';c.shadowColor='#fbbf24';c.shadowBlur=12;
    c.beginPath();c.ellipse(-eyeX,eyeY,size*.065,size*.04,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(eyeX,eyeY,size*.065,size*.04,0,0,Math.PI*2);c.fill();
    c.fillStyle='#000';c.shadowBlur=0;
    c.beginPath();c.arc(-eyeX,eyeY+1,size*.025,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(eyeX,eyeY+1,size*.025,0,Math.PI*2);c.fill();
    // Horns
    c.fillStyle='#fbbf24';c.shadowColor='#fbbf24';c.shadowBlur=6;
    c.beginPath();c.moveTo(-rX*.5,-rY*.7);c.lineTo(-rX*.35,-rY-size*.2);c.lineTo(-rX*.2,-rY*.7);c.closePath();c.fill();
    c.beginPath();c.moveTo(rX*.2,-rY*.7);c.lineTo(rX*.35,-rY-size*.2);c.lineTo(rX*.5,-rY*.7);c.closePath();c.fill();
    c.shadowBlur=0;
    // Dragon fire breath (animated)
    if(frame%40<20){const ft=frame*.15;
      const fg=c.createLinearGradient(0,rY,0,rY+size*.5);fg.addColorStop(0,'rgba(239,68,68,.9)');fg.addColorStop(.5,'rgba(251,146,60,.6)');fg.addColorStop(1,'transparent');
      c.fillStyle=fg;c.beginPath();c.ellipse(Math.sin(ft)*rX*.3,rY+size*.25,rX*.5+Math.sin(ft)*.05,size*.25,Math.sin(ft)*.2,0,Math.PI*2);c.fill();}
  }
  c.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HERO + AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let heroFrame=0;
function animateHero(){
  const hc=document.getElementById('hero-canvas');if(!hc)return;
  hc.width=56;hc.height=88;
  const hctx=hc.getContext('2d');hctx.clearRect(0,0,56,88);
  drawCucumber(hctx,28,44,82,selectedSkin,0,heroFrame++);
  // Draw pet on start screen next to hero
  const petWrap=document.getElementById('hero-pet-display');
  if(petWrap&&selectedPet&&selectedPet!=='none'){
    const pet=PETS.find(p=>p.id===selectedPet);
    if(pet&&pet.emoji){
      petWrap.textContent=pet.emoji;
      petWrap.style.display='inline-block';
      const hop=Math.sin(heroFrame*0.15)*4;
      petWrap.style.transform=`translateY(${hop}px)`;
    }
  } else if(petWrap){petWrap.style.display='none';}
  requestAnimationFrame(animateHero);
}
let audioCtx=null,musicOn=false,musicGain=null;
function initAudio(){if(audioCtx)return;audioCtx=new(window.AudioContext||window.webkitAudioContext)();musicGain=audioCtx.createGain();musicGain.gain.value=.12;musicGain.connect(audioCtx.destination);}
function tone(f,t,d,v=.25,t0=0){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,audioCtx.currentTime+t0);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+t0+d);o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime+t0);o.stop(audioCtx.currentTime+t0+d);}
function playJump(){tone(280,'sine',.07,.22);tone(480,'sine',.1,.18,.04);}
function playScore(){/* no pipe sound */}
function playDeath(){tone(400,'sawtooth',.08,.3);tone(200,'sawtooth',.2,.2,.1);}
function playBoost(){tone(800,'sine',.08,.2);tone(1400,'sine',.1,.15,.08);}
function playShoot(){tone(600,'square',.04,.15);tone(900,'square',.04,.1,.04);}
function playCoinChime(){tone(880,'sine',.05,.14);tone(1320,'sine',.07,.1,.04);tone(1760,'sine',.06,.08,.09);}
function playCombo(){tone(700,'square',.05,.15);tone(1100,'square',.06,.12,.05);tone(1600,'square',.08,.1,.1);}
function playPortal(){tone(300,'sine',.4,.2);tone(600,'sine',.4,.15,.1);tone(900,'sine',.3,.1,.2);}

// ‚îÄ‚îÄ‚îÄ Per-mode unique music ‚îÄ‚îÄ‚îÄ
const MELODIES={
  easy:   {notes:[[523,.3],[659,.3],[784,.3],[880,.6],[784,.3],[659,.3],[523,.6],[440,.3],[494,.3],[523,.9]],type:'triangle',vol:.055,tempo:1},
  normal: {notes:[[523,.2],[659,.2],[784,.2],[659,.2],[523,.4],[440,.4],[523,.2],[659,.2],[698,.4]],type:'square',vol:.08,tempo:1},
  hard:   {notes:[[220,.15],[330,.12],[440,.1],[330,.1],[220,.18],[196,.15],[220,.15],[440,.1],[330,.15],[220,.28]],type:'sawtooth',vol:.07,tempo:1.3},
  insane: {notes:[[110,.09],[165,.08],[220,.07],[165,.08],[110,.11],[98,.09],[110,.09],[82,.13]],type:'sawtooth',vol:.09,tempo:1.6},
  crazy:  {notes:[[440,.12],[660,.1],[880,.08],[1100,.06],[880,.1],[660,.12],[440,.14],[330,.1],[220,.18]],type:'square',vol:.08,tempo:1.4},
  flip:   {notes:[[392,.2],[494,.2],[587,.2],[740,.2],[587,.2],[494,.2],[392,.4],[349,.2],[392,.4]],type:'sine',vol:.06,tempo:1.1},
  zen:    {notes:[[392,.6],[440,.6],[494,.6],[523,.6],[440,.9],[392,.6],[330,.9],[294,1.2]],type:'sine',vol:.05,tempo:.7},
};
let melIdx=0,melTime=0,melMode='normal';
function startMusic(mode='normal'){
  if(!audioCtx||musicOn)return;musicOn=true;melTime=audioCtx.currentTime;melIdx=0;melMode=mode;
  const mel=MELODIES[mode]||MELODIES.normal;
  function sched(){
    if(!musicOn)return;
    while(melTime-audioCtx.currentTime<2){
      const[f,dur]=mel.notes[melIdx%mel.notes.length];
      const rd=dur/mel.tempo;
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type=mel.type;o.frequency.value=f;
      g.gain.setValueAtTime(mel.vol,melTime);
      g.gain.exponentialRampToValueAtTime(.001,melTime+rd-.01);
      o.connect(g);g.connect(musicGain);o.start(melTime);o.stop(melTime+rd);
      melTime+=rd;melIdx++;
    }
    setTimeout(sched,400);
  }
  sched();
}
function stopMusic(){musicOn=false;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OBJECT POOLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _particlePool=[];
function getParticle(){return _particlePool.pop()||{};}
function recycleParticle(p){p.life=0;_particlePool.push(p);}
function spawnParticle(x,y,vx,vy,life,max,r,color){
  const p=getParticle();
  p.x=x;p.y=y;p.vx=vx;p.vy=vy;p.life=life;p.max=max;p.r=r;p.color=color;
  particles.push(p);
}
const _coinFXPool=[];
function getCoinFX(){return _coinFXPool.pop()||{};}
function recycleCoinFX(p){p.life=0;_coinFXPool.push(p);}
let gameState='menu',gameMode='normal';
let score=0,speed=0,pipeTimer=0,gframe=0;
let bird={x:0,y:0,vy:0};
let pipes=[],particles=[],coins=[],coinFX=[],bullets=[],boxes=[],portals=[],zenObstacles=[],flowerTraps=[],trailParts=[];
let shakeX=0,shakeY=0;
let crazyHue=0,crazyTimer=0;
let gravDir=1; // 1=normal, -1=flipped
let flipPortals=[]; // for flip mode
let activeShield=false,activeMagnet=0,activeTurbo=0,activeMega=0;
let bossActive=false,bossHP=0,bossMaxHP=0,bossX=0,bossY=0,bossVY=0,bossTypeIdx=0,lastBossScore=0;
let comboStreak=0,lastCoinX=-999,comboActive=false,comboTimer=0,comboFlashTimer=0;
let noJumpStreak=0,sessionMaxNoJump=0;
let zenSecondsThisRun=0;
let lastJumpTime=0;
let doubleJump=false; // for shooting: detect double-tap
let lastTapTime=0;
const GH=70; // ground height
const bgStars=Array.from({length:55},()=>({x:Math.random()*2000,y:Math.random()*2000,r:Math.random()*2+.5,sp:Math.random()*.3+.1,tw:Math.random()*Math.PI*2}));

const BOSS_TYPES=[
  {name:'–ì–ò–ì–ê–ù–¢ ü¶ñ',color:'#ef4444',hp:5,size:60,reward:30,xpReward:60},
  {name:'–ü–†–ò–ó–†–ê–ö üëª',color:'rgba(180,180,255,.6)',hp:8,size:50,reward:50,xpReward:100},
  {name:'–ö–û–†–û–õ–¨ üëë',color:'#FFD700',hp:12,size:68,reward:80,xpReward:160},
  {name:'–î–†–ê–ö–û–ù üêâ',color:'#22c55e',hp:15,size:65,reward:100,xpReward:200},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE PARAMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getModeParams(){
  const M={easy:{speed:1.8,gap:220,mult:.8},normal:{speed:2.5,gap:182,mult:1},hard:{speed:3.2,gap:145,mult:1.5},insane:{speed:4,gap:130,mult:2},crazy:{speed:2.5,gap:175,mult:3},flip:{speed:2.6,gap:190,mult:2.5},zen:{speed:2,gap:999,mult:.5}};
  return M[gameMode]||M.normal;
}
let GAP=182;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetGame(){
  const mp=getModeParams();
  bird={x:W*.22,y:H/2-20,vy:0};
  pipes=[];particles=[];coins=[];coinFX=[];bullets=[];boxes=[];portals=[];zenObstacles=[];flowerTraps=[];trailParts=[];flipPortals=[];_lastPipeTop=null;gamePaused=false;document.getElementById('pause-overlay').classList.add('hidden');
  pipeTimer=0;score=0;speed=mp.speed;GAP=mp.gap;gframe=0;
  shakeX=0;shakeY=0;crazyHue=0;crazyTimer=0;gravDir=1;
  activeShield=false;activeMagnet=0;activeTurbo=0;activeMega=0;
  bossActive=false;lastBossScore=0;
  comboStreak=0;comboActive=false;comboTimer=0;comboFlashTimer=0;
  noJumpStreak=0;sessionMaxNoJump=0;
  zenSecondsThisRun=0;lastTapTime=0;
  document.getElementById('hud-score').textContent='0';
  document.getElementById('hud-combo').style.opacity='0';
  const gl=document.getElementById('game-label');gl.style.animation='none';gl.style.opacity='0';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIPE ADD + ZEN OBSTACLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _lastPipeTop=null;
function addPipe(){
  // Dynamic gap: starts wide, narrows with score (capped at mode minimum)
  const mp=getModeParams();
  const baseGap=mp.gap;
  const minGap=Math.max(baseGap-60,90);
  const dynamicGap=Math.max(baseGap - Math.min(score*2,60), minGap);
  GAP=dynamicGap;
  const topMin=80,topMax=H-80-GAP-80;
  // Limit delta Y to smooth difficulty (max 120px jump between pipes)
  let top;
  if(_lastPipeTop===null){
    top=topMin+Math.random()*(topMax-topMin);
  } else {
    const maxDelta=120;
    const lo=Math.max(topMin,_lastPipeTop-maxDelta);
    const hi=Math.min(topMax,_lastPipeTop+maxDelta);
    top=lo+Math.random()*(hi-lo);
  }
  _lastPipeTop=top;
  const props=getPipeProps();
  const mAmp=gameMode==='crazy'?50+Math.random()*40:props.moveAmp;
  const mSpd=gameMode==='crazy'?.04+Math.random()*.02:props.moveSpeed;
  // chance for portal
  if(Math.random()<.04){portals.push({x:W+40,y:top+GAP/2,phase:0});return;}
  // chance for box (normal mode)
  if(gameMode==='normal'&&score>5&&Math.random()<.15){
    boxes.push({x:W+80,y:top+GAP/2+(Math.random()-.5)*40,w:88,h:34,hp:2,intact:true,hitFlash:0});
  }
  pipes.push({x:W+40,top,scored:false,props:{...props,moveAmp:mAmp,moveSpeed:mSpd},phase:Math.random()*Math.PI*2,origTop:top,flower:Math.random()<.15&&score>10,bird_scared:false});
  const coinBonus=1+Math.floor(getUpgradeEffect('u_coin_chance')*.05*10);
  const coinChance=.38+getUpgradeEffect('u_coin_chance')*.05;
  if(Math.random()<coinChance){
    const isGold=Math.random()<.02; // 2% gold cuke
    coins.push({x:W+40+62/2,y:top+GAP/2+(Math.random()-.5)*28,collected:false,gold:isGold});
  }
}
function addFlipPortal(){
  const y=80+Math.random()*(H-160);
  flipPortals.push({x:W+60,y,phase:0,r:30});
}
function addZenObstacle(){
  const y=60+Math.random()*(H-190);
  zenObstacles.push({x:W+30,y,r:20+Math.random()*18,phase:0,vY:(Math.random()-.5)*2});
}

function getPipeProps(){
  const p={rotate:false,spiky:false,alpha:1,moveAmp:0,moveSpeed:0};
  if(score<15)return p;
  const r=Math.random();
  if(r<.18)p.rotate=true;
  else if(r<.32)p.spiky=true;
  else if(r<.46)p.alpha=.4+Math.random()*.3;
  else if(r<.65){p.moveAmp=25+Math.random()*35;p.moveSpeed=.025+Math.random()*.025;}
  return p;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLLISION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkCollision(){
  if(bird.y+22>=H-GH||bird.y-22<=0)return true;
  for(const p of pipes){
    if(activeMega>0)continue; // mega-cuke passes through
    const yOff=p.props.moveAmp?Math.sin(p.phase)*p.props.moveAmp:0;
    const pTop=p.top+yOff;
    if(bird.x+15>p.x&&bird.x-15<p.x+62){if(bird.y-17<pTop||bird.y+17>pTop+GAP)return true;}
  }
  for(const b of boxes){
    if(!b.intact)continue;
    if(bird.x+14>b.x&&bird.x-14<b.x+b.w&&bird.y+12>b.y&&bird.y-12<b.y+b.h)return true;
  }
  if(gameMode==='zen'){
    for(const o of zenObstacles){if(Math.hypot(bird.x-o.x,bird.y-o.y)<o.r+15)return true;}
  }
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW BACKGROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawBg(hue=0){
  const W2=getWorld();
  const bg=ctx.createLinearGradient(0,0,0,H);
  if((gameMode==='crazy'||gameMode==='flip')&&gameState==='playing'){
    const h1=`hsl(${hue},80%,8%)`,h2=`hsl(${(hue+60)%360},80%,12%)`;
    bg.addColorStop(0,h1);bg.addColorStop(.5,h2);bg.addColorStop(1,h1);
  } else if(gameMode==='zen'){
    bg.addColorStop(0,'#061a18');bg.addColorStop(.5,'#0d2b24');bg.addColorStop(1,'#061a18');
  } else {
    bg.addColorStop(0,W2.bg[0]);bg.addColorStop(.5,W2.bg[1]);bg.addColorStop(1,W2.bg[2]);
  }
  ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

  // Stars / particles in bg
  bgStars.forEach(s=>{s.x-=s.sp;if(s.x<0){s.x=W;s.y=Math.random()*(H-GH);}s.tw+=.02;
    const a=.3+Math.abs(Math.sin(s.tw))*.5;
    if((gameMode==='crazy'||gameMode==='flip')&&gameState==='playing'){ctx.fillStyle=`hsla(${(hue+s.tw*20)%360},100%,75%,${a})`;}
    else{ctx.fillStyle=W2.star.replace('{a}',a);}
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  });

  // Distant mountains / horizon elements
  if(gameState!=='playing'||(gameMode!=='crazy'&&gameMode!=='flip')){
    const mountainColor=W2.bg[1]+'aa';
    ctx.fillStyle=mountainColor;
    const off2=(Date.now()/200*(speed||2.5))%200;
    for(let i=0;i<8;i++){const mx=((i*180-off2+W+200)%W+W)%W-100;const mh=60+((i*37+11)%50);
      ctx.beginPath();ctx.moveTo(mx,H-GH);ctx.lineTo(mx+50,H-GH-mh);ctx.lineTo(mx+100,H-GH);ctx.fill();}
  }

  // Ground with grass
  const gg=ctx.createLinearGradient(0,H-GH,0,H);gg.addColorStop(0,W2.ground);gg.addColorStop(1,W2.ground);ctx.fillStyle=gg;ctx.fillRect(0,H-GH,W,GH);
  ctx.fillStyle=W2.groundTop;ctx.fillRect(0,H-GH,W,4);
  // Ground highlight
  const gsh=ctx.createLinearGradient(0,H-GH,0,H-GH+8);gsh.addColorStop(0,'rgba(255,255,255,.12)');gsh.addColorStop(1,'transparent');ctx.fillStyle=gsh;ctx.fillRect(0,H-GH,W,8);
  // Animated grass tufts
  const off=(Date.now()/40*(speed||2.5))%32;
  for(let i=0;i<W+32;i+=32){const gx=(i-off+W+32)%W-32;ctx.fillStyle=W2.groundTop+'bb';
    for(const[ox,oh] of[[-2,8],[3,10],[8,7],[14,9],[20,6],[26,8]])ctx.fillRect(gx+ox,H-GH-oh,3,oh);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW PIPE (enhanced with beautiful textures)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIPE SEGMENT CACHE (offscreen canvas for perf)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _pipeCache={};
function _getCachedPipeBody(world, w, h){
  if(h<=0)return null;
  const key=`${world.pipe.join(',')}_${w}_${Math.ceil(h)}`;
  if(_pipeCache[key])return _pipeCache[key];
  if(Object.keys(_pipeCache).length>80){
    // clear oldest half
    const keys=Object.keys(_pipeCache);
    keys.slice(0,40).forEach(k=>delete _pipeCache[k]);
  }
  const oc=document.createElement('canvas');oc.width=w;oc.height=Math.ceil(h);
  const oc2=oc.getContext('2d');
  const g=oc2.createLinearGradient(0,0,w,0);
  g.addColorStop(0,world.pipe[0]);g.addColorStop(.28,world.pipe[1]);g.addColorStop(.6,world.pipe[2]);g.addColorStop(1,world.pipe[3]);
  oc2.fillStyle=g;oc2.beginPath();oc2.roundRect(5,0,w-10,Math.ceil(h),3);oc2.fill();
  // shine
  const shine=oc2.createLinearGradient(5,0,20,0);
  shine.addColorStop(0,'rgba(255,255,255,.18)');shine.addColorStop(1,'rgba(255,255,255,0)');
  oc2.fillStyle=shine;oc2.beginPath();oc2.roundRect(7,0,10,Math.ceil(h),2);oc2.fill();
  // edge lines
  oc2.strokeStyle='rgba(0,0,0,.3)';oc2.lineWidth=1;
  oc2.beginPath();oc2.moveTo(5,0);oc2.lineTo(5,h);oc2.stroke();
  oc2.beginPath();oc2.moveTo(w-5,0);oc2.lineTo(w-5,h);oc2.stroke();
  // rivets
  if(h>20){
    const rv=['rgba(0,0,0,.25)','rgba(255,255,255,.12)'];
    [[10,10],[w-10,10],[10,h-10],[w-10,h-10]].forEach(([rx,ry],ri)=>{
      oc2.fillStyle=rv[ri%2];oc2.beginPath();oc2.arc(rx,ry,3,0,Math.PI*2);oc2.fill();
    });
  }
  _pipeCache[key]=oc;
  return oc;
}
function drawPipe(p,W2){
  const yOff=p.props.moveAmp?Math.sin(p.phase)*p.props.moveAmp:0;
  const topH=p.top+yOff,botY=p.top+yOff+GAP,botH=H-GH-botY;
  const isMega=activeMega>0;
  ctx.globalAlpha=p.props.alpha||1;
  if(p.props.rotate){ctx.save();ctx.translate(p.x+31,p.top+yOff+GAP/2);ctx.rotate(Math.sin(gframe*.05)*.08);ctx.translate(-(p.x+31),-(p.top+yOff+GAP/2));}

  function body(y,h){
    if(h<=0)return;
    // Use cached offscreen canvas for body segment (big perf win on mobile)
    const cached=_getCachedPipeBody(W2,62,h);
    if(cached){ctx.drawImage(cached,p.x,y);}
    else{
      // fallback - gradient directly
      const g=ctx.createLinearGradient(p.x,0,p.x+62,0);
      g.addColorStop(0,W2.pipe[0]);g.addColorStop(.28,W2.pipe[1]);g.addColorStop(.6,W2.pipe[2]);g.addColorStop(1,W2.pipe[3]);
      ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(p.x+5,y,52,h,3);ctx.fill();
    }
  }

  function cap(y,top){
    if(isMega){ctx.shadowColor='#a78bfa';ctx.shadowBlur=20;}
    const cg=ctx.createLinearGradient(p.x,0,p.x+62,0);
    cg.addColorStop(0,W2.pipe[3]);cg.addColorStop(.4,W2.pipeCap);cg.addColorStop(1,W2.pipe[0]);
    ctx.fillStyle=cg;ctx.shadowColor=W2.pipeCap;ctx.shadowBlur=isMega?20:8;
    ctx.beginPath();ctx.roundRect(p.x,y,62,14,top?[6,6,0,0]:[0,0,6,6]);ctx.fill();
    // Cap highlight
    const csh=ctx.createLinearGradient(p.x,0,p.x+62,0);
    csh.addColorStop(0,'rgba(255,255,255,.22)');csh.addColorStop(.5,'rgba(255,255,255,.08)');csh.addColorStop(1,'rgba(255,255,255,.02)');
    ctx.fillStyle=csh;ctx.beginPath();ctx.roundRect(p.x+2,y+(top?1:7),58,6,2);ctx.fill();
    ctx.shadowBlur=0;
    // Cap border
    ctx.strokeStyle='rgba(0,0,0,.35)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.roundRect(p.x,y,62,14,top?[6,6,0,0]:[0,0,6,6]);ctx.stroke();
  }

  if(topH>14){body(0,topH-14);cap(topH-14,true);}
  cap(botY,false);if(botH>14)body(botY+14,botH);

  if(p.props.spiky){
    ctx.fillStyle='#ef4444';ctx.shadowColor='#ef4444';ctx.shadowBlur=4;
    for(let i=0;i<5;i++){const sx=p.x+5+i*11;
      ctx.beginPath();ctx.moveTo(sx,topH-14);ctx.lineTo(sx+5.5,topH-24);ctx.lineTo(sx+11,topH-14);ctx.fill();
      ctx.beginPath();ctx.moveTo(sx,botY+14);ctx.lineTo(sx+5.5,botY+24);ctx.lineTo(sx+11,botY+14);ctx.fill();
    }
    ctx.shadowBlur=0;
  }

  // flower trap
  if(p.flower&&!p.bird_scared){
    const fy=topH-28;ctx.font='18px serif';ctx.textAlign='center';ctx.fillText('ü™ª',p.x+31,fy);
    if(Math.hypot(bird.x-(p.x+31),bird.y-fy)<60&&!p.bird_scared){p.bird_scared=true;setTimeout(()=>{p.flower=false;},1200);}
  } else if(p.flower&&p.bird_scared){
    ctx.font='18px serif';ctx.textAlign='center';ctx.fillText('ü¶ú',p.x+31+Math.random()*20-10,topH-50);
  }

  if(p.props.rotate)ctx.restore();
  ctx.globalAlpha=1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAUSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gamePaused=false;
function pauseGoToMenu(){
  gamePaused=false;
  document.getElementById('pause-overlay').classList.add('hidden');
  stopMusic();
  goToMenu();
}
function togglePause(){
  if(gameState!=='playing')return;
  gamePaused=!gamePaused;
  document.getElementById('pause-overlay').classList.toggle('hidden',!gamePaused);
  document.getElementById('hud-pause').textContent=gamePaused?'‚ñ∂':'‚è∏';
  if(!gamePaused){_lastFrameTime=0;requestAnimationFrame(ts=>gameLoop(ts));}
}
// Also reset pause on game start
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLLECT COINS + COMBO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collectCoins(){
  const magnetRange=120+(getUpgradeEffect('u_magnet_range')*30);
  coins.forEach(c=>{
    if(c.collected)return;
    const dist=Math.hypot(bird.x-c.x,bird.y-c.y);
    if(activeMagnet>0&&dist<magnetRange){c.x+=(bird.x-c.x)*.09;c.y+=(bird.y-c.y)*.09;}
    if(dist<28){
      c.collected=true;
      // Combo multiplier for coins
      const comboMult=comboStreak>=10?2:comboStreak>=5?1.5:1;
      if(c.gold){goldCukes++;showToast('‚ú® –ó–æ–ª–æ—Ç–æ–π –æ–≥—É—Ä—á–∏–∫!');playCombo();}
      else{
        const earned=comboMult>1?Math.ceil(comboMult):1;
        cucumbers+=earned;totalCoins+=earned;playCoinChime();questProgress('collect',earned);
        if(comboMult>1){coinFX.push({x:c.x,y:c.y-14,vx:0,vy:-1.5,life:28,max:28,txt:`x${comboMult}üíö`,gold:false});}
      }
      save();document.getElementById('hud-cukes').textContent=cucumbers;document.getElementById('hud-gold').textContent=goldCukes;
      for(let i=0;i<4;i++)coinFX.push({x:c.x,y:c.y,vx:(Math.random()-.5)*3.5,vy:-Math.random()*3.5-1,life:22,max:22,gold:c.gold});
      // combo tracking
      const isConsecutive=Math.abs(c.x-lastCoinX)<200;
      if(isConsecutive){comboStreak++;}else{comboStreak=1;}
      lastCoinX=c.x;
      if(comboStreak>=5&&!comboActive){
        comboActive=true;comboTimer=600;combosActivated++;
        playCombo();showComboLabel();
      }
    }
  });
  coins=coins.filter(c=>c.x>-30);
}

function showComboLabel(){
  const el=document.getElementById('hud-combo');
  const mult=comboStreak>=10?'x2':'x1.5';
  el.textContent=`üå∂Ô∏è COMBO! –ú–æ–Ω–µ—Ç—ã ${mult} (√ó${comboStreak})`;el.style.opacity='1';
  setTimeout(()=>{if(!comboActive)el.style.opacity='0';},10000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEEDS / SHOOT / BOXES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shoot(){
  if(gameState!=='playing')return;
  bullets.push({x:bird.x+20,y:bird.y,vx:8,life:60});
  playShoot();
}

function updateBullets(){
  bullets=bullets.filter(b=>b.life>0&&b.x<W+20);
  bullets.forEach(b=>{
    b.x+=b.vx;b.life--;
    // draw bullet
    ctx.save();ctx.fillStyle='#86efac';ctx.shadowColor='#4ade80';ctx.shadowBlur=8;
    ctx.beginPath();ctx.ellipse(b.x,b.y,6,3,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.restore();
    // hit boxes
    boxes.forEach(bx=>{
      if(!bx.intact)return;
      if(b.x+6>bx.x&&b.x-6<bx.x+bx.w&&b.y+3>bx.y&&b.y-3<bx.y+bx.h){
        b.life=0;bx.hp--;bx.hitFlash=8;
        if(bx.hp<=0){
          bx.intact=false;boxesDestroyed++;
          // loot
          const loot=3+Math.floor(Math.random()*5);
          cucumbers+=loot;save();
          for(let i=0;i<6;i++)particles.push({x:bx.x+14,y:bx.y+14,vx:(Math.random()-.5)*5,vy:-Math.random()*5-2,life:40,max:40,r:4+Math.random()*5,color:'#92400e'});
          coinFX.push({x:bx.x+14,y:bx.y-10,vx:0,vy:-2,life:30,max:30,txt:`+${loot}ü•í`,gold:false});
          showToast(`üì¶ –Ø—â–∏–∫! +${loot}ü•í`);
        }
      }
    });
  });
  boxes=boxes.filter(b=>b.x>-50);
}

function drawBox(b){
  if(!b.intact)return;
  ctx.save();
  const bx=b.x,by=b.y,bw=b.w,bh=b.h;
  // Hit flash
  if(b.hitFlash>0){
    b.hitFlash--;
    ctx.save();
    ctx.beginPath();ctx.roundRect(bx,by,bw,bh,5);ctx.closePath();
    ctx.fillStyle=`rgba(255,255,255,${b.hitFlash/8})`;ctx.fill();
    ctx.restore();
  }
  // Pulsing danger glow
  const pulse=.5+Math.sin(Date.now()*.004)*.3;
  ctx.shadowColor=b.hp<=1?`rgba(239,68,68,${.6+pulse*.4})`:'rgba(180,45,45,.5)';
  ctx.shadowBlur=8+pulse*6;

  // Wood base - elongated plank style
  const woodGrad=ctx.createLinearGradient(bx,by,bx,by+bh);
  woodGrad.addColorStop(0,'#8b5a1a');
  woodGrad.addColorStop(.3,'#5c3410');
  woodGrad.addColorStop(.7,'#6b3d14');
  woodGrad.addColorStop(1,'#3d2208');
  ctx.fillStyle=woodGrad;
  ctx.beginPath();ctx.roundRect(bx,by,bw,bh,4);ctx.fill();
  ctx.shadowBlur=0;

  // Wood grain lines
  ctx.save();ctx.beginPath();ctx.roundRect(bx,by,bw,bh,4);ctx.clip();
  // Horizontal planks - like a wooden barrier/fence
  const plankH=bh/2;
  [0,1].forEach(i=>{
    const py=by+i*plankH;
    // plank divider
    if(i>0){ctx.strokeStyle='rgba(0,0,0,.5)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(bx,py);ctx.lineTo(bx+bw,py);ctx.stroke();}
    // grain
    for(let gx=0;gx<bw;gx+=20){
      ctx.strokeStyle=`rgba(0,0,0,.15)`;ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(bx+gx,py);ctx.lineTo(bx+gx,py+plankH-1);ctx.stroke();
    }
    // grain wavy lines
    ctx.strokeStyle='rgba(30,12,3,.3)';ctx.lineWidth=.8;
    ctx.beginPath();
    for(let x=0;x<=bw;x+=6)ctx.lineTo(bx+x,py+plankH*.4+Math.sin(x*.25+i*3)*2);
    ctx.stroke();
  });
  // Metal corner nails
  [[0,0],[bw,0],[0,bh],[bw,bh]].forEach(([ox,oy])=>{
    const nx=bx+ox+(ox?-5:5),ny=by+oy+(oy?-4:4);
    ctx.fillStyle='#9ca3af';ctx.beginPath();ctx.arc(nx,ny,3,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.4)';ctx.beginPath();ctx.arc(nx-1,ny-1,1.2,0,Math.PI*2);ctx.fill();
  });
  ctx.restore();

  // === DANGER STRIPES (red/yellow diagonal) on left side ===
  ctx.save();ctx.beginPath();ctx.roundRect(bx,by,bw*.3,bh,4);ctx.clip();
  const sw=8;
  ctx.fillStyle='rgba(239,68,68,.7)';
  for(let i=-2;i<bh/sw+2;i++){
    ctx.beginPath();
    ctx.moveTo(bx,by+i*sw*2);ctx.lineTo(bx+sw,by+i*sw*2);
    ctx.lineTo(bx+sw+bh,by+i*sw*2+bh);ctx.lineTo(bx+bh,by+i*sw*2+bh);
    ctx.closePath();ctx.fill();
  }
  // no-entry circle with X
  const iconX=bx+bw*.15,iconY=by+bh*.5,iconR=bh*.34;
  ctx.fillStyle='rgba(220,38,38,.95)';ctx.beginPath();ctx.arc(iconX,iconY,iconR,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.9)';ctx.lineWidth=1.8;ctx.beginPath();ctx.arc(iconX,iconY,iconR,0,Math.PI*2);ctx.stroke();
  const xOff=iconR*.56;
  ctx.strokeStyle='#fff';ctx.lineWidth=2.2;ctx.lineCap='round';
  ctx.beginPath();ctx.moveTo(iconX-xOff,iconY-xOff);ctx.lineTo(iconX+xOff,iconY+xOff);ctx.stroke();
  ctx.beginPath();ctx.moveTo(iconX+xOff,iconY-xOff);ctx.lineTo(iconX-xOff,iconY+xOff);ctx.stroke();
  ctx.lineCap='butt';
  ctx.restore();

  // === RIGHT SIDE: SHOOT text ===
  const tx=bx+bw*.62,ty=by+bh*.5;
  ctx.font=`bold ${Math.max(6,bh*.21)}px Nunito`;ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillStyle='#fef08a';ctx.shadowColor='rgba(0,0,0,.8)';ctx.shadowBlur=3;
  ctx.fillText('–£–ù–ò–ß–¢–û–ñ–¨',tx,ty-bh*.16);
  ctx.fillStyle='#fca5a5';
  ctx.fillText('–ú–ï–ù–Ø!',tx,ty+bh*.16);
  ctx.shadowBlur=0;

  // Pulsing arrow pointing left at the box (from player side = right side of box)
  const arrowPulse=.5+Math.sin(Date.now()*.006+1)*.5;
  ctx.save();
  ctx.translate(bx+bw+14,by+bh*.5);
  ctx.globalAlpha=arrowPulse;
  ctx.fillStyle='#fbbf24';
  ctx.beginPath();ctx.moveTo(-12,0);ctx.lineTo(0,-5);ctx.lineTo(0,5);ctx.closePath();ctx.fill();
  ctx.globalAlpha=1;
  ctx.restore();

  // Outer border
  ctx.strokeStyle=b.hp<=1?'#ef4444':'#92400e';ctx.lineWidth=2.5;
  ctx.beginPath();ctx.roundRect(bx,by,bw,bh,4);ctx.stroke();
  if(b.hp<=1){
    ctx.shadowColor='#ef4444';ctx.shadowBlur=10;
    ctx.strokeStyle='rgba(239,68,68,.6)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.roundRect(bx-2,by-2,bw+4,bh+4,6);ctx.stroke();
    ctx.shadowBlur=0;
  }

  // HP bar below
  const hpPct=b.hp/2;
  const barY=by+bh+3;
  ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(bx,barY,bw,4);
  const hpGrad=ctx.createLinearGradient(bx,0,bx+bw,0);
  hpGrad.addColorStop(0,'#ef4444');hpGrad.addColorStop(1,'#fbbf24');
  ctx.fillStyle=hpGrad;ctx.fillRect(bx,barY,bw*hpPct,4);
  ctx.font='9px serif';ctx.textAlign='left';ctx.fillStyle='#fff';
  ctx.fillText('‚ù§Ô∏è'.repeat(Math.max(0,b.hp)),bx,by-3);

  ctx.globalAlpha=1;ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PORTALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawPortal(p,hue=0){
  p.phase+=.07;
  ctx.save();ctx.translate(p.x,p.y);
  const r=26+Math.sin(p.phase*1.5)*4;
  // Outer glow rings
  for(let ring=3;ring>=0;ring--){
    ctx.globalAlpha=.08-ring*.015;
    ctx.fillStyle=`hsl(${hue},100%,60%)`;
    ctx.beginPath();ctx.arc(0,0,r+ring*12,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
  // Swirling energy
  for(let i=0;i<8;i++){
    const a=p.phase+i*Math.PI/4;
    const x2=Math.cos(a)*r*.7,y2=Math.sin(a)*r*.7;
    ctx.shadowColor=`hsl(${(hue+i*20)%360},100%,70%)`;ctx.shadowBlur=8;
    ctx.fillStyle=`hsl(${(hue+i*20)%360},100%,75%)`;
    ctx.beginPath();ctx.arc(x2,y2,3+Math.sin(p.phase*2+i)*1.5,0,Math.PI*2);ctx.fill();
  }
  // Main circles
  ctx.shadowColor=`hsl(${hue},100%,60%)`;ctx.shadowBlur=20;
  ctx.strokeStyle=`hsl(${hue},100%,75%)`;ctx.lineWidth=3;
  ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.stroke();
  ctx.strokeStyle=`hsl(${(hue+120)%360},100%,70%)`;ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(0,0,r*.65,p.phase*1.3,p.phase*1.3+Math.PI*1.5);ctx.stroke();
  ctx.strokeStyle=`hsl(${(hue+240)%360},100%,70%)`;ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(0,0,r*.45,-p.phase*1.5,-p.phase*1.5+Math.PI);ctx.stroke();
  // Center fill
  const cg=ctx.createRadialGradient(0,0,0,0,0,r*.5);
  cg.addColorStop(0,`hsla(${hue},100%,80%,.4)`);cg.addColorStop(1,`hsla(${hue},100%,50%,.1)`);
  ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,0,r*.5,0,Math.PI*2);ctx.fill();
  // Portal label
  ctx.shadowBlur=0;ctx.globalAlpha=.8+Math.sin(p.phase*3)*.2;
  ctx.fillStyle='#fff';ctx.font='bold 13px Nunito';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('üåÄ',0,0);
  ctx.globalAlpha=1;ctx.shadowBlur=0;ctx.restore();
}

function checkPortals(){
  portals.forEach(p=>{
    if(Math.hypot(bird.x-p.x,bird.y-p.y)<32){
      score+=10;portalsUsed++;
      const bonus=5+Math.floor(Math.random()*8);cucumbers+=bonus;save();
      playPortal();showToast(`üåÄ –ü–æ—Ä—Ç–∞–ª! +10 –æ—á–∫–æ–≤ +${bonus}ü•í –£–°–ö–û–†–ï–ù–ò–ï!`);
      // Speed boost from portal
      speed=Math.min(speed*1.2,speed+1.5);
      bird.vy=JUMP_VEL*gravDir*.6;
      p.x=-200;
      for(let i=0;i<16;i++)particles.push({x:bird.x,y:bird.y,vx:(Math.random()-.5)*8,vy:(Math.random()-.5)*8,life:50,max:50,r:5+Math.random()*8,color:`hsl(${Math.random()*360},100%,70%)`});
    }
  });
  portals=portals.filter(p=>p.x>-100);
}

function checkFlipPortals(){
  flipPortals.forEach(fp=>{
    if(Math.hypot(bird.x-fp.x,bird.y-fp.y)<fp.r){
      gravDir*=-1;fp.x=-200;playPortal();
      showLabel('üîÑ –ì–†–ê–í–ò–¢–ê–¶–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ê!','#38bdf8');
    }
  });
  flipPortals=flipPortals.filter(fp=>fp.x>-100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOSS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnBoss(){
  if(bossActive)return;
  const bt=BOSS_TYPES[Math.floor(Math.random()*BOSS_TYPES.length)];
  bossTypeIdx=BOSS_TYPES.indexOf(bt);bossActive=true;bossHP=bossMaxHP=bt.hp;bossX=W+90;bossY=H/2;bossVY=2;
  showLabel(`üëπ –ë–û–°–°: ${bt.name}!`,'#ef4444');
}

function updateBoss(){
  if(!bossActive)return;
  const bt=BOSS_TYPES[bossTypeIdx];
  bossX-=speed*.4;bossY+=bossVY;
  if(bossY<80||bossY>H-100)bossVY*=-1;
  ctx.save();
  const s=bt.size/2;
  ctx.shadowColor=bt.color;ctx.shadowBlur=25;

  if(bossTypeIdx===0){
    // –ì–ò–ì–ê–ù–¢ ü¶ñ - dinosaur-like
    ctx.fillStyle='#dc2626';ctx.beginPath();ctx.ellipse(bossX,bossY,s,s*.8,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fca5a5';ctx.beginPath();ctx.ellipse(bossX+s*.2,bossY-s*.1,s*.55,s*.5,-.2,0,Math.PI*2);ctx.fill();
    // eyes
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(bossX+s*.3,bossY-s*.25,s*.2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';ctx.beginPath();ctx.arc(bossX+s*.35,bossY-s*.22,s*.1,0,Math.PI*2);ctx.fill();
    // teeth
    ctx.fillStyle='#fff';for(let i=0;i<3;i++){ctx.beginPath();ctx.moveTo(bossX+s*.1+i*s*.12,bossY+s*.3);ctx.lineTo(bossX+s*.17+i*s*.12,bossY+s*.5);ctx.lineTo(bossX+s*.24+i*s*.12,bossY+s*.3);ctx.fill();}
    // spine
    ctx.fillStyle='#7f1d1d';for(let i=0;i<4;i++){ctx.beginPath();ctx.arc(bossX-s*.4+i*s*.22,bossY-s*.7-i*.05,s*.1,0,Math.PI*2);ctx.fill();}
  } else if(bossTypeIdx===1){
    // –ü–†–ò–ó–†–ê–ö üëª
    const wave=Math.sin(gframe*.05)*5;
    ctx.fillStyle='rgba(180,180,255,.75)';ctx.beginPath();ctx.arc(bossX,bossY-wave,s,Math.PI,0);ctx.lineTo(bossX+s,bossY+s*.5-wave);
    for(let i=3;i>=0;i--){const gx=bossX+s-i*s*.67;ctx.quadraticCurveTo(gx,bossY+s*.9+Math.sin(gframe*.08+i)*6-wave,gx-s*.33,bossY+s*.5-wave);}
    ctx.closePath();ctx.fill();
    ctx.fillStyle='rgba(0,0,80,.8)';ctx.beginPath();ctx.ellipse(bossX-s*.3,bossY-s*.1-wave,s*.18,s*.22,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(bossX+s*.3,bossY-s*.1-wave,s*.18,s*.22,0,0,Math.PI*2);ctx.fill();
    ctx.shadowColor='#818cf8';
  } else if(bossTypeIdx===2){
    // –ö–û–†–û–õ–¨ üëë
    ctx.fillStyle='#ca8a04';ctx.beginPath();ctx.ellipse(bossX,bossY,s,s*.9,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.ellipse(bossX,bossY-s*.1,s*.7,s*.65,0,0,Math.PI*2);ctx.fill();
    // Crown
    ctx.fillStyle='#FFD700';ctx.shadowColor='#FFD700';ctx.shadowBlur=12;
    const cw=s*.9,cy=bossY-s*.7;
    ctx.beginPath();ctx.moveTo(bossX-cw,cy+s*.3);ctx.lineTo(bossX-cw,cy);ctx.lineTo(bossX-cw*.5,cy+s*.15);ctx.lineTo(bossX,cy-s*.1);ctx.lineTo(bossX+cw*.5,cy+s*.15);ctx.lineTo(bossX+cw,cy);ctx.lineTo(bossX+cw,cy+s*.3);ctx.closePath();ctx.fill();
    ctx.shadowBlur=0;
    // gems in crown
    ['#ef4444','#22c55e','#38bdf8'].forEach((g,i)=>{ctx.fillStyle=g;ctx.beginPath();ctx.arc(bossX-cw*.5+i*cw*.5,cy+s*.1,s*.07,0,Math.PI*2);ctx.fill();});
    // eyes
    ctx.fillStyle='#000';ctx.beginPath();ctx.arc(bossX-s*.3,bossY-s*.1,s*.14,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(bossX+s*.3,bossY-s*.1,s*.14,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(bossX-s*.27,bossY-s*.14,s*.06,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(bossX+s*.33,bossY-s*.14,s*.06,0,Math.PI*2);ctx.fill();
  } else {
    // –î–†–ê–ö–û–ù üêâ
    ctx.fillStyle='#15803d';ctx.beginPath();ctx.ellipse(bossX,bossY,s,s*.85,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#4ade80';ctx.beginPath();ctx.ellipse(bossX+s*.15,bossY-s*.15,s*.65,s*.58,-.15,0,Math.PI*2);ctx.fill();
    // Wings
    ctx.fillStyle='rgba(21,128,61,.6)';
    ctx.beginPath();ctx.moveTo(bossX-s*.2,bossY-s*.3);ctx.quadraticCurveTo(bossX-s*1.4,bossY-s*1.1,bossX-s*.8,bossY+s*.1);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(bossX+s*.2,bossY-s*.3);ctx.quadraticCurveTo(bossX+s*1.4,bossY-s*1.1,bossX+s*.8,bossY+s*.1);ctx.closePath();ctx.fill();
    // Eyes (glowing)
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(bossX+s*.2,bossY-s*.25,s*.18,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f97316';ctx.beginPath();ctx.arc(bossX+s*.24,bossY-s*.22,s*.1,0,Math.PI*2);ctx.fill();
    // Spines
    ctx.fillStyle='#052e16';for(let i=0;i<5;i++){ctx.beginPath();ctx.moveTo(bossX-s*.3+i*s*.15,bossY-s*.7);ctx.lineTo(bossX-s*.22+i*s*.15,bossY-s*1.0);ctx.lineTo(bossX-s*.15+i*s*.15,bossY-s*.7);ctx.fill();}
    // Fire breath
    if(gframe%60<20){const fphase=gframe*.18;ctx.shadowColor='#f97316';ctx.shadowBlur=16;
      for(let i=0;i<4;i++){const fg=ctx.createRadialGradient(bossX+s,bossY+i*s*.08,0,bossX+s+s*.4,bossY+i*s*.08,s*.5);fg.addColorStop(0,'rgba(254,215,0,.9)');fg.addColorStop(.5,'rgba(249,115,22,.6)');fg.addColorStop(1,'transparent');ctx.fillStyle=fg;ctx.beginPath();ctx.ellipse(bossX+s+s*.4+Math.sin(fphase+i)*s*.2,bossY+i*s*.08,s*.5,s*.12,Math.sin(fphase+i)*.3,0,Math.PI*2);ctx.fill();}
      ctx.shadowBlur=0;
    }
  }

  // HP bar
  const bw=bt.size*1.6;
  ctx.fillStyle='rgba(0,0,0,.55)';ctx.beginPath();ctx.roundRect(bossX-bw/2,bossY-bt.size/2-20,bw,9,4);ctx.fill();
  const hpPct=bossHP/bossMaxHP;
  const hpColor=hpPct>.6?'#4ade80':hpPct>.3?'#fbbf24':'#ef4444';
  ctx.fillStyle=hpColor;ctx.shadowColor=hpColor;ctx.shadowBlur=6;
  ctx.beginPath();ctx.roundRect(bossX-bw/2,bossY-bt.size/2-20,bw*hpPct,9,4);ctx.fill();ctx.shadowBlur=0;
  ctx.fillStyle='#fff';ctx.font='bold 10px Nunito';ctx.textAlign='center';ctx.fillText(bt.name,bossX,bossY-bt.size/2-26);
  ctx.restore();

  if(Math.hypot(bird.x-bossX,bird.y-bossY)<bt.size/2+18){
    bossHP--;
    if(bossHP<=0){
      bossActive=false;bossesDefeated++;cucumbers+=bt.reward;addXP(bt.xpReward);save();
      localStorage.setItem('fc_bosses',bossesDefeated);
      showLabel(`üíÄ –ë–û–°–° –ü–û–ë–ï–ñ–î–Å–ù! +${bt.reward}ü•í`,'#4ade80');
      for(let i=0;i<15;i++)particles.push({x:bossX,y:bossY,vx:(Math.random()-.5)*8,vy:Math.random()*-8-2,life:60,max:60,r:8+Math.random()*10,color:bt.color});
    } else if(activeShield){activeShield=false;showToast('üõ°Ô∏è –©–∏—Ç —Å–ª–æ–º–∞–Ω –æ—Ç –±–æ—Å—Å–∞!');}
    else{
      if(getUpgradeEffect('u_lucky_save')>0&&Math.random()<.01*getUpgradeEffect('u_lucky_save')){showToast('üçÄ –ü–æ–≤–µ–∑–ª–æ!');return;}
      gameState='dead';playDeath();stopMusic();if(navigator.vibrate)navigator.vibrate(100);spawnDeathFX();showGameOverDelayed();return;
    }
    bossX=W+90;
  }
  if(bossX<-100)bossActive=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEATH + PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnDeathFX(){for(let i=0;i<20;i++){const a=Math.random()*Math.PI*2,sp=2+Math.random()*6;particles.push({x:bird.x,y:bird.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-3,life:55,max:70,r:4+Math.random()*8,color:['#4ade80','#22c55e','#86efac','#dcfce7'][Math.floor(Math.random()*4)]});}}

// ‚îÄ‚îÄ‚îÄ Trail emit (called every frame during play) ‚îÄ‚îÄ‚îÄ
function spawnTrail(x,y){
  const t=TRAILS.find(t=>t.id===selectedTrail);if(!t||!t.color)return;
  // Emit 2-3 particles per frame for richer trail
  const count=selectedTrail==='rainbow'||selectedTrail==='candy'?3:2;
  for(let k=0;k<count;k++){
    const col=t.color[Math.floor(Math.random()*t.color.length)];
    const isB=t.id==='bubbles';
    const isStar=t.id==='stars';
    const isGhost=t.id==='ghost';
    const baseR=isB?4+Math.random()*5:isStar?3+Math.random()*4:2+Math.random()*3;
    trailParts.push({
      x:x+(Math.random()-.5)*10,y:y+(Math.random()-.5)*8,
      vx:(Math.random()-.5)*(isB?.5:1.8)-1.2,
      vy:(Math.random()-.5)*1.5-(isGhost?.3:0),
      life:isB?40:isStar?35:25,max:isB?40:isStar?35:25,
      r:baseR,color:col,
      bubble:isB,star:isStar,ghost:isGhost,
      rot:Math.random()*Math.PI*2,rotV:(Math.random()-.5)*.2
    });
  }
}
function drawTrail(){
  trailParts=trailParts.filter(p=>p.life>0);
  trailParts.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.life--;
    if(p.rot!==undefined)p.rot+=p.rotV;
    const alpha=(p.life/p.max)*.85;
    ctx.save();ctx.globalAlpha=alpha;
    if(p.bubble){
      ctx.strokeStyle=p.color;ctx.lineWidth=1.8;// no shadow
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.stroke();
    } else if(p.star){
      ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=8;
      ctx.translate(p.x,p.y);ctx.rotate(p.rot);
      ctx.beginPath();
      for(let i=0;i<5;i++){const a=i*Math.PI*.4-Math.PI/2,a2=a+Math.PI*.2;ctx.lineTo(Math.cos(a)*p.r,Math.sin(a)*p.r);ctx.lineTo(Math.cos(a2)*p.r*.45,Math.sin(a2)*p.r*.45);}
      ctx.closePath();ctx.fill();
    } else if(p.ghost){
      ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=10;
      ctx.beginPath();ctx.arc(p.x,p.y-p.r*.3,p.r*.7,Math.PI,0);
      ctx.quadraticCurveTo(p.x+p.r*.7,p.y+p.r*.4,p.x+p.r*.35,p.y+p.r*.1);
      ctx.quadraticCurveTo(p.x,p.y+p.r*.5,p.x-p.r*.35,p.y+p.r*.1);
      ctx.quadraticCurveTo(p.x-p.r*.7,p.y+p.r*.4,p.x-p.r*.7,p.y-p.r*.3);
      ctx.fill();
    } else {
      ctx.fillStyle=p.color;// no shadow for perf
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    }
    ctx.restore();
  });
  ctx.globalAlpha=1;ctx.shadowBlur=0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOW LABEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLabel(msg,color='#fbbf24'){
  const el=document.getElementById('game-label');
  el.textContent=msg;el.style.color=color;el.style.textShadow=`0 0 24px ${color}`;
  el.style.animation='none';void el.offsetWidth;el.style.animation='labelPop 1.4s forwards';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ZEN MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addZenObs(){
  const y=60+Math.random()*(H-190);
  const r=22+Math.random()*20;
  const types=['spike','skull','fire','electric'];
  const type=types[Math.floor(Math.random()*types.length)];
  zenObstacles.push({x:W+r+10,y,r,vY:(Math.random()-.5)*1.8,phase:Math.random()*Math.PI*2,type});
}
function drawZenObs(o){
  ctx.save();ctx.translate(o.x,o.y);
  const pulse=1+Math.sin(o.phase+=.06)*.12;
  ctx.scale(pulse,pulse);

  if(o.type==='skull'){
    // Red glowing skull
    ctx.shadowColor='#ef4444';ctx.shadowBlur=20;
    ctx.fillStyle='#dc2626';ctx.beginPath();ctx.arc(0,-o.r*.1,o.r*.75,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#7f1d1d';ctx.beginPath();ctx.ellipse(0,o.r*.35,o.r*.45,o.r*.3,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(-o.r*.28,-o.r*.18,o.r*.22,o.r*.25,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(o.r*.28,-o.r*.18,o.r*.22,o.r*.25,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ef4444';
    ctx.beginPath();ctx.ellipse(-o.r*.28,-o.r*.18,o.r*.12,o.r*.14,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(o.r*.28,-o.r*.18,o.r*.12,o.r*.14,0,0,Math.PI*2);ctx.fill();
    // teeth
    ctx.fillStyle='#fff';
    for(let i=-1;i<=1;i++){ctx.beginPath();ctx.moveTo(i*o.r*.22,o.r*.28);ctx.lineTo(i*o.r*.22-o.r*.1,o.r*.55);ctx.lineTo(i*o.r*.22+o.r*.1,o.r*.55);ctx.closePath();ctx.fill();}
    // WARNING text
    ctx.shadowBlur=0;ctx.fillStyle='#fef2f2';ctx.font=`bold ${Math.floor(o.r*.35)}px Nunito`;ctx.textAlign='center';ctx.textBaseline='middle';
  } else if(o.type==='spike'){
    // Orange/red spiked ball
    ctx.shadowColor='#f97316';ctx.shadowBlur=18;
    ctx.fillStyle='#c2410c';ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ea580c';ctx.beginPath();ctx.arc(0,0,o.r*.5,0,Math.PI*2);ctx.fill();
    // spikes
    ctx.fillStyle='#9a3412';
    for(let i=0;i<10;i++){
      const a=i*Math.PI/5+o.phase*.2;
      ctx.save();ctx.rotate(a);
      ctx.beginPath();ctx.moveTo(0,o.r*.65);ctx.lineTo(-o.r*.1,o.r*.45);ctx.lineTo(o.r*.1,o.r*.45);ctx.closePath();ctx.fill();
      ctx.restore();
    }
    // ‚ö† symbol
    ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.font=`bold ${Math.floor(o.r*.6)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ö†Ô∏è',0,0);
  } else if(o.type==='fire'){
    // Blue fire/electric ball (danger)
    ctx.shadowColor='#ef4444';ctx.shadowBlur=22;
    const fg=ctx.createRadialGradient(0,0,0,0,0,o.r*.7);
    fg.addColorStop(0,'#fef08a');fg.addColorStop(.4,'#ef4444');fg.addColorStop(1,'#7f1d1d');
    ctx.fillStyle=fg;ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.fill();
    // flame tongues
    for(let i=0;i<6;i++){
      const a=i*Math.PI/3+o.phase*.3;
      const fx=Math.cos(a)*o.r*.5,fy=Math.sin(a)*o.r*.5;
      const flg=ctx.createRadialGradient(fx,fy,0,fx,fy,o.r*.4);
      flg.addColorStop(0,'rgba(254,240,138,.8)');flg.addColorStop(.5,'rgba(239,68,68,.5)');flg.addColorStop(1,'transparent');
      ctx.fillStyle=flg;ctx.beginPath();ctx.arc(fx,fy,o.r*.35,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.font=`bold ${Math.floor(o.r*.55)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üî•',0,0);
  } else {
    // electric
    ctx.shadowColor='#a855f7';ctx.shadowBlur=22;
    ctx.fillStyle='#4c1d95';ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#c4b5fd';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.stroke();
    // lightning bolts
    ctx.strokeStyle='#fde68a';ctx.lineWidth=1.5;
    for(let i=0;i<4;i++){
      const a=i*Math.PI/2+o.phase*.4;
      ctx.save();ctx.rotate(a);
      ctx.beginPath();ctx.moveTo(0,o.r*.15);ctx.lineTo(-o.r*.08,o.r*.4);ctx.lineTo(o.r*.04,o.r*.4);ctx.lineTo(-o.r*.06,o.r*.7);ctx.stroke();
      ctx.restore();
    }
    ctx.shadowBlur=0;ctx.fillStyle='#fde68a';ctx.font=`bold ${Math.floor(o.r*.55)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ö°',0,0);
  }

  // Red WARNING ring pulsing
  ctx.shadowColor='#ef4444';ctx.shadowBlur=10;
  ctx.strokeStyle=`rgba(239,68,68,${.4+Math.sin(o.phase*4)*.3})`;ctx.lineWidth=2.5;
  ctx.beginPath();ctx.arc(0,0,o.r+6,0,Math.PI*2);ctx.stroke();
  ctx.shadowBlur=0;ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GHOST / REPLAY SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ghostTrajectory=[];   // best run recorded positions
let currentRunTrajectory=[];
const _gs=loadSave();
if(_gs&&_gs.ghostTraj)try{ghostTrajectory=JSON.parse(_gs.ghostTraj).slice(0,3000);}catch(e){}

function saveGhostTraj(){
  try{const s=JSON.parse(localStorage.getItem('fc_save')||'{}');s.ghostTraj=JSON.stringify(ghostTrajectory.slice(0,3000));localStorage.setItem('fc_save',JSON.stringify(s));}catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gameLoop(ts){
  if(gamePaused)return;
  if(gameState!=='playing')return;
  // Delta time capped at 50ms to avoid huge jumps on tab focus
  const now=ts||performance.now();
  const rawDt=lastFrameTime?Math.min((now-lastFrameTime)/16.667,3):1;
  lastFrameTime=now;
  const dt=rawDt; // multiplier relative to 60fps frame
  gframe++;
  const mp=getModeParams();
  const W2=getWorld();

  // Shake
  const shakeAmt=(gameMode==='insane')?1.5:(gameMode==='crazy'||gameMode==='flip')?2.5:0;
  shakeX=(Math.random()-.5)*shakeAmt*2;shakeY=(Math.random()-.5)*shakeAmt*2;

  // Crazy hue
  if(gameMode==='crazy'||gameMode==='flip')crazyHue=(crazyHue+2)%360;
  // Crazy gravity flip timer
  if(gameMode==='crazy'){
    crazyTimer++;
    if(crazyTimer%180===0){gravDir*=-1;showLabel('üåÄ –ì–†–ê–í–ò–¢–ê–¶–ò–Ø –ü–ï–†–ï–í–ï–†–ù–£–õ–ê–°–¨!','#ff00ff');}
  }

  ctx.save();if(shakeX||shakeY)ctx.translate(shakeX,shakeY);
  ctx.clearRect(-10,-10,W+20,H+20);
  drawBg(crazyHue);

  // Combo flash
  if(comboActive){
    comboTimer--;if(comboTimer<=0){comboActive=false;comboStreak=0;document.getElementById('hud-combo').style.opacity='0';}
    if(gframe%15<7){ctx.fillStyle='rgba(255,100,0,.06)';ctx.fillRect(0,0,W,H);}
  }

  // ZEN mode
  if(gameMode==='zen'){
    zenSecondsThisRun+=1/60;
    if(zenSecondsThisRun>zenSeconds){zenSeconds=zenSecondsThisRun;save();}
    pipeTimer++;if(pipeTimer%200===0){addZenObs();pipeTimer=0;}
    // add coins frequently
    if(gframe%60===0)coins.push({x:W+30,y:60+Math.random()*(H-200),collected:false,gold:Math.random()<.015});
    zenObstacles.forEach(o=>{o.x-=speed;o.y+=o.vY;if(o.y<60||o.y>H-100)o.vY*=-1;drawZenObs(o);});
    zenObstacles=zenObstacles.filter(o=>o.x>-50);
  } else {
    // Normal pipe spawning
    pipeTimer++;if(pipeTimer>=90){addPipe();pipeTimer=0;}
    // flip mode portals
    if(gameMode==='flip'&&gframe%150===0)addFlipPortal();
    // process pipes
    pipes.forEach(p=>{
      p.x-=speed*dt;if(p.props.moveSpeed)p.phase+=p.props.moveSpeed*dt;
      if(!p.scored&&p.x+62<bird.x){
        p.scored=true;
        const pts=comboActive?2:1;score+=pts;
        playScore();
        document.getElementById('hud-score').textContent=score;
        const speedMult=gameMode==='hard'?.12:gameMode==='insane'?.15:.07;
        speed=mp.speed+score*speedMult;
        if(gameMode==='crazy'&&score>crazySurvived){crazySurvived=score;save();}
        if(score>0&&score%25===0&&score!==lastBossScore){lastBossScore=score;spawnBoss();}
        // no-jump streak
        if(Date.now()-lastJumpTime>2000)noJumpStreak++;else noJumpStreak=0;
        if(noJumpStreak>sessionMaxNoJump){sessionMaxNoJump=noJumpStreak;if(sessionMaxNoJump>maxNoJump){maxNoJump=sessionMaxNoJump;save();}}
      }
    });
    pipes=pipes.filter(p=>p.x+62>-20);
    pipes.forEach(p=>drawPipe(p,W2));
    // portals (bonus)
    portals.forEach(p=>{p.x-=speed;drawPortal(p,gframe*2);});
    checkPortals();
    // flip portals
    if(gameMode==='flip'){flipPortals.forEach(fp=>{fp.x-=speed;fp.phase+=.06;drawPortal(fp,180);});checkFlipPortals();}
    // boxes
    boxes.forEach(b=>{b.x-=speed;drawBox(b);});
    // boss
    if(gameMode!=='flip'&&gameMode!=='zen')updateBoss();
    // mega-cuke smash
    if(activeMega>0){
      pipes.forEach(p=>{if(!p.smashed&&p.x<bird.x+80&&p.x+62>bird.x-50){
        p.smashed=true;p.x=-500;megaPipesSmashed++;score++;
        document.getElementById('hud-score').textContent=score;
        for(let i=0;i<10;i++)particles.push({x:bird.x,y:bird.y,vx:(Math.random()-.5)*9,vy:-Math.random()*7-1,life:45,max:45,r:5+Math.random()*7,color:'#a78bfa'});
        coinFX.push({x:bird.x,y:bird.y-20,vx:0,vy:-2,life:28,max:28,txt:'üí•+1',gold:false});
      }});
      pipes=pipes.filter(p=>!p.smashed||p.x>-400);
    }
  }

  // Coins
  coins.forEach(c=>c.x-=speed*dt);
  coins.forEach(c=>{
    if(c.collected)return;ctx.save();ctx.translate(c.x,c.y);
    const pulse=1+Math.sin(gframe*.1)*.08;ctx.scale(pulse,pulse);
    if(c.gold){
      ctx.shadowColor='#FFD700';ctx.shadowBlur=14;
      const cg=ctx.createRadialGradient(0,0,1,0,0,11);cg.addColorStop(0,'#fff9c4');cg.addColorStop(.4,'#FFD700');cg.addColorStop(1,'#f59e0b');
      ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,0,11,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.7)';ctx.font='bold 8px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ú®',0,0);
    } else {
      ctx.shadowColor='#4ade80';ctx.shadowBlur=11;
      const cg=ctx.createRadialGradient(0,0,1,0,0,10);cg.addColorStop(0,'#dcfce7');cg.addColorStop(.4,'#86efac');cg.addColorStop(1,'#4ade80');
      ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;ctx.restore();
  });
  collectCoins();

  // Bird physics with delta time
  const effGrav=.48*gravDir*dt;
  bird.vy+=effGrav;bird.y+=bird.vy*dt;
  // Record ghost trajectory
  currentRunTrajectory.push({x:bird.x,y:bird.y,f:gframe});

  // Trail
  if(gframe%2===0)spawnTrail(bird.x-10,bird.y);
  drawTrail();

  const angle=Math.min(Math.max(bird.vy*.05*gravDir,-.45),.85);

  // Shield visual
  if(activeShield){ctx.save();ctx.strokeStyle='#38bdf8';ctx.lineWidth=2.5;ctx.shadowColor='#38bdf8';ctx.shadowBlur=16;ctx.globalAlpha=.55+Math.sin(gframe*.2)*.25;ctx.beginPath();ctx.arc(bird.x,bird.y,30,0,Math.PI*2);ctx.stroke();ctx.strokeStyle='rgba(56,189,248,.3)';ctx.lineWidth=5;ctx.beginPath();ctx.arc(bird.x,bird.y,38,0,Math.PI*2);ctx.stroke();ctx.restore();}
  if(activeMagnet>0){ctx.save();ctx.strokeStyle='#fbbf24';ctx.lineWidth=1;ctx.shadowColor='#fbbf24';ctx.shadowBlur=6;ctx.globalAlpha=.15+Math.sin(gframe*.1)*.08;ctx.beginPath();ctx.arc(bird.x,bird.y,120+(getUpgradeEffect('u_magnet_range')*30),0,Math.PI*2);ctx.stroke();ctx.restore();activeMagnet--;if(activeMagnet===0)showToast('üß≤ –ú–∞–≥–Ω–∏—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');}
  if(activeTurbo>0){ctx.save();ctx.globalAlpha=.35;ctx.strokeStyle='#fb923c';ctx.lineWidth=1.5;for(let i=0;i<5;i++){const ly=bird.y+(i-2)*9;ctx.beginPath();ctx.moveTo(bird.x-40-Math.random()*15,ly);ctx.lineTo(bird.x-18,ly);ctx.stroke();}ctx.restore();activeTurbo--;if(activeTurbo===0){speed=preTurboSpeed||speed/1.35;showToast('‚ö° –¢—É—Ä–±–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å');}}
  if(activeMega>0){
    ctx.save();ctx.strokeStyle='#a78bfa';ctx.lineWidth=3;ctx.shadowColor='#a78bfa';ctx.shadowBlur=22;ctx.globalAlpha=.45+Math.sin(gframe*.3)*.3;ctx.beginPath();ctx.arc(bird.x,bird.y,38,0,Math.PI*2);ctx.stroke();ctx.lineWidth=1.5;ctx.globalAlpha=.25;ctx.beginPath();ctx.arc(bird.x,bird.y,52,0,Math.PI*2);ctx.stroke();ctx.restore();
    activeMega--;if(activeMega===0)showToast('üí• –ú–µ–≥–∞-–æ–≥—É—Ä–µ—Ü –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');
  }

  // Draw ghost (best run trajectory)
  if(ghostTrajectory.length>0){
    const gf=ghostTrajectory.find(p=>p.f===gframe)||ghostTrajectory[Math.min(gframe,ghostTrajectory.length-1)];
    if(gf){
      ctx.save();ctx.globalAlpha=0.28;
      drawCucumber(ctx,gf.x,gf.y,52,selectedSkin,0,gframe);
      ctx.restore();
    }
  }

  drawCucumber(ctx,bird.x,bird.y,52,selectedSkin,angle,gframe);

  // Draw pet following player
  drawActivePet(bird.x, bird.y, gframe);

  // Bullets
  updateBullets();

  // Particles
  particles=particles.filter(p=>p.life>0);
  particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r/2,0,Math.PI*2);ctx.fill();});
  ctx.globalAlpha=1;

  // Coin FX
  coinFX=coinFX.filter(p=>p.life>0);
  coinFX.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life--;ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.gold?'#FFD700':'#4ade80';ctx.font='bold 14px Nunito';ctx.textAlign='center';ctx.fillText(p.txt||'+1',p.x,p.y);});
  ctx.globalAlpha=1;

  ctx.restore();
  updateBoosterHUD();

  // Collision
  if(checkCollision()){
    if(activeShield){
      activeShield=false;showToast('üõ°Ô∏è –©–∏—Ç –∑–∞—â–∏—Ç–∏–ª!');
      bird.vy=JUMP_VEL*.6*gravDir;
      // push bird to safe zone
      if(bird.y+22>=H-GH)bird.y=H-GH-25;
      if(bird.y-22<=0)bird.y=25;
      playBoost();
    }
    else if(getUpgradeEffect('u_lucky_save')>0&&Math.random()<.01*getUpgradeEffect('u_lucky_save')){showToast('üçÄ –°—á–∞—Å—Ç–ª–∏–≤—á–∏–∫!');}
    else{
      gameState='dead';
      playDeath();stopMusic();spawnDeathFX();
      // Haptic on death
      try{navigator.vibrate&&navigator.vibrate(100);}catch(e){}
      // Save ghost if new record
      if(score>bestScore){
        ghostTrajectory=currentRunTrajectory.slice();
        saveGhostTraj();
      }
      currentRunTrajectory=[];
      showGameOverDelayed();return;
    }
  }
  requestAnimationFrame(gameLoop);
}
let lastFrameTime=0;
function jump(){
  if(gameState!=='playing')return;
  bird.vy=JUMP_VEL*gravDir;
  lastJumpTime=Date.now();
  playJump();
  // Haptic feedback on jump
  try{navigator.vibrate&&navigator.vibrate(30);}catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME OVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showGameOverDelayed(){
  function finalF(){
    ctx.clearRect(0,0,W,H);drawBg(crazyHue);
    pipes.forEach(p=>drawPipe(p,getWorld()));
    particles=particles.filter(p=>p.life>0);
    particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r/2,0,Math.PI*2);ctx.fill();});
    ctx.globalAlpha=1;
    if(particles.some(p=>p.life>0))requestAnimationFrame(finalF);else setTimeout(showGameOver,200);
  }
  requestAnimationFrame(finalF);
}

function showGameOver(){
  const secret=!ownedSkins.includes('secret')&&score>=50;
  if(score>bestScore)bestScore=score;
  // Track per-mode best scores for unlocking
  let modeBests=def('modeBests',{easy:0,normal:0,hard:0,insane:0,crazy:0,flip:0,zen:0});
  if(score>=(modeBests[gameMode]||0)){modeBests[gameMode]=score;try{const s=JSON.parse(localStorage.getItem('fc_save')||'{}');s.modeBests=modeBests;localStorage.setItem('fc_save',JSON.stringify(s));}catch(e){}}
  const mp=getModeParams();
  const earned=Math.floor(score/10*mp.mult);
  const xpEarned=score*5+(gameMode==='crazy'?score*8:0)+(gameMode==='zen'?Math.floor(zenSecondsThisRun/2):0);
  cucumbers+=earned;
  if(secret){ownedSkins.push('secret');}
  totalGames++;
  addXP(xpEarned);
  addSeasonXP(xpEarned);
  // Quest tracking
  questProgress('play',1);
  if(score>0)questProgress('score',score);
  save();updateLeaderboard();checkAchievements();checkStickers();

  document.getElementById('go-score').textContent=score;
  document.getElementById('go-best').textContent='–†–ï–ö–û–†–î: '+bestScore;
  document.getElementById('go-earned').textContent=earned>0?`+${earned} ü•í  +${xpEarned} XP`:'';
  document.getElementById('go-rank').textContent='';
  document.getElementById('go-rank').style.display='none';
  const ul=document.getElementById('go-unlock');
  if(secret){ul.textContent='‚ú® DIVINE –°–ö–ò–ù –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù!';ul.style.display='block';}
  else if(!ownedSkins.includes('secret')){ul.textContent=`üîí DIVINE: ${score}/50 –±–∞—à–µ–Ω`;ul.style.display='block';}
  else ul.style.display='none';
  const dc=document.getElementById('dead-canvas'),dctx=dc.getContext('2d');
  dctx.clearRect(0,0,38,60);drawCucumber(dctx,19,30,56,selectedSkin,.2,0);
  dctx.fillStyle='#ef4444';dctx.font='bold 9px sans-serif';dctx.textAlign='center';dctx.fillText('√ó',14,22);dctx.fillText('√ó',24,22);
  document.getElementById('gameover-screen').classList.remove('hidden');
  updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREENS NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
  document.getElementById('hud-cukes').textContent=cucumbers;
  document.getElementById('hud-gold').textContent=goldCukes;
  document.getElementById('main-cukes').textContent=cucumbers;
  document.getElementById('main-gold').textContent=goldCukes;
  document.getElementById('main-xp').textContent=playerXP;
  const lp=getLevelProgress();
  const rank=getRank();
  document.getElementById('hud-lvl-text').textContent=`LVL ${lp.level+1}`;
  document.getElementById('hud-xpfill').style.width=(lp.progress/lp.need*100)+'%';
  document.getElementById('player-rank-display').textContent=rank.icon+' '+rank.name;
  document.getElementById('player-rank-display').style.color=rank.color;
  const pct=(lp.progress/lp.need*100)+'%';
  const mxpf=document.getElementById('menu-xp-fill');if(mxpf)mxpf.style.width=pct;
  const mxpfg=document.getElementById('menu-xp-fill-glow');if(mxpfg)mxpfg.style.width=pct;
  const mxpl=document.getElementById('menu-xp-label');
  if(mxpl)mxpl.textContent=`${lp.progress} / ${lp.need} XP ¬∑ –£—Ä–æ–≤–µ–Ω—å ${lp.level+1}`;
  updateChestDisplay();
  updateBoosterHUD();
}
function updateBoosterHUD(){
  if(!boosters)return;
  document.getElementById('cnt-shield').textContent=boosters.shield||0;
  document.getElementById('cnt-magnet').textContent=boosters.magnet||0;
  document.getElementById('cnt-turbo').textContent=boosters.turbo||0;
  const cntMega=document.getElementById('cnt-mega');if(cntMega)cntMega.textContent=boosters.mega||0;
  const bs=document.getElementById('btn-shield'),bm=document.getElementById('btn-magnet'),bt=document.getElementById('btn-turbo'),bmg=document.getElementById('btn-mega');
  bs.className='hud-boost-btn'+(activeShield?' on-shield':'');
  bm.className='hud-boost-btn'+(activeMagnet>0?' on-magnet':'');
  bt.className='hud-boost-btn'+(activeTurbo>0?' on-turbo':'');
  if(bmg)bmg.className='hud-boost-btn'+(activeMega>0?' on-turbo':'');
}
let preTurboSpeed=0;
function useBooster(type){
  if(gameState!=='playing')return;
  if(!boosters[type]||boosters[type]<=0){showToast('–ù–µ—Ç –±—É—Å—Ç–µ—Ä–∞!');return;}
  boosters[type]--;save();playBoost();
  if(type==='shield'){activeShield=true;showToast('üõ°Ô∏è –©–∏—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');}
  else if(type==='magnet'){activeMagnet=600;showToast('üß≤ –ú–∞–≥–Ω–∏—Ç!');}
  else if(type==='turbo'){if(activeTurbo<=0){preTurboSpeed=speed;speed=speed*1.35;}activeTurbo=480;showToast('‚ö° –¢—É—Ä–±–æ!');}
  else if(type==='mega'){activeMega=300;showToast('üí• –ú–µ–≥–∞-–æ–≥—É—Ä–µ—Ü! –†—É—à–∏—à—å —Ç—Ä—É–±—ã!');}
  updateBoosterHUD();
}
function buyBooster(type){
  const prices={shield:50,magnet:75,turbo:60,mega:150};
  if(cucumbers<prices[type]){showToast(`–ù—É–∂–Ω–æ ü•í${prices[type]}`);return;}
  cucumbers-=prices[type];boosters[type]=(boosters[type]||0)+1;save();
  document.getElementById('sh-n').textContent=boosters.shield||0;
  document.getElementById('mg-n').textContent=boosters.magnet||0;
  document.getElementById('tb-n').textContent=boosters.turbo||0;
  document.getElementById('mega-n').textContent=boosters.mega||0;
  document.getElementById('boost-cukes').textContent=cucumbers;
  showToast(`‚úÖ –ö—É–ø–ª–µ–Ω!`);playScore();
}

function showPets(){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('pets-gold').textContent=goldCukes;
  renderPets();
  document.getElementById('pets-screen').classList.remove('hidden');
}
function closePets(){document.getElementById('pets-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');updateHUD();}
function renderPets(){
  document.getElementById('pets-gold').textContent=goldCukes;
  const grid=document.getElementById('pets-grid');
  grid.innerHTML=PETS.map(p=>{
    const owned=ownedPets.includes(p.id);
    const sel=selectedPet===p.id;
    let cls='pet-card';if(sel)cls+=' selected';else if(owned)cls+=' owned';
    let priceHtml='';
    if(sel)priceHtml=`<div class="pet-price sel">‚úì –í–´–ë–†–ê–ù</div>`;
    else if(owned)priceHtml=`<div class="pet-price owned-lbl">–ù–ê–ñ–ú–ò –í–´–ë–†–ê–¢–¨</div>`;
    else if(p.priceGold===0)priceHtml=`<div class="pet-price" style="color:#4ade80;">–ë–ï–°–ü–õ–ê–¢–ù–û</div>`;
    else priceHtml=`<div class="pet-price">‚ú® ${p.priceGold} –∑–æ–ª–æ—Ç–∞</div>`;
    return`<div class="${cls}" onclick="petAction('${p.id}')">
      <span class="pet-emoji">${p.emoji||'‚ùå'}</span>
      <div class="pet-name">${p.name}</div>
      <div class="pet-effect">${p.desc}</div>
      ${priceHtml}
    </div>`;
  }).join('');
}
function petAction(id){
  const p=PETS.find(p=>p.id===id);if(!p)return;
  if(ownedPets.includes(id)){selectedPet=id;save();renderPets();showToast(`üêæ ${p.name} –≤—ã–±—Ä–∞–Ω!`);return;}
  if(p.priceGold===0){ownedPets.push(id);selectedPet=id;save();renderPets();showToast(`üêæ ${p.name} –ø–æ–ª—É—á–µ–Ω!`);return;}
  if(goldCukes<p.priceGold){showToast(`–ù—É–∂–Ω–æ ‚ú®${p.priceGold} –∑–æ–ª–æ—Ç–∞`);return;}
  goldCukes-=p.priceGold;ownedPets.push(id);selectedPet=id;save();
  document.getElementById('pets-gold').textContent=goldCukes;
  renderPets();showToast(`üêæ ${p.name} –∫—É–ø–ª–µ–Ω!`);
}

function showModeSelect(){
  document.getElementById('start-screen').classList.add('hidden');
  updateModeCards();
  document.getElementById('mode-screen').classList.remove('hidden');
}
function updateModeCards(){
  // Mode unlock chain: easy->normal (always open), normal->hard (bestScore normal>=50), hard->insane (bestScore hard>=50), insane->crazy (bestScore insane>=50), crazy->flip (bestScore crazy>=50), flip->zen (bestScore flip>=50)
  const modeBests=def('modeBests',{easy:0,normal:0,hard:0,insane:0,crazy:0,flip:0,zen:0});
  const unlockMap={hard:'normal',insane:'hard',crazy:'insane',flip:'crazy',zen:'flip'};
  ['hard','insane','crazy','flip','zen'].forEach(mode=>{
    const card=document.getElementById(`mc-${mode}`);if(!card)return;
    const prevMode=unlockMap[mode];
    const prevBest=(modeBests[prevMode]||0);
    const unlocked=prevBest>=50;
    if(!unlocked){
      card.style.opacity='0.4';card.style.position='relative';
      // add lock overlay if not present
      if(!card.querySelector('.mode-lock')){
        const lock=document.createElement('div');
        lock.className='mode-lock';
        lock.style.cssText='position:absolute;top:0;right:0;bottom:0;left:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);border-radius:10px;font-size:13px;font-weight:800;color:#94a3b8;';
        lock.innerHTML=`üîí 50 –±–∞—à–µ–Ω –≤ ${prevMode==='normal'?'–û–±—ã—á–Ω–æ–º':prevMode==='hard'?'–°–ª–æ–∂–Ω–æ–º':prevMode==='insane'?'–ë–µ–∑—É–º–∏–∏':prevMode==='crazy'?'–•–∞–æ—Å–µ':'–¢–æ—Ä–º–∞—à–∫–∞—Ö'}`;
        card.appendChild(lock);
      }
    } else {
      card.style.opacity='1';
      const lock=card.querySelector('.mode-lock');if(lock)lock.remove();
    }
  });
}
function modeClick(mode){
  const modeBests=def('modeBests',{easy:0,normal:0,hard:0,insane:0,crazy:0,flip:0,zen:0});
  const unlockMap={hard:'normal',insane:'hard',crazy:'insane',flip:'crazy',zen:'flip'};
  const prevMode=unlockMap[mode];
  const prevBest=(modeBests[prevMode]||0);
  if(prevBest>=50){startGame(mode);}
  else{showToast(`üîí –ü—Ä–æ–π–¥–∏ 50 –±–∞—à–µ–Ω –≤ "${prevMode}" —Ä–µ–∂–∏–º–µ!`);}
}
function closeModeSelect(){document.getElementById('mode-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}

function startGame(mode='normal'){
  gameMode=mode;initAudio();
  startMusic(mode);
  resetGame();gameState='playing';
  document.getElementById('mode-screen').classList.add('hidden');
  document.getElementById('gameover-screen').classList.add('hidden');
  const show=['hud-score','hud-currency','hud-lvl-wrap','hud-boosters','hud-shoot','hud-pause'];
  show.forEach(id=>document.getElementById(id).classList.remove('hidden'));
  document.getElementById('hud-chest')||{classList:{add:()=>{}}};
  document.getElementById('hud-chest')?.classList.add('hidden');
  // Show pet in HUD
  const petHud=document.getElementById('hud-pet');
  const activePet=PETS.find(p=>p.id===selectedPet);
  if(petHud&&activePet&&selectedPet!=='none'){petHud.textContent=activePet.emoji||'';petHud.classList.remove('hidden');}
  else if(petHud){petHud.classList.add('hidden');}
  updateHUD();
  // Motivational phrase
  const phrases=['üí™ –¢–´ –ú–û–ñ–ï–®–¨!','üî• –ñ–ì–ò!','ü•í –õ–ï–¢–ò, –û–ì–£–†–ï–¶!','‚ö° –°–ö–û–†–û–°–¢–¨!','üèÜ –ü–û–ë–ï–ô –†–ï–ö–û–†–î!','üåü –í–ï–†–Æ –í –¢–ï–ë–Ø!','üéØ –¶–ï–õ–¨–°–Ø –í –ü–û–ë–ï–î–£!','üíö –ó–ï–õ–Å–ù–ê–Ø –ú–ê–®–ò–ù–ê!','üöÄ –ü–û–ï–•–ê–õ–ò!','üß† –£–ú–ù–´–ô –û–ì–£–†–ï–¶!'];
  const p=phrases[Math.floor(Math.random()*phrases.length)];
  setTimeout(()=>showLabel(p,'#4ade80'),300);
  currentRunTrajectory=[];lastFrameTime=0;
  requestAnimationFrame(gameLoop);
}
function restartGame(){
  initAudio();startMusic(gameMode);
  resetGame();gameState='playing';
  document.getElementById('gameover-screen').classList.add('hidden');
  const petHud=document.getElementById('hud-pet');
  const activePet=PETS.find(p=>p.id===selectedPet);
  if(petHud&&activePet&&selectedPet!=='none'){petHud.textContent=activePet.emoji||'';petHud.classList.remove('hidden');}
  else if(petHud){petHud.classList.add('hidden');}
  currentRunTrajectory=[];lastFrameTime=0;
  updateHUD();requestAnimationFrame(gameLoop);
}
function goToMenu(){
  gameState='menu';
  const hide=['gameover-screen','hud-score','hud-currency','hud-lvl-wrap','hud-boosters','hud-shoot','hud-combo','hud-pet'];
  hide.forEach(id=>document.getElementById(id).classList.add('hidden'));
  const gl=document.getElementById('game-label');gl.style.animation='none';gl.style.opacity='0';
  document.getElementById('start-screen').classList.remove('hidden');
  updateHUD();drawBg();startAnimateBg();
}

function shareToTelegram(){
  const rank=getRank();
  const mn={easy:'–õ—ë–≥–∫–æ–º',normal:'–û–±—ã—á–Ω–æ–º',hard:'–°–ª–æ–∂–Ω–æ–º',insane:'–ë–µ–∑—É–º–∏–∏',crazy:'–•–∞–æ—Å–µ',flip:'–í–≤–µ—Ä—Ö —Ç–æ—Ä–º–∞—à–∫–∞–º–∏',zen:'–î–∑–µ–Ω'};
  const txt=`ü•í Flappy Cucumber!\n–°—á—ë—Ç: ${score} (${mn[gameMode]||''})\n–†–µ–∫–æ—Ä–¥: ${bestScore}\n–†–∞–Ω–≥: ${rank.icon} ${rank.name}\nXP: ${playerXP}\n\n–ü–æ–±–µ–π –º–æ–π —Ä–µ–∫–æ—Ä–¥!`;
  window.open(`https://t.me/share/url?url=https://flappycucumber.app&text=${encodeURIComponent(txt)}`,'_blank');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let carIdx=0,shopTab='skins';
function showShop(){document.getElementById('start-screen').classList.add('hidden');shopTab='skins';carIdx=0;renderShopTabs();renderCarousel();document.getElementById('shop-screen').classList.remove('hidden');}
function closeShop(){document.getElementById('shop-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');updateHUD();updateActivePetDisplay();}
function setShopTab(t){shopTab=t;carIdx=0;resetCarouselVpOverflow();renderShopTabs();renderCarousel();}
function renderShopTabs(){['skins','worlds','trails','upg','pets'].forEach(t=>{const el=document.getElementById(`stab-${t}`);if(el)el.className='shop-tab'+(shopTab===(t==='upg'?'upgrades':t)?' active':'');});}

function renderCarousel(){
  document.getElementById('shop-cukes').textContent=cucumbers;
  document.getElementById('shop-gold').textContent=goldCukes;
  const track=document.getElementById('carousel-track');track.innerHTML='';
  const isUpgrade=shopTab==='upgrades';
  const isPets=shopTab==='pets';
  if(isUpgrade){renderUpgradesInCarousel(track);document.getElementById('shop-action-btn').style.display='none';return;}
  if(isPets){renderPetsInCarousel(track);document.getElementById('shop-action-btn').style.display='none';return;}
  document.getElementById('shop-action-btn').style.display='';
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  items.forEach(item=>{
    const ownedArr=shopTab==='skins'?ownedSkins:shopTab==='worlds'?ownedWorlds:ownedTrails;
    const selId=shopTab==='skins'?selectedSkin:shopTab==='worlds'?selectedWorld:selectedTrail;
    const owned=ownedArr.includes(item.id),sel=selId===item.id;
    const slide=document.createElement('div');slide.className='carousel-slide';
    let cls='skin-card';if(sel)cls+=' selected';else if(owned)cls+=' owned';
    const card=document.createElement('div');card.className=cls;
    if(shopTab==='skins'){
      const wrap=document.createElement('div');wrap.className='skin-canvas-wrap';
      const mc=document.createElement('canvas');mc.width=68;mc.height=105;
      const mctx=mc.getContext('2d');
      if(item.secret&&!owned){mctx.fillStyle='rgba(167,139,250,.15)';mctx.beginPath();mctx.arc(34,52,30,0,Math.PI*2);mctx.fill();mctx.fillStyle='#a78bfa';mctx.font='bold 36px Nunito';mctx.textAlign='center';mctx.textBaseline='middle';mctx.fillText('?',34,52);}
      else drawCucumber(mctx,34,52,98,item.id,0,0);
      wrap.appendChild(mc);card.appendChild(wrap);
    } else if(shopTab==='worlds'){
      const wp=document.createElement('div');wp.style.cssText='width:100%;height:75px;border-radius:9px;margin-bottom:7px;overflow:hidden;';
      const wc=document.createElement('canvas');wc.width=190;wc.height=75;wc.style.cssText='width:100%;height:100%;';
      const wctx=wc.getContext('2d');const wg=wctx.createLinearGradient(0,0,0,75);wg.addColorStop(0,item.bg[0]);wg.addColorStop(.5,item.bg[1]);wg.addColorStop(1,item.bg[2]);wctx.fillStyle=wg;wctx.fillRect(0,0,190,75);
      wctx.fillStyle=item.pipeCap;wctx.shadowColor=item.pipeCap;wctx.shadowBlur=5;
      [[28,0,22,26],[28,50,22,25],[105,0,22,17],[105,58,22,17]].forEach(([x,y,w,h])=>{wctx.beginPath();wctx.roundRect(x,y,w,h,3);wctx.fill();});
      wctx.shadowBlur=0;wctx.fillStyle=item.groundTop;wctx.fillRect(0,68,190,3);
      wp.appendChild(wc);card.appendChild(wp);
    } else {
      // trail preview
      const tc=document.createElement('canvas');tc.width=100;tc.height=145;
      const tctx=tc.getContext('2d');
      if(item.color){const pts=26;for(let i=0;i<pts;i++){const x=50+Math.sin(i*.35)*22,y=12+i*3.5;tctx.globalAlpha=(i/pts)*.95;tctx.fillStyle=item.color[i%item.color.length];tctx.shadowColor=item.color[i%item.color.length];tctx.shadowBlur=7;tctx.beginPath();tctx.arc(x,y,4.5,0,Math.PI*2);tctx.fill();tctx.shadowBlur=0;}tctx.globalAlpha=1;}
      else{tctx.fillStyle='#475569';tctx.font='bold 14px Nunito';tctx.textAlign='center';tctx.textBaseline='middle';tctx.fillText('–Ω–µ—Ç',50,50);}
      drawCucumber(tctx,50,112,65,selectedSkin,0,0);
      tc.style.cssText='display:block;margin:0 auto 7px;';card.appendChild(tc);
    }
    const nm=document.createElement('div');nm.className='skin-name';nm.textContent=(item.secret&&!owned)?'???':item.name;card.appendChild(nm);
    const pr=document.createElement('div');
    if(sel){pr.className='skin-price lbl-selected';pr.textContent='‚úì –í–´–ë–†–ê–ù';}
    else if(owned){pr.className='skin-price lbl-owned';pr.textContent='–ù–ê–ñ–ú–ò –í–´–ë–†–ê–¢–¨';}
    else if(item.secret){pr.className='skin-price';pr.style.color='#a78bfa';pr.textContent='–ù–ê–ë–ï–ô 50 –ë–ê–®–ï–ù';}
    else if(item.goldOnly){pr.className='skin-price';pr.style.color='#FFD700';pr.textContent=`‚ú® ${item.priceGold} –∑–æ–ª–æ—Ç–∞`;}
    else if(item.price===0){pr.className='skin-price';pr.textContent='–ë–ï–°–ü–õ–ê–¢–ù–û';}
    else{pr.className='skin-price';pr.textContent=`ü•í ${item.price}`;}
    card.appendChild(pr);
    if(item.id==='king'){const b=document.createElement('div');b.className='skin-badge';b.style.background='#ef4444';b.textContent='–•–ò–¢';card.appendChild(b);}
    if(item.goldOnly){const b=document.createElement('div');b.className='skin-badge';b.style.background='#FFD700';b.style.color='#000';b.textContent='–ó–û–õ–û–¢–û';card.appendChild(b);}
    slide.appendChild(card);track.appendChild(slide);
  });
  updCarPos();updDots();updShopBtn();
}

function renderUpgradesInCarousel(track){
  // For upgrades: use a scrollable grid, bypass carousel transform
  const outer=document.getElementById('shop-carr-outer');
  outer.querySelector('.carousel-vp').style.overflow='visible';
  const slide=document.createElement('div');slide.className='carousel-slide';
  slide.style.cssText='min-width:100%;display:block;padding:0 4px;';
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;';
  UPGRADES.forEach(u=>{
    const lv=upgradelevels[u.id]||0,maxed=lv>=u.maxLevel,cost=getUpgradeCost(u.id);
    const card=document.createElement('div');
    card.className='upgrade-card'+(maxed?' maxed':'');
    card.style.cssText='cursor:pointer;';
    card.innerHTML=`<span class="upg-icon">${u.icon}</span>
      <div class="upg-name" style="font-size:12px;font-weight:800;">${u.name}</div>
      <div class="upg-desc" style="font-size:11px;">${u.desc}</div>
      <div class="upg-level" style="font-size:13px;margin:4px 0;">${'‚òÖ'.repeat(lv)}${'‚òÜ'.repeat(u.maxLevel-lv)}</div>
      <div class="upg-price" style="font-size:13px;">${maxed?'‚úÖ –ú–ê–ö–°':('ü•í '+cost)}</div>`;
    if(!maxed)card.onclick=()=>{
      if(cucumbers<cost){showToast(`–ù—É–∂–Ω–æ ü•í${cost}`);return;}
      cucumbers-=cost;upgradelevels[u.id]=(upgradelevels[u.id]||0)+1;save();
      showToast(`‚úÖ ${u.name} —É–ª—É—á—à–µ–Ω!`);playScore();renderCarousel();
    };
    grid.appendChild(card);
  });
  slide.appendChild(grid);track.appendChild(slide);
  document.getElementById('carousel-dots').innerHTML='';
  // Ensure carousel track is at position 0 for upgrades
  const tr=document.getElementById('carousel-track');if(tr)tr.style.transform='translateX(0)';
}
function resetCarouselVpOverflow(){
  const outer=document.getElementById('shop-carr-outer');
  if(outer)outer.querySelector('.carousel-vp').style.overflow='hidden';
}

function renderPetsInCarousel(track){
  const outer=document.getElementById('shop-carr-outer');
  outer.querySelector('.carousel-vp').style.overflow='visible';
  const slide=document.createElement('div');slide.className='carousel-slide';
  slide.style.cssText='min-width:100%;display:block;padding:0 4px;';
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;';
  PETS.forEach(p=>{
    const owned=ownedPets.includes(p.id),sel=selectedPet===p.id;
    const card=document.createElement('div');
    let cls='pet-card';if(sel)cls+=' selected';else if(owned)cls+=' owned';
    card.className=cls;
    card.style.cssText='cursor:pointer;';
    let priceHtml='';
    if(sel)priceHtml=`<div class="pet-price sel">‚úì –í–´–ë–†–ê–ù</div>`;
    else if(owned)priceHtml=`<div class="pet-price owned-lbl">–ù–ê–ñ–ú–ò –í–´–ë–†–ê–¢–¨</div>`;
    else if(p.priceGold===0)priceHtml=`<div class="pet-price" style="color:#4ade80;">–ë–ï–°–ü–õ–ê–¢–ù–û</div>`;
    else priceHtml=`<div class="pet-price">‚ú® ${p.priceGold} –∑–æ–ª–æ—Ç–∞</div>`;
    card.innerHTML=`<span class="pet-emoji">${p.emoji||'‚ùå'}</span><div class="pet-name">${p.name}</div><div class="pet-effect">${p.desc}</div>${priceHtml}`;
    card.onclick=()=>{petAction(p.id);renderCarousel();updateActivePetDisplay();};
    grid.appendChild(card);
  });
  slide.appendChild(grid);track.appendChild(slide);
  document.getElementById('carousel-dots').innerHTML='';
  const tr=document.getElementById('carousel-track');if(tr)tr.style.transform='translateX(0)';
}

function renderBoostersInCarousel(track){
  const outer=document.getElementById('shop-carr-outer');
  outer.querySelector('.carousel-vp').style.overflow='visible';
  const slide=document.createElement('div');slide.className='carousel-slide';
  slide.style.cssText='min-width:100%;display:block;padding:0 4px;';
  const boosts=[
    {type:'shield',icon:'üõ°Ô∏è',name:'–©–ò–¢',desc:'1 —Å–ø–∞—Å–µ–Ω–∏–µ –æ—Ç —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è',price:50,countId:'shield'},
    {type:'magnet',icon:'üß≤',name:'–ú–ê–ì–ù–ò–¢',desc:'–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –º–æ–Ω–µ—Ç—ã 10—Å',price:75,countId:'magnet'},
    {type:'turbo', icon:'‚ö°',name:'–¢–£–†–ë–û', desc:'+30% —Å–∫–æ—Ä–æ—Å—Ç—å 8—Å',price:60,countId:'turbo'},
    {type:'mega',  icon:'üí•',name:'–ú–ï–ì–ê-–û–ì–£–†–ï–¶',desc:'–†–∞–∑—Ä—É—à–∞–π —Ç—Ä—É–±—ã 5—Å!',price:150,countId:'mega'},
  ];
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;';
  boosts.forEach(b=>{
    const card=document.createElement('div');
    card.className='boost-card';card.style.cssText='border-radius:14px;padding:12px 8px;text-align:center;background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);';
    card.innerHTML=`<span class="boost-icon">${b.icon}</span>
      <div class="boost-name">${b.name}</div>
      <div class="boost-desc">${b.desc}</div>
      <div class="boost-cnt-txt">x<span id="sh2-${b.type}">${boosters[b.type]||0}</span></div>
      <div class="boost-price">ü•í ${b.price}</div>
      <button class="boost-buy-btn" style="margin-top:6px;" onclick="buyBoosterShop('${b.type}',${b.price})">–ö–£–ü–ò–¢–¨</button>`;
    grid.appendChild(card);
  });
  slide.appendChild(grid);track.appendChild(slide);
  document.getElementById('carousel-dots').innerHTML='';
  const tr=document.getElementById('carousel-track');if(tr)tr.style.transform='translateX(0)';
}

function buyBoosterShop(type,price){
  if(cucumbers<price){showToast(`–ù—É–∂–Ω–æ ü•í${price}`);return;}
  cucumbers-=price;boosters[type]=(boosters[type]||0)+1;save();
  const el=document.getElementById(`sh2-${type}`);if(el)el.textContent=boosters[type];
  document.getElementById('shop-cukes').textContent=cucumbers;
  showToast(`‚úÖ ${type} –∫—É–ø–ª–µ–Ω!`);playScore();updateBoosterHUD();
}

function updateActivePetDisplay(){
  const pet=PETS.find(p=>p.id===selectedPet);
  // Quick selector - skin
  const qsc=document.getElementById('qs-skin-canvas');
  if(qsc){const qctx=qsc.getContext('2d');qctx.clearRect(0,0,36,56);drawCucumber(qctx,18,28,52,selectedSkin,0,0);}
  const qsn=document.getElementById('qs-skin-name');
  if(qsn){const sk=SKINS.find(s=>s.id===selectedSkin);qsn.textContent=sk?sk.name:'–î–µ—Ñ–æ–ª—Ç';}
  // Quick selector - world
  const qwc=document.getElementById('qs-world-canvas');
  if(qwc){const W2=WORLDS.find(w=>w.id===selectedWorld)||WORLDS[0];const wctx=qwc.getContext('2d');wctx.clearRect(0,0,50,36);const wg=wctx.createLinearGradient(0,0,0,36);wg.addColorStop(0,W2.bg[0]);wg.addColorStop(.5,W2.bg[1]);wg.addColorStop(1,W2.bg[2]);wctx.fillStyle=wg;wctx.fillRect(0,0,50,36);wctx.fillStyle=W2.pipeCap;wctx.shadowColor=W2.pipeCap;wctx.shadowBlur=4;[[5,0,12,10],[5,26,12,10],[30,0,12,6],[30,30,12,6]].forEach(([x,y,w,h])=>{wctx.beginPath();wctx.roundRect(x,y,w,h,2);wctx.fill();});wctx.shadowBlur=0;wctx.fillStyle=W2.groundTop;wctx.fillRect(0,33,50,3);}
  const qwn=document.getElementById('qs-world-name');
  if(qwn){const wld=WORLDS.find(w=>w.id===selectedWorld);qwn.textContent=wld?wld.name:'–õ–µ—Å';}
  // Quick selector - pet
  const qpe=document.getElementById('qs-pet-emoji');if(qpe)qpe.textContent=pet&&selectedPet!=='none'?pet.emoji:'ü•ö';
  const qpn=document.getElementById('qs-pet-name');if(qpn)qpn.textContent=pet&&selectedPet!=='none'?pet.name:'–ù–µ—Ç';
  // Quick selector - trail
  const qtc=document.getElementById('qs-trail-canvas');
  if(qtc){const tctx=qtc.getContext('2d');tctx.clearRect(0,0,36,36);const trail=TRAILS.find(t=>t.id===selectedTrail);if(trail&&trail.color){for(let i=0;i<10;i++){tctx.globalAlpha=i/10*.8;tctx.fillStyle=trail.color[i%trail.color.length];tctx.beginPath();tctx.arc(18+Math.sin(i*.6)*8,5+i*2.8,3,0,Math.PI*2);tctx.fill();}tctx.globalAlpha=1;}else{tctx.fillStyle='#475569';tctx.font='bold 9px Nunito';tctx.textAlign='center';tctx.textBaseline='middle';tctx.fillText('–Ω–µ—Ç',18,18);}}
  const qtn=document.getElementById('qs-trail-name');
  if(qtn){const tr=TRAILS.find(t=>t.id===selectedTrail);qtn.textContent=tr?tr.name:'–ù–µ—Ç';}
}

function updCarPos(){const tr=document.getElementById('carousel-track');if(tr)tr.style.transform=`translateX(-${carIdx*100}%)`;}
function updDots(){
  const dots=document.getElementById('carousel-dots');dots.innerHTML='';
  if(shopTab==='upgrades')return;
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  items.forEach((_,i)=>{const d=document.createElement('div');d.className='dot'+(i===carIdx?' active':'');d.onclick=()=>{carIdx=i;updCarPos();updDots();updShopBtn();};dots.appendChild(d);});
}
function updShopBtn(){
  if(shopTab==='upgrades')return;
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  const item=items[carIdx];if(!item)return;
  const btn=document.getElementById('shop-action-btn');
  const ownedArr=shopTab==='skins'?ownedSkins:shopTab==='worlds'?ownedWorlds:ownedTrails;
  const selId=shopTab==='skins'?selectedSkin:shopTab==='worlds'?selectedWorld:selectedTrail;
  const owned=ownedArr.includes(item.id),sel=selId===item.id;
  if(sel){btn.textContent='‚úì –í–´–ë–†–ê–ù';btn.style.opacity='.5';}
  else if(owned){btn.textContent='–í–´–ë–†–ê–¢–¨';btn.style.opacity='1';}
  else if(item.secret){btn.textContent='üîí 50 –ë–ê–®–ï–ù';btn.style.opacity='.7';}
  else if(item.goldOnly){btn.textContent=`‚ú® ${item.priceGold} –∑–æ–ª–æ—Ç–∞`;btn.style.opacity='1';}
  else if(item.price===0){btn.textContent='–ü–û–õ–£–ß–ò–¢–¨';btn.style.opacity='1';}
  else{btn.textContent=`–ö–£–ü–ò–¢–¨ ü•í${item.price}`;btn.style.opacity='1';}
}
function carPrev(){if(carIdx>0){carIdx--;updCarPos();updDots();updShopBtn();}}
function carNext(){const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;const len=shopTab==='upgrades'?0:items.length;if(carIdx<len-1){carIdx++;updCarPos();updDots();updShopBtn();}}
function shopAction(){
  if(shopTab==='upgrades')return;
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  const item=items[carIdx];if(!item)return;
  const ownedArr=shopTab==='skins'?ownedSkins:shopTab==='worlds'?ownedWorlds:ownedTrails;
  if(item.secret&&!ownedArr.includes(item.id)){showToast('üîí –ù–∞–±–µ–π 50 –±–∞—à–µ–Ω!');return;}
  if(ownedArr.includes(item.id)){
    if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;else selectedTrail=item.id;
    save();renderCarousel();showToast('‚úÖ –í—ã–±—Ä–∞–Ω–æ!');return;
  }
  if(item.goldOnly){
    if(goldCukes<item.priceGold){showToast(`–ù—É–∂–Ω–æ ‚ú®${item.priceGold} –∑–æ–ª–æ—Ç–∞`);return;}
    goldCukes-=item.priceGold;ownedArr.push(item.id);
    if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;
    save();renderCarousel();playScore();showToast(`‚úÖ ${item.name} –∫—É–ø–ª–µ–Ω –∑–∞ –∑–æ–ª–æ—Ç–æ!`);return;
  }
  if(item.price===0){ownedArr.push(item.id);if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;else selectedTrail=item.id;save();renderCarousel();playScore();return;}
  if(cucumbers<item.price){showToast(`–ù—É–∂–Ω–æ ü•í${item.price}`);return;}
  cucumbers-=item.price;ownedArr.push(item.id);
  if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;else selectedTrail=item.id;
  save();renderCarousel();playScore();showToast(`‚úÖ ${item.name} –∫—É–ø–ª–µ–Ω!`);
}
let swipeStart=0;
document.getElementById('carousel-track').addEventListener('touchstart',e=>{swipeStart=e.touches[0].clientX;},{passive:true});
document.getElementById('carousel-track').addEventListener('touchend',e=>{const dx=swipeStart-e.changedTouches[0].clientX;if(dx>40)carNext();else if(dx<-40)carPrev();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOST SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showBoostShop(){document.getElementById('start-screen').classList.add('hidden');document.getElementById('boost-cukes').textContent=cucumbers;document.getElementById('sh-n').textContent=boosters.shield||0;document.getElementById('mg-n').textContent=boosters.magnet||0;document.getElementById('tb-n').textContent=boosters.turbo||0;document.getElementById('mega-n').textContent=boosters.mega||0;document.getElementById('boost-screen').classList.remove('hidden');}
function closeBoostShop(){document.getElementById('boost-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');updateHUD();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STICKERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkStickers(){
  let newS=[];
  STICKERS.forEach(s=>{if(!unlockedStickers.includes(s.id)&&s.check()){unlockedStickers.push(s.id);newS.push(s);}});
  if(newS.length){save();newS.forEach((s,i)=>setTimeout(()=>showStickerNotif(s),i*1800));}
}
function showStickerNotif(s){
  const el=document.getElementById('sticker-notif');
  el.innerHTML=`${s.emoji}<br>–ù–∞–∫–ª–µ–π–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞!<br>${s.name}`;
  el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2500);
}
function showStickers(){_arTab='stickers';showAchievements();}
function closeStickers(){closeAchievements();}
function renderStickers(){renderStickerGrid2();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL LEADERBOARD (shared across all players)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LB_KEY='fc_v4_global_leaderboard';
let globalLBCache=null;

async function loadGlobalLB(){
  try{
    const res=await window.storage?.get(LB_KEY,true);
    if(res&&res.value){globalLBCache=JSON.parse(res.value);return globalLBCache;}
  }catch(e){}
  // fallback to localStorage
  try{const d=localStorage.getItem('fc_global_lb');if(d){globalLBCache=JSON.parse(d);return globalLBCache;}}catch(e){}
  return [];
}

async function saveGlobalLB(lb){
  globalLBCache=lb;
  const json=JSON.stringify(lb);
  try{await window.storage?.set(LB_KEY,json,true);}catch(e){}
  try{localStorage.setItem('fc_global_lb',json);}catch(e){}
}

async function submitScore(){
  if(!playerNickname||bestScore<=0)return;
  const myId=tgUserId?String(tgUserId):('g_'+(playerNickname.toLowerCase().replace(/\s/g,'_')));
  let lb=await loadGlobalLB()||[];
  const existing=lb.find(e=>e.uid===myId);
  const entry={uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon,ts:Date.now()};
  if(existing){if(bestScore>=existing.score)Object.assign(existing,entry);}
  else lb.push(entry);
  lb.sort((a,b)=>b.score-a.score);lb=lb.slice(0,100);
  await saveGlobalLB(lb);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEADERBOARD SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateLeaderboard(){save();submitScore();}
function showLeaderboard(){
  document.getElementById('start-screen').classList.add('hidden');
  renderLeaderboard();
  document.getElementById('leaderboard-screen').classList.remove('hidden');
}
function closeLeaderboard(){document.getElementById('leaderboard-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}

async function renderLeaderboard(){
  const listEl=document.getElementById('lb-list');
  listEl.innerHTML='<div style="text-align:center;color:#4ade80;padding:20px;font-size:14px;font-weight:800;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  let lb=await loadGlobalLB()||[];
  // Ensure current player is included
  const myId=tgUserId?String(tgUserId):('g_'+(playerNickname||'').toLowerCase().replace(/\s/g,'_'));
  if(playerNickname&&bestScore>0){
    const ex=lb.find(e=>e.uid===myId);
    if(!ex)lb.push({uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon,ts:Date.now()});
    else if(bestScore>ex.score){ex.score=bestScore;ex.skin=selectedSkin;ex.rank=getRank().icon;}
  }
  lb.sort((a,b)=>b.score-a.score);
  if(lb.length<5){
    const demo=[{uid:'_d1',name:'Pickle_Pro',score:74,skin:'king',rank:'üëë'},{uid:'_d2',name:'SpeedCuke',score:61,skin:'fire',rank:'üî•'},{uid:'_d3',name:'Alien_Bot',score:49,skin:'alien',rank:'üíé'}];
    demo.forEach(d=>{if(!lb.find(e=>e.uid===d.uid))lb.push(d);});
    lb.sort((a,b)=>b.score-a.score);
  }
  lb=lb.slice(0,20);
  const medals=['ü•á','ü•à','ü•â'],cls=['r1','r2','r3'];
  listEl.innerHTML=lb.map((e,i)=>{
    const isMe=e.uid===myId;
    return`<div class="lb-entry${isMe?' me':''}">
      <div class="lb-rank ${cls[i]||''}">${i<3?medals[i]:'#'+(i+1)}</div>
      <div class="lb-sp" id="lbsp${i}"><canvas width="26" height="26"></canvas></div>
      <div class="lb-name">${e.name}${isMe?' <span style="color:#38bdf8;font-size:11px">‚Üê –í–´</span>':''} <span style="color:#a78bfa;font-size:11px">${e.rank||''}</span></div>
      <div class="lb-score">${e.score}</div>
    </div>`;
  }).join('');
  lb.forEach((e,i)=>{
    const w=document.getElementById(`lbsp${i}`);
    if(w)drawCucumber(w.querySelector('canvas').getContext('2d'),13,13,24,e.skin||'default',0,0);
  });
  // Change nick button
  const lbEl=document.getElementById('leaderboard-screen');
  if(!document.getElementById('lb-nick-btn')){
    const nb=document.createElement('button');nb.id='lb-nick-btn';
    nb.className='btn blue';nb.style.cssText='margin-top:8px;width:100%;max-width:340px;flex-shrink:0;';
    nb.textContent='‚úèÔ∏è –ò–ó–ú–ï–ù–ò–¢–¨ –ù–ò–ö';
    nb.onclick=()=>{document.getElementById('nick-input').value=playerNickname||'';document.getElementById('nick-modal').classList.remove('hidden');};
    const closeBtn=lbEl.querySelector('button[id="btn-lb-back"]');
    if(closeBtn)lbEl.insertBefore(nb,closeBtn);else lbEl.appendChild(nb);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACHIEVEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ACHIEVS=[
  {id:'first_blood',icon:'ü•í',name:'–ü–µ—Ä–≤—ã–π –ø–æ–ª—ë—Ç',   desc:'–°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—É—é –∏–≥—Ä—É',    reward:10, check:()=>totalGames>=1},
  {id:'score10',    icon:'üéØ',name:'–ù–æ–≤–∏—á–æ–∫',         desc:'–ü—Ä–æ–π–¥–∏ 10 –±–∞—à–µ–Ω',       reward:20, check:()=>bestScore>=10},
  {id:'score25',    icon:'üî•',name:'–ì–æ—Ä—è—á–æ!',          desc:'–ü—Ä–æ–π–¥–∏ 25 –±–∞—à–µ–Ω',       reward:50, check:()=>bestScore>=25},
  {id:'score50',    icon:'üíé',name:'–ú–∞—Å—Ç–µ—Ä',           desc:'–ü—Ä–æ–π–¥–∏ 50 –±–∞—à–µ–Ω',       reward:100,check:()=>bestScore>=50},
  {id:'score100',   icon:'üëë',name:'–õ–µ–≥–µ–Ω–¥–∞',          desc:'–ü—Ä–æ–π–¥–∏ 100 –±–∞—à–µ–Ω',      reward:300,check:()=>bestScore>=100},
  {id:'coins50',    icon:'üí∞',name:'–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',     desc:'50 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',        reward:30, check:()=>totalCoins>=50},
  {id:'coins200',   icon:'ü§ë',name:'–ë–æ–≥–∞—á',             desc:'200 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',       reward:80, check:()=>totalCoins>=200},
  {id:'coins500',   icon:'üíé',name:'–°–æ–∫—Ä–æ–≤–∏—â–µ',        desc:'500 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',       reward:200,check:()=>totalCoins>=500},
  {id:'games10',    icon:'üéÆ',name:'–ó–∞–≤—Å–µ–≥–¥–∞—Ç–∞–π',      desc:'–°—ã–≥—Ä–∞–π 10 –∏–≥—Ä',         reward:40, check:()=>totalGames>=10},
  {id:'all_skins',  icon:'üåà',name:'–ö–æ–ª–ª–µ–∫—Ü–∏—è',        desc:'–ö—É–ø–∏ 4 —Å–∫–∏–Ω–∞',           reward:150,check:()=>ownedSkins.length>=4},
  {id:'divine',     icon:'‚ú®',name:'–ò–∑–±—Ä–∞–Ω–Ω—ã–π',         desc:'–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π Divine',    reward:200,check:()=>ownedSkins.includes('secret')},
  {id:'level5',     icon:'‚≠ê',name:'–ü—Ä–æ—Ñ–∏',             desc:'5 —É—Ä–æ–≤–µ–Ω—å',             reward:100,check:()=>playerLevel>=5},
  {id:'boss_kill',  icon:'üëπ',name:'–£–±–∏–π—Ü–∞ –±–æ—Å—Å–æ–≤',    desc:'–ü–æ–±–µ–¥–∏ 3 –±–æ—Å—Å–æ–≤',       reward:150,check:()=>bossesDefeated>=3},
  {id:'box_shooter',icon:'üì¶',name:'–°–Ω–∞–π–ø–µ—Ä',          desc:'–†–∞–∑—Ä—É—à–∏ 10 —è—â–∏–∫–æ–≤',     reward:80, check:()=>boxesDestroyed>=10},
  {id:'combo_king', icon:'üå∂Ô∏è',name:'–ö–æ–º–±–æ-–ö–∏–Ω–≥',       desc:'–ê–∫—Ç–∏–≤–∏—Ä—É–π –∫–æ–º–±–æ',       reward:60, check:()=>combosActivated>=1},
  {id:'zen30',      icon:'üçÉ',name:'–î–∑–µ–Ω-–Ω–æ–≤–∏—á–æ–∫',     desc:'30 —Å–µ–∫ –≤ –î–∑–µ–Ω-—Ä–µ–∂–∏–º–µ',  reward:50, check:()=>zenSeconds>=30},
];
function checkAchievements(){
  let newO=[];
  ACHIEVS.forEach(a=>{if(!unlockedAchievs.includes(a.id)&&a.check()){unlockedAchievs.push(a.id);cucumbers+=a.reward;newO.push(a);}});
  if(newO.length){save();setTimeout(()=>newO.forEach((a,i)=>setTimeout(()=>showToast(`üèÖ ${a.name}! +${a.reward}ü•í`),i*1400)),500);}
}
let _arTab='achiev';
function setArTab(tab){
  _arTab=tab;
  ['achiev','ranks','stickers'].forEach(t=>{
    document.getElementById(`ar-tab-${t}`).className='ar-tab'+(tab===t?' active':'');
    document.getElementById(`ar-${t}-pane`).classList.toggle('hidden',tab!==t);
  });
  if(tab==='ranks')renderRanksList();
  if(tab==='stickers')renderStickerGrid2();
}
function renderRanksList(){
  const cur=getRank();
  const rl=document.getElementById('ranks-list');
  if(!rl)return;
  rl.innerHTML=RANKS.map(r=>{
    const done=playerXP>=r.xpRequired,isCur=r.name===cur.name;
    return`<div style="display:flex;align-items:center;background:rgba(255,255,255,.04);border:1px solid ${isCur?'#fbbf24':done?'rgba(74,222,128,.3)':'rgba(255,255,255,.06)'};border-radius:14px;padding:11px 14px;margin-bottom:8px;gap:12px;${isCur?'background:rgba(251,191,36,.1);box-shadow:0 0 16px rgba(251,191,36,.15);':''}opacity:${done?1:.4};">
      <div style="font-size:26px;flex-shrink:0;">${r.icon}</div>
      <div style="flex:1;"><div style="font-size:14px;font-weight:800;color:${r.color};margin-bottom:2px;">${r.name}</div><div style="font-size:11px;color:#64748b;font-weight:700;">XP: ${r.xpRequired}</div></div>
      ${isCur?'<div style="font-size:11px;color:#fbbf24;font-weight:800;">‚Üê –í–´</div>':done?'<div style="font-size:14px;">‚úÖ</div>':'<div style="font-size:11px;color:#475569;">üîí</div>'}
    </div>`;
  }).join('');
}
function renderStickerGrid2(){
  const grid=document.getElementById('sticker-grid2');if(!grid)return;
  grid.innerHTML=STICKERS.map(s=>{const got=unlockedStickers.includes(s.id);return`<div class="sticker-card ${got?'got':'locked'}"><span class="sticker-emoji">${got?s.emoji:'‚ùì'}</span><div class="sticker-name">${got?s.name:'???'}</div><div class="sticker-req">${s.req}</div></div>`;}).join('');
}
function showAchievements(){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('ar-achiev-pane').innerHTML=ACHIEVS.map(a=>{const d=unlockedAchievs.includes(a.id);return`<div class="achiev-card ${d?'unlocked':'locked'}"><span class="achiev-icon">${a.icon}</span><div class="achiev-name">${a.name}</div><div class="achiev-desc">${a.desc}</div><div class="achiev-reward">+${a.reward}ü•í</div>${d?'<div class="achiev-done">‚úÖ</div>':''}</div>`;}).join('');
  setArTab(_arTab);
  document.getElementById('achiev-screen').classList.remove('hidden');
}
function closeAchievements(){document.getElementById('achiev-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}
// Legacy showRanks - redirect to unified screen
function showRanks(){_arTab='ranks';showAchievements();}
function closeRanks(){closeAchievements();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORTUNE WHEEL (redesigned)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Prize distribution: ~65% cukes, ~15% xp/boosters, ~15% gold, ~5% skin
const WHEEL_PRIZES=[
  // cukes - 8 slots (most common)
  {label:'20 ü•í',  value:20,  type:'cukes',       color:'#15803d', emoji:'ü•í',    rare:false},
  {label:'50 ü•í',  value:50,  type:'cukes',       color:'#16a34a', emoji:'ü•íü•í',  rare:false},
  {label:'10 ü•í',  value:10,  type:'cukes',       color:'#14532d', emoji:'ü•í',    rare:false},
  {label:'30 ü•í',  value:30,  type:'cukes',       color:'#22c55e', emoji:'ü•í',    rare:false},
  {label:'75 ü•í',  value:75,  type:'cukes',       color:'#4ade80', emoji:'ü•íüí∞',  rare:false},
  {label:'15 ü•í',  value:15,  type:'cukes',       color:'#166534', emoji:'ü•í',    rare:false},
  {label:'100 ü•í', value:100, type:'cukes',       color:'#dcfce7', emoji:'ü•íü•íü•í',rare:false},
  {label:'25 ü•í',  value:25,  type:'cukes',       color:'#86efac', emoji:'ü•í',    rare:false},
  // boosters - 2 slots (uncommon)
  {label:'üõ°Ô∏è –©–ò–¢', value:0,  type:'boost_shield',color:'#0284c7', emoji:'üõ°Ô∏è',    rare:false},
  {label:'50 XP',   value:50, type:'xp',          color:'#92400e', emoji:'‚≠ê',    rare:false},
  // gold - 3 slots (rare) 
  {label:'3 ‚ú® –ó–û–õ',value:3,  type:'gold',        color:'#FFD700', emoji:'‚ú®‚ú®‚ú®', rare:true},
  {label:'5 ‚ú® –ó–û–õ',value:5,  type:'gold',        color:'#f59e0b', emoji:'‚ú®‚ú®',   rare:true},
  {label:'10‚ú® –ó–û–õ', value:10, type:'gold',       color:'#d97706', emoji:'‚ú®üëë',   rare:true},
  // skin - 1 slot (very rare)
  {label:'üé® –°–ö–ò–ù!',value:0,  type:'skin',        color:'#7c3aed', emoji:'üé®üåü',  rare:true},
];
let wheelAngle=0,wheelSpinning=false,_wHeroFrame=0,_wHeroRaf=null;

function drawWheel(){
  const wc=document.getElementById('wheel-canvas');if(!wc)return;
  const wctx=wc.getContext('2d');
  const CW=wc.width,CH=wc.height,cx=CW/2,cy=CH/2;
  const r=cx*0.78; // main wheel radius
  const rimW=cx*0.115; // gold rim width
  const n=WHEEL_PRIZES.length,arc=Math.PI*2/n;
  wctx.clearRect(0,0,CW,CH);

  // === OUTER GLOW ===
  const glowGrad=wctx.createRadialGradient(cx,cy,r+rimW,cx,cy,r+rimW+20);
  glowGrad.addColorStop(0,'rgba(255,215,0,.35)');
  glowGrad.addColorStop(1,'rgba(255,165,0,0)');
  wctx.fillStyle=glowGrad;
  wctx.beginPath();wctx.arc(cx,cy,r+rimW+20,0,Math.PI*2);wctx.fill();

  // === GOLD RIM - multi-layer ===
  // Dark shadow ring
  const shadowRing=wctx.createRadialGradient(cx,cy+4,r-2,cx,cy+4,r+rimW+4);
  shadowRing.addColorStop(0,'rgba(0,0,0,0)');shadowRing.addColorStop(.6,'rgba(0,0,0,.4)');shadowRing.addColorStop(1,'rgba(0,0,0,0)');
  wctx.fillStyle=shadowRing;wctx.beginPath();wctx.arc(cx,cy+4,r+rimW+4,0,Math.PI*2);wctx.fill();
  // Main gold ring
  const rimGrad=wctx.createRadialGradient(cx,cy,r-2,cx,cy,r+rimW);
  rimGrad.addColorStop(0,'#b8860b');
  rimGrad.addColorStop(.2,'#FFD700');
  rimGrad.addColorStop(.45,'#fff8dc');
  rimGrad.addColorStop(.65,'#FFD700');
  rimGrad.addColorStop(.85,'#d4a017');
  rimGrad.addColorStop(1,'#8B6914');
  wctx.fillStyle=rimGrad;
  wctx.beginPath();wctx.arc(cx,cy,r+rimW,0,Math.PI*2);wctx.fill();
  // Inner rim shadow
  const innerRimGrad=wctx.createRadialGradient(cx,cy,r-4,cx,cy,r+2);
  innerRimGrad.addColorStop(0,'rgba(0,0,0,.6)');innerRimGrad.addColorStop(1,'rgba(0,0,0,0)');
  wctx.fillStyle=innerRimGrad;wctx.beginPath();wctx.arc(cx,cy,r+2,0,Math.PI*2);wctx.fill();
  // Gold studs on rim
  const studCount=n*2;
  for(let i=0;i<studCount;i++){
    const a=i*Math.PI*2/studCount+wheelAngle*.05;
    const sr=r+rimW*.5;
    const sx=cx+Math.cos(a)*sr,sy=cy+Math.sin(a)*sr;
    const studSize=i%2===0?4.5:2.8;
    const studColor=i%2===0?'#fff8dc':'#b8860b';
    wctx.fillStyle=studColor;
    wctx.beginPath();wctx.arc(sx,sy,studSize,0,Math.PI*2);wctx.fill();
    if(i%2===0){
      wctx.fillStyle='rgba(255,255,255,.5)';
      wctx.beginPath();wctx.arc(sx-1,sy-1,2,0,Math.PI*2);wctx.fill();
    }
  }
  // Sector separator lines on rim
  for(let i=0;i<n;i++){
    const a=arc*i+wheelAngle;
    wctx.strokeStyle='rgba(0,0,0,.5)';wctx.lineWidth=2;
    wctx.beginPath();wctx.moveTo(cx+Math.cos(a)*(r-2),cy+Math.sin(a)*(r-2));
    wctx.lineTo(cx+Math.cos(a)*(r+rimW+1),cy+Math.sin(a)*(r+rimW+1));
    wctx.stroke();
  }

  // === SECTORS ===
  WHEEL_PRIZES.forEach((p,i)=>{
    const a=arc*i+wheelAngle;
    wctx.save();
    wctx.beginPath();wctx.moveTo(cx,cy);wctx.arc(cx,cy,r,a,a+arc);wctx.closePath();
    // Radial gradient from center for each sector
    const midA=a+arc/2;
    const gx=Math.cos(midA)*r*.55+cx,gy=Math.sin(midA)*r*.55+cy;
    const sg=wctx.createRadialGradient(cx,cy,0,gx,gy,r*.85);
    sg.addColorStop(0,p.color+'ff');
    sg.addColorStop(.5,p.color+'cc');
    sg.addColorStop(1,p.color+'88');
    wctx.fillStyle=sg;wctx.fill();
    // Rare sector golden shimmer overlay
    if(p.rare){
      const goldOverlay=wctx.createRadialGradient(gx,gy,0,gx,gy,r*.6);
      goldOverlay.addColorStop(0,'rgba(255,215,0,.25)');
      goldOverlay.addColorStop(1,'rgba(255,215,0,0)');
      wctx.fillStyle=goldOverlay;wctx.fill();
    }
    // Sector dividers
    wctx.strokeStyle='rgba(0,0,0,.5)';wctx.lineWidth=2;wctx.stroke();
    if(p.rare){wctx.strokeStyle='rgba(255,215,0,.4)';wctx.lineWidth=1.5;wctx.stroke();}
    // Light edge highlight on each sector
    wctx.beginPath();wctx.moveTo(cx,cy);wctx.arc(cx,cy,r,a,a+arc);wctx.closePath();
    const edgeG=wctx.createLinearGradient(cx+Math.cos(a)*r*.3,cy+Math.sin(a)*r*.3,cx+Math.cos(a+arc)*r*.3,cy+Math.sin(a+arc)*r*.3);
    edgeG.addColorStop(0,'rgba(255,255,255,.18)');edgeG.addColorStop(.5,'rgba(255,255,255,0)');edgeG.addColorStop(1,'rgba(255,255,255,.08)');
    wctx.fillStyle=edgeG;wctx.fill();
    wctx.restore();

    // Text on sector
    wctx.save();wctx.translate(cx,cy);wctx.rotate(midA);
    wctx.shadowColor='rgba(0,0,0,.9)';wctx.shadowBlur=6;
    // Emoji line
    const fSize=Math.max(12,Math.min(16,r*arc*.28));
    wctx.font=`bold ${fSize}px Nunito`;wctx.textAlign='center';wctx.textBaseline='middle';
    wctx.fillStyle=p.rare?'#FFD700':'#ffffff';
    wctx.fillText(p.label,r*.62,0);
    wctx.shadowBlur=0;
    wctx.restore();
  });

  // === CENTER CIRCLE ===
  const centerR=cx*0.175;
  // Outer gold ring of center
  wctx.save();
  const cRimG=wctx.createRadialGradient(cx,cy,centerR-4,cx,cy,centerR+6);
  cRimG.addColorStop(0,'#b8860b');cRimG.addColorStop(.4,'#FFD700');cRimG.addColorStop(.7,'#fff8dc');cRimG.addColorStop(1,'#b8860b');
  wctx.fillStyle=cRimG;wctx.beginPath();wctx.arc(cx,cy,centerR+6,0,Math.PI*2);wctx.fill();
  // Dark bg
  const icg=wctx.createRadialGradient(cx,cy-centerR*.3,0,cx,cy,centerR);
  icg.addColorStop(0,'#1a3a28');icg.addColorStop(1,'#061810');
  wctx.fillStyle=icg;wctx.beginPath();wctx.arc(cx,cy,centerR,0,Math.PI*2);wctx.fill();
  // Golden shimmer
  wctx.strokeStyle='#FFD700';wctx.lineWidth=2;wctx.shadowColor='#FFD700';wctx.shadowBlur=12;
  wctx.beginPath();wctx.arc(cx,cy,centerR,0,Math.PI*2);wctx.stroke();
  wctx.shadowBlur=0;
  wctx.restore();

  // === CUCUMBER IN CENTER ===
  _wHeroFrame++;
  const cucSize=centerR*1.4;
  const cucAngle=Math.sin(_wHeroFrame*.04)*.2;
  drawCucumber(wctx,cx,cy,cucSize,selectedSkin,cucAngle,_wHeroFrame);
}

function _wheelHeroLoop(){
  if(!document.getElementById('wheel-screen')||document.getElementById('wheel-screen').classList.contains('hidden')){_wHeroRaf=null;return;}
  drawWheel();
  _wHeroRaf=requestAnimationFrame(_wheelHeroLoop);
}

function spinWheel(){
  const today=new Date().toDateString();
  if(lastWheelDate===today){showToast('–ü—Ä–∏—Ö–æ–¥–∏ –∑–∞–≤—Ç—Ä–∞! üé°');return;}
  if(wheelSpinning)return;
  wheelSpinning=true;
  document.getElementById('wheel-spin-btn').disabled=true;
  document.getElementById('wheel-result').textContent='';
  document.getElementById('wheel-result').className='wheel-result';
  // Sound: rising tone
  if(typeof tone==='function'){
    for(let i=0;i<8;i++)tone(200+i*80,'sine',.2,.08+i*.01,i*.18);
  }
  const totalRot=Math.PI*2*(8+Math.floor(Math.random()*5))+Math.random()*Math.PI*2;
  const dur=4500,start=performance.now(),startA=wheelAngle;
  // Weighted random - mostly cukes, some gold, rare skin
  // Prizes: 0-7=cukes(8), 8-9=boost/xp(2), 10-12=gold(3), 13=skin(1)
  const rnd=Math.random();
  let prizeIdx;
  if(rnd<.65){prizeIdx=Math.floor(Math.random()*8);}         // 65% cukes
  else if(rnd<.80){prizeIdx=8+Math.floor(Math.random()*2);}  // 15% boost/xp
  else if(rnd<.97){prizeIdx=10+Math.floor(Math.random()*3);} // 17% gold
  else prizeIdx=13;                                            // 3% skin
  // Calculate target angle so that prizeIdx sector lands under pointer (top = -PI/2)
  const arc=Math.PI*2/WHEEL_PRIZES.length;
  const targetSectorMid=(prizeIdx+0.5)*arc;
  const targetAngle=(-Math.PI/2-targetSectorMid+Math.PI*2*20)%(Math.PI*2);
  const finalAngle=startA+totalRot-((startA+totalRot)%(Math.PI*2))+(targetAngle%(Math.PI*2));

  function f(ts){
    const t=Math.min((ts-start)/dur,1);
    const ease=t<1?1-Math.pow(1-t,4):1;
    wheelAngle=startA+(finalAngle-startA)*ease;
    drawWheel();
    if(t<1){requestAnimationFrame(f);return;}
    // Landed
    wheelSpinning=false;lastWheelDate=today;save();
    const prize=WHEEL_PRIZES[prizeIdx];
    let resultText='';let isRare=prize.rare;
    if(prize.type==='cukes'){cucumbers+=prize.value;save();updateHUD();resultText=`+${prize.value} ü•í`;}
    else if(prize.type==='xp'){addXP(prize.value);resultText=`+${prize.value} ‚≠ê XP`;}
    else if(prize.type==='gold'){goldCukes+=prize.value;save();updateHUD();resultText=`+${prize.value} ‚ú® –ó–û–õ–û–¢–û!`;isRare=true;prize._isGold=true;}
    else if(prize.type==='boost_shield'){boosters.shield=(boosters.shield||0)+1;save();resultText='üõ°Ô∏è –©–ò–¢ –ü–û–õ–£–ß–ï–ù!';}
    else if(prize.type==='boost_magnet'){boosters.magnet=(boosters.magnet||0)+1;save();resultText='üß≤ –ú–ê–ì–ù–ò–¢ –ü–û–õ–£–ß–ï–ù!';}
    else if(prize.type==='skin'){
      const u=SKINS.filter(s=>!s.secret&&!ownedSkins.includes(s.id));
      if(u.length){const s=u[Math.floor(Math.random()*u.length)];ownedSkins.push(s.id);save();resultText=`üé® –°–ö–ò–ù: ${s.name}!`;}
      else{cucumbers+=150;save();updateHUD();resultText='+150 ü•í (–≤—Å–µ —Å–∫–∏–Ω—ã –µ—Å—Ç—å!)';isRare=false;}
      isRare=true;
    }
    const resEl=document.getElementById('wheel-result');
    resEl.textContent=resultText;
    resEl.className='wheel-result'+(isRare?' rare':'');
    // Sound
    if(typeof tone==='function'){
      if(isRare){
        tone(523,'sine',.1,.2);tone(659,'sine',.1,.2,.12);tone(784,'sine',.1,.2,.24);
        tone(1047,'sine',.15,.25,.36);tone(1319,'sine',.12,.2,.56);
        // extra shimmer for rare
        for(let i=0;i<5;i++)tone(1000+i*200,'sine',.06,.15,i*.08);
      } else {
        tone(440,'sine',.08,.18);tone(554,'sine',.08,.18,.1);tone(659,'sine',.08,.2,.2);
      }
    }
    // Particle overlay for rare prizes
    if(isRare){showWheelRareAnim(prize.emoji||'‚ú®',resultText,!!prize._isGold);}
    document.getElementById('wheel-info').textContent='üïê –°–ª–µ–¥—É—é—â–∏–π —à–∞–Ω—Å –∑–∞–≤—Ç—Ä–∞';
    checkAchievements();
    // Restart hero loop
    if(!_wHeroRaf)_wheelHeroLoop();
  }
  requestAnimationFrame(f);
}

function showWheelRareAnim(emoji,text,isGold){
  const overlay=document.getElementById('wheel-prize-overlay');
  if(!overlay)return;
  overlay.classList.remove('hidden');
  const emojiEl=document.getElementById('wheel-prize-emoji');
  const labelEl=document.getElementById('wheel-prize-label');
  emojiEl.textContent=emoji;
  labelEl.textContent=text;
  // Gold special style
  if(isGold){
    emojiEl.style.cssText='font-size:90px;filter:drop-shadow(0 0 20px #FFD700) drop-shadow(0 0 40px rgba(255,165,0,.6));animation:prizePop .5s cubic-bezier(.34,1.56,.64,1),goldSpin 2s linear infinite .5s;';
    labelEl.style.cssText='font-size:28px;font-weight:900;color:#FFD700;text-shadow:0 0 30px #FFD700,0 0 60px rgba(255,215,0,.6);margin-top:12px;';
  } else {
    emojiEl.style.cssText='font-size:80px;filter:drop-shadow(0 0 20px #a78bfa);animation:prizePop .5s cubic-bezier(.34,1.56,.64,1);';
    labelEl.style.cssText='font-size:24px;font-weight:900;color:#c4b5fd;text-shadow:0 0 20px #a78bfa;margin-top:12px;';
  }
  // enhanced confetti
  _spawnWheelConfetti(isGold);
  // sound
  if(typeof tone==='function'){
    if(isGold){
      // fanfare
      [523,659,784,1047,1319,1568].forEach((f,i)=>tone(f,'sine',.2,.3,i*.12));
      setTimeout(()=>{[1047,784,659,784,1047,1319].forEach((f,i)=>tone(f,'sine',.15,.25,i*.1));},900);
    } else {
      [523,659,784,1047,1319].forEach((f,i)=>tone(f,'sine',.18,.28,i*.14));
    }
  }
  setTimeout(()=>{overlay.classList.add('hidden');emojiEl.style='';labelEl.style='';},4500);
}
function _spawnWheelConfetti(isGold=false){
  const colors=isGold?['#FFD700','#fff8dc','#fbbf24','#f59e0b','#fcd34d','#fffbeb']:['#FFD700','#a78bfa','#4ade80','#f472b6','#38bdf8','#fb923c'];
  const wrap=document.getElementById('wheel-prize-overlay')||document.body;
  const count=isGold?80:50;
  for(let i=0;i<count;i++){
    setTimeout(()=>{
      const el=document.createElement('div');
      const size=isGold?12+Math.random()*14:7+Math.random()*9;
      const isCircle=Math.random()>.4;
      const isStar=isGold&&Math.random()>.6;
      el.textContent=isStar?'‚ú®':'';
      if(isStar){
        el.style.cssText=`position:absolute;top:${5+Math.random()*85}%;left:${3+Math.random()*94}%;font-size:${size+6}px;pointer-events:none;animation:coinFloat ${.8+Math.random()*.8}s ease-out forwards;opacity:.9;`;
      } else {
        el.style.cssText=`position:absolute;top:${5+Math.random()*85}%;left:${3+Math.random()*94}%;width:${size}px;height:${size}px;background:${colors[Math.floor(Math.random()*colors.length)]};border-radius:${isCircle?'50%':'3px'};pointer-events:none;animation:coinFloat ${.9+Math.random()*.8}s ease-out forwards;box-shadow:0 0 ${isGold?8:4}px currentColor;transform:rotate(${Math.random()*360}deg);`;
      }
      wrap.appendChild(el);setTimeout(()=>el.remove(),2000);
    },i*35);
  }
}

function showWheel(){
  document.getElementById('start-screen').classList.add('hidden');
  const today=new Date().toDateString();
  document.getElementById('wheel-spin-btn').disabled=lastWheelDate===today;
  document.getElementById('wheel-info').textContent=lastWheelDate===today?'üïê –°–ª–µ–¥—É—é—â–∏–π —à–∞–Ω—Å –∑–∞–≤—Ç—Ä–∞':'üéÅ –†–∞–∑ –≤ –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ';
  document.getElementById('wheel-result').textContent='';
  document.getElementById('wheel-screen').classList.remove('hidden');
  drawWheel();
  // Start animated hero in center
  if(!_wHeroRaf)_wheelHeroLoop();
}
function closeWheel(){
  document.getElementById('wheel-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
  if(_wHeroRaf){cancelAnimationFrame(_wHeroRaf);_wHeroRaf=null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHEST (4-HOUR)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHEST_INTERVAL=4*60*60*1000;
function getChestReady(){return Date.now()-lastChestTime>=CHEST_INTERVAL;}
function getChestCountdown(){
  const remain=CHEST_INTERVAL-(Date.now()-lastChestTime);
  if(remain<=0)return'–ì–û–¢–û–í!';
  const h=Math.floor(remain/3600000),m=Math.floor((remain%3600000)/60000),s=Math.floor((remain%60000)/1000);
  return`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function updateChestDisplay(){
  const ready=getChestReady();
  const mi=document.getElementById('menu-chest-info');if(mi)mi.textContent=ready?'üì¶ –°—É–Ω–¥—É–∫ –≥–æ—Ç–æ–≤! –û—Ç–∫—Ä–æ–π!':'‚è∞ –°–ª–µ–¥—É—é—â–∏–π: '+getChestCountdown();
  const ht=document.getElementById('chest-timer-txt');if(ht)ht.textContent=ready?'OPEN!':getChestCountdown();
  // Update chest notification dot
  const dot=document.getElementById('chest-notif-dot');if(dot)dot.style.display=ready?'flex':'none';
}
setInterval(updateChestDisplay,1000);

// ‚îÄ‚îÄ‚îÄ CHEST CANVAS ANIMATION ‚îÄ‚îÄ‚îÄ
let _chestRaf=null,_chestFrame=0,_chestOpen=false,_chestOpenProg=0,_chestShake=false;
function _drawChest(open,shake,prog){
  const cc=document.getElementById('chest-canvas');if(!cc)return;
  const c=cc.getContext('2d');const W=200,H=160;
  c.clearRect(0,0,W,H);
  const cx=100,cy=100;
  c.save();
  const sx=shake?Math.sin(_chestFrame*.5)*5*(1-prog):0;
  c.translate(cx+sx,cy);
  // Shadow glow
  const gl=c.createRadialGradient(0,40,2,0,40,55);
  gl.addColorStop(0,'rgba(120,70,200,.4)');gl.addColorStop(1,'transparent');
  c.fillStyle=gl;c.beginPath();c.ellipse(0,44,55,16,0,0,Math.PI*2);c.fill();
  // Body
  const bg=c.createLinearGradient(-50,0,50,55);
  bg.addColorStop(0,'#c07820');bg.addColorStop(.5,'#92400e');bg.addColorStop(1,'#6b2d00');
  c.fillStyle=bg;c.shadowColor='rgba(0,0,0,.6)';c.shadowBlur=14;c.shadowOffsetY=5;
  c.beginPath();c.roundRect(-50,0,100,55,5);c.fill();c.shadowBlur=0;c.shadowOffsetY=0;
  // Wood lines body
  c.strokeStyle='rgba(0,0,0,.25)';c.lineWidth=1.5;
  [-17,17].forEach(x=>{c.beginPath();c.moveTo(x,0);c.lineTo(x,55);c.stroke();});
  [20,38].forEach(y=>{c.beginPath();c.moveTo(-50,y);c.lineTo(50,y);c.stroke();});
  // Metal bands body
  const mg=c.createLinearGradient(-50,0,50,0);
  mg.addColorStop(0,'#6b7280');mg.addColorStop(.5,'#e5e7eb');mg.addColorStop(1,'#6b7280');
  c.fillStyle=mg;c.fillRect(-50,18,100,9);c.fillRect(-50,36,100,7);
  // Lid
  const lidRot=open?-Math.PI*.78*Math.min(prog*1.3,1):0;
  c.save();c.translate(0,0);c.rotate(lidRot);
  const ld=c.createLinearGradient(-50,-50,50,0);
  ld.addColorStop(0,'#e08830');ld.addColorStop(.5,'#b45309');ld.addColorStop(1,'#78350f');
  c.fillStyle=ld;c.shadowColor='rgba(0,0,0,.4)';c.shadowBlur=8;
  c.beginPath();c.roundRect(-50,-52,100,52,[5,5,0,0]);c.fill();c.shadowBlur=0;
  // Wood lines lid
  c.strokeStyle='rgba(0,0,0,.2)';c.lineWidth=1.5;
  [-17,17].forEach(x=>{c.beginPath();c.moveTo(x,-52);c.lineTo(x,0);c.stroke();});
  [-37,-20].forEach(y=>{c.beginPath();c.moveTo(-50,y);c.lineTo(50,y);c.stroke();});
  // Metal lid
  c.fillStyle=mg;c.fillRect(-50,-18,100,9);c.fillRect(-50,-34,100,7);
  // Lid highlight
  c.fillStyle='rgba(255,255,255,.09)';c.beginPath();c.roundRect(-48,-50,96,14,[4,4,0,0]);c.fill();
  // Lock
  const lkg=c.createLinearGradient(-15,-30,15,-8);
  lkg.addColorStop(0,'#fde68a');lkg.addColorStop(.5,'#FFD700');lkg.addColorStop(1,'#d97706');
  c.fillStyle=lkg;c.shadowColor='#FFD700';c.shadowBlur=open?0:10;
  c.beginPath();c.roundRect(-15,-32,30,25,4);c.fill();c.shadowBlur=0;
  if(!open||prog<.25){
    c.fillStyle='rgba(0,0,0,.65)';c.beginPath();c.arc(0,-23,5.5,0,Math.PI*2);c.fill();
    c.beginPath();c.moveTo(-3.5,-17);c.lineTo(3.5,-17);c.lineTo(2.5,-10);c.lineTo(-2.5,-10);c.closePath();c.fill();
  } else {
    c.strokeStyle='rgba(0,0,0,.5)';c.lineWidth=3.5;c.lineCap='round';
    c.beginPath();c.arc(0,-21,5,Math.PI*.9,0);c.lineTo(5,-12);c.stroke();
    c.beginPath();c.moveTo(-5,-21);c.lineTo(-5,-12);c.stroke();
  }
  c.restore();
  // Light rays when opening
  if(prog>.15){
    const ra=Math.min((prog-.15)/.4,1)*.65;
    c.save();c.globalAlpha=ra;
    for(let i=0;i<10;i++){
      const a=(i/10)*Math.PI*2+_chestFrame*.018;
      const len=35+Math.sin(_chestFrame*.09+i)*14;
      const rg=c.createLinearGradient(0,-12,Math.cos(a)*len,Math.sin(a)*len-12);
      rg.addColorStop(0,'rgba(255,220,50,.9)');rg.addColorStop(1,'transparent');
      c.strokeStyle=rg;c.lineWidth=2.5+Math.sin(_chestFrame*.07+i);
      c.beginPath();c.moveTo(0,-12);c.lineTo(Math.cos(a)*len,Math.sin(a)*len-12);c.stroke();
    }
    c.restore();
  }
  // Coins spilling
  if(prog>.45){
    const cp=Math.min((prog-.45)/.55,1);
    for(let i=0;i<6;i++){
      const cx2=(i%3-1)*22*cp+Math.sin(_chestFrame*.06+i)*4;
      const cy2=-35-i*7*cp;
      const ca=Math.max(0,cp-.15);
      if(ca<=0)continue;
      c.save();c.globalAlpha=ca;
      const cg=c.createRadialGradient(cx2,cy2,0,cx2,cy2,8);
      cg.addColorStop(0,'#fff9c4');cg.addColorStop(.5,'#FFD700');cg.addColorStop(1,'#b45309');
      c.fillStyle=cg;c.shadowColor='#FFD700';c.shadowBlur=10;
      c.beginPath();c.arc(cx2,cy2,6+i*.3,0,Math.PI*2);c.fill();
      c.shadowBlur=0;c.restore();
    }
  }
  c.restore();
  _chestFrame++;
}
function _animChest(){
  if(!document.getElementById('chest-modal')||document.getElementById('chest-modal').classList.contains('hidden')){_chestRaf=null;return;}
  if(_chestOpen)_chestOpenProg=Math.min(_chestOpenProg+.022,1);
  _drawChest(_chestOpen,_chestShake&&!_chestOpen,_chestOpenProg);
  _chestRaf=requestAnimationFrame(_animChest);
}
function openChestModal(){
  const ready=getChestReady();
  _chestOpen=false;_chestOpenProg=0;_chestShake=ready;_chestFrame=0;
  document.getElementById('chest-open-btn').style.display=ready?'':'none';
  document.getElementById('chest-box-title').textContent=ready?'üì¶ –°–£–ù–î–£–ö –ñ–î–Å–¢!':'üì¶ –°–£–ù–î–£–ö';
  document.getElementById('chest-reward-text').textContent=ready?'–ù–∞–∂–º–∏ –∏ –∑–∞–±–µ—Ä–∏ –Ω–∞–≥—Ä–∞–¥—É!':'–ï—â—ë —Ä–∞–Ω–æ... '+getChestCountdown();
  document.getElementById('chest-modal').classList.remove('hidden');
  if(!_chestRaf)_animChest();
}
function closeChestModal(){
  document.getElementById('chest-modal').classList.add('hidden');
  _chestOpen=false;_chestOpenProg=0;_chestShake=false;
  if(_chestRaf){cancelAnimationFrame(_chestRaf);_chestRaf=null;}
}
function _spawnChestFX(){
  const wrap=document.getElementById('chest-particles-wrap');if(!wrap)return;
  const items=['ü•í','‚ú®','‚≠ê','üí´','üåü','ü™ô'];
  for(let i=0;i<10;i++){
    setTimeout(()=>{
      const el=document.createElement('div');el.className='chest-coin-fx';
      el.textContent=items[Math.floor(Math.random()*items.length)];
      el.style.cssText=`left:${15+Math.random()*70}%;top:${25+Math.random()*45}%;font-size:${16+Math.random()*14}px;animation-delay:${Math.random()*.4}s;`;
      wrap.appendChild(el);setTimeout(()=>el.remove(),1300);
    },i*55);
  }
}
function claimChest(){
  if(!getChestReady()){showToast('–ï—â—ë —Ä–∞–Ω–æ!');return;}
  lastChestTime=Date.now();chestsOpened++;
  const reward=15+Math.floor(Math.random()*36);
  const goldBonus=Math.random()<.1?1:0;
  cucumbers+=reward;if(goldBonus)goldCukes+=goldBonus;
  addXP(20);save();checkStickers();checkAchievements();
  _chestOpen=true;_chestShake=false;_chestOpenProg=0;
  document.getElementById('chest-open-btn').style.display='none';
  _spawnChestFX();
  if(typeof tone==='function'){
    tone(523,'sine',.08,.15);tone(659,'sine',.08,.15,.1);
    tone(784,'sine',.08,.15,.2);tone(1047,'sine',.1,.25,.35);
    tone(1319,'sine',.09,.2,.55);
  }
  setTimeout(()=>{
    const t=document.getElementById('chest-reward-text');
    t.textContent=`+${reward} ü•í${goldBonus?' +1 ‚ú®':''}!`;
    t.style.animation='chestRewardPop .5s ease-out';
    document.getElementById('chest-box-title').textContent='üéâ –ù–ê–ì–†–ê–î–ê!';
  },900);
  showToast(`üì¶ –°—É–Ω–¥—É–∫! +${reward}ü•í${goldBonus?' +1‚ú®':''}`);
  updateHUD();
  // Update quests
  questProgress('open_chest',1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DAILY QUESTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const QUEST_DEFS=[
  {id:'score_20',   icon:'üéØ', name:'–ü—Ä–æ–±–µ–≥–∏ –¥–∞–ª–µ–∫–æ',    desc:'–ù–∞–±–µ—Ä–∏ 20 –æ—á–∫–æ–≤ –∑–∞ –∏–≥—Ä—É',  target:20,  reward:30,  rewardGold:0, type:'score'},
  {id:'collect_15', icon:'ü•í', name:'–û–≥—É—Ä–µ—Ü-—Å–æ–±–∏—Ä–∞—Ç–µ–ª—å', desc:'–°–æ–±–µ—Ä–∏ 15 –æ–≥—É—Ä—Ü–æ–≤ –∑–∞ –¥–µ–Ω—å', target:15,  reward:25,  rewardGold:0, type:'collect'},
  {id:'open_chest', icon:'üì¶', name:'–û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É–∫',     desc:'–û—Ç–∫—Ä–æ–π 1 —Å—É–Ω–¥—É–∫',           target:1,   reward:0,   rewardGold:1, type:'chest'},
  {id:'play_3',     icon:'üéÆ', name:'–ó–∞—è–¥–ª—ã–π –∏–≥—Ä–æ–∫',     desc:'–°—ã–≥—Ä–∞–π 3 –ø–∞—Ä—Ç–∏–∏',           target:3,   reward:20,  rewardGold:0, type:'play'},
  {id:'score_50',   icon:'üèÜ', name:'–ú–∞—Å—Ç–µ—Ä',            desc:'–ù–∞–±–µ—Ä–∏ 50 –æ—á–∫–æ–≤ –∑–∞ –∏–≥—Ä—É',   target:50,  reward:60,  rewardGold:1, type:'score'},
  {id:'collect_30', icon:'üí∞', name:'–ë–æ–≥–∞—Ç—ã–π –æ–≥—É—Ä–µ—Ü',    desc:'–°–æ–±–µ—Ä–∏ 30 –æ–≥—É—Ä—Ü–æ–≤ –∑–∞ –¥–µ–Ω—å', target:30,  reward:50,  rewardGold:0, type:'collect'},
];
function getTodayKey(){return'q_'+new Date().toDateString().replace(/ /g,'_');}
function loadQuests(){
  const key=getTodayKey();
  let data=null;try{data=JSON.parse(localStorage.getItem(key)||'null');}catch(e){}
  if(!data){
    // Pick 3 random quests for today
    const shuffled=[...QUEST_DEFS].sort(()=>Math.random()-.5).slice(0,3);
    data={quests:shuffled.map(q=>({...q,progress:0,claimed:false}))};
    try{localStorage.setItem(key,JSON.stringify(data));}catch(e){}
  }
  return data;
}
function saveQuests(data){try{localStorage.setItem(getTodayKey(),JSON.stringify(data));}catch(e){}}
function questProgress(type,amount){
  const data=loadQuests();
  let changed=false;
  data.quests.forEach(q=>{
    if(q.claimed)return;
    if(q.type===type){q.progress=Math.min(q.progress+amount,q.target);changed=true;}
  });
  if(changed)saveQuests(data);
  // Update badge
  const done=data.quests.filter(q=>q.progress>=q.target&&!q.claimed).length;
  const btn=document.getElementById('quests-btn');
  if(btn)btn.textContent=done>0?`üéØ –ó–ê–î–ê–ù–ò–Ø (${done})`:'üéØ –ó–ê–î–ê–ù–ò–Ø';
  if(done>0&&changed)showToast('üéØ –ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!');
}
function questCheckScore(score){questProgress('score',score);}
function renderQuestsList(){
  const data=loadQuests();
  const list=document.getElementById('quests-list');if(!list)return;
  const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);tomorrow.setHours(0,0,0,0);
  const ms=tomorrow-Date.now();
  const hr=Math.floor(ms/3600000),mn=Math.floor((ms%3600000)/60000);
  const rt=document.getElementById('quests-reset-txt');
  if(rt)rt.textContent=`üîÑ –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ ${hr}—á ${mn}–º–∏–Ω`;
  list.innerHTML=data.quests.map(q=>{
    const pct=Math.min(q.progress/q.target*100,100);
    const done=q.progress>=q.target;
    const cls=q.claimed?'quest-card done':(done?'quest-card done':'quest-card');
    const rewardTxt=q.reward>0?`+${q.reward}ü•í`:(q.rewardGold>0?`+${q.rewardGold}‚ú®`:'');
    return`<div class="${cls}" onclick="claimQuestReward('${q.id}')">
      <div class="quest-icon">${q.icon}</div>
      <div class="quest-info">
        <div class="quest-name">${q.name}${q.claimed?' ‚úÖ':''}</div>
        <div class="quest-progress">${q.progress}/${q.target} ‚Äî ${q.desc}</div>
        <div class="quest-bar-wrap"><div class="quest-bar-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="quest-reward">${q.claimed?'‚úì':rewardTxt}</div>
    </div>`;
  }).join('');
}
function claimQuestReward(id){
  const data=loadQuests();
  const q=data.quests.find(q=>q.id===id);
  if(!q||q.claimed)return;
  if(q.progress<q.target){showToast('–ï—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!');return;}
  q.claimed=true;saveQuests(data);
  if(q.reward>0){cucumbers+=q.reward;showToast(`üéØ +${q.reward}ü•í`);}
  if(q.rewardGold>0){goldCukes+=q.rewardGold;showToast(`üéØ +${q.rewardGold}‚ú®`);}
  save();updateHUD();renderQuestsList();
}
function showQuests(){
  renderQuestsList();
  document.getElementById('quests-modal').classList.remove('hidden');
}
function closeQuests(){document.getElementById('quests-modal').classList.add('hidden');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEASON PASS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SEASON_REWARDS=[
  {level:1,  icon:'ü•í', val:'+25ü•í',   type:'cukes',  amount:25,   rare:false},
  {level:2,  icon:'‚≠ê', val:'+100XP',  type:'xp',     amount:100,  rare:false},
  {level:3,  icon:'üõ°Ô∏è', val:'–©–∏—Ç',     type:'shield', amount:1,    rare:false},
  {level:4,  icon:'ü•í', val:'+50ü•í',   type:'cukes',  amount:50,   rare:false},
  {level:5,  icon:'‚ú®', val:'+1 –∑–æ–ª–æ—Ç–æ',type:'gold',   amount:1,    rare:true},
  {level:6,  icon:'üß≤', val:'–ú–∞–≥–Ω–∏—Ç',  type:'magnet', amount:1,    rare:false},
  {level:7,  icon:'ü•í', val:'+80ü•í',   type:'cukes',  amount:80,   rare:false},
  {level:8,  icon:'‚ö°', val:'–¢—É—Ä–±–æ',   type:'turbo',  amount:1,    rare:false},
  {level:9,  icon:'‚ú®', val:'+2 –∑–æ–ª–æ—Ç–∞',type:'gold',   amount:2,    rare:true},
  {level:10, icon:'ü•í', val:'+120ü•í',  type:'cukes',  amount:120,  rare:false},
  {level:11, icon:'üí•', val:'–ú–µ–≥–∞',    type:'mega',   amount:1,    rare:false},
  {level:12, icon:'‚≠ê', val:'+300XP',  type:'xp',     amount:300,  rare:false},
  {level:13, icon:'ü•í', val:'+150ü•í',  type:'cukes',  amount:150,  rare:false},
  {level:14, icon:'‚ú®', val:'+3 –∑–æ–ª–æ—Ç–∞',type:'gold',   amount:3,    rare:true},
  {level:15, icon:'üõ°Ô∏è', val:'2x –©–∏—Ç',  type:'shield', amount:2,    rare:false},
  {level:16, icon:'ü•í', val:'+200ü•í',  type:'cukes',  amount:200,  rare:false},
  {level:17, icon:'üß≤', val:'2x –ú–∞–≥–Ω–∏—Ç',type:'magnet',amount:2,    rare:false},
  {level:18, icon:'‚ú®', val:'+5 –∑–æ–ª–æ—Ç–∞',type:'gold',   amount:5,    rare:true},
  {level:19, icon:'ü•í', val:'+300ü•í',  type:'cukes',  amount:300,  rare:false},
  {level:20, icon:'üëë', val:'–õ–ï–ì–ï–ù–î–ê!', type:'skin',   amount:0,    rare:true},
];
const SEASON_XP_PER_LEVEL=200;
function getSeasonData(){
  let d=null;try{d=JSON.parse(localStorage.getItem('fc_season')||'null');}catch(e){}
  if(!d)d={xp:0,claimed:[]};
  return d;
}
function saveSeasonData(d){try{localStorage.setItem('fc_season',JSON.stringify(d));}catch(e){}}
function addSeasonXP(amt){
  const d=getSeasonData();d.xp+=amt;saveSeasonData(d);
}
function renderSeasonUI(){
  const d=getSeasonData();
  const totalLevels=SEASON_REWARDS.length;
  const currentLevel=Math.min(Math.floor(d.xp/SEASON_XP_PER_LEVEL)+1,totalLevels);
  const xpInLevel=d.xp%SEASON_XP_PER_LEVEL;
  const pct=Math.min(xpInLevel/SEASON_XP_PER_LEVEL*100,100);
  const lbl=document.getElementById('season-xp-label');
  const fill=document.getElementById('season-xp-fill');
  const totalPct=Math.min(d.xp/(totalLevels*SEASON_XP_PER_LEVEL)*100,100);
  if(lbl)lbl.innerHTML=`<span style="color:#c4b5fd;font-size:20px;font-weight:900;">‚≠ê –£—Ä–æ–≤–µ–Ω—å ${Math.min(currentLevel,totalLevels)}/20</span>&nbsp;&nbsp;<span style="color:#94a3b8;font-size:14px;">${xpInLevel}/${SEASON_XP_PER_LEVEL} XP</span>`;
  if(fill)fill.style.width=pct+'%';
  const grid=document.getElementById('season-rewards-grid');
  if(grid)grid.innerHTML=SEASON_REWARDS.map(r=>{
    const unlocked=d.xp>=(r.level-1)*SEASON_XP_PER_LEVEL;
    const isCurrent=r.level===currentLevel;
    const claimed=d.claimed.includes(r.level);
    let cls='season-reward';
    if(r.rare)cls+=' rare-reward';
    if(claimed)cls+=' claimed';
    else if(isCurrent)cls+=' current';
    else if(!unlocked)cls+=' locked';
    const canClaim=unlocked&&!claimed;
    return`<div class="${cls}" onclick="claimSeasonLevel(${r.level})" title="–£—Ä–æ–≤–µ–Ω—å ${r.level}">
      <div class="sr-lv">–£–†.${r.level}${r.rare?'‚≠ê':''}</div>
      <span class="sr-icon">${claimed?'‚úÖ':(unlocked?r.icon:'üîí')}</span>
      <div class="sr-val">${r.val}</div>
      ${canClaim?'<div style="font-size:9px;color:#4ade80;font-weight:900;margin-top:2px;">–ó–ê–ë–†–ê–¢–¨</div>':''}    </div>`;
  }).join('');
  // Progress track dots
  const track=document.getElementById('season-track');
  if(track){
    track.innerHTML=SEASON_REWARDS.map((r,i)=>{
      const done=d.xp>=(r.level*SEASON_XP_PER_LEVEL);
      return`<div class="season-milestone"><div class="sm-dot${done?' done':''}"></div>${i<SEASON_REWARDS.length-1?`<div class="sm-line${done?' done':''} "></div>`:''}</div>`;
    }).join('');
  }
}
function claimSeasonLevel(level){
  const d=getSeasonData();
  if(d.claimed.includes(level)){showToast('–£–∂–µ –ø–æ–ª—É—á–µ–Ω–æ!');return;}
  const unlocked=d.xp>=(level-1)*SEASON_XP_PER_LEVEL;
  if(!unlocked){showToast('–ï—â—ë –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ!');return;}
  d.claimed.push(level);saveSeasonData(d);
  const r=SEASON_REWARDS.find(r=>r.level===level);
  if(r){
    if(r.type==='cukes'){cucumbers+=r.amount;showToast(`‚≠ê +${r.amount}ü•í`);}
    else if(r.type==='gold'){goldCukes+=r.amount;showToast(`‚≠ê +${r.amount}‚ú®`);}
    else if(r.type==='shield'){boosters.shield=(boosters.shield||0)+r.amount;showToast('‚≠ê –©–∏—Ç –ø–æ–ª—É—á–µ–Ω!');}
    else if(r.type==='magnet'){boosters.magnet=(boosters.magnet||0)+r.amount;showToast('‚≠ê –ú–∞–≥–Ω–∏—Ç –ø–æ–ª—É—á–µ–Ω!');}
    else if(r.type==='turbo'){boosters.turbo=(boosters.turbo||0)+r.amount;showToast('‚≠ê –¢—É—Ä–±–æ –ø–æ–ª—É—á–µ–Ω!');}
    else if(r.type==='mega'){boosters.mega=(boosters.mega||0)+(r.amount||1);showToast('‚≠ê –ú–µ–≥–∞-–æ–≥—É—Ä–µ—Ü –ø–æ–ª—É—á–µ–Ω!');}
    else if(r.type==='xp'){addXP(r.amount);showToast(`‚≠ê +${r.amount} XP!`);}
    else if(r.type==='skin'){showToast('üëë –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π —Å–∫–∏–Ω ‚Äî —Å–∫–æ—Ä–æ!');}
    save();updateHUD();
  }
  renderSeasonUI();
}
function claimSeasonReward(){
  // Find first unclaimed unlocked level
  const d=getSeasonData();
  const r=SEASON_REWARDS.find(r=>!d.claimed.includes(r.level)&&d.xp>=(r.level-1)*SEASON_XP_PER_LEVEL);
  if(r)claimSeasonLevel(r.level);
  else showToast('–ù–µ—á–µ–≥–æ –∑–∞–±–∏—Ä–∞—Ç—å!');
}
function showSeason(){renderSeasonUI();document.getElementById('season-modal').classList.remove('hidden');}
function closeSeason(){document.getElementById('season-modal').classList.add('hidden');}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleTap(){
  if(gameState!=='playing')return;
  // No double-tap shoot - use the üå± button for that
  jump();
}
document.addEventListener('keydown',e=>{
  if(e.code==='Space'){e.preventDefault();jump();}
  if(e.code==='KeyF'){shoot();}
});
canvas.addEventListener('click',handleTap);
canvas.addEventListener('touchstart',e=>{e.preventDefault();handleTap();},{passive:false});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EVENT LISTENERS (replacing inline onclick)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function bindEvents(){
  const $ = id => document.getElementById(id);

  // HUD booster buttons
  $('btn-shield')?.addEventListener('click', () => useBooster('shield'));
  $('btn-magnet')?.addEventListener('click', () => useBooster('magnet'));
  $('btn-turbo')?.addEventListener('click',  () => useBooster('turbo'));
  $('btn-mega')?.addEventListener('click',   () => useBooster('mega'));
  $('hud-shoot')?.addEventListener('click',  () => shoot());
  $('hud-pause')?.addEventListener('click',  () => togglePause());
  $('btn-pause-resume')?.addEventListener('click', () => togglePause());
  $('btn-pause-menu')?.addEventListener('click', () => pauseGoToMenu());

  // Start screen
  $('btn-play')?.addEventListener('click', () => showModeSelect());
  $('btn-shop')?.addEventListener('click', () => showShop());
  $('btn-improvements')?.addEventListener('click', () => showImprovements());
  document.getElementById('impr-tab-boost')?.addEventListener('click', () => setImprTab('boost'));
  document.getElementById('impr-tab-upg')?.addEventListener('click', () => setImprTab('upg'));
  $('btn-lb')?.addEventListener('click', () => showLeaderboard());
  $('btn-achiev')?.addEventListener('click', () => showAchievements());
  $('btn-wheel')?.addEventListener('click', () => showWheel());
  $('btn-quests')?.addEventListener('click', () => showQuests());
  $('btn-season')?.addEventListener('click', () => showSeason());
  $('btn-bestrun')?.addEventListener('click', () => showBestRun());
  $('btn-leagues')?.addEventListener('click', () => showLeagues());
  $('btn-streak')?.addEventListener('click', () => showStreak());

  // Mode screen
  $('mc-easy')?.addEventListener('click', () => startGameWithCountdown('easy'));
  $('mc-normal')?.addEventListener('click', () => startGameWithCountdown('normal'));
  $('mc-hard')?.addEventListener('click', () => modeClick('hard'));
  $('mc-insane')?.addEventListener('click', () => modeClick('insane'));
  $('mc-crazy')?.addEventListener('click', () => modeClick('crazy'));
  $('mc-flip')?.addEventListener('click', () => modeClick('flip'));
  $('mc-zen')?.addEventListener('click', () => modeClick('zen'));
  $('btn-mode-back')?.addEventListener('click', () => closeModeSelect());

  // Boost shop
  $('btn-buy-shield')?.addEventListener('click', () => buyBooster('shield'));
  $('btn-buy-magnet')?.addEventListener('click', () => buyBooster('magnet'));
  $('btn-buy-turbo')?.addEventListener('click', () => buyBooster('turbo'));
  $('btn-buy-mega')?.addEventListener('click', () => buyBooster('mega'));
  $('btn-boost-back')?.addEventListener('click', () => closeBoostShop());

  // Carousel
  $('btn-car-prev')?.addEventListener('click', () => carPrev());
  $('btn-car-next')?.addEventListener('click', () => carNext());
  $('btn-shop-action')?.addEventListener('click', () => shopAction());
  $('btn-shop-close')?.addEventListener('click', () => closeShop());

  // Leaderboard / Achievements / Wheel / Quests / Season
  $('btn-lb-back')?.addEventListener('click', () => closeLeaderboard());
  $('btn-achiev-back')?.addEventListener('click', () => closeAchievements());
  $('btn-wheel-back')?.addEventListener('click', () => closeWheel());
  $('btn-spin-real')?.addEventListener('click', () => spinWheel());
  $('btn-quests-close')?.addEventListener('click', () => closeQuests());
  $('btn-season-claim')?.addEventListener('click', () => claimSeasonReward());
  $('btn-season-close')?.addEventListener('click', () => closeSeason());
  $('btn-season-close2')?.addEventListener('click', () => closeSeason());

  // Game over
  $('btn-restart')?.addEventListener('click', () => restartGame());
  $('btn-gomenu')?.addEventListener('click', () => goToMenu());
  $('btn-share')?.addEventListener('click', () => shareToTelegram());

  // Nickname
  $('btn-nick-save')?.addEventListener('click', () => saveNickname());

  // Pets back
  $('btn-pets-back')?.addEventListener('click', () => closePets());

  // New screens back
  $('btn-bestrun-back')?.addEventListener('click', () => { $('bestrun-screen').classList.add('hidden'); $('start-screen').classList.remove('hidden'); });
  $('btn-leagues-back')?.addEventListener('click', () => { $('leagues-screen').classList.add('hidden'); $('start-screen').classList.remove('hidden'); });
  $('btn-streak-back')?.addEventListener('click', () => { $('streak-screen').classList.add('hidden'); $('start-screen').classList.remove('hidden'); });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COUNTDOWN 3...2...1...GO!
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGameWithCountdown(mode) {
  const overlay = document.getElementById('countdown-overlay');
  const num = document.getElementById('countdown-num');
  document.getElementById('mode-screen').classList.add('hidden');
  overlay.classList.remove('hidden');

  let count = 3;
  function tick() {
    if (count > 0) {
      num.textContent = count;
      num.style.animation = 'none';
      void num.offsetWidth;
      num.style.animation = 'countPop .6s ease-out forwards';
      if (typeof tone === 'function') tone(440 + count * 110, 'sine', .12, .3);
      count--;
      setTimeout(tick, 750);
    } else {
      num.textContent = 'GO!';
      num.style.color = '#fbbf24';
      num.style.textShadow = '0 0 40px #fbbf24';
      num.style.animation = 'none';
      void num.offsetWidth;
      num.style.animation = 'countPop .5s ease-out forwards';
      if (typeof tone === 'function') { tone(880, 'sine', .15, .4); tone(1320, 'sine', .12, .3, .1); }
      setTimeout(() => {
        overlay.classList.add('hidden');
        num.textContent = '3';
        num.style.color = '#4ade80';
        num.style.textShadow = '0 0 40px #4ade80,0 0 80px rgba(74,222,128,.5),2px 2px 0 #000';
        startGame(mode);
      }, 500);
    }
  }
  tick();
}

// Also patch modeClick to use countdown
const _origModeClick = modeClick;
function modeClick(mode) {
  const modeBests = def('modeBests', {easy:0,normal:0,hard:0,insane:0,crazy:0,flip:0,zen:0});
  const unlockMap = {hard:'normal',insane:'hard',crazy:'insane',flip:'crazy',zen:'flip'};
  const prevMode = unlockMap[mode];
  const prevBest = (modeBests[prevMode] || 0);
  if (prevBest >= 50) startGameWithCountdown(mode);
  else showToast(`üîí –ü—Ä–æ–π–¥–∏ 50 –±–∞—à–µ–Ω –≤ "${prevMode}" —Ä–µ–∂–∏–º–µ!`);
}

// CSS for countdown animation
const _cntStyle = document.createElement('style');
_cntStyle.textContent = `@keyframes countPop{0%{transform:scale(1.6);opacity:0}60%{transform:scale(.95);opacity:1}100%{transform:scale(1);opacity:1}}`;
document.head.appendChild(_cntStyle);



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEAGUES SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LEAGUES = [
  { name: '–ë—Ä–æ–Ω–∑–∞',  icon: 'ü•â', min: 0,   max: 9,   color: '#CD7F32', bg: 'rgba(205,127,50,.15)' },
  { name: '–°–µ—Ä–µ–±—Ä–æ', icon: 'ü•à', min: 10,  max: 24,  color: '#C0C0C0', bg: 'rgba(192,192,192,.15)' },
  { name: '–ó–æ–ª–æ—Ç–æ',  icon: 'ü•á', min: 25,  max: 49,  color: '#FFD700', bg: 'rgba(255,215,0,.15)' },
  { name: '–ê–ª–º–∞–∑',  icon: 'üíé', min: 50,  max: 99,  color: '#38bdf8', bg: 'rgba(56,189,248,.15)' },
  { name: '–õ–µ–≥–µ–Ω–¥–∞', icon: 'üëë', min: 100, max: 9999, color: '#a78bfa', bg: 'rgba(167,139,250,.15)' },
];

function getCurrentLeague() {
  return LEAGUES.find(l => bestScore >= l.min && bestScore <= l.max) || LEAGUES[0];
}

function showLeagues() {
  document.getElementById('start-screen').classList.add('hidden');
  renderLeaguesScreen();
  document.getElementById('leagues-screen').classList.remove('hidden');
}

function renderLeaguesScreen() {
  const cur = getCurrentLeague();
  const icon = document.getElementById('league-current-icon');
  const name = document.getElementById('league-current-name');
  const range = document.getElementById('league-current-range');
  if (icon) icon.textContent = cur.icon;
  if (name) { name.textContent = cur.name; name.style.color = cur.color; }
  if (range) range.textContent = `–†–µ–∫–æ—Ä–¥: ${bestScore} –±–∞—à–µ–Ω | –î–∏–∞–ø–∞–∑–æ–Ω: ${cur.min}‚Äì${cur.max === 9999 ? '‚àû' : cur.max}`;

  const list = document.getElementById('leagues-list');
  if (!list) return;
  list.innerHTML = LEAGUES.map(l => {
    const isCur = l.name === cur.name;
    const done = bestScore >= l.min;
    return `<div style="display:flex;align-items:center;gap:10px;background:${isCur ? l.bg : 'rgba(0,0,0,.2)'};border:1px solid ${isCur ? l.color : 'rgba(255,255,255,.06)'};border-radius:12px;padding:10px 14px;margin-bottom:7px;opacity:${done ? 1 : 0.5};">
      <span style="font-size:26px;">${l.icon}</span>
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:800;color:${l.color};">${l.name}</div>
        <div style="font-size:11px;color:#64748b;font-weight:700;">${l.min}‚Äì${l.max === 9999 ? '‚àû' : l.max} –±–∞—à–µ–Ω</div>
      </div>
      ${isCur ? `<div style="font-size:11px;color:${l.color};font-weight:800;">‚Üê –í–´</div>` : done ? '<div style="font-size:14px;">‚úÖ</div>' : '<div style="font-size:14px;">üîí</div>'}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DAILY STREAK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STREAK_REWARDS = [
  { day: 1,  icon: 'ü•í', reward: '+20 ü•í',  type: 'cukes', amount: 20 },
  { day: 2,  icon: '‚≠ê', reward: '+50 XP',   type: 'xp',    amount: 50 },
  { day: 3,  icon: 'üõ°Ô∏è', reward: '–©–∏—Ç',     type: 'shield', amount: 1 },
  { day: 4,  icon: 'ü•í', reward: '+50 ü•í',  type: 'cukes', amount: 50 },
  { day: 5,  icon: 'üß≤', reward: '–ú–∞–≥–Ω–∏—Ç',  type: 'magnet', amount: 1 },
  { day: 6,  icon: '‚ú®', reward: '+2 –∑–æ–ª–æ—Ç–∞', type: 'gold',  amount: 2 },
  { day: 7,  icon: 'üåü', reward: '–†–µ–¥–∫–∏–π —Å–∫–∏–Ω!', type: 'skin', amount: 0 },
  { day: 30, icon: 'üêâ', reward: '–ü–∏—Ç–æ–º–µ—Ü-–ª–µ–≥–µ–Ω–¥–∞!', type: 'legendpet', amount: 0 },
];

function getStreakData() {
  let d = null;
  try { d = JSON.parse(localStorage.getItem('fc_streak') || 'null'); } catch(e) {}
  if (!d) d = { streak: 0, lastDate: null, claimedDays: [] };
  return d;
}
function saveStreakData(d) { try { localStorage.setItem('fc_streak', JSON.stringify(d)); } catch(e) {} }

function checkDailyStreak() {
  const d = getStreakData();
  const today = new Date().toDateString();
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  if (d.lastDate === today) return; // already logged today
  if (d.lastDate === yesterday) d.streak++;
  else if (d.lastDate !== today) d.streak = 1; // reset
  d.lastDate = today;
  saveStreakData(d);
  // Check rewards
  const reward = STREAK_REWARDS.find(r => r.day === d.streak && !d.claimedDays.includes(r.day));
  if (reward) {
    d.claimedDays.push(reward.day);
    saveStreakData(d);
    setTimeout(() => {
      if (reward.type === 'cukes') { cucumbers += reward.amount; save(); updateHUD(); }
      else if (reward.type === 'gold') { goldCukes += reward.amount; save(); updateHUD(); }
      else if (reward.type === 'xp') { addXP(reward.amount); }
      else if (reward.type === 'shield') { boosters.shield = (boosters.shield||0) + 1; save(); }
      else if (reward.type === 'magnet') { boosters.magnet = (boosters.magnet||0) + 1; save(); }
      showToast(`üî• –î–µ–Ω—å ${d.streak}! ${reward.reward}`);
    }, 1500);
  }
}

function showStreak() {
  document.getElementById('start-screen').classList.add('hidden');
  renderStreakScreen();
  document.getElementById('streak-screen').classList.remove('hidden');
}

function renderStreakScreen() {
  const d = getStreakData();
  const cntEl = document.getElementById('streak-count');
  if (cntEl) cntEl.textContent = d.streak || 0;

  const grid = document.getElementById('streak-days-grid');
  if (grid) {
    const today = new Date().toDateString();
    const days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
    const dayOfWeek = new Date().getDay();
    grid.innerHTML = days.map((day, i) => {
      const isToday = (i + 1) % 7 === dayOfWeek % 7;
      const done = d.streak > 0 && i < (d.streak % 7 || 7);
      return `<div style="text-align:center;background:${done ? 'rgba(251,146,60,.2)' : 'rgba(0,0,0,.2)'};border:1px solid ${isToday ? '#fb923c' : done ? 'rgba(251,146,60,.3)' : 'rgba(255,255,255,.06)'};border-radius:8px;padding:6px 4px;">
        <div style="font-size:16px;">${done ? 'üî•' : '‚ó¶'}</div>
        <div style="font-size:11px;color:#94a3b8;font-weight:700;">${day}</div>
      </div>`;
    }).join('');
  }

  const rewardsList = document.getElementById('streak-rewards-list');
  if (rewardsList) {
    rewardsList.innerHTML = STREAK_REWARDS.map(r => {
      const claimed = d.claimedDays.includes(r.day);
      const unlocked = d.streak >= r.day;
      return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05);opacity:${unlocked ? 1 : 0.5};">
        <span style="font-size:20px;">${r.icon}</span>
        <div style="flex:1;font-size:12px;font-weight:700;color:#e2e8f0;">–î–µ–Ω—å ${r.day}: ${r.reward}</div>
        ${claimed ? '<span style="font-size:13px;">‚úÖ</span>' : unlocked ? '<span style="font-size:11px;color:#fb923c;font-weight:800;">–ó–ê–ë–†–ê–¢–¨!</span>' : '<span style="font-size:13px;color:#475569;">üîí</span>'}
      </div>`;
    }).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BEST RUN SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showBestRun() {
  document.getElementById('start-screen').classList.add('hidden');
  renderBestRunScreen();
  document.getElementById('bestrun-screen').classList.remove('hidden');
}

function renderBestRunScreen() {
  const canvas = document.getElementById('bestrun-canvas');
  if (!canvas) return;
  const c = canvas.getContext('2d');
  const cw = canvas.width, ch = canvas.height;
  c.clearRect(0, 0, cw, ch);

  // Background
  const bg = c.createLinearGradient(0, 0, 0, ch);
  bg.addColorStop(0, '#061a10'); bg.addColorStop(1, '#020d07');
  c.fillStyle = bg; c.fillRect(0, 0, cw, ch);

  // Ground
  c.fillStyle = '#14532d'; c.fillRect(0, ch - 20, cw, 20);
  c.fillStyle = '#4ade80'; c.fillRect(0, ch - 20, cw, 3);

  if (ghostTrajectory && ghostTrajectory.length > 1) {
    // Draw ghost trajectory path
    const scaleX = cw / W;
    const scaleY = (ch - 20) / H;
    c.save();
    c.strokeStyle = 'rgba(74,222,128,.6)';
    c.lineWidth = 2;
    c.setLineDash([4, 4]);
    c.beginPath();
    ghostTrajectory.forEach((pt, i) => {
      const px = pt.x * scaleX, py = pt.y * scaleY;
      if (i === 0) c.moveTo(px, py); else c.lineTo(px, py);
    });
    c.stroke();
    c.setLineDash([]);
    // Draw cucumber at end position
    const last = ghostTrajectory[ghostTrajectory.length - 1];
    drawCucumber(c, last.x * scaleX, last.y * scaleY, 32, selectedSkin, 0, 0);
    c.restore();
  } else {
    c.fillStyle = 'rgba(74,222,128,.4)';
    c.font = 'bold 14px Nunito'; c.textAlign = 'center'; c.textBaseline = 'middle';
    c.fillText('–°—ã–≥—Ä–∞–π –∏–≥—Ä—É, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∫–æ—Ä–¥!', cw / 2, ch / 2);
  }

  const stats = document.getElementById('bestrun-stats');
  if (stats) {
    const cur = getCurrentLeague();
    stats.innerHTML = [
      ['üèÜ –†–µ–∫–æ—Ä–¥', bestScore + ' –±–∞—à–µ–Ω'],
      ['ü•á –õ–∏–≥–∞', cur.icon + ' ' + cur.name],
      ['üéÆ –ò–≥—Ä –≤—Å–µ–≥–æ', totalGames],
      ['ü•í –ú–æ–Ω–µ—Ç —Å–æ–±—Ä–∞–Ω–æ', totalCoins],
    ].map(([label, val]) => `<div style="background:rgba(0,0,0,.35);border:1px solid rgba(74,222,128,.15);border-radius:10px;padding:9px 8px;text-align:center;">
      <div style="font-size:11px;color:#64748b;font-weight:700;margin-bottom:3px;">${label}</div>
      <div style="font-size:15px;font-weight:900;color:#4ade80;">${val}</div>
    </div>`).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MINI-BOSSES every 20 score points
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MINI_BOSS_TYPES = [
  { name: 'üî• –û–ì–†–û–ú–ù–ê–Ø –¢–†–£–ë–ê', type: 'pipe',   score: 0 },
  { name: '‚ö° –î–í–û–ô–ù–ê–Ø –°–ö–û–†–û–°–¢–¨', type: 'speed',  score: 0 },
  { name: 'üíÄ –î–í–ò–ñ–£–©–ò–ï–°–Ø –®–ò–ü–´', type: 'spikes', score: 0 },
];
let miniBossActive = false, miniBossTimer = 0;

function checkMiniBoss() {
  if (!miniBossActive && score > 0 && score % 20 === 0 && score !== lastBossScore) {
    // pick random mini boss event
    const evt = MINI_BOSS_TYPES[Math.floor(Math.random() * MINI_BOSS_TYPES.length)];
    lastBossScore = score;
    miniBossActive = true;
    miniBossTimer = 180; // ~3 seconds
    if (evt.type === 'speed') {
      if (activeTurbo <= 0) { preTurboSpeed = speed; speed = speed * 1.6; }
      activeTurbo = 180;
    }
    showLabel('üëπ –ú–ò–ù–ò-–ë–û–°–°: ' + evt.name + '!', '#ef4444');
    showToast('‚ö†Ô∏è ' + evt.name);
    if (typeof tone === 'function') { tone(150, 'sawtooth', .15, .4); tone(120, 'sawtooth', .2, .3, .15); }
  }
  if (miniBossActive) {
    miniBossTimer--;
    if (miniBossTimer <= 0) {
      miniBossActive = false;
      if (activeTurbo > 0 && preTurboSpeed > 0) { speed = preTurboSpeed; activeTurbo = 0; }
    }
  }
}

// Patch gameLoop to call checkMiniBoss and drawActivePet
const _origGameLoop = gameLoop;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT: check streak, bind shop tabs, etc.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
checkDailyStreak();


// Improvements screen (Boost + Upgrades merged)
function showImprovements() {
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('boost-cukes').textContent = cucumbers;
  document.getElementById('sh-n').textContent = boosters.shield || 0;
  document.getElementById('mg-n').textContent = boosters.magnet || 0;
  document.getElementById('tb-n').textContent = boosters.turbo || 0;
  document.getElementById('mega-n').textContent = boosters.mega || 0;
  document.getElementById('boost-screen').classList.remove('hidden');
  setImprTab('boost');
}
  const boostPane = document.getElementById('impr-boost-pane');
  const upgPane = document.getElementById('impr-upg-pane');
  const tabBoost = document.getElementById('impr-tab-boost');
  const tabUpg = document.getElementById('impr-tab-upg');
  if (!boostPane || !upgPane) return;
  boostPane.classList.toggle('hidden', tab !== 'boost');
  upgPane.classList.toggle('hidden', tab !== 'upg');
  if (tabBoost) tabBoost.className = 'shop-tab' + (tab === 'boost' ? ' active' : '');
  if (tabUpg) tabUpg.className = 'shop-tab' + (tab === 'upg' ? ' active' : '');
  if (tab === 'upg') {
    const cuEl = document.getElementById('impr-upg-cukes');
    if (cuEl) cuEl.textContent = cucumbers;
    const grid = document.getElementById('impr-upg-grid');
    if (grid && typeof UPGRADES !== 'undefined') {
      grid.innerHTML = '';
      UPGRADES.forEach(u => {
        const lv = upgradelevels[u.id] || 0, maxed = lv >= u.maxLevel, cost = getUpgradeCost(u.id);
        const card = document.createElement('div');
        card.className = 'upgrade-card' + (maxed ? ' maxed' : '');
        card.innerHTML = `<span class="upg-icon">${u.icon}</span>
          <div class="upg-name">${u.name}</div>
          <div class="upg-desc">${u.desc}</div>
          <div class="upg-level">${'‚òÖ'.repeat(lv)}${'‚òÜ'.repeat(u.maxLevel - lv)}</div>
          <div class="upg-price">${maxed ? '‚úÖ –ú–ê–ö–°' : 'ü•í ' + cost}</div>`;
        if (!maxed) card.onclick = () => {
          if (cucumbers < cost) { showToast(`–ù—É–∂–Ω–æ ü•í${cost}`); return; }
          cucumbers -= cost; upgradelevels[u.id] = (upgradelevels[u.id] || 0) + 1; save();
          showToast(`‚úÖ ${u.name} —É–ª—É—á—à–µ–Ω!`); playScore(); setImprTab('upg');
        };
        grid.appendChild(card);
      });
    }
  }
}

// Bind shop tabs properly
['skins','worlds','trails','upg','pets'].forEach(t => {
  const el = document.getElementById(`stab-${t}`);
  if (el) el.addEventListener('click', () => setShopTab(t === 'upg' ? 'upgrades' : t));
});

// Nick modal nick change button (rendered dynamically - handled via event delegation)
document.addEventListener('click', e => {
  if (e.target && e.target.id === 'lb-nick-btn') {
    const ni = document.getElementById('nick-input');
    if (ni) ni.value = playerNickname || '';
    document.getElementById('nick-modal').classList.remove('hidden');
  }
});

// ar-tab clicks
['achiev','ranks','stickers'].forEach(t => {
  const el = document.getElementById(`ar-tab-${t}`);
  if (el) el.addEventListener('click', () => setArTab(t));
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastQueue=[],toastShowing=false;
function showToast(msg){
  toastQueue.push(msg);if(!toastShowing)processToast();
}
function processToast(){
  if(!toastQueue.length){toastShowing=false;return;}
  toastShowing=true;const t=document.getElementById('toast');t.textContent=toastQueue.shift();t.classList.add('show');
  setTimeout(()=>{t.classList.remove('show');setTimeout(processToast,300);},2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ANIMATED START SCREEN BACKGROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const startBg=document.getElementById('start-bg-canvas');
const sbCtx=startBg.getContext('2d');
let sbW=0,sbH=0,sbFrame=0;
const sbParticles=Array.from({length:60},()=>({
  x:Math.random()*800,y:Math.random()*1200,
  vx:(Math.random()-.5)*.4,vy:-Math.random()*.6-.2,
  r:Math.random()*3+.5,
  hue:Math.random()<.5?120+Math.random()*30:60+Math.random()*20,
  alpha:Math.random()*.7+.3,
  tw:Math.random()*Math.PI*2
}));
const sbPipes=Array.from({length:4},(_,i)=>({x:200+i*220,speed:.4+i*.15,hue:120+i*10}));

function resizeStartBg(){
  sbW=startBg.width=window.innerWidth;
  sbH=startBg.height=window.innerHeight;
}
resizeStartBg();
window.addEventListener('resize',resizeStartBg);

let _sbRafId=null;
function animateStartBg(){
  if(gameState!=='menu'){_sbRafId=null;return;}
  sbFrame++;
  sbCtx.clearRect(0,0,sbW,sbH);

  // Gradient background
  const bg=sbCtx.createLinearGradient(0,0,0,sbH);
  bg.addColorStop(0,'#020d07');bg.addColorStop(.4,'#061a10');bg.addColorStop(.7,'#0d2b1a');bg.addColorStop(1,'#020d07');
  sbCtx.fillStyle=bg;sbCtx.fillRect(0,0,sbW,sbH);

  // Radial glow center
  const rg=sbCtx.createRadialGradient(sbW/2,sbH*.35,0,sbW/2,sbH*.35,sbW*.6);
  rg.addColorStop(0,'rgba(74,222,128,.06)');rg.addColorStop(.5,'rgba(34,197,94,.03)');rg.addColorStop(1,'transparent');
  sbCtx.fillStyle=rg;sbCtx.fillRect(0,0,sbW,sbH);

  // Animated pipes in background
  sbPipes.forEach(p=>{
    p.x-=p.speed;if(p.x<-70)p.x=sbW+70;
    const gp=sbCtx.createLinearGradient(p.x-35,0,p.x+35,0);
    gp.addColorStop(0,'rgba(5,46,22,.5)');gp.addColorStop(.4,'rgba(74,222,128,.2)');gp.addColorStop(1,'rgba(5,46,22,.5)');
    sbCtx.fillStyle=gp;
    // top pipe
    sbCtx.beginPath();sbCtx.roundRect(p.x-30,0,60,sbH*.2,3);sbCtx.fill();
    sbCtx.fillStyle='rgba(74,222,128,.15)';
    sbCtx.beginPath();sbCtx.roundRect(p.x-35,sbH*.2,70,12,4);sbCtx.fill();
    // bottom pipe
    sbCtx.fillStyle=gp;
    sbCtx.beginPath();sbCtx.roundRect(p.x-30,sbH*.65,60,sbH*.35,3);sbCtx.fill();
    sbCtx.fillStyle='rgba(74,222,128,.15)';
    sbCtx.beginPath();sbCtx.roundRect(p.x-35,sbH*.65-12,70,12,[0,0,4,4]);sbCtx.fill();
  });

  // Floating particles
  sbParticles.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.tw+=.02;
    if(p.y<-10){p.y=sbH+10;p.x=Math.random()*sbW;}
    if(p.x<-10||p.x>sbW+10){p.x=Math.random()*sbW;}
    const a=p.alpha*(0.5+Math.abs(Math.sin(p.tw))*.5);
    sbCtx.fillStyle=`hsla(${p.hue},80%,65%,${a})`;
    sbCtx.shadowColor=`hsl(${p.hue},80%,65%)`;sbCtx.shadowBlur=8;
    sbCtx.beginPath();sbCtx.arc(p.x,p.y,p.r,0,Math.PI*2);sbCtx.fill();
    sbCtx.shadowBlur=0;
  });

  // Grid lines (subtle)
  sbCtx.strokeStyle='rgba(74,222,128,.03)';sbCtx.lineWidth=1;
  const gridOff=(sbFrame*.5)%60;
  for(let x=gridOff;x<sbW;x+=60){sbCtx.beginPath();sbCtx.moveTo(x,0);sbCtx.lineTo(x,sbH);sbCtx.stroke();}
  for(let y=gridOff;y<sbH;y+=60){sbCtx.beginPath();sbCtx.moveTo(0,y);sbCtx.lineTo(sbW,y);sbCtx.stroke();}

  _sbRafId=requestAnimationFrame(animateStartBg);
}
function startAnimateBg(){if(!_sbRafId&&gameState==='menu'){_sbRafId=requestAnimationFrame(animateStartBg);}}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PET VISUAL SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PET_TRAIL_POOL = [];
let petTrailParts = [];

const PET_CONFIGS = {
  none:    {trail:null, aura:null, hop:0},
  bug:     {trail:['#4ade80','#86efac','#22c55e'], aura:null, hop:0.08},
  frog:    {trail:['#4ade80','#22c55e','#86efac'], aura:null, hop:0.18},
  dragon2: {trail:['#ef4444','#f97316','#fbbf24'], aura:'#ef4444', hop:0.05},
  star_p:  {trail:['#fbbf24','#fff','#fde68a'],   aura:null, hop:0.1},
  alien_p: {trail:['#818cf8','#c4b5fd','#38bdf8'], aura:'#818cf8', hop:0.06},
  ghost_p: {trail:['rgba(255,255,255,.5)','rgba(200,200,255,.4)','rgba(255,255,255,.3)'], aura:null, hop:0, alpha:0.6},
  angel:   {trail:['#fde68a','#fff','#fef3c7'],   aura:'#fde68a', hop:0.07},
  phoenix: {trail:['#f97316','#ef4444','#fbbf24','#fff'], aura:'#f97316', hop:0.04},
};

function drawActivePet(bx, by, frame) {
  if(!selectedPet || selectedPet==='none') return;
  const pet = PETS.find(p=>p.id===selectedPet);
  if(!pet || !pet.emoji) return;
  const cfg = PET_CONFIGS[selectedPet] || PET_CONFIGS.none;
  
  // Pet follows behind player with offset
  const offsetX = -45;
  const hopY = cfg.hop ? Math.sin(frame * 0.15) * 8 * cfg.hop * 50 : 0;
  const px = bx + offsetX;
  const py = by + hopY;
  
  // Spawn trail particle
  if(frame % 3 === 0 && cfg.trail) {
    const tp = PET_TRAIL_POOL.pop() || {};
    tp.x = px; tp.y = py;
    tp.vx = (Math.random()-.5)*1.5;
    tp.vy = -Math.random()*1.2 - 0.3;
    tp.life = 20; tp.max = 20;
    tp.color = cfg.trail[frame % cfg.trail.length];
    tp.r = 4 + Math.random()*3;
    petTrailParts.push(tp);
  }
  
  // Draw trail particles
  petTrailParts = petTrailParts.filter(p=>p.life>0);
  petTrailParts.forEach(p=>{
    p.x += p.vx; p.y += p.vy; p.life--;
    ctx.globalAlpha = p.life/p.max * 0.8;
    ctx.fillStyle = p.color;
    // Dragon gets fire effect
    if(selectedPet === 'dragon2') {
      ctx.shadowColor = '#f97316'; ctx.shadowBlur = 8;
    }
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r*(p.life/p.max), 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    if(p.life <= 0) PET_TRAIL_POOL.push(p);
  });
  ctx.globalAlpha = 1;
  
  // Draw aura for rare pets
  if(cfg.aura) {
    ctx.save();
    ctx.globalAlpha = 0.2 + Math.sin(frame*0.08)*0.08;
    ctx.fillStyle = cfg.aura;
    ctx.beginPath(); ctx.arc(px, py, 22, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.restore();
  }
  
  // Ghost pet - semi-transparent with wave
  if(selectedPet === 'ghost_p') {
    ctx.globalAlpha = 0.6 + Math.sin(frame*0.1)*0.15;
  }
  
  // Draw pet emoji
  ctx.save();
  // Frog hops - scale Y
  if(selectedPet === 'frog') {
    const scaleY = 1 + Math.abs(Math.sin(frame*0.2))*0.3;
    ctx.translate(px, py); ctx.scale(1, scaleY); ctx.translate(-px,-py);
  }
  ctx.font = '22px serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  ctx.fillText(pet.emoji, px, py);
  ctx.restore();
  ctx.globalAlpha = 1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COUNTDOWN ANIMATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCountdown(cb) {
  const overlay = document.getElementById('countdown-overlay');
  const num = document.getElementById('countdown-num');
  overlay.classList.remove('hidden');
  let count = 3;
  function tick() {
    if(count > 0) {
      num.textContent = count;
      num.style.transform = 'scale(1.4)';
      num.style.transition = 'none';
      setTimeout(()=>{
        num.style.transition = 'transform 0.8s ease-out, opacity 0.8s ease-out';
        num.style.transform = 'scale(0.7)';
        num.style.opacity = '0.3';
      }, 50);
      if(typeof tone==='function') tone(count===1?880:count===2?660:440,'sine',.15,.35);
      count--;
      setTimeout(tick, 900);
    } else {
      num.textContent = 'GO!';
      num.style.color = '#fbbf24';
      num.style.transform = 'scale(1)';
      num.style.opacity = '1';
      if(typeof tone==='function'){tone(880,'sine',.06,.4);tone(1320,'sine',.08,.35,.07);}
      setTimeout(()=>{
        overlay.classList.add('hidden');
        num.style.color = '#4ade80';
        num.style.opacity = '1';
        if(cb) cb();
      }, 700);
    }
  }
  tick();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BEST RUN + LAST RECORD SCREENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastRunData = null; // store last game data

function showBestRun() {
  document.getElementById('start-screen').classList.add('hidden');
  const el = document.getElementById('bestrun-content');
  const modes = {easy:'–õ—ë–≥–∫–∏–π',normal:'–û–±—ã—á–Ω—ã–π',hard:'–°–ª–æ–∂–Ω—ã–π',insane:'–ë–µ–∑—É–º–∏–µ',crazy:'–•–∞–æ—Å',flip:'–¢–æ—Ä–º–∞—à–∫–∏',zen:'–î–∑–µ–Ω'};
  el.innerHTML = `
    <div class="go-box" style="margin-bottom:12px;">
      <div class="go-lbl" style="font-size:12px;">üèÜ –õ–£–ß–®–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢</div>
      <div class="go-val" style="font-size:40px;">${bestScore}</div>
      <div style="font-size:13px;color:#94a3b8;margin-top:4px;">–ë–∞—à–µ–Ω –ø—Ä–æ–π–¥–µ–Ω–æ</div>
    </div>
    <div class="go-box" style="margin-bottom:12px;">
      <div style="font-size:13px;color:#64748b;margin-bottom:6px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div style="font-size:13px;color:#e2e8f0;line-height:2;">üéÆ –ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: <span style="color:#4ade80">${totalGames}</span><br>
      ü•í –ú–æ–Ω–µ—Ç —Å–æ–±—Ä–∞–Ω–æ: <span style="color:#4ade80">${totalCoins}</span><br>
      ‚≠ê XP –≤—Å–µ–≥–æ: <span style="color:#a78bfa">${playerXP}</span><br>
      üíÄ –ë–æ—Å—Å–æ–≤ –ø–æ–±–µ–∂–¥–µ–Ω–æ: <span style="color:#ef4444">${bossesDefeated}</span><br>
      ${getRank().icon} –†–∞–Ω–≥: <span style="color:${getRank().color}">${getRank().name}</span></div>
    </div>
  `;
  document.getElementById('bestrun-screen').classList.remove('hidden');
}

function closeBestRun() {
  document.getElementById('bestrun-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
}

function showLastRecord() {
  document.getElementById('start-screen').classList.add('hidden');
  const el = document.getElementById('lastrecord-content');
  if(!lastRunData) {
    el.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:30px;font-size:14px;">–°—ã–≥—Ä–∞–π —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∏–≥—Ä—É!</div>';
  } else {
    const d = lastRunData;
    el.innerHTML = `
      <div class="go-box" style="margin-bottom:12px;">
        <div class="go-lbl" style="font-size:12px;">üéØ –ü–û–°–õ–ï–î–ù–Ø–Ø –ò–ì–†–ê</div>
        <div class="go-val" style="font-size:40px;">${d.score}</div>
        <div style="font-size:13px;color:#94a3b8;margin-top:4px;">–ë–∞—à–µ–Ω ‚Äî ${d.mode}</div>
      </div>
      <div class="go-box">
        <div style="font-size:13px;color:#64748b;margin-bottom:6px;">–î–µ—Ç–∞–ª–∏</div>
        <div style="font-size:13px;color:#e2e8f0;line-height:2;">ü•í –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span style="color:#4ade80">+${d.earned}</span><br>
        ‚≠ê XP –ø–æ–ª—É—á–µ–Ω–æ: <span style="color:#a78bfa">+${d.xp}</span><br>
        ${d.isRecord ? 'üÜï <span style="color:#fbbf24">–ù–û–í–´–ô –†–ï–ö–û–†–î!</span>' : 'üìä –†–µ–∫–æ—Ä–¥: ' + bestScore}</div>
      </div>
    `;
  }
  document.getElementById('lastrecord-screen').classList.remove('hidden');
}

function closeLastRecord() {
  document.getElementById('lastrecord-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// loadSave() already ran at line 686 when vars were declared
// Now call initTelegram AFTER all game data is loaded - admin gets correct state
initTelegram();
updateHUD();drawBg();animateHero();startAnimateBg();
checkNicknameOnStart();
updateActivePetDisplay();
// Init daily quests badge
(()=>{const data=loadQuests();const done=data.quests.filter(q=>q.progress>=q.target&&!q.claimed).length;const btn=document.getElementById('quests-btn');if(btn&&done>0)btn.textContent=`üéØ –ó–ê–î–ê–ù–ò–Ø (${done})`;})();
</script>

</body>
</html>