<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Flappy Cucumber ü•í</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;touch-action:none;-webkit-tap-highlight-color:transparent;}
  body{
    background:radial-gradient(ellipse at center,#0d2b1a 0%,#050f09 100%);
    display:flex;justify-content:center;align-items:center;
    height:100vh;overflow:hidden;font-family:'Press Start 2P',monospace;
  }
  #wrap{
    position:relative;width:400px;height:650px;
    overflow:hidden;border-radius:24px;
    box-shadow:0 0 80px rgba(74,222,128,.25),0 0 200px rgba(74,222,128,.08),inset 0 0 0 2px rgba(74,222,128,.3);
  }
  canvas{display:block;width:100%;height:100%;}
  #ui{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;}

  /* HUD */
  #hud-score{position:absolute;top:18px;left:50%;transform:translateX(-50%);color:#fff;font-size:30px;text-shadow:0 0 20px rgba(74,222,128,.9),2px 2px 0 #000;pointer-events:none;}
  #hud-currency{position:absolute;top:16px;left:14px;color:#7fffb0;font-size:9px;text-shadow:0 0 10px rgba(74,222,128,.7);display:flex;align-items:center;gap:4px;}
  #hud-stars{position:absolute;top:16px;right:14px;color:#FFD700;font-size:9px;text-shadow:0 0 10px rgba(255,215,0,.7);display:flex;align-items:center;gap:4px;}

  .screen{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:all;}
  .hidden{display:none!important;}

  /* START */
  #start-screen{background:linear-gradient(170deg,#061a10 0%,#0d2b1a 50%,#061a10 100%);}
  .game-title{font-size:17px;color:#4ade80;line-height:1.6;text-align:center;text-shadow:0 0 30px #4ade80,0 0 60px rgba(74,222,128,.4),2px 2px 0 #000;animation:titleGlow 2.5s infinite;margin-bottom:2px;}
  @keyframes titleGlow{0%,100%{text-shadow:0 0 20px #4ade80,2px 2px 0 #000}50%{text-shadow:0 0 50px #4ade80,0 0 100px rgba(74,222,128,.3),2px 2px 0 #000}}
  #hero-canvas{margin:4px 0 2px;filter:drop-shadow(0 0 12px rgba(74,222,128,.6));animation:heroFloat 1.8s ease-in-out infinite;}
  @keyframes heroFloat{0%,100%{transform:translateY(0) rotate(-4deg)}50%{transform:translateY(-10px) rotate(4deg)}}
  .currency-bar{display:flex;gap:14px;margin:4px 0 8px;background:rgba(0,0,0,.3);border-radius:12px;padding:6px 14px;border:1px solid rgba(74,222,128,.2);}
  .currency-item{font-size:7px;color:#94a3b8;text-align:center;}
  .currency-item span{display:block;font-size:10px;margin-bottom:2px;}
  .currency-item .val{color:#4ade80;}.currency-item .val.gold{color:#FFD700;}
  .btns{display:flex;gap:7px;flex-wrap:wrap;justify-content:center;}
  .btn{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border:none;padding:10px 18px;font-family:'Press Start 2P',monospace;font-size:9px;border-radius:12px;cursor:pointer;box-shadow:0 4px 0 #14532d,0 0 20px rgba(74,222,128,.2);transition:transform .1s,box-shadow .1s;pointer-events:all;}
  .btn:active{transform:translateY(4px);box-shadow:0 0 0 #14532d;}
  .btn.gold{background:linear-gradient(135deg,#fbbf24,#d97706);box-shadow:0 4px 0 #92400e,0 0 20px rgba(251,191,36,.2);}
  .btn.gold:active{box-shadow:0 0 0 #92400e;}
  .btn.blue{background:linear-gradient(135deg,#38bdf8,#0284c7);box-shadow:0 4px 0 #075985,0 0 20px rgba(56,189,248,.2);}
  .btn.blue:active{box-shadow:0 0 0 #075985;}
  .btn.purple{background:linear-gradient(135deg,#a78bfa,#7c3aed);box-shadow:0 4px 0 #4c1d95;}
  .btn.purple:active{box-shadow:0 0 0 #4c1d95;}
  .tap-hint{color:#4b7a5c;font-size:8px;animation:blink 1.3s infinite;margin-top:6px;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

  /* SHOP ‚Äî carousel layout */
  #shop-screen{background:linear-gradient(170deg,#0a0a1a 0%,#1a0a2e 50%,#0a0a1a 100%);padding:16px 12px;overflow:hidden;}
  .shop-title{font-size:13px;color:#a78bfa;text-shadow:0 0 20px #a78bfa;margin-bottom:6px;}
  .shop-balance{display:flex;gap:14px;margin-bottom:10px;background:rgba(255,255,255,.04);border-radius:10px;padding:7px 14px;border:1px solid rgba(255,255,255,.08);}
  .bal-item{font-size:8px;color:#94a3b8;display:flex;align-items:center;gap:5px;}
  .bal-val{color:#4ade80;}.bal-val.gold{color:#FFD700;}
  .exchange-box{background:rgba(255,215,0,.07);border:1px solid rgba(255,215,0,.2);border-radius:12px;padding:10px 16px;margin-bottom:12px;text-align:center;width:100%;max-width:360px;}
  .exchange-title{font-size:7px;color:#FFD700;margin-bottom:6px;}
  .exchange-rate{font-size:8px;color:#94a3b8;margin-bottom:6px;}.exchange-rate span{color:#fff;}
  .exchange-input-row{display:flex;align-items:center;gap:8px;justify-content:center;}
  .exchange-input{background:rgba(0,0,0,.4);border:1px solid rgba(255,215,0,.3);color:#FFD700;font-family:'Press Start 2P',monospace;font-size:9px;padding:6px 10px;border-radius:8px;width:70px;text-align:center;}
  .exchange-input:focus{outline:none;border-color:#FFD700;}

  /* Carousel */
  .carousel-wrap{position:relative;width:100%;max-width:360px;margin-bottom:12px;}
  .carousel-viewport{width:100%;overflow:hidden;border-radius:16px;}
  .carousel-track{display:flex;transition:transform .35s cubic-bezier(.4,0,.2,1);}
  .carousel-slide{min-width:100%;display:flex;justify-content:center;align-items:center;padding:0 8px;}

  /* Skin card inside carousel */
  .skin-card-big{
    background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);
    border-radius:20px;padding:20px 28px;text-align:center;
    width:100%;position:relative;transition:border-color .2s;
  }
  .skin-card-big.owned{border-color:#22c55e;background:rgba(74,222,128,.07);}
  .skin-card-big.selected{border-color:#FFD700;background:rgba(255,215,0,.1);box-shadow:0 0 30px rgba(255,215,0,.2);}
  .skin-card-big.secret-card{border-color:#a78bfa;background:rgba(167,139,250,.08);}
  .skin-canvas-big{width:100px;height:100px;margin:0 auto 12px;}
  .skin-canvas-big canvas{width:100%;height:100%;}
  .skin-name-big{font-size:11px;color:#e2e8f0;margin-bottom:8px;letter-spacing:1px;}
  .skin-price-big{font-size:10px;color:#4ade80;margin-bottom:14px;}
  .skin-price-big.owned-lbl{color:#64748b;font-size:9px;}
  .skin-price-big.selected-lbl{color:#FFD700;}
  .skin-price-big.secret-lbl{color:#a78bfa;font-size:8px;}
  .skin-badge{position:absolute;top:-8px;right:-8px;padding:3px 8px;border-radius:8px;font-size:7px;color:#fff;}

  /* Carousel arrows */
  .carousel-arrow{
    position:absolute;top:50%;transform:translateY(-50%);
    background:rgba(0,0,0,.6);border:2px solid rgba(255,255,255,.15);
    color:#fff;width:36px;height:36px;border-radius:50%;font-size:14px;
    cursor:pointer;display:flex;align-items:center;justify-content:center;
    z-index:10;transition:all .15s;pointer-events:all;
  }
  .carousel-arrow:hover{background:rgba(74,222,128,.3);border-color:#4ade80;}
  .carousel-arrow:active{transform:translateY(-50%) scale(.9);}
  .carousel-arrow.left{left:-4px;}
  .carousel-arrow.right{right:-4px;}

  /* Dots */
  .carousel-dots{display:flex;gap:6px;justify-content:center;margin-bottom:10px;}
  .dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.2);transition:all .2s;cursor:pointer;}
  .dot.active{background:#a78bfa;box-shadow:0 0 8px #a78bfa;}

  /* LEADERBOARD */
  #leaderboard-screen{background:linear-gradient(170deg,#0a1628 0%,#0f2044 100%);padding:20px;overflow-y:auto;justify-content:flex-start;padding-top:24px;}
  .lb-title{font-size:12px;color:#38bdf8;text-shadow:0 0 20px #38bdf8;margin-bottom:16px;}
  .lb-list{width:100%;max-width:360px;}
  .lb-entry{display:flex;align-items:center;background:rgba(255,255,255,.04);border-radius:12px;padding:10px 14px;margin-bottom:8px;border:1px solid rgba(255,255,255,.06);gap:10px;}
  .lb-rank{font-size:11px;width:26px;color:#475569;}
  .lb-rank.r1{color:#FFD700;text-shadow:0 0 10px #FFD700;}
  .lb-rank.r2{color:#C0C0C0;}
  .lb-rank.r3{color:#CD7F32;}
  .lb-skin-preview{width:32px;height:32px;}
  .lb-skin-preview canvas{width:100%;height:100%;}
  .lb-name{flex:1;font-size:7px;color:#e2e8f0;}
  .lb-score{font-size:10px;color:#4ade80;text-shadow:0 0 8px #4ade80;}

  /* REFERRAL */
  #ref-screen{background:linear-gradient(170deg,#0f1a0a 0%,#1a2e0d 100%);padding:20px;}
  .ref-title{font-size:12px;color:#4ade80;text-shadow:0 0 20px #4ade80;margin-bottom:12px;}
  .ref-box{background:rgba(0,0,0,.4);border:2px dashed rgba(74,222,128,.4);border-radius:16px;padding:20px;text-align:center;width:100%;max-width:340px;margin-bottom:16px;}
  .ref-reward{font-size:10px;color:#4ade80;margin-bottom:8px;}
  .ref-reward span{color:#7fffb0;font-size:16px;}
  .ref-link{background:rgba(74,222,128,.1);border:1px solid rgba(74,222,128,.3);border-radius:10px;padding:10px 14px;font-size:7px;color:#94a3b8;word-break:break-all;margin-bottom:10px;cursor:pointer;}
  .ref-link:hover{background:rgba(74,222,128,.15);color:#e2e8f0;}
  .ref-stats{font-size:8px;color:#94a3b8;margin-top:8px;}
  .ref-stats span{color:#4ade80;}
  .ref-note{font-size:6px;color:#475569;text-align:center;line-height:1.8;max-width:300px;}

  /* GAMEOVER */
  #gameover-screen{background:rgba(0,0,0,.88);backdrop-filter:blur(6px);}
  .go-title{font-size:18px;color:#ef4444;text-align:center;text-shadow:0 0 30px #ef4444,2px 2px 0 #000;margin-bottom:16px;animation:goShake .4s ease;}
  @keyframes goShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}60%{transform:translateX(10px)}}
  .go-box{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.15);border-radius:18px;padding:20px 36px;text-align:center;margin-bottom:16px;}
  .go-lbl{font-size:6px;color:#64748b;margin-bottom:4px;}
  .go-val{font-size:32px;color:#4ade80;text-shadow:0 0 20px #4ade80;}
  .go-best{font-size:7px;color:#FFD700;margin-top:6px;}
  .go-earned{font-size:8px;color:#7fffb0;margin-top:6px;}
  .go-unlock{font-size:7px;color:#a78bfa;margin-top:6px;animation:titleGlow 1s infinite;}

  /* TOAST */
  #toast{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);border:1px solid rgba(74,222,128,.4);border-radius:12px;padding:10px 20px;font-size:8px;color:#4ade80;white-space:nowrap;opacity:0;transition:opacity .3s;pointer-events:none;z-index:100;}
  #toast.show{opacity:1;}

  ::-webkit-scrollbar{width:3px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="gameCanvas" width="400" height="650"></canvas>

  <div id="ui">
    <div id="hud-score" class="hidden">0</div>
    <div id="hud-currency" class="hidden">ü•í <span id="hud-cukes">0</span></div>
    <div id="hud-stars" class="hidden">‚≠ê <span id="hud-stars-val">0</span></div>
  </div>

  <!-- START -->
  <div class="screen" id="start-screen">
    <div class="game-title">FLAPPY<br>CUCUMBER</div>
    <canvas id="hero-canvas" width="44" height="72"></canvas>
    <div class="currency-bar">
      <div class="currency-item"><span>ü•í</span><div class="val" id="main-cukes">0</div>–æ–≥—É—Ä—á–∏–∫–∏</div>
      <div class="currency-item"><span>‚≠ê</span><div class="val gold" id="main-stars">0</div>–∑–≤—ë–∑–¥—ã</div>
    </div>
    <div class="btns">
      <button class="btn" onclick="startGame()">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
      <button class="btn gold" onclick="showShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
    </div>
    <div class="btns" style="margin-top:6px">
      <button class="btn blue" onclick="showLeaderboard()">üèÜ –†–ï–ô–¢–ò–ù–ì</button>
      <button class="btn purple" onclick="showRef()">üîó –î–†–£–ó–¨–Ø</button>
    </div>
    <div class="tap-hint" style="margin-top:6px">–¢–ê–ü / –ü–†–û–ë–ï–õ = –ü–†–´–ñ–û–ö</div>
  </div>

  <!-- SHOP -->
  <div class="screen hidden" id="shop-screen">
    <div class="shop-title">üõí –ú–ê–ì–ê–ó–ò–ù –°–ö–ò–ù–û–í</div>
    <div class="shop-balance">
      <div class="bal-item">ü•í <span class="bal-val" id="shop-cukes">0</span></div>
      <div class="bal-item">‚≠ê <span class="bal-val gold" id="shop-stars">0</span></div>
    </div>
    <div class="exchange-box">
      <div class="exchange-title">üí± –û–ë–ú–ï–ù –ó–í–Å–ó–î –ù–ê –û–ì–£–†–ß–ò–ö–ò</div>
      <div class="exchange-rate">1 ‚≠ê = <span>5 ü•í</span></div>
      <div class="exchange-input-row">
        <input class="exchange-input" type="number" id="exchange-amount" value="1" min="1">
        <span style="font-size:8px;color:#94a3b8">‚≠ê</span>
        <button class="btn gold" style="padding:8px 14px;font-size:8px" onclick="doExchange()">–û–ë–ú–ï–ù–Ø–¢–¨</button>
      </div>
    </div>

    <!-- Carousel -->
    <div class="carousel-wrap">
      <button class="carousel-arrow left" onclick="carouselPrev()">‚Äπ</button>
      <div class="carousel-viewport">
        <div class="carousel-track" id="carousel-track"></div>
      </div>
      <button class="carousel-arrow right" onclick="carouselNext()">‚Ä∫</button>
    </div>
    <div class="carousel-dots" id="carousel-dots"></div>

    <div style="display:flex;gap:8px;margin-top:4px;margin-bottom:8px;">
      <button class="btn purple" id="shop-action-btn" onclick="shopAction()">–í–´–ë–†–ê–¢–¨</button>
      <button class="btn" onclick="closeShop()">‚Üê –ù–ê–ó–ê–î</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="screen hidden" id="leaderboard-screen">
    <div class="lb-title">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</div>
    <div class="lb-list" id="lb-list"></div>
    <button class="btn blue" style="margin-top:12px;margin-bottom:16px" onclick="closeLeaderboard()">‚Üê –ù–ê–ó–ê–î</button>
  </div>

  <!-- REFERRAL -->
  <div class="screen hidden" id="ref-screen">
    <div class="ref-title">üîó –ü–†–ò–ì–õ–ê–°–ò –î–†–£–ì–ê</div>
    <div class="ref-box">
      <div class="ref-reward">–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞: <span>+30 ü•í</span></div>
      <div style="font-size:7px;color:#64748b;margin-bottom:12px">–¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</div>
      <div class="ref-link" id="ref-link-text" onclick="copyRef()">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
      <button class="btn" style="font-size:8px;padding:10px 20px" onclick="copyRef()">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
      <div class="ref-stats" style="margin-top:12px">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: <span id="ref-count">0</span> ¬∑ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: <span id="ref-earned">0</span> ü•í</div>
    </div>
    <div class="ref-note">–î—Ä—É–≥ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏–≥—Ä—É –ø–æ —Ç–≤–æ–µ–π —Å—Å—ã–ª–∫–µ ‚Äî<br>—Ç—ã –ø–æ–ª—É—á–∞–µ—à—å 30 –æ–≥—É—Ä—á–∏–∫–æ–≤ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ!</div>
    <button class="btn purple" style="margin-top:16px" onclick="closeRef()">‚Üê –ù–ê–ó–ê–î</button>
  </div>

  <!-- GAMEOVER -->
  <div class="screen hidden" id="gameover-screen">
    <div class="go-title">üíÄ –û–ì–£–†–ï–¶ –£–ú–ï–†!</div>
    <canvas id="dead-canvas" width="60" height="100" style="margin-bottom:12px;filter:drop-shadow(0 0 16px rgba(239,68,68,.5))"></canvas>
    <div class="go-box">
      <div class="go-lbl">–°–ß–Å–¢</div>
      <div class="go-val" id="go-score">0</div>
      <div class="go-best" id="go-best">–†–ï–ö–û–†–î: 0</div>
      <div class="go-earned" id="go-earned"></div>
      <div class="go-unlock" id="go-unlock"></div>
    </div>
    <div class="btns">
      <button class="btn" onclick="restartGame()">üîÑ –ï–©–Å –†–ê–ó</button>
      <button class="btn blue" onclick="goToMenu()">üè† –ú–ï–ù–Æ</button>
    </div>
  </div>

  <div id="toast"></div>
</div>

<script>
// =================== DATA ===================
let cucumbers  = parseInt(localStorage.getItem('fc_cukes') || '0');
let stars      = parseInt(localStorage.getItem('fc_stars') || '0');
let bestScore  = parseInt(localStorage.getItem('fc_best')  || '0');
let ownedSkins = JSON.parse(localStorage.getItem('fc_owned') || '["default"]');
let selectedSkin = localStorage.getItem('fc_skin') || 'default';
let leaderboard  = JSON.parse(localStorage.getItem('fc_lb') || '[]');
let refCount   = parseInt(localStorage.getItem('fc_refs') || '0');
let refEarned  = parseInt(localStorage.getItem('fc_ref_earned') || '0');

function save(){
  localStorage.setItem('fc_cukes',  cucumbers);
  localStorage.setItem('fc_stars',  stars);
  localStorage.setItem('fc_best',   bestScore);
  localStorage.setItem('fc_owned',  JSON.stringify(ownedSkins));
  localStorage.setItem('fc_skin',   selectedSkin);
  localStorage.setItem('fc_lb',     JSON.stringify(leaderboard));
  localStorage.setItem('fc_refs',   refCount);
  localStorage.setItem('fc_ref_earned', refEarned);
}

// =================== REFERRAL ===================
(function checkRef(){
  const p = new URLSearchParams(window.location.search);
  const ref = p.get('ref');
  if(ref && ref !== getMyRefId() && !localStorage.getItem('fc_ref_used_'+ref)){
    localStorage.setItem('fc_ref_used_'+ref,'1');
    cucumbers += 30; save();
    setTimeout(()=>showToast('ü•í +30 –æ–≥—É—Ä—á–∏–∫–æ–≤ –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞!'), 500);
  }
})();
function getMyRefId(){
  let id = localStorage.getItem('fc_myid');
  if(!id){id=Math.random().toString(36).slice(2,10);localStorage.setItem('fc_myid',id);}
  return id;
}
function getRefLink(){return window.location.href.split('?')[0]+'?ref='+getMyRefId();}
function copyRef(){
  navigator.clipboard.writeText(getRefLink())
    .then(()=>showToast('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'))
    .catch(()=>{document.getElementById('ref-link-text').textContent=getRefLink();showToast('üìã –°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –≤—ã—à–µ');});
}

// =================== SKINS ===================
const SKINS = [
  { id:'default', name:'–û–ì–£–†–ï–¶',    price:0,    color:'#4ade80', accent:'#22c55e', eyes:'#1a1a1a', special:null },
  { id:'fire',    name:'–û–ì–û–ù–¨',     price:120,  color:'#ef4444', accent:'#dc2626', eyes:'#fff',    special:'fire' },
  { id:'cool',    name:'–ö–†–£–¢–û–ô',    price:200,  color:'#60a5fa', accent:'#3b82f6', eyes:'#fff',    special:'glasses' },
  { id:'alien',   name:'–ü–†–ò–®–ï–õ–ï–¶',  price:350,  color:'#a78bfa', accent:'#8b5cf6', eyes:'#00ff88', special:'alien' },
  { id:'king',    name:'–¶–ê–†–¨',      price:500,  color:'#fbbf24', accent:'#f59e0b', eyes:'#1a1a1a', special:'crown' },
  { id:'ghost',   name:'–ü–†–ò–ó–†–ê–ö',   price:700,  color:'#e2e8f0', accent:'#cbd5e1', eyes:'#000',    special:'ghost' },
  { id:'ninja',   name:'–ù–ò–ù–î–ó–Ø',    price:1000, color:'#1e293b', accent:'#334155', eyes:'#ef4444', special:'ninja' },
  { id:'secret',  name:'DIVINE',    price:0,    color:'#FFD700', accent:'#fbbf24', eyes:'#fff',    special:'divine', secret:true },
];
function getSkin(){ return SKINS.find(s=>s.id===selectedSkin)||SKINS[0]; }

// =================== DRAW CUCUMBER ===================
// Elongated cucumber shape using bezier curves, not just ellipse
function drawCucumber(ctx, x, y, size, skinId, angle=0, frame=0){
  const skin = SKINS.find(s=>s.id===skinId)||SKINS[0];
  ctx.save();
  ctx.translate(x, y);
  ctx.rotate(angle);

  // Cucumber proportions: narrow & elongated (like a real cucumber)
  const rX = size * 0.18;  // narrow width
  const rY = size * 0.48;  // tall height
  const tipR = rX * 0.6;   // tip radius

  // Glow
  const glow = ctx.createRadialGradient(0,0,rX*0.5,0,0,rY*0.9);
  glow.addColorStop(0, skin.color+'55');
  glow.addColorStop(1,'transparent');
  ctx.fillStyle=glow;
  ctx.beginPath(); ctx.ellipse(0,0,rY*0.9,rY*0.9,0,0,Math.PI*2); ctx.fill();

  if(skin.special==='divine'){
    for(let i=3;i>0;i--){
      const sg=ctx.createRadialGradient(0,0,0,0,0,rY*0.9);
      sg.addColorStop(0,`rgba(255,215,0,${0.07*i})`); sg.addColorStop(1,'transparent');
      ctx.fillStyle=sg; ctx.beginPath(); ctx.ellipse(0,0,rY*(0.7+i*0.08),rY*(0.7+i*0.08),0,0,Math.PI*2); ctx.fill();
    }
  }

  // Body path: elongated cucumber shape using bezier
  function cucumberPath(){
    ctx.beginPath();
    // top half arc
    ctx.moveTo(0, -rY);
    ctx.bezierCurveTo(rX*1.1, -rY*0.85,  rX*1.2, -rY*0.3,  rX*1.15,  0);
    ctx.bezierCurveTo(rX*1.2,  rY*0.3,   rX*1.1,  rY*0.8,  0,  rY);
    ctx.bezierCurveTo(-rX*1.1, rY*0.8,  -rX*1.2,  rY*0.3, -rX*1.15, 0);
    ctx.bezierCurveTo(-rX*1.2,-rY*0.3,  -rX*1.1, -rY*0.85, 0, -rY);
    ctx.closePath();
  }

  // Body gradient
  const bg = ctx.createLinearGradient(-rX*1.2,-rY, rX*1.2, rY);
  if(skin.special==='divine'){
    bg.addColorStop(0,'#fff7c0'); bg.addColorStop(0.3,'#FFD700'); bg.addColorStop(0.7,'#fbbf24'); bg.addColorStop(1,'#92400e');
  } else if(skin.special==='ghost'){
    bg.addColorStop(0,'#f8fafc'); bg.addColorStop(1,'#94a3b8');
  } else if(skin.special==='fire'){
    bg.addColorStop(0,'#fef3c7'); bg.addColorStop(0.4,'#ef4444'); bg.addColorStop(1,'#7f1d1d');
  } else {
    bg.addColorStop(0,lighten(skin.color,.35)); bg.addColorStop(0.45,skin.color); bg.addColorStop(1,skin.accent);
  }

  // Shadow / outline
  ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=6; ctx.shadowOffsetY=2;
  cucumberPath(); ctx.fillStyle=bg; ctx.fill();
  ctx.shadowBlur=0; ctx.shadowOffsetY=0;

  // Outline
  cucumberPath(); ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.lineWidth=1.5; ctx.stroke();

  // Vertical stripes (longitudinal lines, like real cucumber)
  if(skin.special!=='ghost' && skin.special!=='divine' && skin.special!=='fire'){
    ctx.save(); cucumberPath(); ctx.clip();
    ctx.strokeStyle=skin.accent+'99'; ctx.lineWidth=1.2;
    for(let i=-2;i<=2;i++){
      const lx=i*rX*0.45;
      ctx.beginPath(); ctx.moveTo(lx,-rY*0.85); ctx.lineTo(lx,rY*0.85); ctx.stroke();
    }
    ctx.restore();
  }
  if(skin.special==='fire'){
    ctx.save(); cucumberPath(); ctx.clip();
    ctx.strokeStyle='rgba(255,200,0,.5)'; ctx.lineWidth=1.2;
    for(let i=-1;i<=1;i++){
      ctx.beginPath(); ctx.moveTo(i*rX*.5,-rY*.85); ctx.lineTo(i*rX*.5,rY*.85); ctx.stroke();
    }
    ctx.restore();
  }
  if(skin.special==='divine'){
    ctx.save(); cucumberPath(); ctx.clip();
    ctx.strokeStyle='rgba(255,255,255,.4)'; ctx.lineWidth=1.2;
    for(let i=-2;i<=2;i++){
      ctx.beginPath(); ctx.moveTo(i*rX*.4,-rY*.85); ctx.lineTo(i*rX*.4,rY*.85); ctx.stroke();
    }
    ctx.restore();
  }

  // Bumps (cucumber texture bumps along the body)
  if(skin.special!=='ghost' && skin.special!=='divine'){
    ctx.fillStyle='rgba(0,0,0,0.12)';
    const bumps = [[-rX*.9,-rY*.45],[rX*.9,-rY*.2],[rX*.85,rY*.15],[-rX*.88,rY*.35],[rX*.9,rY*.5],[-rX*.85,-rY*.05]];
    bumps.forEach(([bx,by])=>{ ctx.beginPath(); ctx.arc(bx,by,rX*0.22,0,Math.PI*2); ctx.fill(); });
  }

  // Tips (ends)
  const tipGrad = ctx.createRadialGradient(0,-rY,1,0,-rY,tipR*1.5);
  tipGrad.addColorStop(0, skin.special==='divine'?'#fef3c7':lighten(skin.accent,.1));
  tipGrad.addColorStop(1, skin.special==='divine'?'#d97706':darken(skin.accent,.3));
  ctx.fillStyle=tipGrad;
  ctx.beginPath(); ctx.ellipse(0,-rY,tipR,tipR*0.7,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(0,rY,tipR*0.8,tipR*0.6,0,0,Math.PI*2); ctx.fill();

  // Eyes position ‚Äî upper third
  const eyeY = -rY*0.35;
  const eyeX = rX*0.65;

  // Sclera
  if(skin.special!=='alien'){
    ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.arc(-eyeX,eyeY,size*0.055,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( eyeX,eyeY,size*0.055,0,Math.PI*2); ctx.fill();
  }
  // Pupils
  ctx.fillStyle=skin.eyes;
  ctx.beginPath(); ctx.arc(-eyeX+0.8,eyeY+0.8,size*0.03,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( eyeX+0.8,eyeY+0.8,size*0.03,0,Math.PI*2); ctx.fill();

  // Alien eyes
  if(skin.special==='alien'){
    ctx.fillStyle=skin.eyes;
    ctx.beginPath(); ctx.ellipse(-eyeX,eyeY,size*.08,size*.05,0.2,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse( eyeX,eyeY,size*.08,size*.05,-.2,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#000';
    ctx.beginPath(); ctx.arc(-eyeX+1,eyeY+1,size*.032,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( eyeX+1,eyeY+1,size*.032,0,Math.PI*2); ctx.fill();
  }

  // Smile
  ctx.strokeStyle='rgba(0,0,0,.5)'; ctx.lineWidth=1.3; ctx.lineCap='round';
  ctx.beginPath(); ctx.arc(0,eyeY+size*.085,size*.075,0.25,Math.PI-0.25); ctx.stroke();

  // === ACCESSORIES ===

  // GLASSES
  if(skin.special==='glasses'){
    ctx.fillStyle='rgba(0,0,0,.75)';
    ctx.beginPath(); ctx.roundRect(-eyeX-size*.09,eyeY-size*.055,size*.18,size*.11,3); ctx.fill();
    ctx.beginPath(); ctx.roundRect( eyeX-size*.09,eyeY-size*.055,size*.18,size*.11,3); ctx.fill();
    ctx.strokeStyle='#1e40af'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(-eyeX+size*.09,eyeY); ctx.lineTo(eyeX-size*.09,eyeY); ctx.stroke();
    ctx.beginPath(); ctx.roundRect(-eyeX-size*.09,eyeY-size*.055,size*.18,size*.11,3); ctx.stroke();
    ctx.beginPath(); ctx.roundRect( eyeX-size*.09,eyeY-size*.055,size*.18,size*.11,3); ctx.stroke();
    // Glare
    ctx.fillStyle='rgba(255,255,255,.35)';
    ctx.beginPath(); ctx.arc(-eyeX-size*.03,eyeY-size*.02,size*.025,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( eyeX-size*.03,eyeY-size*.02,size*.025,0,Math.PI*2); ctx.fill();
  }

  // CROWN
  if(skin.special==='crown'||skin.special==='divine'){
    const cy=-rY-size*.02;
    const cw=rX*1.4;
    ctx.fillStyle=skin.special==='divine'?'#fff':'#FFD700';
    ctx.shadowColor=skin.special==='divine'?'#fff':'#FFD700'; ctx.shadowBlur=10;
    ctx.beginPath();
    ctx.moveTo(-cw,cy); ctx.lineTo(-cw,cy-size*.14);
    ctx.lineTo(-cw*.5,cy-size*.07); ctx.lineTo(0,cy-size*.18);
    ctx.lineTo(cw*.5,cy-size*.07); ctx.lineTo(cw,cy-size*.14);
    ctx.lineTo(cw,cy); ctx.closePath(); ctx.fill();
    ctx.shadowBlur=0;
    const jewels=skin.special==='divine'?['#a78bfa','#38bdf8','#a78bfa']:['#ef4444','#4ade80','#3b82f6'];
    ctx.fillStyle=jewels[0]; ctx.beginPath(); ctx.arc(-cw*.5,cy-size*.06,size*.025,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=jewels[1]; ctx.beginPath(); ctx.arc(0,cy-size*.1,size*.025,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=jewels[2]; ctx.beginPath(); ctx.arc(cw*.5,cy-size*.06,size*.025,0,Math.PI*2); ctx.fill();
  }

  // NINJA bandana
  if(skin.special==='ninja'){
    const by=eyeY;
    ctx.save(); cucumberPath(); ctx.clip();
    ctx.fillStyle='#ef4444';
    ctx.fillRect(-rX*1.3,by-size*.045,rX*2.6,size*.08);
    ctx.restore();
    // Knot
    ctx.fillStyle='#ef4444';
    ctx.beginPath(); ctx.moveTo(rX*1.1,by-size*.04); ctx.lineTo(rX*1.25,by-size*.1); ctx.lineTo(rX*1.2,by+size*.06); ctx.closePath(); ctx.fill();
    // Slit eyes on top
    ctx.fillStyle=skin.eyes; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.rect(-eyeX-size*.05,by-size*.025,size*.1,size*.04); ctx.fill();
    ctx.beginPath(); ctx.rect( eyeX-size*.05,by-size*.025,size*.1,size*.04); ctx.fill();
  }

  // GHOST tail
  if(skin.special==='ghost'){
    ctx.fillStyle='rgba(203,213,225,.8)';
    ctx.beginPath(); ctx.moveTo(-rX*1.1,rY-4);
    for(let i=0;i<=4;i++){
      const cx2=-rX*1.1+(rX*2.2/4)*i;
      const wav=Math.sin(frame*.1+i)*3;
      if(i%2===0) ctx.quadraticCurveTo(cx2+rX*.3,rY+8+wav,cx2+rX*.55,rY-2);
      else        ctx.quadraticCurveTo(cx2+rX*.3,rY+3,     cx2+rX*.55,rY-2);
    }
    ctx.closePath(); ctx.fill();
  }

  // DIVINE halo
  if(skin.special==='divine'){
    const haloY=-rY-size*.28;
    ctx.strokeStyle='rgba(255,255,255,.95)'; ctx.lineWidth=2.5;
    ctx.shadowColor='#fff'; ctx.shadowBlur=14;
    ctx.beginPath(); ctx.ellipse(0,haloY,rX*1.1,size*.06,0,0,Math.PI*2); ctx.stroke();
    ctx.shadowBlur=0;
    const t=frame*.05;
    [[-rX*1.5,-rY*.1],[rX*1.5,-rY*.25],[-rX*1.3,rY*.1],[rX*1.4,rY*.0]].forEach(([sx,sy],i)=>{
      const fl=Math.abs(Math.sin(t+i*1.3));
      if(fl>.4){ ctx.fillStyle=`rgba(255,255,200,${fl})`; ctx.beginPath(); ctx.arc(sx+Math.sin(t+i)*2,sy+Math.cos(t+i)*2,size*.02,0,Math.PI*2); ctx.fill(); }
    });
  }

  // FIRE flames
  if(skin.special==='fire'){
    const ft=frame*.12;
    for(let i=-1;i<=1;i++){
      const fx=i*rX*.5;
      const fh=size*(.2+Math.sin(ft+i)*.07);
      const fg=ctx.createLinearGradient(fx,rY,fx,rY+fh*2);
      fg.addColorStop(0,'#ef4444'); fg.addColorStop(.5,'#fbbf24'); fg.addColorStop(1,'transparent');
      ctx.fillStyle=fg;
      ctx.beginPath();
      ctx.moveTo(fx-rX*.15,rY);
      ctx.quadraticCurveTo(fx+Math.sin(ft+i)*rX*.2,rY+fh,fx+rX*.08,rY+fh*2);
      ctx.quadraticCurveTo(fx-Math.sin(ft+i)*rX*.2,rY+fh,fx+rX*.15,rY);
      ctx.fill();
    }
  }

  ctx.restore();
}

function lighten(hex,amt){
  const n=parseInt(hex.replace('#',''),16);
  return `rgb(${Math.min(255,(n>>16)+Math.floor(255*amt))},${Math.min(255,((n>>8)&0xff)+Math.floor(255*amt))},${Math.min(255,(n&0xff)+Math.floor(255*amt))})`;
}
function darken(hex,amt){
  const n=parseInt(hex.replace('#',''),16);
  return `rgb(${Math.max(0,(n>>16)-Math.floor(255*amt))},${Math.max(0,((n>>8)&0xff)-Math.floor(255*amt))},${Math.max(0,(n&0xff)-Math.floor(255*amt))})`;
}

// =================== HERO ANIMATION ===================
let heroFrame=0;
function animateHero(){
  const hc=document.getElementById('hero-canvas');
  if(!hc)return;
  const hctx=hc.getContext('2d');
  hctx.clearRect(0,0,44,72);
  drawCucumber(hctx,22,36,64,selectedSkin,0,heroFrame++);
  requestAnimationFrame(animateHero);
}

// =================== AUDIO ===================
let audioCtx=null,musicGain=null,musicOn=false;
function initAudio(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  musicGain=audioCtx.createGain(); musicGain.gain.value=0.15; musicGain.connect(audioCtx.destination);
}
function tone(freq,type,dur,vol=0.3,t0=0){
  if(!audioCtx)return;
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.setValueAtTime(vol,audioCtx.currentTime+t0);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+t0+dur);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(audioCtx.currentTime+t0); o.stop(audioCtx.currentTime+t0+dur);
}
function playJump(){ tone(280,'sine',.07,.22); tone(480,'sine',.1,.18,.04); }
function playScore(){ tone(550,'square',.07,.12); tone(750,'square',.07,.12,.08); tone(1000,'square',.1,.12,.16); }
function playDeath(){
  tone(400,'sawtooth',.08,.35); tone(280,'sawtooth',.14,.30,.07);
  tone(180,'sawtooth',.18,.25,.17); tone(120,'sawtooth',.25,.20,.28);
  if(!audioCtx)return;
  const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*.3,audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length);
  const s=audioCtx.createBufferSource(),g=audioCtx.createGain();
  g.gain.value=.25; s.buffer=buf; s.connect(g); g.connect(audioCtx.destination); s.start();
}
const MELODY=[[523,.2],[523,.2],[659,.2],[523,.2],[784,.4],[740,.4],[523,.2],[523,.2],[659,.2],[523,.2],[698,.4],[659,.4],[523,.2],[523,.2],[1047,.2],[880,.2],[784,.2],[659,.2],[523,.2],[440,.2],[523,.4]];
let melIdx=0,melTime=0;
function startMusic(){
  if(!audioCtx||musicOn)return; musicOn=true; melTime=audioCtx.currentTime; melIdx=0;
  function sched(){
    if(!musicOn)return;
    while(melTime-audioCtx.currentTime<1.5){
      const[f,d]=MELODY[melIdx%MELODY.length];
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='square'; o.frequency.value=f;
      g.gain.setValueAtTime(.1,melTime); g.gain.exponentialRampToValueAtTime(.001,melTime+d-.01);
      o.connect(g); g.connect(musicGain); o.start(melTime); o.stop(melTime+d);
      melTime+=d; melIdx++;
    }
    setTimeout(sched,400);
  }
  sched();
  function bass(){
    if(!musicOn)return;
    [130,147,165,147].forEach((f,i)=>{
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      const t=audioCtx.currentTime+i*.4;
      o.type='triangle'; o.frequency.value=f;
      g.gain.setValueAtTime(.07,t); g.gain.exponentialRampToValueAtTime(.001,t+.35);
      o.connect(g); g.connect(musicGain); o.start(t); o.stop(t+.38);
    });
    setTimeout(bass,1600);
  }
  bass();
}
function stopMusic(){ musicOn=false; }

// =================== GAME ===================
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const W=400,H=650,GH=65;
let gameState='menu',score=0,speed=2.5,pipeTimer=0,gframe=0;
let bird={x:90,y:H/2,vy:0};
let pipes=[],particles=[],coins=[],coinFX=[];
const GRAVITY=0.48,JUMP=-9.2,PIPE_W=62,GAP=158,PIPE_INT=92;

const bgStars=Array.from({length:55},()=>({
  x:Math.random()*W, y:Math.random()*(H-GH),
  r:Math.random()*2+.5, sp:Math.random()*.25+.1, tw:Math.random()*Math.PI*2
}));

function resetGame(){
  bird={x:90,y:H/2-20,vy:0};
  pipes=[];particles=[];coins=[];coinFX=[];
  pipeTimer=0;score=0;speed=2.5;gframe=0;
  document.getElementById('hud-score').textContent='0';
}

function addPipe(){
  const top=80+Math.random()*(H-GH-GAP-100);
  pipes.push({x:W+30,top,scored:false});
  if(Math.random()<0.35){
    coins.push({x:W+30+PIPE_W/2+Math.random()*50,y:top+GAP/2+(Math.random()-.5)*30,collected:false});
  }
}

function checkCollision(){
  if(bird.y+20>=H-GH||bird.y-20<=0) return true;
  for(const p of pipes){
    if(bird.x+16>p.x&&bird.x-16<p.x+PIPE_W){
      if(bird.y-18<p.top||bird.y+18>p.top+GAP) return true;
    }
  }
  return false;
}

function drawBg(){
  const bg=ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#061810'); bg.addColorStop(.5,'#0a2918'); bg.addColorStop(1,'#061810');
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);
  bgStars.forEach(s=>{
    s.x-=s.sp; if(s.x<0){s.x=W;s.y=Math.random()*(H-GH);}
    s.tw+=.02;
    ctx.fillStyle=`rgba(200,255,220,${.3+Math.abs(Math.sin(s.tw))*.5})`;
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  });
  const gg=ctx.createLinearGradient(0,H-GH,0,H);
  gg.addColorStop(0,'#14532d'); gg.addColorStop(.3,'#15803d'); gg.addColorStop(1,'#052e16');
  ctx.fillStyle=gg; ctx.fillRect(0,H-GH,W,GH);
  ctx.fillStyle='#4ade80'; ctx.fillRect(0,H-GH,W,3);
  const offset=(Date.now()/40*speed)%32;
  for(let i=0;i<W+32;i+=32){
    const gx=(i-offset+W+32)%W+(-32);
    ctx.fillStyle='#22c55e';
    for(const[ox,oh] of[[-2,7],[3,9],[8,6],[14,8]]){ctx.fillRect(gx+ox,H-GH-oh,3,oh);}
  }
}

function drawPipe(p){
  const topH=p.top,botY=p.top+GAP,botH=H-GH-botY;
  function body(y,h,capTop){
    const g=ctx.createLinearGradient(p.x,0,p.x+PIPE_W,0);
    g.addColorStop(0,'#14532d');g.addColorStop(.25,'#4ade80');g.addColorStop(.6,'#22c55e');g.addColorStop(1,'#052e16');
    ctx.fillStyle=g;
    ctx.beginPath();ctx.roundRect(p.x+6,y,PIPE_W-12,h,capTop?[0,0,4,4]:[4,4,0,0]);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.1)';ctx.beginPath();ctx.roundRect(p.x+9,y+4,8,h-8,2);ctx.fill();
  }
  function cap(y,top){
    ctx.fillStyle='#4ade80';ctx.shadowColor='#4ade80';ctx.shadowBlur=8;
    ctx.beginPath();ctx.roundRect(p.x,y,PIPE_W,14,top?[6,6,0,0]:[0,0,6,6]);ctx.fill();ctx.shadowBlur=0;
  }
  body(0,topH-14,false);cap(topH-14,true);
  cap(botY,false);body(botY+14,botH,true);
}

function drawCoin(c){
  if(c.collected)return;
  ctx.save(); ctx.translate(c.x,c.y);
  const pulse=1+Math.sin(gframe*.1)*.08; ctx.scale(pulse,pulse);
  ctx.shadowColor='#4ade80'; ctx.shadowBlur=12;
  const cg=ctx.createRadialGradient(0,0,1,0,0,10);
  cg.addColorStop(0,'#dcfce7');cg.addColorStop(.4,'#86efac');cg.addColorStop(1,'#4ade80');
  ctx.fillStyle=cg; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1;ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,.7)';
  [[0,-4],[3.5,2],[-3.5,2]].forEach(([sx,sy])=>{ctx.beginPath();ctx.ellipse(sx,sy,1.2,2,0,0,Math.PI*2);ctx.fill();});
  ctx.shadowBlur=0; ctx.restore();
}

function collectCoins(){
  coins.forEach(c=>{
    if(c.collected)return;
    if(Math.hypot(bird.x-c.x,bird.y-c.y)<26){
      c.collected=true; cucumbers++; save();
      document.getElementById('hud-cukes').textContent=cucumbers;
      for(let i=0;i<5;i++) coinFX.push({x:c.x,y:c.y,vx:(Math.random()-.5)*4,vy:-Math.random()*4-1,life:25,max:25});
    }
  });
  coins=coins.filter(c=>c.x>-20);
}

function spawnDeathFX(){
  for(let i=0;i<18;i++){
    const a=Math.random()*Math.PI*2,sp=2+Math.random()*6;
    particles.push({x:bird.x,y:bird.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-3,life:55,max:70,r:4+Math.random()*8,color:['#4ade80','#22c55e','#86efac','#dcfce7'][Math.floor(Math.random()*4)]});
  }
}

function gameLoop(){
  if(gameState!=='playing')return;
  gframe++;
  ctx.clearRect(0,0,W,H); drawBg();

  pipeTimer++; if(pipeTimer>=PIPE_INT){addPipe();pipeTimer=0;}
  pipes.forEach(p=>p.x-=speed);
  pipes.forEach(p=>{
    if(!p.scored&&p.x+PIPE_W<bird.x){
      p.scored=true; score++;
      playScore();
      document.getElementById('hud-score').textContent=score;
      speed=2.5+score*.07;
    }
  });
  pipes=pipes.filter(p=>p.x+PIPE_W>-20);
  pipes.forEach(p=>drawPipe(p));

  coins.forEach(c=>c.x-=speed);
  coins.forEach(c=>drawCoin(c));
  collectCoins();

  bird.vy+=GRAVITY; bird.y+=bird.vy;
  const angle=Math.min(Math.max(bird.vy*.055,-.45),.85);
  drawCucumber(ctx,bird.x,bird.y,50,selectedSkin,angle,gframe);

  // particles
  particles=particles.filter(p=>p.life>0);
  particles.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;
    ctx.globalAlpha=p.life/p.max;ctx.shadowColor=p.color;ctx.shadowBlur=5;
    ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r/2,0,Math.PI*2);ctx.fill();
  });
  ctx.globalAlpha=1;ctx.shadowBlur=0;

  // coin FX
  coinFX=coinFX.filter(p=>p.life>0);
  coinFX.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;
    ctx.globalAlpha=p.life/p.max;ctx.fillStyle='#4ade80';
    ctx.font='bold 10px Press Start 2P';ctx.textAlign='center';ctx.fillText('+1',p.x,p.y);
  });
  ctx.globalAlpha=1;

  if(checkCollision()){
    gameState='dead'; playDeath(); stopMusic(); spawnDeathFX();
    function finalFrame(){
      ctx.clearRect(0,0,W,H);drawBg();
      pipes.forEach(p=>drawPipe(p));
      coins.forEach(c=>drawCoin(c));
      particles=particles.filter(p=>p.life>0);
      particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r/2,0,Math.PI*2);ctx.fill();});
      ctx.globalAlpha=1;
      if(particles.some(p=>p.life>0)) requestAnimationFrame(finalFrame); else setTimeout(showGameOver,200);
    }
    requestAnimationFrame(finalFrame); return;
  }
  requestAnimationFrame(gameLoop);
}

// =================== UI SCREENS ===================
function updateHUD(){
  document.getElementById('hud-cukes').textContent=cucumbers;
  document.getElementById('hud-stars-val').textContent=stars;
  document.getElementById('main-cukes').textContent=cucumbers;
  document.getElementById('main-stars').textContent=stars;
}

function startGame(){
  initAudio();startMusic();resetGame();gameState='playing';
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('gameover-screen').classList.add('hidden');
  document.getElementById('hud-score').classList.remove('hidden');
  document.getElementById('hud-currency').classList.remove('hidden');
  document.getElementById('hud-stars').classList.remove('hidden');
  updateHUD(); gameLoop();
}
function restartGame(){
  initAudio();startMusic();resetGame();gameState='playing';
  document.getElementById('gameover-screen').classList.add('hidden');
  updateHUD(); gameLoop();
}

function showGameOver(){
  const secretUnlocked=!ownedSkins.includes('secret')&&score>=50;
  if(score>bestScore){bestScore=score;localStorage.setItem('fc_best',bestScore);}

  // 1 –æ–≥—É—Ä—á–∏–∫ –∑–∞ –∫–∞–∂–¥—ã–µ 10 –æ—á–∫–æ–≤
  const earned=Math.floor(score/10);
  const starEarned=Math.floor(score/15);
  cucumbers+=earned; stars+=starEarned;

  if(secretUnlocked){ownedSkins.push('secret');selectedSkin='secret';}
  save(); updateLeaderboard();

  document.getElementById('go-score').textContent=score;
  document.getElementById('go-best').textContent='–†–ï–ö–û–†–î: '+bestScore;
  document.getElementById('go-earned').textContent=(earned>0||starEarned>0)?`+${earned} ü•í  +${starEarned} ‚≠ê`:'';
  const ul=document.getElementById('go-unlock');
  if(secretUnlocked){ul.textContent='‚ú® DIVINE –°–ö–ò–ù –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù!';ul.style.display='block';}
  else if(!ownedSkins.includes('secret')){ul.textContent=`üîí DIVINE –°–ö–ò–ù: ${score}/50 –±–∞—à–µ–Ω`;ul.style.display='block';}
  else{ul.style.display='none';}

  const dc=document.getElementById('dead-canvas');
  const dctx=dc.getContext('2d');
  dctx.clearRect(0,0,60,100);
  drawCucumber(dctx,30,50,90,selectedSkin,.2,0);
  // X eyes
  dctx.fillStyle='#ef4444'; dctx.font='bold 12px sans-serif'; dctx.textAlign='center';
  dctx.fillText('√ó',23,38); dctx.fillText('√ó',37,38);

  document.getElementById('gameover-screen').classList.remove('hidden');
  updateHUD();
}

function goToMenu(){
  gameState='menu';
  ['gameover-screen','hud-score','hud-currency','hud-stars'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('start-screen').classList.remove('hidden');
  updateHUD(); drawBg();
}

// =================== SHOP CAROUSEL ===================
let carIdx=0;

function showShop(){
  document.getElementById('start-screen').classList.add('hidden');
  renderCarousel();
  document.getElementById('shop-screen').classList.remove('hidden');
}
function closeShop(){
  document.getElementById('shop-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
  updateHUD();
}
function doExchange(){
  const amt=parseInt(document.getElementById('exchange-amount').value)||0;
  if(amt<1){showToast('–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!');return;}
  if(stars<amt){showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥ ‚≠ê');return;}
  stars-=amt; cucumbers+=amt*5; save(); renderCarousel();
  showToast(`‚úÖ +${amt*5} ü•í –ø–æ–ª—É—á–µ–Ω–æ!`);
}

function renderCarousel(){
  document.getElementById('shop-cukes').textContent=cucumbers;
  document.getElementById('shop-stars').textContent=stars;

  const track=document.getElementById('carousel-track');
  track.innerHTML='';

  SKINS.forEach((skin,i)=>{
    const owned=ownedSkins.includes(skin.id);
    const sel=selectedSkin===skin.id;
    const slide=document.createElement('div'); slide.className='carousel-slide';

    let cardCls='skin-card-big';
    if(sel) cardCls+=' selected';
    else if(owned) cardCls+=' owned';
    if(skin.secret&&owned) cardCls+=' secret-card';

    const card=document.createElement('div'); card.className=cardCls;

    // Canvas preview
    const wrap=document.createElement('div'); wrap.className='skin-canvas-big';
    const mc=document.createElement('canvas'); mc.width=100; mc.height=100;
    const mctx=mc.getContext('2d');
    if(skin.secret&&!owned){
      mctx.fillStyle='rgba(167,139,250,.15)'; mctx.beginPath(); mctx.arc(50,50,40,0,Math.PI*2); mctx.fill();
      mctx.fillStyle='#a78bfa'; mctx.font='bold 36px Press Start 2P';
      mctx.textAlign='center'; mctx.textBaseline='middle'; mctx.fillText('?',50,50);
    } else {
      drawCucumber(mctx,50,50,90,skin.id,0,0);
    }
    wrap.appendChild(mc); card.appendChild(wrap);

    const nameEl=document.createElement('div'); nameEl.className='skin-name-big';
    nameEl.textContent=skin.secret&&!owned?'???':skin.name; card.appendChild(nameEl);

    const priceEl=document.createElement('div');
    if(sel){priceEl.className='skin-price-big selected-lbl';priceEl.textContent='‚úì –í–´–ë–†–ê–ù';}
    else if(owned){priceEl.className='skin-price-big owned-lbl';priceEl.textContent='–ù–ê–ñ–ú–ò –ß–¢–û–ë–´ –í–´–ë–†–ê–¢–¨';}
    else if(skin.secret){priceEl.className='skin-price-big secret-lbl';priceEl.textContent='–ù–ê–ë–ï–ô 50 –ë–ê–®–ï–ù';}
    else if(skin.price===0){priceEl.className='skin-price-big';priceEl.textContent='–ë–ï–°–ü–õ–ê–¢–ù–û';}
    else{priceEl.className='skin-price-big';priceEl.textContent=`ü•í ${skin.price} –æ–≥—É—Ä—á–∏–∫–æ–≤`;}
    card.appendChild(priceEl);

    // Badge
    if(skin.id==='king'){const b=document.createElement('div');b.className='skin-badge';b.style.background='#ef4444';b.textContent='–•–ò–¢';card.appendChild(b);}
    if(skin.secret){const b=document.createElement('div');b.className='skin-badge';b.style.background='#a78bfa';b.textContent='–°–ï–ö–†–ï–¢';card.appendChild(b);}

    slide.appendChild(card); track.appendChild(slide);
  });

  updateCarouselPos();
  updateDots();
  updateShopBtn();
}

function updateCarouselPos(){
  const track=document.getElementById('carousel-track');
  track.style.transform=`translateX(-${carIdx*100}%)`;
}
function updateDots(){
  const dots=document.getElementById('carousel-dots'); dots.innerHTML='';
  SKINS.forEach((_,i)=>{
    const d=document.createElement('div'); d.className='dot'+(i===carIdx?' active':'');
    d.onclick=()=>{ carIdx=i; updateCarouselPos(); updateDots(); updateShopBtn(); };
    dots.appendChild(d);
  });
}
function updateShopBtn(){
  const skin=SKINS[carIdx]; if(!skin)return;
  const btn=document.getElementById('shop-action-btn');
  const owned=ownedSkins.includes(skin.id);
  const sel=selectedSkin===skin.id;
  if(sel){btn.textContent='‚úì –í–´–ë–†–ê–ù';btn.style.opacity='.5';}
  else if(owned){btn.textContent='–í–´–ë–†–ê–¢–¨';btn.style.opacity='1';}
  else if(skin.secret){btn.textContent='üîí 50 –ë–ê–®–ï–ù';btn.style.opacity='.7';}
  else if(skin.price===0){btn.textContent='–ü–û–õ–£–ß–ò–¢–¨ –ë–ï–°–ü–õ–ê–¢–ù–û';btn.style.opacity='1';}
  else{btn.textContent=`–ö–£–ü–ò–¢–¨ ü•í ${skin.price}`;btn.style.opacity='1';}
}
function carouselPrev(){ if(carIdx>0){carIdx--;updateCarouselPos();updateDots();updateShopBtn();} }
function carouselNext(){ if(carIdx<SKINS.length-1){carIdx++;updateCarouselPos();updateDots();updateShopBtn();} }

function shopAction(){
  const skin=SKINS[carIdx]; if(!skin)return;
  if(skin.secret&&!ownedSkins.includes(skin.id)){showToast('üîí –ù–∞–±–µ–π —Ä–µ–∫–æ—Ä–¥ 50 –±–∞—à–µ–Ω!');return;}
  if(ownedSkins.includes(skin.id)){
    selectedSkin=skin.id; save(); renderCarousel(); showToast('‚úÖ –°–∫–∏–Ω –≤—ã–±—Ä–∞–Ω!');
  } else {
    if(skin.price===0){ownedSkins.push(skin.id);selectedSkin=skin.id;save();renderCarousel();playScore();return;}
    if(cucumbers<skin.price){showToast(`–ù—É–∂–Ω–æ ü•í ${skin.price}, –µ—Å—Ç—å ${cucumbers}`);return;}
    cucumbers-=skin.price;ownedSkins.push(skin.id);selectedSkin=skin.id;save();renderCarousel();playScore();
    showToast(`‚úÖ ${skin.name} –∫—É–ø–ª–µ–Ω!`);
  }
}

// Touch swipe on carousel
let swipeStart=0;
document.getElementById('carousel-track').addEventListener('touchstart',e=>{ swipeStart=e.touches[0].clientX; },{passive:true});
document.getElementById('carousel-track').addEventListener('touchend',e=>{
  const dx=swipeStart-e.changedTouches[0].clientX;
  if(dx>40) carouselNext();
  else if(dx<-40) carouselPrev();
});

// =================== LEADERBOARD ===================
function updateLeaderboard(){
  leaderboard.push({name:'–ò–≥—Ä–æ–∫_'+Math.floor(Math.random()*9000+1000),score,skin:selectedSkin});
  leaderboard.sort((a,b)=>b.score-a.score); leaderboard=leaderboard.slice(0,10); save();
}
function showLeaderboard(){
  document.getElementById('start-screen').classList.add('hidden');
  renderLeaderboard(); document.getElementById('leaderboard-screen').classList.remove('hidden');
}
function closeLeaderboard(){
  document.getElementById('leaderboard-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
}
function renderLeaderboard(){
  const list=document.getElementById('lb-list');
  let lb=[...leaderboard];
  const demo=[{name:'Pickle_Pro',score:74,skin:'king'},{name:'SpeedCuke',score:61,skin:'fire'},{name:'Alien_Runner',score:55,skin:'alien'},{name:'CoolCuke',score:48,skin:'cool'},{name:'GhostRider',score:37,skin:'ghost'}];
  if(lb.length<5) lb=[...lb,...demo].sort((a,b)=>b.score-a.score).slice(0,10);
  const medals=['ü•á','ü•à','ü•â'],cls=['r1','r2','r3'];
  list.innerHTML=lb.map((e,i)=>`<div class="lb-entry">
    <div class="lb-rank ${cls[i]||''}">${i<3?medals[i]:'#'+(i+1)}</div>
    <div class="lb-skin-preview" id="lbsp-${i}"><canvas width="32" height="32"></canvas></div>
    <div class="lb-name">${e.name}</div>
    <div class="lb-score">${e.score}</div>
  </div>`).join('');
  lb.forEach((e,i)=>{
    const w=document.getElementById(`lbsp-${i}`); if(!w)return;
    drawCucumber(w.querySelector('canvas').getContext('2d'),16,16,28,e.skin||'default',0,0);
  });
}

// =================== REFERRAL ===================
function showRef(){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('ref-link-text').textContent=getRefLink();
  document.getElementById('ref-count').textContent=refCount;
  document.getElementById('ref-earned').textContent=refEarned;
  document.getElementById('ref-screen').classList.remove('hidden');
}
function closeRef(){
  document.getElementById('ref-screen').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
}

// =================== CONTROLS ===================
function jump(){if(gameState!=='playing')return;bird.vy=JUMP;playJump();}
document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();jump();}});
canvas.addEventListener('click',jump);
canvas.addEventListener('touchstart',e=>{e.preventDefault();jump();},{passive:false});

// =================== TOAST ===================
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}

// =================== INIT ===================
updateHUD(); drawBg(); animateHero();
</script>
</body>
</html>
