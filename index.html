<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Flappy Cucumber ü•í</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;background:#050f09;overflow:hidden;font-family:'Nunito',sans-serif;touch-action:none;}
#wrap{position:fixed;inset:0;overflow:hidden;}
#gameCanvas{position:absolute;inset:0;width:100%;height:100%;display:block;}
#ui{position:absolute;inset:0;pointer-events:none;}

/* ‚îÄ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ */
/* Score: top-center */
#hud-score{position:absolute;top:calc(env(safe-area-inset-top,0px)+14px);left:50%;transform:translateX(-50%);color:#fff;font-size:28px;text-shadow:0 0 20px rgba(74,222,128,.9),2px 2px 0 #000;}
/* Cukes + gold: top-left */
#hud-currency{position:absolute;top:calc(env(safe-area-inset-top,0px)+14px);left:12px;display:flex;flex-direction:column;gap:3px;}
#hud-cukes-row{color:#7fffb0;font-size:8px;text-shadow:0 0 8px rgba(74,222,128,.7);display:flex;align-items:center;gap:3px;}
#hud-gold-row{color:#FFD700;font-size:8px;text-shadow:0 0 8px rgba(255,215,0,.7);display:flex;align-items:center;gap:3px;}
/* Level: right of currency, aligned properly */
#hud-lvl-wrap{position:absolute;top:calc(env(safe-area-inset-top,0px)+14px);left:115px;background:rgba(0,0,0,.6);border:1px solid rgba(251,191,36,.4);border-radius:8px;padding:4px 8px;display:flex;flex-direction:row;gap:5px;align-items:center;line-height:1;}
#hud-lvl-text{color:#fbbf24;font-size:7px;white-space:nowrap;line-height:1;}
#hud-xpbar{width:40px;height:4px;background:rgba(255,255,255,.15);border-radius:2px;overflow:hidden;}
#hud-xpfill{height:4px;background:linear-gradient(90deg,#fbbf24,#f97316);border-radius:2px;transition:width .3s;}
/* Combo: center-bottom */
#hud-combo{position:absolute;bottom:calc(env(safe-area-inset-bottom,0px)+8px);left:50%;transform:translateX(-50%);font-size:9px;color:#fbbf24;text-shadow:0 0 12px #fbbf24;opacity:0;transition:opacity .3s;text-align:center;}
/* Boosters: right-center */
#hud-boosters{position:absolute;top:50%;right:10px;transform:translateY(-50%);display:flex;flex-direction:column;gap:8px;pointer-events:all;}
.hud-boost-btn{width:46px;height:46px;border-radius:12px;border:2px solid rgba(255,255,255,.2);background:rgba(0,0,0,.72);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;position:relative;pointer-events:all;backdrop-filter:blur(4px);}
.hud-boost-btn .bcnt{position:absolute;top:-5px;right:-5px;background:#ef4444;color:#fff;font-size:10px;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Nunito',sans-serif;font-weight:900;}
.hud-boost-btn.on-shield{border-color:#38bdf8;box-shadow:0 0 14px #38bdf8;}
.hud-boost-btn.on-magnet{border-color:#fbbf24;box-shadow:0 0 14px #fbbf24;}
.hud-boost-btn.on-turbo{border-color:#fb923c;box-shadow:0 0 14px #fb923c;}
.hud-boost-btn.on-mega{border-color:#a78bfa;box-shadow:0 0 18px #a78bfa;animation:megaPulse .4s infinite;}
@keyframes megaPulse{0%,100%{box-shadow:0 0 14px #a78bfa}50%{box-shadow:0 0 28px #a78bfa,0 0 48px rgba(167,139,250,.4)}}
/* Shoot button: bottom-right */
#hud-shoot{position:absolute;bottom:calc(env(safe-area-inset-bottom,0px)+8px);right:10px;width:52px;height:52px;border-radius:14px;border:2px solid rgba(255,200,100,.4);background:rgba(0,0,0,.72);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:all;backdrop-filter:blur(4px);}
/* Chest timer */
#hud-chest{position:absolute;top:calc(env(safe-area-inset-top,0px)+14px);right:10px;background:rgba(0,0,0,.6);border:1px solid rgba(139,92,246,.4);border-radius:8px;padding:4px 7px;font-size:6px;color:#a78bfa;pointer-events:all;cursor:pointer;text-align:center;}
/* Crazy/event labels */
#game-label{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px;text-align:center;opacity:0;pointer-events:none;z-index:50;}
@keyframes labelPop{0%,100%{opacity:0;transform:translate(-50%,-50%) scale(.8)}40%,60%{opacity:1;transform:translate(-50%,-50%) scale(1.05)}}
/* Sticker album notification */
#sticker-notif{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.85);border:2px solid #fbbf24;border-radius:16px;padding:14px 20px;text-align:center;font-size:8px;color:#fbbf24;opacity:0;pointer-events:none;z-index:100;transition:opacity .4s;}
#sticker-notif.show{opacity:1;}

.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:all;padding:16px;padding-top:calc(env(safe-area-inset-top,0px)+16px);padding-bottom:calc(env(safe-area-inset-bottom,0px)+16px);overflow-y:auto;gap:0;}
.hidden{display:none!important;}

/* START */
#start-screen{background:transparent;overflow:hidden;}
#start-bg-canvas{position:absolute;inset:0;width:100%;height:100%;z-index:0;}
#start-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;width:100%;padding:16px;padding-top:calc(env(safe-area-inset-top,0px)+16px);padding-bottom:calc(env(safe-area-inset-bottom,0px)+16px);}
.game-title{font-size:34px;color:#4ade80;line-height:1.3;text-align:center;font-family:'Nunito',sans-serif;font-weight:900;text-shadow:0 0 30px #4ade80,0 0 60px rgba(74,222,128,.4),0 3px 6px rgba(0,0,0,.6);animation:glow 2.5s infinite;margin-bottom:8px;flex-shrink:0;letter-spacing:-1px;}
@keyframes glow{0%,100%{text-shadow:0 0 20px #4ade80,2px 2px 0 #000}50%{text-shadow:0 0 45px #4ade80,0 0 80px rgba(74,222,128,.3),2px 2px 0 #000}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
#hero-wrap{width:38px;height:60px;flex-shrink:0;filter:drop-shadow(0 0 10px rgba(74,222,128,.6));animation:hfloat 1.8s ease-in-out infinite;margin-bottom:6px;}
@keyframes hfloat{0%,100%{transform:translateY(0) rotate(-4deg)}50%{transform:translateY(-8px) rotate(4deg)}}
.player-rank{font-size:7px;margin-bottom:4px;flex-shrink:0;}
.xp-bar-wrap{width:170px;height:7px;background:rgba(255,255,255,.1);border-radius:4px;margin-bottom:3px;flex-shrink:0;border:1px solid rgba(255,255,255,.08);}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f97316);border-radius:4px;transition:width .5s;}
.xp-label{font-size:6px;color:#94a3b8;margin-bottom:7px;flex-shrink:0;}
.cur-bar{display:flex;gap:10px;flex-shrink:0;background:rgba(0,0,0,.35);border-radius:10px;padding:5px 14px;border:1px solid rgba(74,222,128,.2);margin-bottom:9px;}
.cur-item{font-size:6px;color:#94a3b8;text-align:center;}
.cur-item .ico{font-size:10px;display:block;margin-bottom:1px;}
.cur-item .val{font-size:8px;}
.cur-item .val.g{color:#4ade80;}.cur-item .val.gd{color:#FFD700;}

/* chest bar */
.chest-bar{display:flex;align-items:center;gap:8px;background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.3);border-radius:10px;padding:5px 12px;margin-bottom:9px;flex-shrink:0;cursor:pointer;pointer-events:all;}
.chest-icon{font-size:16px;}
.chest-info{font-size:6px;color:#a78bfa;line-height:1.8;}

.btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:340px;flex-shrink:0;}
.btn{background:linear-gradient(145deg,#22c55e,#16a34a);color:#fff;border:none;padding:15px 10px;font-family:'Nunito',sans-serif;font-size:14px;font-weight:900;border-radius:18px;cursor:pointer;box-shadow:0 6px 0 #14532d,inset 0 1px 0 rgba(255,255,255,.3),0 0 24px rgba(34,197,94,.25);transition:transform .1s,box-shadow .1s;pointer-events:all;white-space:nowrap;width:100%;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,.3);}
.btn:active{transform:translateY(6px);box-shadow:0 0 0 #14532d,inset 0 1px 0 rgba(255,255,255,.2);}
.btn.gold{background:linear-gradient(145deg,#fbbf24,#d97706);box-shadow:0 6px 0 #92400e,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(251,191,36,.2);}
.btn.gold:active{box-shadow:0 0 0 #92400e,inset 0 1px 0 rgba(255,255,255,.2);}
.btn.blue{background:linear-gradient(145deg,#38bdf8,#0284c7);box-shadow:0 6px 0 #075985,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(56,189,248,.2);}
.btn.blue:active{box-shadow:0 0 0 #075985;}
.btn.purple{background:linear-gradient(145deg,#a78bfa,#7c3aed);box-shadow:0 6px 0 #4c1d95,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(167,139,250,.2);}
.btn.purple:active{box-shadow:0 0 0 #4c1d95;}
.btn.pink{background:linear-gradient(145deg,#f472b6,#be185d);box-shadow:0 6px 0 #831843,inset 0 1px 0 rgba(255,255,255,.3);}
.btn.orange{background:linear-gradient(145deg,#fb923c,#ea580c);box-shadow:0 6px 0 #9a3412,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(251,146,60,.2);}
.btn.orange:active{box-shadow:0 0 0 #9a3412;}
.btn.teal{background:linear-gradient(145deg,#2dd4bf,#0d9488);box-shadow:0 6px 0 #134e4a,inset 0 1px 0 rgba(255,255,255,.3),0 0 20px rgba(45,212,191,.2);}
.btn.red{background:linear-gradient(145deg,#f87171,#dc2626);box-shadow:0 6px 0 #7f1d1d,inset 0 1px 0 rgba(255,255,255,.3);}
.btn.wide{grid-column:1/-1;}
.btn.crazy-btn{background:linear-gradient(145deg,#ff00ff,#7c3aed);box-shadow:0 6px 0 #4c1d95,inset 0 1px 0 rgba(255,255,255,.3);animation:crazyB .5s infinite;}
@keyframes crazyB{0%,100%{filter:hue-rotate(0deg)}50%{filter:hue-rotate(180deg)}}
.tap-hint{color:#3d6b4f;font-size:12px;font-weight:700;animation:blink 1.3s infinite;margin-top:7px;flex-shrink:0;}

/* MODE SELECT */
#mode-screen{background:linear-gradient(170deg,#061a10,#0d2b1a,#061a10);overflow-y:auto;}
.mode-title{font-size:11px;color:#4ade80;margin-bottom:12px;text-shadow:0 0 15px #4ade80;flex-shrink:0;}
.mode-card{width:100%;max-width:300px;padding:11px 14px;border-radius:12px;border:2px solid rgba(255,255,255,.1);margin-bottom:8px;cursor:pointer;transition:all .2s;flex-shrink:0;}
.mode-card:active{transform:scale(.97);}
.mode-card.easy{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.4);}
.mode-card.normal{background:rgba(74,222,128,.1);border-color:rgba(74,222,128,.4);}
.mode-card.hard{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.4);}
.mode-card.insane{background:rgba(168,85,247,.1);border-color:rgba(168,85,247,.4);}
.mode-card.crazy{background:rgba(255,0,255,.1);border-color:rgba(255,0,255,.4);animation:crazybrd 1s infinite;}
@keyframes crazybrd{0%,100%{border-color:rgba(255,0,255,.4)}50%{border-color:rgba(0,255,255,.6)}}
.mode-card.flip{background:rgba(56,189,248,.1);border-color:rgba(56,189,248,.4);}
.mode-card.zen{background:rgba(167,243,208,.07);border-color:rgba(110,231,183,.4);}
/* ‚îÄ‚îÄ‚îÄ NEW INFO PANEL ‚îÄ‚îÄ‚îÄ */
.info-panel{width:100%;max-width:340px;background:rgba(0,0,0,.45);border:1px solid rgba(74,222,128,.25);border-radius:18px;padding:14px 16px 12px;margin-bottom:10px;flex-shrink:0;backdrop-filter:blur(6px);}
.info-row{display:flex;align-items:center;justify-content:space-around;margin-bottom:12px;}
.info-item{display:flex;flex-direction:column;align-items:center;gap:2px;}
.info-ico{font-size:22px;line-height:1;}
.info-val{font-size:20px;font-weight:900;line-height:1;}
.info-val.g{color:#4ade80;text-shadow:0 0 10px rgba(74,222,128,.5);}
.info-val.gd{color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,.4);}
.info-val.xp{color:#a78bfa;text-shadow:0 0 10px rgba(167,139,250,.4);}
.info-lbl{font-size:10px;font-weight:700;color:#475569;}
.info-divider{width:1px;height:40px;background:rgba(255,255,255,.1);}
.lvl-bar-wrap{width:100%;}
.lvl-bar-label{font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:5px;text-align:center;}
.lvl-bar-outer{height:12px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.1);}
.lvl-bar-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f97316,#ef4444);border-radius:6px;transition:width .5s;position:relative;z-index:1;}
.lvl-bar-glow{height:100%;background:linear-gradient(90deg,rgba(251,191,36,.5),transparent);border-radius:6px;position:absolute;top:0;left:0;filter:blur(4px);}
/* Chest bar redesign */
.chest-bar{display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(139,92,246,.2),rgba(79,70,229,.15));border:2px solid rgba(139,92,246,.5);border-radius:16px;padding:12px 16px;margin-bottom:12px;flex-shrink:0;cursor:pointer;pointer-events:all;width:100%;max-width:340px;transition:all .2s;box-shadow:0 0 16px rgba(139,92,246,.15);}
.chest-bar:active{transform:scale(.97);}
.chest-icon{font-size:28px;filter:drop-shadow(0 0 8px rgba(139,92,246,.6));}
.chest-info{flex:1;font-size:13px;font-weight:800;color:#c4b5fd;line-height:1.4;}
.chest-arrow{font-size:22px;color:#a78bfa;font-weight:900;}
/* Play button */
.play-btn{font-size:22px!important;padding:18px 8px!important;background:linear-gradient(145deg,#22c55e,#16a34a)!important;box-shadow:0 8px 0 #14532d,inset 0 2px 0 rgba(255,255,255,.4),0 0 30px rgba(34,197,94,.3)!important;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,.3);}
/* Hero wrap bigger */
#hero-wrap{width:56px;height:88px;flex-shrink:0;filter:drop-shadow(0 0 14px rgba(74,222,128,.7));animation:hfloat 1.8s ease-in-out infinite;margin-bottom:6px;}
/* PETS screen */
#pets-screen{background:linear-gradient(170deg,#0a0a1a,#1a0a2e);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;padding-top:calc(env(safe-area-inset-top,0px)+14px);}
.pets-title{font-size:18px;font-weight:900;color:#f472b6;text-shadow:0 0 14px #f472b6;margin-bottom:8px;flex-shrink:0;}
.pets-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;max-width:340px;flex-shrink:0;margin-bottom:10px;}
.pet-card{background:rgba(255,255,255,.04);border:2px solid rgba(255,255,255,.1);border-radius:14px;padding:12px 8px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.pet-card:active{transform:scale(.96);}
.pet-card.owned{border-color:rgba(74,222,128,.4);}
.pet-card.selected{border-color:#FFD700;background:rgba(255,215,0,.08);box-shadow:0 0 18px rgba(255,215,0,.2);}
.pet-emoji{font-size:36px;display:block;margin-bottom:5px;}
.pet-name{font-size:13px;font-weight:800;color:#e2e8f0;margin-bottom:3px;}
.pet-effect{font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:4px;line-height:1.3;}
.pet-price{font-size:13px;font-weight:800;color:#FFD700;}
.pet-price.sel{color:#FFD700;}
.pet-price.owned-lbl{color:#64748b;}
/* Shop add pets tab */


/* SHOP / CAROUSEL */
#shop-screen,#trail-screen,#boost-screen,#upgrade-screen{background:linear-gradient(170deg,#0a0a1a,#1a0a2e,#0a0a1a);overflow-y:auto;gap:0;justify-content:center;align-items:center;padding-top:calc(env(safe-area-inset-top,0px)+14px);}
/* ACHIEVEMENTS / STICKERS - center content */
#achiev-screen{background:linear-gradient(170deg,#0a0a1a,#1a0a2e);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;}
.shop-title{font-size:18px;font-weight:900;color:#a78bfa;text-shadow:0 0 14px #a78bfa;margin-bottom:7px;flex-shrink:0;}
.shop-bal{display:flex;gap:10px;margin-bottom:7px;flex-shrink:0;background:rgba(255,255,255,.04);border-radius:9px;padding:6px 14px;border:1px solid rgba(255,255,255,.07);}
.bal-item{font-size:13px;font-weight:800;color:#94a3b8;display:flex;align-items:center;gap:5px;}
.bal-val{color:#4ade80;font-weight:900;}.bal-val.gd{color:#FFD700;}
.skin-name{font-size:14px;font-weight:800;color:#e2e8f0;margin-bottom:5px;}
.skin-price{font-size:13px;font-weight:800;color:#4ade80;}
.skin-price.lbl-owned{color:#64748b;font-size:12px;}
.skin-price.lbl-selected{color:#FFD700;}
.mode-name{font-size:15px;font-weight:900;color:#e2e8f0;margin-bottom:3px;}
.mode-desc{font-size:12px;font-weight:700;color:#94a3b8;line-height:1.5;}
.mode-reward{font-size:12px;font-weight:800;color:#fbbf24;margin-top:3px;}
.boost-name{font-size:12px;font-weight:800;color:#e2e8f0;margin-bottom:2px;}
.boost-desc{font-size:11px;font-weight:700;color:#64748b;margin-bottom:3px;line-height:1.4;}
.boost-cnt-txt{font-size:15px;font-weight:900;color:#4ade80;margin-bottom:3px;}
.boost-price{font-size:12px;font-weight:800;color:#fbbf24;margin-bottom:4px;}
.upg-name{font-size:12px;font-weight:800;color:#e2e8f0;margin-bottom:3px;line-height:1.4;}
.upg-desc{font-size:11px;font-weight:700;color:#64748b;margin-bottom:4px;line-height:1.4;}
.upg-level{font-size:13px;color:#4ade80;font-weight:800;}
.upg-price{font-size:12px;font-weight:800;color:#fbbf24;margin-top:2px;}
.achiev-name{font-size:12px;font-weight:800;color:#e2e8f0;margin-bottom:2px;line-height:1.4;}
.achiev-desc{font-size:11px;font-weight:700;color:#64748b;line-height:1.4;}
.achiev-reward{font-size:12px;font-weight:800;color:#4ade80;margin-top:2px;}
.sticker-name{font-size:11px;font-weight:800;color:#e2e8f0;margin-bottom:2px;line-height:1.4;}
.sticker-req{font-size:10px;font-weight:700;color:#64748b;line-height:1.4;}
.shop-tabs{display:flex;gap:5px;margin-bottom:7px;flex-shrink:0;width:100%;max-width:340px;}
.shop-tab{flex:1;padding:8px 4px;font-size:12px;font-weight:800;border-radius:12px;cursor:pointer;border:2px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#94a3b8;font-family:'Nunito',sans-serif;}
.shop-tab.active{border-color:#a78bfa;background:rgba(167,139,250,.15);color:#e2e8f0;}
.carousel-outer{width:100%;max-width:340px;flex-shrink:0;position:relative;margin-bottom:5px;}
.carousel-vp{width:100%;overflow:hidden;border-radius:12px;}
.carousel-track{display:flex;transition:transform .3s cubic-bezier(.4,0,.2,1);}
.carousel-slide{min-width:100%;display:flex;justify-content:center;align-items:center;padding:0 3px;}
.skin-card{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:16px;padding:11px 18px;text-align:center;width:100%;position:relative;}
.skin-card.owned{border-color:#22c55e;background:rgba(74,222,128,.07);}
.skin-card.selected{border-color:#FFD700;background:rgba(255,215,0,.1);box-shadow:0 0 22px rgba(255,215,0,.2);}
.skin-canvas-wrap{width:68px;height:105px;margin:0 auto 7px;}
.skin-canvas-wrap canvas{width:100%;height:100%;}
/* skin card */
.skin-price{font-size:8px;color:#4ade80;}
.skin-price.lbl-owned{color:#64748b;font-size:7px;}
.skin-price.lbl-selected{color:#FFD700;}
.skin-badge{position:absolute;top:-6px;right:-6px;padding:3px 6px;border-radius:6px;font-size:5px;color:#fff;}
.carr-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.6);border:2px solid rgba(255,255,255,.15);color:#fff;width:30px;height:30px;border-radius:50%;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;pointer-events:all;}
.carr-arrow.left{left:-5px;}.carr-arrow.right{right:-5px;}
.carr-dots{display:flex;gap:5px;justify-content:center;margin-bottom:7px;flex-shrink:0;}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.2);cursor:pointer;transition:all .2s;}
.dot.active{background:#a78bfa;box-shadow:0 0 6px #a78bfa;}
.shop-actions{display:flex;gap:7px;flex-shrink:0;width:100%;max-width:340px;}
.shop-actions .btn{flex:1;}

/* UPGRADES */
.upgrade-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;max-width:340px;flex-shrink:0;margin-bottom:8px;}
.upgrade-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:9px;text-align:center;cursor:pointer;transition:all .2s;}
.upgrade-card:active{transform:scale(.96);}
.upgrade-card.maxed{border-color:rgba(74,222,128,.4);opacity:.7;}
/* upg icon */
.upg-icon{font-size:26px;display:block;margin-bottom:5px;}

/* BOOST SHOP */
.boost-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;width:100%;max-width:340px;flex-shrink:0;margin-bottom:10px;}
.boost-card{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 5px;text-align:center;}
/* boost icon */
.boost-icon{font-size:26px;display:block;margin-bottom:4px;}
.boost-buy-btn{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border:none;padding:7px 4px;font-family:'Nunito',sans-serif;font-size:11px;font-weight:800;border-radius:8px;cursor:pointer;width:100%;}

/* STICKERS */
#sticker-screen{background:linear-gradient(170deg,#0a0a1a,#1a1a0a);overflow-y:auto;justify-content:center;align-items:center;gap:0;}
.sticker-title{font-size:10px;color:#fbbf24;text-shadow:0 0 14px #fbbf24;margin-bottom:10px;flex-shrink:0;}
.sticker-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;max-width:340px;flex-shrink:0;}
.sticker-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:10px 6px;text-align:center;}
.sticker-card.got{border-color:rgba(251,191,36,.5);background:rgba(251,191,36,.07);}
.sticker-card.locked{opacity:.35;}
/* sticker */
.sticker-emoji{font-size:32px;display:block;margin-bottom:5px;}

/* LEADERBOARD */
#leaderboard-screen{background:linear-gradient(170deg,#0a1628,#0f2044);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;}
.lb-title{font-size:22px;font-weight:900;color:#38bdf8;text-shadow:0 0 14px #38bdf8;margin-bottom:12px;flex-shrink:0;}
.lb-list{width:100%;max-width:340px;flex-shrink:0;}
.lb-entry{display:flex;align-items:center;background:rgba(255,255,255,.04);border-radius:12px;padding:9px 12px;margin-bottom:7px;border:1px solid rgba(255,255,255,.07);gap:10px;}
.lb-entry.me{border-color:#38bdf8;background:rgba(56,189,248,.08);box-shadow:0 0 14px rgba(56,189,248,.1);}
.lb-rank{font-size:16px;font-weight:900;width:26px;color:#475569;}
.lb-rank.r1{color:#FFD700;text-shadow:0 0 8px #FFD700;}.lb-rank.r2{color:#C0C0C0;}.lb-rank.r3{color:#CD7F32;}
.lb-sp{width:26px;height:26px;flex-shrink:0;}
.lb-name{flex:1;font-size:13px;font-weight:800;color:#e2e8f0;}
.lb-score{font-size:16px;font-weight:900;color:#4ade80;text-shadow:0 0 6px #4ade80;}
/* Nickname modal */
#nick-modal{position:absolute;inset:0;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;z-index:500;pointer-events:all;}
.nick-box{background:linear-gradient(160deg,#0a1a10,#061810);border:2px solid rgba(74,222,128,.4);border-radius:22px;padding:32px 28px;text-align:center;max-width:300px;width:90%;}
.nick-title{font-size:22px;font-weight:900;color:#4ade80;text-shadow:0 0 14px #4ade80;margin-bottom:8px;}
.nick-sub{font-size:13px;color:#94a3b8;margin-bottom:20px;font-weight:700;line-height:1.5;}
.nick-input{width:100%;background:rgba(255,255,255,.08);border:2px solid rgba(74,222,128,.3);border-radius:12px;padding:12px 16px;color:#fff;font-size:18px;font-weight:800;font-family:'Nunito',sans-serif;outline:none;text-align:center;margin-bottom:16px;}
.nick-input:focus{border-color:#4ade80;box-shadow:0 0 12px rgba(74,222,128,.3);}
.nick-input::placeholder{color:#475569;}

/* ACHIEVEMENTS card styles */
.achiev-title{font-size:10px;color:#fbbf24;text-shadow:0 0 14px #fbbf24;margin-bottom:10px;flex-shrink:0;}
.achiev-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;width:100%;max-width:340px;flex-shrink:0;}
.achiev-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:11px;padding:8px;text-align:center;position:relative;}
.achiev-card.unlocked{border-color:rgba(251,191,36,.4);background:rgba(251,191,36,.07);}
.achiev-card.locked{opacity:.4;}
/* achiev */
.achiev-icon{font-size:26px;display:block;margin-bottom:3px;}
.achiev-done{position:absolute;top:3px;right:3px;font-size:9px;}

/* RANKS */
#ranks-screen{background:linear-gradient(170deg,#0a1010,#0a2020);overflow-y:auto;justify-content:flex-start;align-items:center;gap:0;}
.ranks-title{font-size:22px;font-weight:900;color:#fbbf24;text-shadow:0 0 14px #fbbf24;margin-bottom:14px;flex-shrink:0;font-family:'Nunito',sans-serif;}
.rank-entry{display:flex;align-items:center;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:11px 14px;margin-bottom:8px;gap:12px;width:100%;max-width:340px;flex-shrink:0;}
.rank-entry.cur{border-color:#fbbf24;background:rgba(251,191,36,.1);box-shadow:0 0 16px rgba(251,191,36,.15);}
.rank-entry.done{border-color:rgba(74,222,128,.3);}
.rank-ico{font-size:26px;flex-shrink:0;}
.rank-nm{font-size:14px;font-weight:800;color:#e2e8f0;margin-bottom:2px;}
.rank-xpreq{font-size:11px;color:#64748b;font-weight:700;}

/* WHEEL */
#wheel-screen{background:linear-gradient(170deg,#0a0a1a,#200a3a);}
.wheel-title{font-size:18px;font-weight:900;color:#FFD700;text-shadow:0 0 20px #FFD700,0 0 40px rgba(255,215,0,.5);margin-bottom:10px;flex-shrink:0;letter-spacing:1px;}
.wheel-wrap{position:relative;width:300px;height:300px;flex-shrink:0;margin-bottom:14px;filter:drop-shadow(0 0 20px rgba(255,215,0,.5));}
#wheel-canvas{width:300px;height:300px;}
.wheel-ptr{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:36px;filter:drop-shadow(0 0 6px rgba(255,215,0,.8));z-index:2;}
.wheel-btn{background:linear-gradient(145deg,#FFD700,#f59e0b,#d97706);color:#1a0a00;border:none;padding:18px 48px;font-family:'Nunito',sans-serif;font-size:20px;font-weight:900;border-radius:18px;cursor:pointer;box-shadow:0 7px 0 #92400e,inset 0 2px 0 rgba(255,255,255,.5),0 0 30px rgba(255,215,0,.4);margin-bottom:7px;letter-spacing:1px;transition:transform .1s,box-shadow .1s;}
.wheel-btn:active{transform:translateY(7px);box-shadow:0 0 0 #92400e,inset 0 1px 0 rgba(255,255,255,.3);}
.wheel-btn:disabled{opacity:.4;cursor:not-allowed;}
.wheel-result{font-size:16px;font-weight:900;color:#FFD700;text-align:center;min-height:24px;margin-bottom:6px;text-shadow:0 0 16px #FFD700;}

/* GAMEOVER */
#gameover-screen{background:rgba(0,0,0,.9);backdrop-filter:blur(8px);}
.go-title{font-size:15px;color:#ef4444;text-align:center;text-shadow:0 0 28px #ef4444,2px 2px 0 #000;margin-bottom:10px;animation:goShake .4s ease;flex-shrink:0;}
@keyframes goShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}60%{transform:translateX(8px)}}
.go-box{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.12);border-radius:14px;padding:12px 26px;text-align:center;margin-bottom:10px;flex-shrink:0;}
.go-lbl{font-size:6px;color:#64748b;margin-bottom:3px;}
.go-val{font-size:26px;color:#4ade80;text-shadow:0 0 16px #4ade80;}
.go-best{font-size:6px;color:#FFD700;margin-top:3px;}
.go-earned{font-size:6px;color:#7fffb0;margin-top:3px;}
.go-rank{font-size:7px;color:#fbbf24;margin-top:3px;}
.go-sticker{font-size:6px;color:#a78bfa;margin-top:3px;animation:glow 1s infinite;}
.go-unlock{font-size:5px;color:#a78bfa;margin-top:3px;animation:glow 1s infinite;}

/* CHEST MODAL */
#chest-modal{position:absolute;inset:0;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;z-index:200;pointer-events:all;}
.chest-box{background:linear-gradient(160deg,#1a0a3e,#0a1a3e);border:2px solid rgba(139,92,246,.5);border-radius:20px;padding:28px 30px;text-align:center;max-width:280px;width:100%;}
.chest-box-title{font-size:10px;color:#a78bfa;text-shadow:0 0 14px #a78bfa;margin-bottom:10px;}
.chest-big-icon{font-size:56px;margin-bottom:10px;display:block;}
.chest-reward-text{font-size:8px;color:#fbbf24;margin-bottom:14px;}

/* TOAST */
#toast{position:absolute;bottom:calc(env(safe-area-inset-bottom,0px)+65px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,.87);border:1px solid rgba(74,222,128,.4);border-radius:11px;padding:8px 16px;font-size:7px;color:#4ade80;white-space:nowrap;opacity:0;transition:opacity .3s;pointer-events:none;z-index:300;}
#toast.show{opacity:1;}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:2px}
</style>

</head>
<body>
<div id="wrap">
<canvas id="gameCanvas"></canvas>
<div id="ui">
  <div id="hud-score" class="hidden">0</div>
  <div id="hud-currency" class="hidden">
    <div id="hud-cukes-row">ü•í <span id="hud-cukes">0</span></div>
    <div id="hud-gold-row">‚ú® <span id="hud-gold">0</span></div>
  </div>
  <div id="hud-lvl-wrap" class="hidden">
    <div id="hud-lvl-text">LVL 1</div>
    <div id="hud-xpbar"><div id="hud-xpfill" style="width:0%"></div></div>
  </div>
  <div id="hud-combo" class="hidden"></div>
  <div id="hud-boosters" class="hidden">
    <div class="hud-boost-btn" id="btn-shield" onclick="useBooster('shield')">üõ°Ô∏è<div class="bcnt" id="cnt-shield">0</div></div>
    <div class="hud-boost-btn" id="btn-magnet" onclick="useBooster('magnet')">üß≤<div class="bcnt" id="cnt-magnet">0</div></div>
    <div class="hud-boost-btn" id="btn-turbo" onclick="useBooster('turbo')">‚ö°<div class="bcnt" id="cnt-turbo">0</div></div>
    <div class="hud-boost-btn" id="btn-mega" onclick="useBooster('mega')">üí•<div class="bcnt" id="cnt-mega">0</div></div>
  </div>
  <div id="hud-shoot" class="hidden" onclick="shoot()">üå±</div>
  <div id="hud-chest" class="hidden" onclick="openChestModal()">üì¶<br><span id="chest-timer-txt">--:--</span></div>
  <div id="game-label"></div>
  <div id="sticker-notif"></div>
</div>

<!-- START -->

<div class="screen" id="start-screen">
  <canvas id="start-bg-canvas"></canvas>
  <div id="start-content">
  <div class="game-title">ü•í FLAPPY<br>CUCUMBER</div>
  <div id="hero-wrap" style="position:relative;display:flex;align-items:flex-end;gap:4px;">
    <canvas id="hero-canvas" width="56" height="88"></canvas>
    <canvas id="start-pet-canvas" width="52" height="52" style="margin-bottom:8px;filter:drop-shadow(0 0 8px rgba(255,100,255,.6));display:none;transition:opacity .3s;"></canvas>
  </div>
  <div class="player-rank" id="player-rank-display">ü•í –ù–ê–ß–ò–ù–ê–Æ–©–ò–ô</div>

  <!-- Big info panel -->
  <div class="info-panel">
    <div class="info-row">
      <div class="info-item">
        <span class="info-ico">ü•í</span>
        <div class="info-val g" id="main-cukes">0</div>
        <div class="info-lbl">–û–≥—É—Ä—á–∏–∫–∏</div>
      </div>
      <div class="info-divider"></div>
      <div class="info-item">
        <span class="info-ico">‚ú®</span>
        <div class="info-val gd" id="main-gold">0</div>
        <div class="info-lbl">–ó–æ–ª–æ—Ç–æ</div>
      </div>
      <div class="info-divider"></div>
      <div class="info-item">
        <span class="info-ico">‚≠ê</span>
        <div class="info-val xp" id="main-xp">0</div>
        <div class="info-lbl">XP</div>
      </div>
    </div>
    <!-- Level bar -->
    <div class="lvl-bar-wrap">
      <div class="lvl-bar-label" id="menu-xp-label">0 / 100 XP ¬∑ –£—Ä–æ–≤–µ–Ω—å 1</div>
      <div class="lvl-bar-outer">
        <div class="lvl-bar-fill" id="menu-xp-fill" style="width:0%"></div>
        <div class="lvl-bar-glow" id="menu-xp-fill-glow" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- Chest button -->
  <div class="chest-bar" onclick="openChestModal()">
    <div class="chest-icon">üéÅ</div>
    <div class="chest-info" id="menu-chest-info">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å—É–Ω–¥—É–∫ –≥–æ—Ç–æ–≤!</div>
    <div class="chest-arrow">‚Ä∫</div>
  </div>

  <div class="btn-grid">
    <button class="btn play-btn wide" onclick="showModeSelect()">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
    <button class="btn gold" onclick="showShop()">üõí –ú–ê–ì–ê–ó–ò–ù</button>
    <button class="btn blue" onclick="showLeaderboard()">üèÜ –†–ï–ô–¢–ò–ù–ì</button>
    <button class="btn purple" onclick="showAchievements()">üèÖ –ê–ß–ò–í–ö–ò</button>
    <button class="btn" onclick="showWheel()" style="background:linear-gradient(145deg,#a855f7,#6d28d9);box-shadow:0 6px 0 #3b0764,inset 0 1px 0 rgba(255,255,255,.3);">üé° –ö–û–õ–ï–°–û</button>
    <button class="btn teal" onclick="showBoostShop()">üíä –ë–£–°–¢–ï–†–´</button>
    <button class="btn orange" onclick="showRanks()">üéñÔ∏è –†–ê–ù–ì–ò</button>
    <button class="btn pink" onclick="showPets()">üêæ –ü–ò–¢–û–ú–¶–´</button>
  </div>
  <div class="tap-hint">–¢–ê–ü / –ü–†–û–ë–ï–õ = –ü–†–´–ñ–û–ö ¬∑ –î–í–û–ô–ù–û–ô –¢–ê–ü = üå±</div>
  </div>
</div>

<!-- MODE SELECT -->

<div class="screen hidden" id="mode-screen">
  <div class="mode-title">–í–´–ë–û–† –†–ï–ñ–ò–ú–ê</div>
  <div class="mode-card easy" onclick="startGame('easy')"><div class="mode-name">üòå –õ–Å–ì–ö–ò–ô</div><div class="mode-desc">–ú–µ–¥–ª–µ–Ω–Ω–æ, —à–∏—Ä–æ–∫–∏–µ –ø—Ä–æ—Ö–æ–¥—ã.</div><div class="mode-reward">x0.8 ü•í</div></div>
  <div class="mode-card normal" onclick="startGame('normal')"><div class="mode-name">ü•í –û–ë–´–ß–ù–´–ô</div><div class="mode-desc">–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–±—ã –ø–æ—Å–ª–µ 15 –±–∞—à–µ–Ω. –ë–æ—Å—Å—ã. –Ø—â–∏–∫–∏.</div><div class="mode-reward">x1.0 ü•í</div></div>
  <div class="mode-card hard" onclick="startGame('hard')"><div class="mode-name">üî• –°–õ–û–ñ–ù–´–ô</div><div class="mode-desc">–£–∑–∫–∏–µ –ø—Ä–æ—Ö–æ–¥—ã, –±—ã—Å—Ç—Ä–µ–µ —Ä–∞–∑–≥–æ–Ω.</div><div class="mode-reward">x1.5 ü•í</div></div>
  <div class="mode-card insane" onclick="startGame('insane')"><div class="mode-name">üíÄ –ë–ï–ó–£–ú–ò–ï</div><div class="mode-desc">–ö–∞–º–µ—Ä–∞ —Ç—Ä—è—Å—ë—Ç—Å—è. –≠–∫—Å—Ç—Ä–∏–º.</div><div class="mode-reward">x2.0 ü•í</div></div>
  <div class="mode-card crazy" onclick="startGame('crazy')"><div class="mode-name">üåÄ –•–ê–û–°</div><div class="mode-desc">–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è, —Ñ–æ–Ω –∏ —Ç—Ä—É–±—ã —Å—Ö–æ–¥—è—Ç —Å —É–º–∞!</div><div class="mode-reward">x3.0 ü•í</div></div>
  <div class="mode-card flip" onclick="startGame('flip')"><div class="mode-name">üîÑ –í–í–ï–†–• –¢–û–†–ú–ê–®–ö–ê–ú–ò</div><div class="mode-desc">–ü—Ä–æ–ª–µ—Ç–∞–π —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª—ã -- –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è –º–µ–Ω—è–µ—Ç—Å—è!</div><div class="mode-reward">x2.5 ü•í</div></div>
  <div class="mode-card zen" onclick="startGame('zen')"><div class="mode-name">üçÉ –î–ó–ï –ù-–†–ï–ñ–ò–ú</div><div class="mode-desc">–ë–µ–∑ —Ç—Ä—É–±! –£–≤–æ—Ä–∞—á–∏–≤–∞–π—Å—è –æ—Ç –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π, —Ñ–∞—Ä–º—å –æ–≥—É—Ä—á–∏–∫–∏.</div><div class="mode-reward">x0.5 ü•í (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)</div></div>
  <button class="btn blue" style="margin-top:8px;width:100%;max-width:300px;flex-shrink:0;" onclick="closeModeSelect()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- PETS SCREEN -->
<div class="screen hidden" id="pets-screen">
  <div class="pets-title">üêæ –ü–ò–¢–û–ú–¶–´</div>
  <div class="shop-bal">
    <div class="bal-item">‚ú® <span class="bal-val gd" id="pets-gold">0</span> –∑–æ–ª–æ—Ç–æ</div>
  </div>
  <div class="pets-grid" id="pets-grid"></div>
  <button class="btn blue" style="width:100%;max-width:340px;flex-shrink:0;margin-top:4px;" onclick="closePets()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- SHOP -->

<div class="screen hidden" id="shop-screen">
  <div class="shop-title">üõí –ú–ê–ì–ê–ó–ò–ù</div>
  <div class="shop-bal">
    <div class="bal-item">ü•í <span class="bal-val" id="shop-cukes">0</span></div>
    <div class="bal-item">‚ú® <span class="bal-val gd" id="shop-gold">0</span> –∑–æ–ª–æ—Ç–æ</div>
  </div>
  <div class="shop-tabs">
    <button class="shop-tab active" id="stab-skins" onclick="setShopTab('skins')">ü•í –°–ö–ò–ù–´</button>
    <button class="shop-tab" id="stab-worlds" onclick="setShopTab('worlds')">üåç –ú–ò–†–´</button>
    <button class="shop-tab" id="stab-trails" onclick="setShopTab('trails')">‚ú® –°–õ–ï–î–´</button>
    <button class="shop-tab" id="stab-upg" onclick="setShopTab('upgrades')">‚¨ÜÔ∏è –£–õ–£–ß–®.</button>
  </div>
  <div class="carousel-outer" id="shop-carr-outer">
    <button class="carr-arrow left" onclick="carPrev()">‚Äπ</button>
    <div class="carousel-vp"><div class="carousel-track" id="carousel-track"></div></div>
    <button class="carr-arrow right" onclick="carNext()">‚Ä∫</button>
  </div>
  <div class="carr-dots" id="carousel-dots"></div>
  <div class="shop-actions">
    <button class="btn purple" id="shop-action-btn" onclick="shopAction()">–í–´–ë–†–ê–¢–¨</button>
    <button class="btn" onclick="closeShop()">‚Üê –ù–ê–ó–ê–î</button>
  </div>
</div>

<!-- BOOST SHOP -->

<div class="screen hidden" id="boost-screen">
  <div class="shop-title" style="color:#2dd4bf;text-shadow:0 0 14px #2dd4bf;">üíä –ë–£–°–¢–ï–†–´</div>
  <div class="shop-bal"><div class="bal-item">ü•í <span class="bal-val" id="boost-cukes">0</span></div></div>
  <div class="boost-grid">
    <div class="boost-card" style="border-color:rgba(56,189,248,.3);"><span class="boost-icon">üõ°Ô∏è</span><div class="boost-name">–©–ò–¢</div><div class="boost-desc">–ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–∞–¥–µ–Ω–∏—è –∏ —É–¥–∞—Ä–∞ –æ–± –ø–æ—Ç–æ–ª–æ–∫</div><div class="boost-cnt-txt">x<span id="sh-n">0</span></div><div class="boost-price">ü•í 50</div><button class="boost-buy-btn" onclick="buyBooster('shield')">–ö–£–ü–ò–¢–¨</button></div>
    <div class="boost-card" style="border-color:rgba(251,191,36,.3);"><span class="boost-icon">üß≤</span><div class="boost-name">–ú–ê–ì–ù–ò–¢</div><div class="boost-desc">–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –º–æ–Ω–µ—Ç—ã 10—Å</div><div class="boost-cnt-txt">x<span id="mg-n">0</span></div><div class="boost-price">ü•í 75</div><button class="boost-buy-btn" onclick="buyBooster('magnet')">–ö–£–ü–ò–¢–¨</button></div>
    <div class="boost-card" style="border-color:rgba(249,115,22,.3);"><span class="boost-icon">‚ö°</span><div class="boost-name">–¢–£–†–ë–û</div><div class="boost-desc">+30% —Å–∫–æ—Ä–æ—Å—Ç—å 8—Å</div><div class="boost-cnt-txt">x<span id="tb-n">0</span></div><div class="boost-price">ü•í 60</div><button class="boost-buy-btn" onclick="buyBooster('turbo')">–ö–£–ü–ò–¢–¨</button></div>
    <div class="boost-card" style="border-color:rgba(167,139,250,.3);" id="mega-boost-card"><span class="boost-icon">ü•íüí•</span><div class="boost-name">–ú–ï–ì–ê-–û–ì–£–†–ï–¶</div><div class="boost-desc">–†–∞–∑—Ä—É—à–∞–π —Ç—Ä—É–±—ã 5—Å!</div><div class="boost-cnt-txt">x<span id="mega-n">0</span></div><div class="boost-price">ü•í 150</div><button class="boost-buy-btn" onclick="buyBooster('mega')">–ö–£–ü–ò–¢–¨</button></div>
  </div>
  <button class="btn blue" style="margin-top:8px;width:100%;max-width:280px;flex-shrink:0;" onclick="closeBoostShop()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- STICKERS -->

<div class="screen hidden" id="sticker-screen">
  <div class="sticker-title">üè∑Ô∏è –ù–ê–ö–õ–ï–ô–ö–ò</div>
  <div class="sticker-grid" id="sticker-grid"></div>
  <button class="btn blue" style="margin-top:12px;width:100%;max-width:300px;flex-shrink:0;" onclick="closeStickers()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- LEADERBOARD -->

<div class="screen hidden" id="leaderboard-screen">
  <div class="lb-title">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</div>
  <div class="lb-list" id="lb-list"></div>
  <button class="btn blue" style="margin-top:10px;width:100%;max-width:300px;flex-shrink:0;" onclick="closeLeaderboard()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- ACHIEVEMENTS -->

<div class="screen hidden" id="achiev-screen">
  <div class="achiev-title">üèÖ –ê–ß–ò–í–ö–ò</div>
  <div class="achiev-grid" id="achiev-grid"></div>
  <button class="btn blue" style="margin-top:10px;width:100%;max-width:300px;flex-shrink:0;" onclick="closeAchievements()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- RANKS -->

<div class="screen hidden" id="ranks-screen">
  <div class="ranks-title">üéñÔ∏è –†–ê–ù–ì–ò</div>
  <div id="ranks-list"></div>
  <button class="btn blue" style="margin-top:10px;width:100%;max-width:300px;flex-shrink:0;" onclick="closeRanks()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- WHEEL -->

<div class="screen hidden" id="wheel-screen">
  <div class="wheel-title">üé° –ö–û–õ–ï–°–û –§–û–†–¢–£–ù–´</div>
  <div class="wheel-wrap"><div class="wheel-ptr">‚ñº</div><canvas id="wheel-canvas" width="300" height="300"></canvas></div>
  <div class="wheel-result" id="wheel-result"></div>
  <button class="wheel-btn" id="wheel-spin-btn" onclick="spinWheel()">üé° –ö–†–£–¢–ò–¢–¨!</button>
  <div style="font-size:13px;font-weight:700;color:#94a3b8;margin-bottom:4px;" id="wheel-info">–†–∞–∑ –≤ –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
  <button class="btn blue" style="margin-top:8px;width:100%;max-width:260px;flex-shrink:0;" onclick="closeWheel()">‚Üê –ù–ê–ó–ê–î</button>
</div>

<!-- GAMEOVER -->

<div class="screen hidden" id="gameover-screen">
  <div class="go-title">üíÄ –û–ì–£–†–ï–¶ –£–ú–ï–†!</div>
  <canvas id="dead-canvas" width="38" height="60" style="margin-bottom:8px;flex-shrink:0;filter:drop-shadow(0 0 12px rgba(239,68,68,.5));"></canvas>
  <div class="go-box">
    <div class="go-lbl">–°–ß–Å–¢</div>
    <div class="go-val" id="go-score">0</div>
    <div class="go-best" id="go-best"></div>
    <div class="go-earned" id="go-earned"></div>
    <div class="go-rank" id="go-rank"></div>
    <div class="go-sticker" id="go-sticker"></div>
    <div class="go-unlock" id="go-unlock"></div>
  </div>
  <div class="btn-grid" style="max-width:270px;">
    <button class="btn" onclick="restartGame()">üîÑ –ï–©–Å –†–ê–ó</button>
    <button class="btn blue" onclick="goToMenu()">üè† –ú–ï–ù–Æ</button>
    <button class="btn wide" style="background:linear-gradient(135deg,#0088cc,#005fa3);box-shadow:0 4px 0 #003d6b;" onclick="shareToTelegram()">üì§ –ü–û–î–ï–õ–ò–¢–¨–°–Ø –í TELEGRAM</button>
  </div>
</div>

<!-- NICKNAME MODAL -->
<div id="nick-modal" class="hidden">
  <div class="nick-box">
    <div class="nick-title">üëã –ü—Ä–∏–≤–µ—Ç!</div>
    <div class="nick-sub">–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?<br>–¢–≤–æ—ë –∏–º—è –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</div>
    <input class="nick-input" id="nick-input" type="text" placeholder="–í–≤–µ–¥–∏ –Ω–∏–∫–Ω–µ–π–º..." maxlength="16" autocomplete="off">
    <button class="btn wide" id="nick-save-btn" onclick="saveNickname()">‚úÖ –°–û–•–†–ê–ù–ò–¢–¨</button>
  </div>
</div>

<!-- CHEST MODAL -->

<div id="chest-modal" class="hidden">
  <div class="chest-box">
    <div class="chest-box-title">üì¶ –°–£–ù–î–£–ö</div>
    <span class="chest-big-icon" id="chest-anim-icon">üì¶</span>
    <div class="chest-reward-text" id="chest-reward-text">–û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É–∫!</div>
    <button class="btn wide" id="chest-open-btn" onclick="claimChest()">–û–¢–ö–†–´–¢–¨!</button>
    <button class="btn blue wide" style="margin-top:8px;" onclick="closeChestModal()">–ó–ê–ö–†–´–¢–¨</button>
  </div>
</div>

<div id="toast"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
let W,H;
function resizeCanvas(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;}
resizeCanvas();
window.addEventListener('resize',()=>{resizeCanvas();if(gameState==='menu')drawBg();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RANKS + CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RANKS=[
  {icon:'ü•í',name:'–ù–ê–ß–ò–ù–ê–Æ–©–ò–ô',xpRequired:0,   color:'#4ade80'},
  {icon:'üå±',name:'–†–û–°–¢–û–ö',    xpRequired:100,  color:'#22c55e'},
  {icon:'ü•ó',name:'–°–ê–õ–ê–¢–û–í–´–ô', xpRequired:300,  color:'#84cc16'},
  {icon:'‚öîÔ∏è', name:'–ë–û–ï–¶',     xpRequired:700,  color:'#fbbf24'},
  {icon:'üèÖ',name:'–û–ü–´–¢–ù–´–ô',   xpRequired:1500, color:'#f97316'},
  {icon:'üî•',name:'–≠–õ–ò–¢–ê',     xpRequired:3000, color:'#ef4444'},
  {icon:'üíé',name:'–ê–õ–ú–ê–ó–ù–´–ô',  xpRequired:6000, color:'#38bdf8'},
  {icon:'üëë',name:'–õ–ï–ì–ï–ù–î–ê',   xpRequired:12000,color:'#a78bfa'},
  {icon:'üåü',name:'DIVINE',    xpRequired:25000,color:'#FFD700'},
];
const XP_PER_LEVEL=[100,150,200,300,450,650,900,1200,2000];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STICKER DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STICKERS=[
  {id:'s_firstfly',  emoji:'üê£', name:'–ü–µ—Ä–≤—ã–π –ø–æ–ª—ë—Ç',   req:'–°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—É—é –∏–≥—Ä—É',         check:()=>totalGames>=1},
  {id:'s_inertia',   emoji:'ü™Å', name:'–ò–Ω–µ—Ä—Ü–∏—è',          req:'–ü—Ä–æ–π–¥–∏ 5 —Ç—Ä—É–± –±–µ–∑ –ø—Ä—ã–∂–∫–∞',  check:()=>maxNoJump>=5},
  {id:'s_zenmaster', emoji:'üçÉ', name:'–î–∑–µ–Ω-–º–∞—Å—Ç–µ—Ä',      req:'–ü—Ä–æ–ª–µ—Ç–∏ 60—Å –≤ –î–∑–µ–Ω-—Ä–µ–∂–∏–º–µ', check:()=>zenSeconds>=60},
  {id:'s_combofever',emoji:'üå∂Ô∏è', name:'–û–≥—É—Ä–µ—á–Ω–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞',req:'–ê–∫—Ç–∏–≤–∏—Ä—É–π –∫–æ–º–±–æ x5',      check:()=>combosActivated>=1},
  {id:'s_bossslayer',emoji:'üëπ', name:'–£–±–∏–π—Ü–∞ –±–æ—Å—Å–æ–≤',    req:'–ü–æ–±–µ–¥–∏ 5 –±–æ—Å—Å–æ–≤',            check:()=>bossesDefeated>=5},
  {id:'s_richcuke',  emoji:'üí∞', name:'–ë–æ–≥–∞—á',             req:'–°–æ–±–µ—Ä–∏ 500 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',    check:()=>totalCoins>=500},
  {id:'s_divine',    emoji:'‚ú®', name:'Divine',            req:'–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π Divine —Å–∫–∏–Ω',   check:()=>ownedSkins.includes('secret')},
  {id:'s_shooter',   emoji:'üå±', name:'–°–Ω–∞–π–ø–µ—Ä',           req:'–†–∞–∑—Ä—É—à–∏ 20 —è—â–∏–∫–æ–≤',         check:()=>boxesDestroyed>=20},
  {id:'s_portal',    emoji:'üåÄ', name:'–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫',   req:'–í–æ–π–¥–∏ –≤ 3 –ø–æ—Ä—Ç–∞–ª–∞',         check:()=>portalsUsed>=3},
  {id:'s_megapower', emoji:'üí•', name:'–ú–µ–≥–∞-—Å–∏–ª–∞',        req:'–†–∞–∑—Ä—É—à–∏ 5 —Ç—Ä—É–± –ú–µ–≥–∞-–æ–≥—É—Ä—Ü–æ–º',check:()=>megaPipesSmashed>=5},
  {id:'s_chestloot', emoji:'üì¶', name:'–°–±–æ—Ä—â–∏–∫',          req:'–û—Ç–∫—Ä–æ–π 10 —Å—É–Ω–¥—É–∫–æ–≤',        check:()=>chestsOpened>=10},
  {id:'s_crazy100',  emoji:'üåÄ', name:'–•–∞–æ—Ç–∏–∫',            req:'–í—ã–∂–∏–≤–∏ 25 –±–∞—à–µ–Ω –≤ –•–∞–æ—Å–µ',  check:()=>crazySurvived>=25},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPGRADES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UPGRADES=[
  {id:'u_coin_chance',  icon:'ü™ô', name:'–ú–û–ù–ï–¢–ù–ê–Ø –£–î–ê–ß–ê',  desc:'+5% —à–∞–Ω—Å –º–æ–Ω–µ—Ç—ã –∑–∞ —É—Ä–æ–≤–µ–Ω—å',    maxLevel:5, baseCost:80,  costMult:1.8, effect:'coinChance'},
  {id:'u_low_gravity',  icon:'ü™∂', name:'–õ–Å–ì–ö–û–°–¢–¨',        desc:'-8% —Å–∏–ª–∞ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å', maxLevel:4, baseCost:100, costMult:2,   effect:'lowGravity'},
  {id:'u_lucky_save',   icon:'üçÄ', name:'–°–ß–ê–°–¢–õ–ò–í–ß–ò–ö',     desc:'1% —à–∞–Ω—Å –≤—ã–∂–∏—Ç—å –ø—Ä–∏ —É–¥–∞—Ä–µ',       maxLevel:3, baseCost:200, costMult:2.5, effect:'luckySave'},
  {id:'u_magnet_range', icon:'üß≤', name:'–ú–û–©–ù–´–ô –ú–ê–ì–ù–ò–¢',   desc:'+30 –µ–¥. –¥–∞–ª—å–Ω–æ—Å—Ç—å –º–∞–≥–Ω–∏—Ç–∞',     maxLevel:3, baseCost:120, costMult:1.9, effect:'magnetRange'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD / SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadSave(){
  try{const s=localStorage.getItem('fc_save');if(s)return JSON.parse(s);}catch(e){}
  return null;
}
const _s=loadSave();
const def=(k,d)=>_s&&_s[k]!==undefined?_s[k]:d;

let cucumbers     = def('cukes',   0);
let goldCukes     = def('gold',    0);
let bestScore     = def('best',    0);
let ownedSkins    = def('owned',   ['default']);
let selectedSkin  = def('skin',    'default');
let leaderboard   = def('lb',      []);
let unlockedAchievs= def('achiev', []);
let ownedTrails   = def('trails',  ['none']);
let selectedTrail = def('trail',   'none');
let lastWheelDate = def('wheelDate','');
let totalGames    = def('games',   0);
let totalCoins    = def('totalCoins',0);
let selectedWorld = def('world',   'forest');
let ownedWorlds   = def('worlds',  ['forest']);
let playerXP      = def('xp',      0);
let playerLevel   = def('level',   0);
let boosters      = def('boosters',{shield:0,magnet:0,turbo:0,mega:0});
let crazySurvived = def('crazy',   0);
let bossesDefeated= def('bosses',  0);
let upgradelevels = def('upglvls', {u_coin_chance:0,u_low_gravity:0,u_lucky_save:0,u_magnet_range:0});
let unlockedStickers=def('stickers',[]);
let lastChestTime = def('lastChest',0);
let chestsOpened  = def('chestsOpened',0);
let maxNoJump     = def('maxNoJump',0);
let zenSeconds    = def('zenSeconds',0);
let combosActivated=def('combosActivated',0);
let boxesDestroyed= def('boxesDestroyed',0);
let portalsUsed   = def('portalsUsed',0);
let megaPipesSmashed=def('megaPipesSmashed',0);
let playerNickname= def('nickname','');

function save(){
  try{
    const data={cukes:cucumbers,gold:goldCukes,best:bestScore,owned:ownedSkins,skin:selectedSkin,
      lb:leaderboard,achiev:unlockedAchievs,trails:ownedTrails,trail:selectedTrail,
      wheelDate:lastWheelDate,games:totalGames,totalCoins,world:selectedWorld,worlds:ownedWorlds,
      xp:playerXP,level:playerLevel,boosters,crazy:crazySurvived,bosses:bossesDefeated,
      upglvls:upgradelevels,stickers:unlockedStickers,lastChest:lastChestTime,chestsOpened,
      maxNoJump,zenSeconds,combosActivated,boxesDestroyed,portalsUsed,megaPipesSmashed,
      nickname:playerNickname,pet:selectedPet,ownedPets};
    localStorage.setItem('fc_save',JSON.stringify(data));
    // Save to shared leaderboard key
    if(playerNickname&&bestScore>0){
      const lbKey='fc_global_lb';
      let glb=[];try{glb=JSON.parse(localStorage.getItem(lbKey)||'[]');}catch(e){}
      const myId=tgUserId||('guest_'+playerNickname.toLowerCase());
      const existing=glb.find(e=>e.uid===myId);
      if(existing){if(bestScore>existing.score){existing.score=bestScore;existing.rank=getRank().icon;existing.skin=selectedSkin;}}
      else{glb.push({uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon});}
      glb.sort((a,b)=>b.score-a.score);glb=glb.slice(0,50);
      try{localStorage.setItem(lbKey,JSON.stringify(glb));}catch(e){}
    }
  }catch(e){console.warn('save err',e);}
}
document.addEventListener('visibilitychange',()=>{if(document.visibilityState==='hidden'){if(gameState==='playing'&&score>bestScore){bestScore=score;}save();}});
window.addEventListener('pagehide',()=>save());
window.addEventListener('beforeunload',()=>save());
setInterval(()=>save(),15000);

// ‚îÄ‚îÄ‚îÄ Nickname system ‚îÄ‚îÄ‚îÄ
function checkNicknameOnStart(){
  if(!playerNickname){
    setTimeout(()=>{
      document.getElementById('nick-modal').classList.remove('hidden');
      const inp=document.getElementById('nick-input');
      inp.focus();
      inp.onkeydown=e=>{if(e.key==='Enter')saveNickname();};
    },800);
  }
}
function saveNickname(){
  const inp=document.getElementById('nick-input');
  const val=(inp.value||'').trim().replace(/[<>"']/g,'').slice(0,16);
  if(!val||val.length<2){inp.style.borderColor='#ef4444';setTimeout(()=>inp.style.borderColor='rgba(74,222,128,.3)',1000);return;}
  playerNickname=val;save();
  document.getElementById('nick-modal').classList.add('hidden');
  showToast('üëã –ü—Ä–∏–≤–µ—Ç, '+playerNickname+'!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL LEADERBOARD (via Anthropic API as shared storage)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GLOBAL_LB_KEY='fc_global_lb_v2';
// We store leaderboard in localStorage under a shared key.
// For true multi-user sharing: all users share the same localStorage key via
// the artifact's persistent storage. When running as Telegram WebApp, we can
// additionally post scores to a shared namespace.
function getGlobalLB(){
  try{return JSON.parse(localStorage.getItem(GLOBAL_LB_KEY)||'[]');}catch(e){return[];}
}
function saveGlobalLB(lb){
  try{localStorage.setItem(GLOBAL_LB_KEY,JSON.stringify(lb));}catch(e){}
}
async function pushMyScore(){
  if(!playerNickname||bestScore<=0)return;
  const myId=String(tgUserId||('g_'+playerNickname.replace(/\s/g,'_').toLowerCase()));
  let glb=getGlobalLB();
  const existing=glb.find(e=>e.uid===myId);
  const entry={uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon,ts:Date.now()};
  if(existing){if(bestScore>existing.score)Object.assign(existing,entry);}
  else glb.push(entry);
  glb.sort((a,b)=>b.score-a.score);glb=glb.slice(0,100);
  saveGlobalLB(glb);
  // Try to fetch remote leaderboard from artifact storage
  try{
    const res=await window.storage?.get('fc_lb_v1',true);
    if(res&&res.value){
      let remote=JSON.parse(res.value);
      remote=remote.filter(e=>e.uid!==myId);
      remote.push(entry);
      remote.sort((a,b)=>b.score-a.score);
      remote=remote.slice(0,100);
      await window.storage?.set('fc_lb_v1',JSON.stringify(remote),true);
      saveGlobalLB(remote);
    } else {
      await window.storage?.set('fc_lb_v1',JSON.stringify(glb),true);
    }
  }catch(e){}
}
async function loadGlobalLB(){
  try{
    const res=await window.storage?.get('fc_lb_v1',true);
    if(res&&res.value){
      const remote=JSON.parse(res.value);
      // Merge with local
      const local=getGlobalLB();
      const merged=Object.values([...local,...remote].reduce((m,e)=>{
        if(!m[e.uid]||e.score>m[e.uid].score)m[e.uid]=e;return m;},{})
      );
      merged.sort((a,b)=>b.score-a.score);
      saveGlobalLB(merged.slice(0,100));
      return merged;
    }
  }catch(e){}
  return getGlobalLB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TELEGRAM STATS (–∞–Ω–æ–Ω–∏–º–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - —Ç–æ–ª—å–∫–æ Telegram ID)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tgUserId=null,tgUsername=null;
const ADMIN_IDS=[5557580974, 363001588, 5488225835];
let adminModeActive=false;
// Track real scores before admin boost
let preAdminCukes=cucumbers,preAdminGold=goldCukes,preAdminXP=playerXP;

function checkAdminMode(uid){
  if(!ADMIN_IDS.includes(Number(uid)))return;
  if(adminModeActive)return; // already active
  adminModeActive=true;
  // Save scores before boost
  preAdminCukes=cucumbers;preAdminGold=goldCukes;preAdminXP=playerXP;
  // Give admin resources
  if(cucumbers<10000)cucumbers=10000;
  if(goldCukes<10000)goldCukes=10000;
  if(playerXP<10000)playerXP=10000;
  save();updateHUD();
  // Show admin button
  if(!document.getElementById('admin-stat-btn')){
    const statsEl=document.createElement('button');
    statsEl.id='admin-stat-btn';
    statsEl.className='btn blue';
    statsEl.style.cssText='position:fixed;top:calc(env(safe-area-inset-top,0px)+8px);right:8px;z-index:9999;font-size:13px;font-weight:900;padding:8px 12px;width:auto;min-width:unset;';
    statsEl.textContent='üìä –°–¢–ê–¢';
    statsEl.onclick=showAdminStats;
    document.body.appendChild(statsEl);
  }
  showToast('üëë –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
}

function deactivateAdminMode(){
  if(!adminModeActive)return;
  adminModeActive=false;
  // Restore original values (keep real achievements, not admin boosts)
  cucumbers=Math.max(preAdminCukes,cucumbers-10000);
  goldCukes=Math.max(preAdminGold,goldCukes-10000);
  playerXP=Math.max(preAdminXP,playerXP-10000);
  save();updateHUD();
  const btn=document.getElementById('admin-stat-btn');if(btn)btn.remove();
}

function initTelegram(){
  if(window.Telegram?.WebApp){
    const tg=window.Telegram.WebApp;
    tg.ready();tg.expand();
    const u=tg.initDataUnsafe?.user;
    if(u){
      tgUserId=u.id;
      tgUsername=u.username||u.first_name||'Unknown';
      const statsKey='fc_stats';
      let stats=[];
      try{stats=JSON.parse(localStorage.getItem(statsKey)||'[]');}catch(e){}
      const now=Date.now();
      const existing=stats.find(s=>s.id===String(tgUserId));
      if(existing){
        existing.last=now;
        existing.sessions=(existing.sessions||1)+1;
        existing.name=tgUsername;
        if(bestScore>0)existing.best=Math.max(existing.best||0,bestScore);
      } else {
        stats.push({id:String(tgUserId),name:tgUsername,first:now,last:now,sessions:1,best:bestScore||0});
      }
      if(stats.length>500)stats=stats.slice(-500);
      try{localStorage.setItem(statsKey,JSON.stringify(stats));}catch(e){}
      // Also push to shared storage for admin access
      try{
        const entry={id:String(tgUserId),name:tgUsername,first:now,last:now,best:bestScore||0};
        window.storage?.get('fc_tg_users',true).then(res=>{
          let users=[];try{if(res&&res.value)users=JSON.parse(res.value);}catch(e){}
          const ex=users.find(u2=>u2.id===String(tgUserId));
          if(ex){ex.last=now;ex.name=tgUsername;if(bestScore>0)ex.best=Math.max(ex.best||0,bestScore);ex.sessions=(ex.sessions||1)+1;}
          else users.push({...entry,sessions:1});
          window.storage?.set('fc_tg_users',JSON.stringify(users.slice(-500)),true);
        }).catch(()=>{});
      }catch(e){}
      checkAdminMode(tgUserId);
    }
  }
  // Admin secret tap: tap title 5 times
  let titleTaps=0;
  document.querySelector('.game-title')?.addEventListener('click',()=>{
    titleTaps++;
    if(titleTaps>=5){
      titleTaps=0;
      const id=parseInt(prompt('Admin ID:'));
      if(!isNaN(id)&&ADMIN_IDS.includes(id)){tgUserId=id;checkAdminMode(id);}
      else showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID');
    }
  });
  // Deactivate admin on page hide (simulate re-entry)
  document.addEventListener('visibilitychange',()=>{
    if(document.visibilityState==='hidden'&&adminModeActive){deactivateAdminMode();}
  });
}

async function showAdminStats(){
  let stats=[];
  try{stats=JSON.parse(localStorage.getItem('fc_stats')||'[]');}catch(e){}
  // Try to load from shared storage
  let sharedUsers=[];
  try{
    const res=await window.storage?.get('fc_tg_users',true);
    if(res&&res.value)sharedUsers=JSON.parse(res.value);
  }catch(e){}
  // Merge local + shared
  const allUsers=[...stats,...sharedUsers].reduce((m,u)=>{
    if(!m[u.id]||u.last>m[u.id].last)m[u.id]={...m[u.id],...u};return m;
  },{});
  const users=Object.values(allUsers);
  const total=users.length;
  const now=Date.now();
  const day=86400000;
  const today=users.filter(s=>(now-s.last)<day).length;
  const week=users.filter(s=>(now-s.last)<7*day).length;
  const avgSessions=(users.reduce((a,s)=>a+(s.sessions||1),0)/(total||1)).toFixed(1);
  // Top 10 by best score
  const top10=[...users].sort((a,b)=>(b.best||0)-(a.best||0)).slice(0,10);
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.93);z-index:10000;display:flex;align-items:center;justify-content:center;font-family:Nunito,sans-serif;overflow-y:auto;';
  const top10html=top10.map((u,i)=>`<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05);">
    <span style="color:#fbbf24;min-width:20px;font-size:12px;">#${i+1}</span>
    <span style="color:#94a3b8;font-size:10px;font-family:monospace;min-width:90px;">${u.id||'?'}</span>
    <span style="color:#e2e8f0;font-size:11px;flex:1;">${u.name||'?'}</span>
    <span style="color:#4ade80;font-size:12px;font-weight:900;">${u.best||0}</span>
  </div>`).join('');
  // Recent users
  const recent=[...users].sort((a,b)=>b.last-a.last).slice(0,15);
  const recentHtml=recent.map(u=>`<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.05);">
    <span style="color:#94a3b8;font-size:9px;font-family:monospace;min-width:90px;">${u.id||'?'}</span>
    <span style="color:#e2e8f0;font-size:10px;flex:1;">${u.name||'?'}</span>
    <span style="color:#64748b;font-size:9px;">${new Date(u.last).toLocaleDateString('ru')}</span>
    <span style="color:#fbbf24;font-size:10px;">x${u.sessions||1}</span>
  </div>`).join('');
  modal.innerHTML=`<div style="background:#0a1a0a;border:2px solid #4ade80;border-radius:16px;padding:20px;max-width:360px;width:95%;color:#4ade80;max-height:90vh;overflow-y:auto;">
    <div style="font-size:16px;font-weight:900;margin-bottom:16px;text-shadow:0 0 14px #4ade80;">üìä ADMIN –°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;">
      <div style="background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.2);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-size:24px;font-weight:900;color:#4ade80;">${total}</div>
        <div style="font-size:10px;color:#64748b;">üë• –í—Å–µ–≥–æ</div>
      </div>
      <div style="background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-size:24px;font-weight:900;color:#fbbf24;">${today}</div>
        <div style="font-size:10px;color:#64748b;">üìÖ –°–µ–≥–æ–¥–Ω—è</div>
      </div>
      <div style="background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-size:24px;font-weight:900;color:#38bdf8;">${week}</div>
        <div style="font-size:10px;color:#64748b;">üìÜ –ó–∞ –Ω–µ–¥–µ–ª—é</div>
      </div>
      <div style="background:rgba(167,139,250,.08);border:1px solid rgba(167,139,250,.2);border-radius:10px;padding:10px;text-align:center;">
        <div style="font-size:24px;font-weight:900;color:#a78bfa;">${avgSessions}</div>
        <div style="font-size:10px;color:#64748b;">üîÑ –°—Ä. —Å–µ—Å—Å–∏–π</div>
      </div>
    </div>
    <div style="font-size:12px;font-weight:800;color:#fbbf24;margin-bottom:8px;">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í (Telegram ID)</div>
    <div style="background:rgba(0,0,0,.3);border-radius:8px;padding:8px;margin-bottom:14px;">
      <div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:4px;">
        <span style="color:#475569;font-size:10px;min-width:20px;">#</span>
        <span style="color:#475569;font-size:10px;min-width:90px;">TG ID</span>
        <span style="color:#475569;font-size:10px;flex:1;">–ò–º—è</span>
        <span style="color:#475569;font-size:10px;">–†–µ–∫–æ—Ä–¥</span>
      </div>
      ${top10html}
    </div>
    <div style="font-size:12px;font-weight:800;color:#38bdf8;margin-bottom:8px;">‚è∞ –ü–û–°–õ–ï–î–ù–ò–ï –ò–ì–†–û–ö–ò</div>
    <div style="background:rgba(0,0,0,.3);border-radius:8px;padding:8px;margin-bottom:14px;">
      <div style="display:flex;gap:6px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:4px;">
        <span style="color:#475569;font-size:9px;min-width:90px;">TG ID</span>
        <span style="color:#475569;font-size:9px;flex:1;">–ò–º—è</span>
        <span style="color:#475569;font-size:9px;">–î–∞—Ç–∞</span>
        <span style="color:#475569;font-size:9px;">–°–µ—Å—Å.</span>
      </div>
      ${recentHtml}
    </div>
    <div style="font-size:9px;color:#475569;margin-bottom:12px;text-align:center;">–¢–≤–æ–π Telegram ID: <span style="color:#4ade80;">${tgUserId||'–Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω'}</span></div>
    <button onclick="this.parentElement.parentElement.remove()" style="width:100%;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border:none;padding:10px;font-family:Nunito,sans-serif;font-size:13px;font-weight:900;border-radius:10px;cursor:pointer;">–ó–ê–ö–†–´–¢–¨</button>
  </div>`;
  document.body.appendChild(modal);
}
initTelegram();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getRank(){for(let i=RANKS.length-1;i>=0;i--)if(playerXP>=RANKS[i].xpRequired)return RANKS[i];return RANKS[0];}
function getLevelProgress(){
  let xp=playerXP,lv=0;
  for(let i=0;i<XP_PER_LEVEL.length;i++){if(xp<XP_PER_LEVEL[i]){lv=i;break;}xp-=XP_PER_LEVEL[i];lv=i+1;}
  const need=XP_PER_LEVEL[Math.min(lv,XP_PER_LEVEL.length-1)]||9999;
  return{level:lv,progress:xp,need};
}
function addXP(amt){
  const before=getLevelProgress().level;
  playerXP+=amt;
  const after=getLevelProgress().level;
  playerLevel=after;
  if(after>before){const rw=after*25;cucumbers+=rw;showToast(`üéâ –£—Ä–æ–≤–µ–Ω—å ${after+1}! +${rw}ü•í`);}
  save();updateHUD();
}
function getUpgradeEffect(id){
  const u=UPGRADES.find(u=>u.id===id);if(!u)return 0;
  return upgradelevels[id]||0;
}
function getUpgradeCost(id){
  const u=UPGRADES.find(u=>u.id===id);if(!u)return 999999;
  const lv=upgradelevels[id]||0;
  return Math.floor(u.baseCost*Math.pow(u.costMult,lv));
}
function lighten(hex,a){const n=parseInt(hex.replace('#',''),16);return`rgb(${Math.min(255,(n>>16)+Math.floor(255*a))},${Math.min(255,((n>>8)&255)+Math.floor(255*a))},${Math.min(255,(n&255)+Math.floor(255*a))})`;}
function darken(hex,a){const n=parseInt(hex.replace('#',''),16);return`rgb(${Math.max(0,(n>>16)-Math.floor(255*a))},${Math.max(0,((n>>8)&255)-Math.floor(255*a))},${Math.max(0,(n&255)-Math.floor(255*a))})`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SKINS / WORLDS / TRAILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SKINS=[
  {id:'default',name:'–û–ì–£–†–ï–¶',    price:0,    priceGold:0,  color:'#4ade80',accent:'#16a34a',eyes:'#1a1a1a',special:null,       desc:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –æ–≥—É—Ä–µ—Ü'},
  {id:'fire',   name:'–û–ì–û–ù–¨',     price:120,  priceGold:0,  color:'#ff5500',accent:'#991b1b',eyes:'#fff8e0',special:'fire',      desc:'–ü—ã–ª–∞–µ—Ç –æ–≥–Ω—ë–º!'},
  {id:'cool',   name:'–ö–†–£–¢–û–ô',    price:200,  priceGold:0,  color:'#38bdf8',accent:'#0369a1',eyes:'#fff',   special:'glasses',   desc:'–í—Å–µ–≥–¥–∞ –≤ –æ—á–∫–∞—Ö'},
  {id:'alien',  name:'–ü–†–ò–®–ï–õ–ï–¶',  price:350,  priceGold:0,  color:'#818cf8',accent:'#4338ca',eyes:'#00ff88',special:'alien',     desc:'–° –¥—Ä—É–≥–æ–π –ø–ª–∞–Ω–µ—Ç—ã'},
  {id:'king',   name:'–¶–ê–†–¨',      price:500,  priceGold:0,  color:'#fbbf24',accent:'#b45309',eyes:'#1a1a1a',special:'crown',     desc:'–ù–æ—Å–∏—Ç –∫–æ—Ä–æ–Ω—É'},
  {id:'ghost',  name:'–ü–†–ò–ó–†–ê–ö',   price:700,  priceGold:0,  color:'#f0fdfa',accent:'#99f6e4',eyes:'#0f766e',special:'ghost',     desc:'–ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π'},
  {id:'ninja',  name:'–ù–ò–ù–î–ó–Ø',    price:1000, priceGold:0,  color:'#1e293b',accent:'#0f172a',eyes:'#ef4444',special:'ninja',     desc:'–ú–∞—Å—Ç–µ—Ä —Ç–µ–Ω–µ–π'},
  {id:'secret', name:'DIVINE',    price:0,    priceGold:0,  color:'#FFD700',accent:'#fbbf24',eyes:'#fff',   special:'divine',    secret:true, desc:'–ù–∞–±–µ–π 50 –±–∞—à–µ–Ω'},
  {id:'cyber',  name:'–ö–ò–ë–ï–†',     price:0,    priceGold:50, color:'#00ffff',accent:'#0088ff',eyes:'#ff00ff',special:'cyber',     goldOnly:true,desc:'–ò–∑ –±—É–¥—É—â–µ–≥–æ'},
  {id:'zombie', name:'–ó–û–ú–ë–ò',     price:0,    priceGold:30, color:'#86efac',accent:'#166534',eyes:'#dc2626',special:'zombie',    goldOnly:true,desc:'–í–æ—Å—Å—Ç–∞–ª –∏–∑ –º—ë—Ä—Ç–≤—ã—Ö'},
  {id:'robot',  name:'–†–û–ë–û–¢',     price:0,    priceGold:40, color:'#94a3b8',accent:'#334155',eyes:'#38bdf8',special:'robot',     goldOnly:true,desc:'–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π'},
  {id:'dragon', name:'–î–†–ê–ö–û–ù',    price:0,    priceGold:80, color:'#15803d',accent:'#052e16',eyes:'#fbbf24',special:'dragon',    goldOnly:true,desc:'–û–≥–Ω–µ–¥—ã—à–∞—â–∏–π'},
];
const WORLDS=[
  {id:'forest', name:'–õ–ï–°',        price:0,    priceGold:0,  bg:['#061810','#0a2918','#061810'],ground:'#14532d',groundTop:'#4ade80',pipe:['#14532d','#4ade80','#22c55e','#052e16'],pipeCap:'#4ade80',star:'rgba(200,255,220,{a})'},
  {id:'candy',  name:'–ö–û–ù–§–ï–¢–´',    price:300,  priceGold:0,  bg:['#1a0628','#2d0a3a','#1a0628'],ground:'#7c3aed',groundTop:'#a78bfa',pipe:['#5b21b6','#c4b5fd','#a78bfa','#4c1d95'],pipeCap:'#c4b5fd',star:'rgba(220,200,255,{a})'},
  {id:'lava',   name:'–õ–ê–í–ê',       price:500,  priceGold:0,  bg:['#1c0a00','#2d1200','#1c0a00'],ground:'#7f1d1d',groundTop:'#ef4444',pipe:['#7f1d1d','#f97316','#ef4444','#450a0a'],pipeCap:'#f97316',star:'rgba(255,200,100,{a})'},
  {id:'ocean',  name:'–û–ö–ï–ê–ù',      price:700,  priceGold:0,  bg:['#022c50','#064e7a','#022c50'],ground:'#0c4a6e',groundTop:'#38bdf8',pipe:['#075985','#38bdf8','#0ea5e9','#023455'],pipeCap:'#38bdf8',star:'rgba(180,230,255,{a})'},
  {id:'space',  name:'–ö–û–°–ú–û–°',     price:1000, priceGold:0,  bg:['#000010','#05051a','#000010'],ground:'#0f172a',groundTop:'#a78bfa',pipe:['#1e1b4b','#818cf8','#6366f1','#0f0e2e'],pipeCap:'#818cf8',star:'rgba(200,200,255,{a})'},
  {id:'cyber_w',name:'–ö–ò–ë–ï–†–ü–ê–ù–ö',  price:0,    priceGold:30, bg:['#0a0014','#140028','#0a0014'],ground:'#1a0040',groundTop:'#ff00ff',pipe:['#300060','#ff00ff','#00ffff','#1a0040'],pipeCap:'#ff00ff',star:'rgba(255,0,255,{a})',goldOnly:true},
  {id:'galaxy', name:'–ì–ê–õ–ê–ö–¢–ò–ö–ê',  price:0,    priceGold:55, bg:['#000008','#06001a','#000008'],ground:'#100030',groundTop:'#a5b4fc',pipe:['#1e1b6b','#a5b4fc','#818cf8','#080028'],pipeCap:'#c7d2fe',star:'rgba(180,180,255,{a})',goldOnly:true},
  {id:'crystal',name:'–ö–†–ò–°–¢–ê–õ–¨–ù–´–ô',price:0,    priceGold:80, bg:['#001820','#002a3a','#001820'],ground:'#093050',groundTop:'#67e8f9',pipe:['#0e4070','#67e8f9','#22d3ee','#062030'],pipeCap:'#a5f3fc',star:'rgba(180,240,255,{a})',goldOnly:true},
];
const TRAILS=[
  {id:'none',      name:'–ù–ï–¢',        price:0,   priceGold:0,  color:null,   desc:'–ß–∏—Å—Ç—ã–π –ø–æ–ª—ë—Ç'},
  {id:'rainbow',   name:'–†–ê–î–£–ì–ê',     price:80,  priceGold:0,  color:['#ef4444','#f97316','#fbbf24','#4ade80','#38bdf8','#a78bfa'],desc:'–†–∞–¥—É–∂–Ω—ã–π —Å–ª–µ–¥'},
  {id:'fire',      name:'–ü–õ–ê–ú–Ø',      price:150, priceGold:0,  color:['#ef4444','#f97316','#fbbf24','#fef3c7'],desc:'–û–≥–Ω–µ–Ω–Ω—ã–π —Å–ª–µ–¥'},
  {id:'bubbles',   name:'–ü–£–ó–´–†–ò',     price:120, priceGold:0,  color:['#bfdbfe','#93c5fd','#60a5fa','#dbeafe'],desc:'–ü—É–∑—ã—Ä—å–∫–æ–≤—ã–π —Å–ª–µ–¥'},
  {id:'stars',     name:'–ó–í–Å–ó–î–´',     price:200, priceGold:0,  color:['#fef3c7','#fde68a','#fbbf24','#fff'],desc:'–ó–≤—ë–∑–¥–Ω—ã–π —Å–ª–µ–¥'},
  {id:'ghost',     name:'–ü–†–ò–ó–†–ê–ö',    price:180, priceGold:0,  color:['#e2e8f0','#cbd5e1','#94a3b8','#f8fafc'],desc:'–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π —Å–ª–µ–¥'},
  {id:'candy',     name:'–ö–û–ù–§–ï–¢–¢–ò',   price:220, priceGold:0,  color:['#f472b6','#a78bfa','#38bdf8','#4ade80','#fbbf24'],desc:'–¶–≤–µ—Ç–Ω–æ–π —Å–ª–µ–¥'},
  {id:'lightning', name:'–ú–û–õ–ù–ò–Ø',     price:0,   priceGold:20, color:['#fbbf24','#fff','#fde68a','#fef3c7'],goldOnly:true,desc:'–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π —Å–ª–µ–¥'},
  {id:'plasma',    name:'–ü–õ–ê–ó–ú–ê',     price:0,   priceGold:35, color:['#c084fc','#818cf8','#38bdf8','#a78bfa','#fff'],goldOnly:true,desc:'–ü–ª–∞–∑–º–µ–Ω–Ω—ã–π –≤–∏—Ö—Ä—å'},
  {id:'diamond',   name:'–ê–õ–ú–ê–ó',      price:0,   priceGold:50, color:['#e0f2fe','#bae6fd','#fff','#38bdf8','#f0fdff'],goldOnly:true,desc:'–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π —Å–ª–µ–¥'},
];

// ‚îÄ‚îÄ‚îÄ PETS ‚îÄ‚îÄ‚îÄ
const PETS=[
  {id:'none',   name:'–ù–ï–¢',         priceGold:0,   emoji:'',    desc:'–ë–µ–∑ –ø–∏—Ç–æ–º—Ü–∞',color:'#475569'},
  {id:'bug',    name:'–ñ–£–ß–û–ö',       priceGold:10,  emoji:'üêõ',  desc:'–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –º–æ–Ω–µ—Ç—ã', color:'#22c55e'},
  {id:'frog',   name:'–õ–Ø–ì–£–®–ö–ê',     priceGold:20,  emoji:'üê∏',  desc:'+10% –∫ –æ—á–∫–∞–º',       color:'#4ade80'},
  {id:'dragon2',name:'–î–†–ê–ö–û–ù–ß–ò–ö',   priceGold:40,  emoji:'üêâ',  desc:'–ò–Ω–æ–≥–¥–∞ —Å—Ç—Ä–µ–ª—è–µ—Ç',    color:'#ef4444'},
  {id:'star_p', name:'–ó–í–Å–ó–î–û–ß–ö–ê',   priceGold:30,  emoji:'‚≠ê',  desc:'–û—Å—Ç–∞–≤–ª—è–µ—Ç –∑–≤—ë–∑–¥–Ω—ã–π —Å–ª–µ–¥',color:'#fbbf24'},
  {id:'alien_p',name:'–ò–ù–û–ü–õ–ê–ù–ï–¢–ï–¶', priceGold:45,  emoji:'üëΩ',  desc:'–¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–æ–Ω–µ—Ç—ã',color:'#818cf8'},
  {id:'ghost_p',name:'–ü–†–ò–ó–†–ê–ö',     priceGold:35,  emoji:'üëª',  desc:'–ü—É–≥–∞–µ—Ç —Ç—Ä—É–±—ã',        color:'#e2e8f0'},
  {id:'angel',  name:'–ê–ù–ì–ï–õ–û–ß–ï–ö',   priceGold:80,  emoji:'üòá',  desc:'–ê–≤—Ç–æ—â–∏—Ç —Ä–∞–∑ –≤ 10 –±–∞—à–µ–Ω',color:'#fde68a'},
  {id:'phoenix',name:'–§–ï–ù–ò–ö–°',      priceGold:120, emoji:'ü¶Ö',  desc:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü!',color:'#f97316'},
];
let selectedPet=def('pet','none');
let ownedPets=def('ownedPets',['none']);
function getSkin(){return SKINS.find(s=>s.id===selectedSkin)||SKINS[0];}
function getWorld(){return WORLDS.find(w=>w.id===selectedWorld)||WORLDS[0];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW CUCUMBER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawCucumber(c,x,y,size,skinId,angle=0,frame=0){
  const skin=SKINS.find(s=>s.id===skinId)||SKINS[0];
  c.save();c.translate(x,y);c.rotate(angle);
  const rX=size*.18,rY=size*.46,tipR=rX*.6;
  function cucPath(){c.beginPath();c.moveTo(0,-rY);c.bezierCurveTo(rX*1.1,-rY*.85,rX*1.2,-rY*.3,rX*1.15,0);c.bezierCurveTo(rX*1.2,rY*.3,rX*1.1,rY*.8,0,rY);c.bezierCurveTo(-rX*1.1,rY*.8,-rX*1.2,rY*.3,-rX*1.15,0);c.bezierCurveTo(-rX*1.2,-rY*.3,-rX*1.1,-rY*.85,0,-rY);c.closePath();}
  const bg=c.createLinearGradient(-rX*1.2,-rY,rX*1.2,rY);
  if(skin.special==='divine'){bg.addColorStop(0,'#fffde0');bg.addColorStop(.25,'#FFD700');bg.addColorStop(.6,'#fbbf24');bg.addColorStop(1,'#92400e');}
  else if(skin.special==='ghost'){bg.addColorStop(0,'#ffffff');bg.addColorStop(.5,'#e2e8f0');bg.addColorStop(1,'#94a3b8');}
  else if(skin.special==='fire'){bg.addColorStop(0,'#fef9c3');bg.addColorStop(.3,'#fbbf24');bg.addColorStop(.65,'#ef4444');bg.addColorStop(1,'#7f1d1d');}
  else if(skin.special==='cyber'){bg.addColorStop(0,'#00ffff');bg.addColorStop(.4,'#0088ff');bg.addColorStop(.8,'#0000aa');bg.addColorStop(1,'#1a0050');}
  else if(skin.special==='alien'){bg.addColorStop(0,'#c4b5fd');bg.addColorStop(.4,'#8b5cf6');bg.addColorStop(1,'#4c1d95');}
  else if(skin.special==='ninja'){bg.addColorStop(0,'#334155');bg.addColorStop(.5,'#1e293b');bg.addColorStop(1,'#0f172a');}
  else if(skin.special==='crown'){bg.addColorStop(0,'#fde68a');bg.addColorStop(.4,'#fbbf24');bg.addColorStop(1,'#d97706');}
  else if(skin.special==='glasses'){bg.addColorStop(0,'#bfdbfe');bg.addColorStop(.4,'#60a5fa');bg.addColorStop(1,'#2563eb');}
  else{bg.addColorStop(0,lighten(skin.color,.35));bg.addColorStop(.45,skin.color);bg.addColorStop(1,skin.accent);}
  c.shadowColor=skin.special==='cyber'?'#00ffff':skin.special==='fire'?'#f97316':skin.special==='divine'?'#FFD700':'rgba(0,0,0,.4)';
  c.shadowBlur=(skin.special==='cyber'||skin.special==='divine'||skin.special==='fire')?12:5;
  c.shadowOffsetY=(skin.special==='cyber'||skin.special==='divine')?0:2;
  cucPath();c.fillStyle=bg;c.fill();c.shadowBlur=0;c.shadowOffsetY=0;
  cucPath();c.strokeStyle='rgba(0,0,0,.25)';c.lineWidth=1.5;c.stroke();
  // Textures
  if(skin.special===null||skin.special==='glasses'){
    c.save();cucPath();c.clip();
    c.strokeStyle=skin.accent+'88';c.lineWidth=1.1;
    for(let i=-2;i<=2;i++){c.beginPath();c.moveTo(i*rX*.42,-rY*.85);c.lineTo(i*rX*.42,rY*.85);c.stroke();}
    c.fillStyle='rgba(0,0,0,.07)';
    for(let row=-3;row<=3;row++){for(let col=-1;col<=1;col++){c.beginPath();c.arc(col*rX*.6,row*rY*.28,rX*.12,0,Math.PI*2);c.fill();}}
    c.restore();
  }
  if(skin.special==='cyber'){
    c.save();cucPath();c.clip();c.strokeStyle='rgba(0,255,255,.45)';c.lineWidth=1;
    for(let i=-3;i<=3;i++){c.beginPath();c.moveTo(i*rX*.35,-rY);c.lineTo(i*rX*.35,rY);c.stroke();}
    c.beginPath();c.moveTo(-rX,0);c.lineTo(rX,0);c.stroke();
    c.restore();
    c.shadowColor='#00ffff';c.shadowBlur=14;c.strokeStyle='rgba(0,255,255,.6)';c.lineWidth=1.5;cucPath();c.stroke();c.shadowBlur=0;
  }
  if(skin.special==='fire'){c.save();cucPath();c.clip();c.strokeStyle='rgba(255,150,0,.5)';c.lineWidth=1;for(let i=-1;i<=1;i++){c.beginPath();c.moveTo(i*rX*.6,-rY*.7);c.lineTo(i*rX*.4,-rY*.2);c.lineTo(i*rX*.7,rY*.2);c.stroke();}c.restore();}
  if(skin.special==='alien'){c.save();cucPath();c.clip();c.fillStyle='rgba(0,255,136,.12)';for(let i=0;i<5;i++){c.beginPath();c.arc(Math.sin(i*1.7)*rX*.7,Math.cos(i*1.3)*rY*.5,rX*.22,0,Math.PI*2);c.fill();}c.restore();}
  if(skin.special==='ninja'){c.save();cucPath();c.clip();c.strokeStyle='rgba(239,68,68,.2)';c.lineWidth=1.8;for(let i=-4;i<=4;i++){c.beginPath();c.moveTo(i*rX*.5-rX,-rY);c.lineTo(i*rX*.5+rX,rY);c.stroke();}c.restore();}
  if(skin.special==='divine'){c.save();cucPath();c.clip();c.fillStyle='rgba(255,255,255,.18)';for(let i=0;i<6;i++){c.beginPath();c.arc(Math.sin(i*2.1)*rX*.7,Math.cos(i*1.8)*rY*.5,rX*.1,0,Math.PI*2);c.fill();}c.restore();}
  if(skin.special==='crown'){c.save();cucPath();c.clip();c.fillStyle='rgba(255,255,255,.13)';for(let i=-2;i<=2;i++){c.beginPath();c.arc(i*rX*.5,0,rX*.15,0,Math.PI*2);c.fill();}c.restore();}
  // Bumps
  if(skin.special!=='ghost'&&skin.special!=='divine'){c.fillStyle='rgba(0,0,0,.1)';[[-rX*.9,-rY*.42],[rX*.9,-rY*.18],[rX*.85,rY*.18],[-rX*.88,rY*.38]].forEach(([bx,by])=>{c.beginPath();c.arc(bx,by,rX*.2,0,Math.PI*2);c.fill();});}
  // Tips
  c.fillStyle=skin.special==='divine'?'#d97706':darken(skin.accent,.25);
  c.beginPath();c.ellipse(0,-rY,tipR,tipR*.65,0,0,Math.PI*2);c.fill();
  c.beginPath();c.ellipse(0,rY,tipR*.75,tipR*.55,0,0,Math.PI*2);c.fill();
  // Eyes
  const eyeY=-rY*.35,eyeX=rX*.65;
  if(skin.special!=='alien'&&skin.special!=='ninja'){
    c.fillStyle='#fff';c.shadowColor='rgba(0,0,0,.3)';c.shadowBlur=2;
    c.beginPath();c.arc(-eyeX,eyeY,size*.057,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(eyeX,eyeY,size*.057,0,Math.PI*2);c.fill();c.shadowBlur=0;
  }
  c.fillStyle=skin.special==='cyber'?'#ff00ff':skin.eyes;
  c.beginPath();c.arc(-eyeX+.8,eyeY+.8,size*.032,0,Math.PI*2);c.fill();
  c.beginPath();c.arc(eyeX+.8,eyeY+.8,size*.032,0,Math.PI*2);c.fill();
  if(skin.special!=='alien'&&skin.special!=='ninja'){c.fillStyle='rgba(255,255,255,.85)';c.beginPath();c.arc(-eyeX-.5,eyeY-.5,size*.012,0,Math.PI*2);c.fill();c.beginPath();c.arc(eyeX-.5,eyeY-.5,size*.012,0,Math.PI*2);c.fill();}
  if(skin.special==='alien'){c.fillStyle='rgba(0,0,0,.7)';c.shadowColor='#00ff88';c.shadowBlur=8;c.beginPath();c.ellipse(-eyeX,eyeY,size*.1,size*.065,.2,0,Math.PI*2);c.fill();c.beginPath();c.ellipse(eyeX,eyeY,size*.1,size*.065,-.2,0,Math.PI*2);c.fill();c.fillStyle='#00ff88';c.beginPath();c.arc(-eyeX+1,eyeY+1,size*.036,0,Math.PI*2);c.fill();c.beginPath();c.arc(eyeX+1,eyeY+1,size*.036,0,Math.PI*2);c.fill();c.shadowBlur=0;}
  // Smile
  c.strokeStyle='rgba(0,0,0,.45)';c.lineWidth=1.4;c.lineCap='round';c.beginPath();c.arc(0,eyeY+size*.09,size*.07,.2,Math.PI-.2);c.stroke();
  // Glasses
  if(skin.special==='glasses'){
    c.fillStyle='rgba(0,0,0,.8)';c.shadowColor='#1e40af';c.shadowBlur=4;
    c.beginPath();c.roundRect(-eyeX-size*.1,eyeY-size*.058,size*.2,size*.12,4);c.fill();
    c.beginPath();c.roundRect(eyeX-size*.1,eyeY-size*.058,size*.2,size*.12,4);c.fill();
    c.strokeStyle='#60a5fa';c.lineWidth=1.5;c.beginPath();c.moveTo(-eyeX+size*.1,eyeY);c.lineTo(eyeX-size*.1,eyeY);c.stroke();
    c.fillStyle='rgba(255,255,255,.35)';c.beginPath();c.roundRect(-eyeX-size*.05,eyeY-size*.05,size*.08,size*.055,2);c.fill();c.beginPath();c.roundRect(eyeX-size*.05,eyeY-size*.05,size*.08,size*.055,2);c.fill();c.shadowBlur=0;
  }
  // Crown
  if(skin.special==='crown'||skin.special==='divine'){
    const cy=-rY-size*.02,cw=rX*1.45,crownCol=skin.special==='divine'?'#fff':'#FFD700';
    c.fillStyle=crownCol;c.shadowColor=crownCol;c.shadowBlur=10;
    c.beginPath();c.moveTo(-cw,cy);c.lineTo(-cw,cy-size*.15);c.lineTo(-cw*.5,cy-size*.07);c.lineTo(0,cy-size*.19);c.lineTo(cw*.5,cy-size*.07);c.lineTo(cw,cy-size*.15);c.lineTo(cw,cy);c.closePath();c.fill();c.shadowBlur=0;
    const gems=skin.special==='divine'?['#ff6b9d','#00ffff','#ff6b00']:['#ef4444','#22c55e','#38bdf8'];
    gems.forEach((g,i)=>{c.fillStyle=g;c.beginPath();c.arc(-cw*.5+i*cw*.5,cy-size*.06,rX*.22,0,Math.PI*2);c.fill();});
  }
  // Ninja mask + headband
  if(skin.special==='ninja'){
    c.save();cucPath();c.clip();c.fillStyle='#1e293b';c.fillRect(-rX*1.3,eyeY-size*.06,rX*2.6,size*.1);c.restore();
    c.fillStyle='#ef4444';c.shadowColor='#ef4444';c.shadowBlur=5;
    c.beginPath();c.rect(-eyeX-size*.055,eyeY-size*.025,size*.11,size*.04);c.fill();
    c.beginPath();c.rect(eyeX-size*.055,eyeY-size*.025,size*.11,size*.04);c.fill();
    c.fillStyle='#ef4444';c.shadowBlur=0;c.beginPath();c.rect(-rX*1.2,-rY*.85,rX*2.4,size*.065);c.fill();
    c.fillStyle='#fff';c.font=`bold ${Math.floor(rX*.7)}px Nunito`;c.textAlign='center';c.textBaseline='middle';c.fillText('‚òØ',0,-rY*.82+size*.03);
  }
  // Ghost wavy bottom
  if(skin.special==='ghost'){c.fillStyle='rgba(248,250,252,.7)';c.beginPath();c.moveTo(-rX*1.1,rY-4);for(let i=0;i<=4;i++){const cx2=-rX*1.1+(rX*2.2/4)*i,wav=Math.sin(frame*.08+i)*3;if(i%2===0)c.quadraticCurveTo(cx2+rX*.3,rY+9+wav,cx2+rX*.55,rY-2);else c.quadraticCurveTo(cx2+rX*.3,rY+3,cx2+rX*.55,rY-2);}c.closePath();c.fill();}
  // Divine halo
  if(skin.special==='divine'){const haloY=-rY-size*.28;c.strokeStyle='rgba(255,255,200,.95)';c.lineWidth=2.5;c.shadowColor='#fff';c.shadowBlur=14;c.beginPath();c.ellipse(0,haloY,rX*1.15,size*.058,0,0,Math.PI*2);c.stroke();c.shadowBlur=0;}
  // Fire flames
  if(skin.special==='fire'){const ft=frame*.12;for(let i=-1;i<=1;i++){const fx=i*rX*.5,fh=size*(.22+Math.sin(ft+i)*.08);const fg=c.createLinearGradient(fx,rY,fx,rY+fh*2.5);fg.addColorStop(0,'#ef4444');fg.addColorStop(.4,'#fbbf24');fg.addColorStop(1,'transparent');c.fillStyle=fg;c.beginPath();c.moveTo(fx-rX*.15,rY);c.quadraticCurveTo(fx+Math.sin(ft+i)*rX*.2,rY+fh,fx+rX*.08,rY+fh*2.5);c.quadraticCurveTo(fx-Math.sin(ft+i)*rX*.2,rY+fh,fx+rX*.15,rY);c.fill();}}
  if(skin.special==='zombie'){
    // Stitches across body
    c.save();cucPath();c.clip();
    c.strokeStyle='#166534';c.lineWidth=1.4;
    for(let i=-1;i<=1;i++){c.beginPath();c.moveTo(i*rX*.6,-rY*.3+i*rY*.2);c.lineTo(i*rX*.6+rX*.3,rY*.1+i*rY*.1);c.stroke();}
    // X marks (stitches)
    c.lineWidth=1;c.strokeStyle='#15803d';
    [[0,-rY*.4],[rX*.4,rY*.2],[-rX*.5,rY*.1]].forEach(([sx,sy])=>{
      c.beginPath();c.moveTo(sx-3,sy-3);c.lineTo(sx+3,sy+3);c.moveTo(sx+3,sy-3);c.lineTo(sx-3,sy+3);c.stroke();});
    c.restore();
    // Red zombie eyes
    c.fillStyle='#dc2626';c.shadowColor='#dc2626';c.shadowBlur=8;
    c.beginPath();c.arc(-eyeX,eyeY,size*.045,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(eyeX,eyeY,size*.045,0,Math.PI*2);c.fill();
    c.shadowBlur=0;
  }
  if(skin.special==='robot'){
    // Metal panel lines
    c.save();cucPath();c.clip();
    c.strokeStyle='rgba(148,163,184,.6)';c.lineWidth=1.2;
    c.beginPath();c.moveTo(-rX,0);c.lineTo(rX,0);c.stroke();
    c.beginPath();c.moveTo(-rX*1.1,-rY*.3);c.lineTo(rX*1.1,-rY*.3);c.stroke();
    c.beginPath();c.moveTo(-rX*1.1,rY*.3);c.lineTo(rX*1.1,rY*.3);c.stroke();
    c.restore();
    // Visor / eyes - rectangular
    c.fillStyle='#0ea5e9';c.shadowColor='#38bdf8';c.shadowBlur=10;
    c.beginPath();c.roundRect(-eyeX-size*.06,eyeY-size*.032,size*.12,size*.064,2);c.fill();
    c.beginPath();c.roundRect(eyeX-size*.06,eyeY-size*.032,size*.12,size*.064,2);c.fill();
    c.shadowBlur=0;
    // Antenna
    c.strokeStyle='#94a3b8';c.lineWidth=1.5;
    c.beginPath();c.moveTo(0,-rY);c.lineTo(0,-rY-size*.18);c.stroke();
    c.fillStyle='#38bdf8';c.shadowColor='#38bdf8';c.shadowBlur=6;
    c.beginPath();c.arc(0,-rY-size*.18,size*.03,0,Math.PI*2);c.fill();c.shadowBlur=0;
  }
  if(skin.special==='dragon'){
    // Dragon scales pattern
    c.save();cucPath();c.clip();
    c.fillStyle='rgba(5,46,22,.4)';
    for(let row=-3;row<=3;row++){for(let col=-1;col<=1;col++){
      const sx=col*rX*.55+(row%2)*rX*.28,sy=row*rY*.3;
      c.beginPath();c.ellipse(sx,sy,rX*.28,rY*.14,0,0,Math.PI*2);c.fill();
    }}
    c.restore();
    // Glowing gold eyes
    c.fillStyle='#fbbf24';c.shadowColor='#fbbf24';c.shadowBlur=12;
    c.beginPath();c.ellipse(-eyeX,eyeY,size*.065,size*.04,0,0,Math.PI*2);c.fill();
    c.beginPath();c.ellipse(eyeX,eyeY,size*.065,size*.04,0,0,Math.PI*2);c.fill();
    c.fillStyle='#000';c.shadowBlur=0;
    c.beginPath();c.arc(-eyeX,eyeY+1,size*.025,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(eyeX,eyeY+1,size*.025,0,Math.PI*2);c.fill();
    // Horns
    c.fillStyle='#fbbf24';c.shadowColor='#fbbf24';c.shadowBlur=6;
    c.beginPath();c.moveTo(-rX*.5,-rY*.7);c.lineTo(-rX*.35,-rY-size*.2);c.lineTo(-rX*.2,-rY*.7);c.closePath();c.fill();
    c.beginPath();c.moveTo(rX*.2,-rY*.7);c.lineTo(rX*.35,-rY-size*.2);c.lineTo(rX*.5,-rY*.7);c.closePath();c.fill();
    c.shadowBlur=0;
    // Dragon fire breath (animated)
    if(frame%40<20){const ft=frame*.15;
      const fg=c.createLinearGradient(0,rY,0,rY+size*.5);fg.addColorStop(0,'rgba(239,68,68,.9)');fg.addColorStop(.5,'rgba(251,146,60,.6)');fg.addColorStop(1,'transparent');
      c.fillStyle=fg;c.beginPath();c.ellipse(Math.sin(ft)*rX*.3,rY+size*.25,rX*.5+Math.sin(ft)*.05,size*.25,Math.sin(ft)*.2,0,Math.PI*2);c.fill();}
  }
  c.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HERO + AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let heroFrame=0;
function animateHero(){
  const hc=document.getElementById('hero-canvas');if(!hc)return;
  hc.width=56;hc.height=88;
  const hctx=hc.getContext('2d');hctx.clearRect(0,0,56,88);
  drawCucumber(hctx,28,44,82,selectedSkin,0,heroFrame++);
  requestAnimationFrame(animateHero);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PET DRAWING + ANIMATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let petFrame=0;
const PET_SOUNDS={
  bug:  [()=>{tone(800,'square',.04,.08);tone(1200,'square',.03,.06,.04);}],
  frog: [()=>{tone(300,'sine',.08,.1);tone(200,'sine',.1,.08,.08);}],
  dragon2:[()=>{tone(150,'sawtooth',.12,.15);tone(220,'sawtooth',.1,.1,.1);}],
  star_p:[()=>{tone(1200,'sine',.04,.08);tone(1600,'sine',.04,.06,.04);tone(2000,'sine',.04,.04,.08);}],
  alien_p:[()=>{tone(600,'square',.06,.1);tone(900,'square',.05,.08,.06);tone(400,'square',.06,.06,.12);}],
  ghost_p:[()=>{tone(200,'sine',.2,.06);tone(300,'sine',.15,.04,.2);}],
  angel: [()=>{tone(880,'sine',.08,.1);tone(1100,'sine',.08,.08,.08);tone(1320,'sine',.06,.06,.16);}],
  phoenix:[()=>{tone(300,'sawtooth',.04,.12);tone(600,'sine',.08,.1,.04);tone(900,'sine',.06,.08,.12);}],
};
let lastPetSound=0;
function maybePlayPetSound(){
  if(!audioCtx)return;
  const now=Date.now();
  if(now-lastPetSound<8000+Math.random()*12000)return; // rare: 8-20s
  const sounds=PET_SOUNDS[selectedPet];
  if(!sounds)return;
  lastPetSound=now;
  const sfn=sounds[Math.floor(Math.random()*sounds.length)];
  sfn();
}

function drawPetOnCanvas(c,id,frame,w,h){
  c.clearRect(0,0,w,h);
  const t=frame*.05;
  const cx=w/2,cy=h/2;
  const bounce=Math.sin(t*2)*3;
  c.save();c.translate(cx,cy+bounce);
  switch(id){
    case 'bug':{
      // Animated bug/worm
      const bodyGrad=c.createRadialGradient(0,0,2,0,0,14);
      bodyGrad.addColorStop(0,'#86efac');bodyGrad.addColorStop(1,'#16a34a');
      c.fillStyle=bodyGrad;c.shadowColor='#4ade80';c.shadowBlur=10;
      // body segments
      for(let i=0;i<3;i++){const bx=-10+i*10,by=Math.sin(t+i)*.5;c.beginPath();c.arc(bx,by,7-i*.5,0,Math.PI*2);c.fill();}
      c.shadowBlur=0;
      // eyes
      c.fillStyle='#fff';c.beginPath();c.arc(10,-2,4,0,Math.PI*2);c.fill();c.beginPath();c.arc(15,-2,4,0,Math.PI*2);c.fill();
      c.fillStyle='#000';c.beginPath();c.arc(11,-1.5,2,0,Math.PI*2);c.fill();c.beginPath();c.arc(16,-1.5,2,0,Math.PI*2);c.fill();
      // antennae
      c.strokeStyle='#4ade80';c.lineWidth=1.5;
      c.beginPath();c.moveTo(8,-5);c.quadraticCurveTo(5,-14,3+Math.sin(t)*3,-17);c.stroke();
      c.beginPath();c.moveTo(14,-5);c.quadraticCurveTo(17,-14,19+Math.sin(t+1)*3,-17);c.stroke();
      break;
    }
    case 'frog':{
      // Frog
      const fg=c.createRadialGradient(0,0,2,0,2,16);
      fg.addColorStop(0,'#86efac');fg.addColorStop(1,'#16a34a');
      c.fillStyle=fg;c.shadowColor='#4ade80';c.shadowBlur=10;
      c.beginPath();c.ellipse(0,2,15,12,0,0,Math.PI*2);c.fill();c.shadowBlur=0;
      // belly
      c.fillStyle='#bbf7d0';c.beginPath();c.ellipse(0,4,9,8,0,0,Math.PI*2);c.fill();
      // eyes on top
      c.fillStyle='#16a34a';c.shadowColor='#4ade80';c.shadowBlur=6;
      c.beginPath();c.arc(-8,-8,6,0,Math.PI*2);c.fill();c.beginPath();c.arc(8,-8,6,0,Math.PI*2);c.fill();c.shadowBlur=0;
      c.fillStyle='#fff';c.beginPath();c.arc(-8,-8,4,0,Math.PI*2);c.fill();c.beginPath();c.arc(8,-8,4,0,Math.PI*2);c.fill();
      c.fillStyle='#000';c.beginPath();c.arc(-7.5,-8,2,0,Math.PI*2);c.fill();c.beginPath();c.arc(8.5,-8,2,0,Math.PI*2);c.fill();
      // mouth smile
      c.strokeStyle='#166534';c.lineWidth=1.5;c.beginPath();c.arc(0,5,7,.2,Math.PI-.2);c.stroke();
      // legs
      const kickL=Math.sin(t)*5;c.fillStyle='#16a34a';
      c.beginPath();c.ellipse(-18,8+kickL,8,4,.5,0,Math.PI*2);c.fill();
      c.beginPath();c.ellipse(18,8-kickL,8,4,-.5,0,Math.PI*2);c.fill();
      break;
    }
    case 'dragon2':{
      // Mini dragon
      c.fillStyle='#15803d';c.shadowColor='#4ade80';c.shadowBlur=12;
      c.beginPath();c.ellipse(0,4,14,11,0,0,Math.PI*2);c.fill();c.shadowBlur=0;
      // head
      c.fillStyle='#16a34a';c.beginPath();c.ellipse(12,-4,10,8,-.3,0,Math.PI*2);c.fill();
      // wings
      const wFlap=Math.sin(t*3)*8;c.fillStyle='rgba(21,128,61,.6)';
      c.beginPath();c.moveTo(-5,-2);c.quadraticCurveTo(-18,-10-wFlap,-14,5);c.closePath();c.fill();
      // horn
      c.fillStyle='#fbbf24';c.beginPath();c.moveTo(14,-10);c.lineTo(18,-18);c.lineTo(22,-10);c.closePath();c.fill();
      // eyes
      c.fillStyle='#fbbf24';c.shadowColor='#fbbf24';c.shadowBlur=6;
      c.beginPath();c.arc(16,-5,4,0,Math.PI*2);c.fill();c.shadowBlur=0;
      c.fillStyle='#000';c.beginPath();c.arc(17,-4.5,2,0,Math.PI*2);c.fill();
      // fire breath
      if(frame%40<20){const fG=c.createLinearGradient(22,-4,38,-4);fG.addColorStop(0,'#ef4444');fG.addColorStop(.5,'#fbbf24');fG.addColorStop(1,'transparent');c.fillStyle=fG;c.beginPath();c.ellipse(30,-4+Math.sin(t*2)*2,10,4,0,0,Math.PI*2);c.fill();}
      break;
    }
    case 'star_p':{
      // Star pet - spinning glowing star
      const spin=t*2;c.save();c.rotate(spin);
      c.fillStyle='#FFD700';c.shadowColor='#FFD700';c.shadowBlur=18;
      c.beginPath();
      for(let i=0;i<5;i++){const a=i*Math.PI*.4-Math.PI/2,a2=a+Math.PI*.2;c.lineTo(Math.cos(a)*18,Math.sin(a)*18);c.lineTo(Math.cos(a2)*8,Math.sin(a2)*8);}
      c.closePath();c.fill();c.shadowBlur=0;c.restore();
      // sparkles
      for(let i=0;i<4;i++){const a=spin+i*Math.PI/2,r=20+Math.sin(t*3+i)*3;c.fillStyle=`rgba(255,255,180,${.5+Math.sin(t+i)*.3})`;c.beginPath();c.arc(Math.cos(a)*r,Math.sin(a)*r,2,0,Math.PI*2);c.fill();}
      break;
    }
    case 'alien_p':{
      // Alien pet
      c.fillStyle='#818cf8';c.shadowColor='#818cf8';c.shadowBlur=12;
      c.beginPath();c.ellipse(0,3,13,11,0,0,Math.PI*2);c.fill();c.shadowBlur=0;
      // big head
      c.fillStyle='#6366f1';c.beginPath();c.ellipse(0,-8,12,10,0,0,Math.PI*2);c.fill();
      // big eyes
      c.fillStyle='#000';c.shadowColor='#00ff88';c.shadowBlur=8;
      c.beginPath();c.ellipse(-6,-8,6,5,.2,0,Math.PI*2);c.fill();c.beginPath();c.ellipse(6,-8,6,5,-.2,0,Math.PI*2);c.fill();c.shadowBlur=0;
      c.fillStyle='#00ff88';c.beginPath();c.arc(-5.5,-7.5,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(6.5,-7.5,3,0,Math.PI*2);c.fill();
      // antennae with light
      c.strokeStyle='#a5b4fc';c.lineWidth=1.5;
      c.beginPath();c.moveTo(-5,-17);c.lineTo(-3+Math.sin(t)*2,-24);c.stroke();
      c.beginPath();c.moveTo(5,-17);c.lineTo(7+Math.sin(t+1)*2,-24);c.stroke();
      c.fillStyle='#00ff88';c.shadowColor='#00ff88';c.shadowBlur=8;
      c.beginPath();c.arc(-3+Math.sin(t)*2,-25,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(7+Math.sin(t+1)*2,-25,3,0,Math.PI*2);c.fill();c.shadowBlur=0;
      break;
    }
    case 'ghost_p':{
      // Ghost pet
      const ga=.7+Math.sin(t)*.2;c.globalAlpha=ga;
      c.fillStyle='#e2e8f0';c.shadowColor='#c7d2fe';c.shadowBlur=15;
      c.beginPath();c.arc(0,-4,14,Math.PI,0);c.lineTo(14,8);
      for(let i=3;i>=0;i--){const gx=14-i*9.3;c.quadraticCurveTo(gx,15+Math.sin(t+i)*4,gx-4.7,8);}
      c.closePath();c.fill();c.shadowBlur=0;c.globalAlpha=1;
      // eyes
      c.fillStyle='rgba(0,0,50,.7)';c.beginPath();c.ellipse(-5,-5,5,6,0,0,Math.PI*2);c.fill();c.beginPath();c.ellipse(5,-5,5,6,0,0,Math.PI*2);c.fill();
      c.fillStyle='#818cf8';c.beginPath();c.arc(-4,-4,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(6,-4,3,0,Math.PI*2);c.fill();
      break;
    }
    case 'angel':{
      // Angel pet
      c.fillStyle='#fde68a';c.shadowColor='#fde68a';c.shadowBlur=18;
      c.beginPath();c.arc(0,0,14,0,Math.PI*2);c.fill();c.shadowBlur=0;
      // wings
      const wA=Math.sin(t*3)*10;c.fillStyle='rgba(255,255,255,.8)';
      c.save();c.translate(-16,0);c.rotate(-wA*Math.PI/180);c.beginPath();c.ellipse(0,0,16,8,.5,0,Math.PI*2);c.fill();c.restore();
      c.save();c.translate(16,0);c.rotate(wA*Math.PI/180);c.beginPath();c.ellipse(0,0,16,8,-.5,0,Math.PI*2);c.fill();c.restore();
      // face
      c.fillStyle='#fef3c7';c.beginPath();c.arc(0,0,11,0,Math.PI*2);c.fill();
      c.fillStyle='#b45309';c.beginPath();c.arc(-4,-2,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(4,-2,3,0,Math.PI*2);c.fill();
      c.strokeStyle='#b45309';c.lineWidth=1.5;c.beginPath();c.arc(0,3,4,.2,Math.PI-.2);c.stroke();
      // halo
      c.strokeStyle='#FFD700';c.lineWidth=2.5;c.shadowColor='#FFD700';c.shadowBlur=8;c.beginPath();c.ellipse(0,-16,10,4,0,0,Math.PI*2);c.stroke();c.shadowBlur=0;
      break;
    }
    case 'phoenix':{
      // Phoenix bird
      const phaseWing=Math.sin(t*4)*12;
      // tail flames
      for(let i=0;i<3;i++){const fG=c.createLinearGradient(0,5,0,20+i*5);fG.addColorStop(0,'rgba(251,191,36,.9)');fG.addColorStop(.5,'rgba(249,115,22,.7)');fG.addColorStop(1,'transparent');c.fillStyle=fG;c.beginPath();c.ellipse((i-1)*7,12+i*3,4,8+i,0,0,Math.PI*2);c.fill();}
      // body
      c.fillStyle='#f97316';c.shadowColor='#f97316';c.shadowBlur=14;
      c.beginPath();c.ellipse(0,0,10,8,0,0,Math.PI*2);c.fill();c.shadowBlur=0;
      // wings
      c.fillStyle='rgba(239,68,68,.8)';
      c.save();c.translate(-12,-2);c.rotate((phaseWing-15)*Math.PI/180);c.beginPath();c.ellipse(0,0,16,6,.4,0,Math.PI*2);c.fill();c.restore();
      c.save();c.translate(12,-2);c.rotate((-phaseWing+15)*Math.PI/180);c.beginPath();c.ellipse(0,0,16,6,-.4,0,Math.PI*2);c.fill();c.restore();
      // head
      c.fillStyle='#fbbf24';c.shadowColor='#FFD700';c.shadowBlur=8;
      c.beginPath();c.arc(12,-4,8,0,Math.PI*2);c.fill();c.shadowBlur=0;
      // beak + eye
      c.fillStyle='#b45309';c.beginPath();c.moveTo(18,-3);c.lineTo(24,-5);c.lineTo(18,-7);c.closePath();c.fill();
      c.fillStyle='#000';c.beginPath();c.arc(14,-5,2.5,0,Math.PI*2);c.fill();
      c.fillStyle='#fff';c.beginPath();c.arc(13,-5.5,1,0,Math.PI*2);c.fill();
      break;
    }
    default:{
      // Generic - no pet, draw nothing
    }
  }
  c.restore();
}

let startPetFrame=0;
function animateStartPet(){
  const pc=document.getElementById('start-pet-canvas');
  if(!pc){requestAnimationFrame(animateStartPet);return;}
  const pet=PETS.find(p=>p.id===selectedPet);
  if(!pet||pet.id==='none'){pc.style.display='none';requestAnimationFrame(animateStartPet);return;}
  pc.style.display='block';
  const c=pc.getContext('2d');
  drawPetOnCanvas(c,selectedPet,startPetFrame++,52,52);
  if(gameState==='menu')maybePlayPetSound();
  requestAnimationFrame(animateStartPet);
}

// In-game pet canvas overlay
let gamePetFrame2=0;
function drawGamePet(){
  if(gameState!=='playing')return;
  if(!selectedPet||selectedPet==='none')return;
  // Draw pet near the bird on main canvas
  ctx.save();
  const px=bird.x+38,py=bird.y-28;
  ctx.translate(px,py);
  // Use a temporary approach - draw on main canvas
  const pOff=Math.sin(gamePetFrame2*.08)*4;
  ctx.translate(0,pOff);
  // Draw pet inline (simplified in-game version)
  const t=gamePetFrame2*.05;
  ctx.scale(.55,.55);
  switch(selectedPet){
    case 'bug':ctx.fillStyle='#4ade80';ctx.shadowColor='#4ade80';ctx.shadowBlur=8;ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(7,-3,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(8,-2.5,2,0,Math.PI*2);ctx.fill();break;
    case 'frog':ctx.fillStyle='#22c55e';ctx.shadowColor='#4ade80';ctx.shadowBlur=8;ctx.beginPath();ctx.ellipse(0,2,12,9,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='#bbf7d0';ctx.beginPath();ctx.ellipse(0,4,7,6,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(-7,-6,5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(7,-6,5,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(-6.5,-5.5,2.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(7.5,-5.5,2.5,0,Math.PI*2);ctx.fill();break;
    case 'dragon2':ctx.fillStyle='#15803d';ctx.shadowColor='#4ade80';ctx.shadowBlur=10;ctx.beginPath();ctx.ellipse(0,2,12,9,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='#16a34a';ctx.beginPath();ctx.ellipse(10,-3,9,7,-.3,0,Math.PI*2);ctx.fill();const ww=Math.sin(t*3)*6;ctx.fillStyle='rgba(21,128,61,.6)';ctx.beginPath();ctx.moveTo(-4,-2);ctx.quadraticCurveTo(-15,-8-ww,-12,5);ctx.closePath();ctx.fill();ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.arc(14,-4,3,0,Math.PI*2);ctx.fill();break;
    case 'star_p':ctx.save();ctx.rotate(t*2);ctx.fillStyle='#FFD700';ctx.shadowColor='#FFD700';ctx.shadowBlur=14;ctx.beginPath();for(let i=0;i<5;i++){const a=i*Math.PI*.4-Math.PI/2,a2=a+Math.PI*.2;ctx.lineTo(Math.cos(a)*14,Math.sin(a)*14);ctx.lineTo(Math.cos(a2)*6,Math.sin(a2)*6);}ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.restore();break;
    case 'alien_p':ctx.fillStyle='#818cf8';ctx.shadowColor='#818cf8';ctx.shadowBlur=8;ctx.beginPath();ctx.ellipse(0,2,10,8,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='#000';ctx.beginPath();ctx.ellipse(-5,-5,5,4,.2,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(5,-5,5,4,-.2,0,Math.PI*2);ctx.fill();ctx.fillStyle='#00ff88';ctx.beginPath();ctx.arc(-4.5,-4.5,2.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(5.5,-4.5,2.5,0,Math.PI*2);ctx.fill();break;
    case 'ghost_p':ctx.globalAlpha=.75+Math.sin(t)*.15;ctx.fillStyle='#e2e8f0';ctx.shadowColor='#a5b4fc';ctx.shadowBlur=12;ctx.beginPath();ctx.arc(0,-3,11,Math.PI,0);ctx.lineTo(11,6);for(let i=3;i>=0;i--){const gx2=11-i*7.3;ctx.quadraticCurveTo(gx2,12+Math.sin(t+i)*3,gx2-3.7,6);}ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.globalAlpha=1;break;
    case 'angel':ctx.fillStyle='#fde68a';ctx.shadowColor='#fde68a';ctx.shadowBlur=12;ctx.beginPath();ctx.arc(0,0,11,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;const ww2=Math.sin(t*3)*8;ctx.fillStyle='rgba(255,255,255,.8)';ctx.save();ctx.translate(-13,0);ctx.rotate(-ww2*Math.PI/180);ctx.beginPath();ctx.ellipse(0,0,13,6,.5,0,Math.PI*2);ctx.fill();ctx.restore();ctx.save();ctx.translate(13,0);ctx.rotate(ww2*Math.PI/180);ctx.beginPath();ctx.ellipse(0,0,13,6,-.5,0,Math.PI*2);ctx.fill();ctx.restore();ctx.fillStyle='#fef3c7';ctx.beginPath();ctx.arc(0,0,9,0,Math.PI*2);ctx.fill();break;
    case 'phoenix':ctx.fillStyle='#f97316';ctx.shadowColor='#f97316';ctx.shadowBlur=12;ctx.beginPath();ctx.ellipse(0,0,10,8,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.fillStyle='rgba(239,68,68,.8)';const wpH=Math.sin(t*4)*10;ctx.save();ctx.translate(-11,-2);ctx.rotate((wpH-12)*Math.PI/180);ctx.beginPath();ctx.ellipse(0,0,13,5,.4,0,Math.PI*2);ctx.fill();ctx.restore();ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.arc(11,-3,7,0,Math.PI*2);ctx.fill();break;
  }
  ctx.restore();
  gamePetFrame2++;
  maybePlayPetSound();
}
let audioCtx=null,musicOn=false,musicGain=null;
function initAudio(){if(audioCtx)return;audioCtx=new(window.AudioContext||window.webkitAudioContext)();musicGain=audioCtx.createGain();musicGain.gain.value=.12;musicGain.connect(audioCtx.destination);}
function tone(f,t,d,v=.25,t0=0){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,audioCtx.currentTime+t0);g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+t0+d);o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime+t0);o.stop(audioCtx.currentTime+t0+d);}
function playJump(){tone(280,'sine',.07,.22);tone(480,'sine',.1,.18,.04);}
function playScore(){/* no pipe sound */}
function playDeath(){tone(400,'sawtooth',.08,.3);tone(200,'sawtooth',.2,.2,.1);}
function playBoost(){tone(800,'sine',.08,.2);tone(1400,'sine',.1,.15,.08);}
function playShoot(){tone(600,'square',.04,.15);tone(900,'square',.04,.1,.04);}
function playCoinChime(){tone(880,'sine',.05,.14);tone(1320,'sine',.07,.1,.04);tone(1760,'sine',.06,.08,.09);}
function playCombo(){tone(700,'square',.05,.15);tone(1100,'square',.06,.12,.05);tone(1600,'square',.08,.1,.1);}
function playPortal(){tone(300,'sine',.4,.2);tone(600,'sine',.4,.15,.1);tone(900,'sine',.3,.1,.2);}

// ‚îÄ‚îÄ‚îÄ Per-mode unique music ‚îÄ‚îÄ‚îÄ
const MELODIES={
  easy:   {notes:[[523,.3],[659,.3],[784,.3],[880,.6],[784,.3],[659,.3],[523,.6],[440,.3],[494,.3],[523,.9]],type:'triangle',vol:.055,tempo:1},
  normal: {notes:[[523,.2],[659,.2],[784,.2],[659,.2],[523,.4],[440,.4],[523,.2],[659,.2],[698,.4]],type:'square',vol:.08,tempo:1},
  hard:   {notes:[[220,.15],[330,.12],[440,.1],[330,.1],[220,.18],[196,.15],[220,.15],[440,.1],[330,.15],[220,.28]],type:'sawtooth',vol:.07,tempo:1.3},
  insane: {notes:[[110,.09],[165,.08],[220,.07],[165,.08],[110,.11],[98,.09],[110,.09],[82,.13]],type:'sawtooth',vol:.09,tempo:1.6},
  crazy:  {notes:[[440,.12],[660,.1],[880,.08],[1100,.06],[880,.1],[660,.12],[440,.14],[330,.1],[220,.18]],type:'square',vol:.08,tempo:1.4},
  flip:   {notes:[[392,.2],[494,.2],[587,.2],[740,.2],[587,.2],[494,.2],[392,.4],[349,.2],[392,.4]],type:'sine',vol:.06,tempo:1.1},
  zen:    {notes:[[392,.6],[440,.6],[494,.6],[523,.6],[440,.9],[392,.6],[330,.9],[294,1.2]],type:'sine',vol:.05,tempo:.7},
};
let melIdx=0,melTime=0,melMode='normal';
function startMusic(mode='normal'){
  if(!audioCtx||musicOn)return;musicOn=true;melTime=audioCtx.currentTime;melIdx=0;melMode=mode;
  const mel=MELODIES[mode]||MELODIES.normal;
  function sched(){
    if(!musicOn)return;
    while(melTime-audioCtx.currentTime<2){
      const[f,dur]=mel.notes[melIdx%mel.notes.length];
      const rd=dur/mel.tempo;
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type=mel.type;o.frequency.value=f;
      g.gain.setValueAtTime(mel.vol,melTime);
      g.gain.exponentialRampToValueAtTime(.001,melTime+rd-.01);
      o.connect(g);g.connect(musicGain);o.start(melTime);o.stop(melTime+rd);
      melTime+=rd;melIdx++;
    }
    setTimeout(sched,400);
  }
  sched();
}
function stopMusic(){musicOn=false;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gameState='menu',gameMode='normal';
let score=0,speed=0,pipeTimer=0,gframe=0;
let bird={x:0,y:0,vy:0};
let pipes=[],particles=[],coins=[],coinFX=[],bullets=[],boxes=[],portals=[],zenObstacles=[],flowerTraps=[],trailParts=[],woodPlanks=[];
let shakeX=0,shakeY=0;
let crazyHue=0,crazyTimer=0;
let gravDir=1; // 1=normal, -1=flipped
let flipPortals=[]; // for flip mode
let activeShield=false,activeMagnet=0,activeTurbo=0,activeMega=0;
let bossActive=false,bossHP=0,bossMaxHP=0,bossX=0,bossY=0,bossVY=0,bossTypeIdx=0,lastBossScore=0;
let comboStreak=0,lastCoinX=-999,comboActive=false,comboTimer=0,comboFlashTimer=0;
let noJumpStreak=0,sessionMaxNoJump=0;
let zenSecondsThisRun=0;
let lastJumpTime=0;
let doubleJump=false; // for shooting: detect double-tap
let lastTapTime=0;
const GH=70; // ground height
const bgStars=Array.from({length:55},()=>({x:Math.random()*2000,y:Math.random()*2000,r:Math.random()*2+.5,sp:Math.random()*.3+.1,tw:Math.random()*Math.PI*2}));

const BOSS_TYPES=[
  {name:'–ì–ò–ì–ê–ù–¢ ü¶ñ',color:'#ef4444',hp:5,size:60,reward:30,xpReward:60},
  {name:'–ü–†–ò–ó–†–ê–ö üëª',color:'rgba(180,180,255,.6)',hp:8,size:50,reward:50,xpReward:100},
  {name:'–ö–û–†–û–õ–¨ üëë',color:'#FFD700',hp:12,size:68,reward:80,xpReward:160},
  {name:'–î–†–ê–ö–û–ù üêâ',color:'#22c55e',hp:15,size:65,reward:100,xpReward:200},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE PARAMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getModeParams(){
  const M={easy:{speed:1.8,gap:220,mult:.8},normal:{speed:2.5,gap:182,mult:1},hard:{speed:3.2,gap:145,mult:1.5},insane:{speed:4,gap:130,mult:2},crazy:{speed:2.5,gap:175,mult:3},flip:{speed:2.6,gap:190,mult:2.5},zen:{speed:2,gap:999,mult:.5}};
  return M[gameMode]||M.normal;
}
let GAP=182;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resetGame(){
  const mp=getModeParams();
  bird={x:W*.22,y:H/2-20,vy:0};
  pipes=[];particles=[];coins=[];coinFX=[];bullets=[];boxes=[];portals=[];zenObstacles=[];flowerTraps=[];trailParts=[];flipPortals=[];woodPlanks=[];
  pipeTimer=0;score=0;speed=mp.speed;GAP=mp.gap;gframe=0;
  shakeX=0;shakeY=0;crazyHue=0;crazyTimer=0;gravDir=1;
  activeShield=false;activeMagnet=0;activeTurbo=0;activeMega=0;
  bossActive=false;lastBossScore=0;
  comboStreak=0;comboActive=false;comboTimer=0;comboFlashTimer=0;
  noJumpStreak=0;sessionMaxNoJump=0;
  zenSecondsThisRun=0;lastTapTime=0;
  document.getElementById('hud-score').textContent='0';
  document.getElementById('hud-combo').style.opacity='0';
  const gl=document.getElementById('game-label');gl.style.animation='none';gl.style.opacity='0';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIPE ADD + ZEN OBSTACLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addPipe(){
  const topMin=80,topMax=H-80-GAP-80;
  const top=topMin+Math.random()*(topMax-topMin);
  const props=getPipeProps();
  const mAmp=gameMode==='crazy'?50+Math.random()*40:props.moveAmp;
  const mSpd=gameMode==='crazy'?.04+Math.random()*.02:props.moveSpeed;
  // chance for portal
  if(Math.random()<.04){portals.push({x:W+40,y:top+GAP/2,phase:0});return;}
  // chance for box (normal mode)
  if(gameMode==='normal'&&score>5&&Math.random()<.15){
    boxes.push({x:W+80,y:top+GAP/2+(Math.random()-.5)*40,w:28,h:28,hp:2,intact:true});
  }
  // chance for wooden plank (rare, all modes except zen)
  if(gameMode!=='zen'&&score>3&&Math.random()<.08){
    const pw=50+Math.random()*40,ph=14+Math.random()*8;
    woodPlanks.push({x:W+100,y:top+GAP/2+(Math.random()-.5)*50,w:pw,h:ph,hp:1,intact:true,angle:(Math.random()-.5)*.25});
  }
  pipes.push({x:W+40,top,scored:false,props:{...props,moveAmp:mAmp,moveSpeed:mSpd},phase:Math.random()*Math.PI*2,origTop:top,flower:Math.random()<.15&&score>10,bird_scared:false});
  const coinBonus=1+Math.floor(getUpgradeEffect('u_coin_chance')*.05*10);
  const coinChance=.38+getUpgradeEffect('u_coin_chance')*.05;
  if(Math.random()<coinChance){
    const isGold=Math.random()<.02; // 2% gold cuke
    coins.push({x:W+40+62/2,y:top+GAP/2+(Math.random()-.5)*28,collected:false,gold:isGold});
  }
}
function addFlipPortal(){
  const y=80+Math.random()*(H-160);
  flipPortals.push({x:W+60,y,phase:0,r:30});
}
function addZenObstacle(){
  const y=60+Math.random()*(H-190);
  zenObstacles.push({x:W+30,y,r:20+Math.random()*18,phase:0,vY:(Math.random()-.5)*2});
}

function getPipeProps(){
  const p={rotate:false,spiky:false,alpha:1,moveAmp:0,moveSpeed:0};
  if(score<15)return p;
  const r=Math.random();
  if(r<.18)p.rotate=true;
  else if(r<.32)p.spiky=true;
  else if(r<.46)p.alpha=.4+Math.random()*.3;
  else if(r<.65){p.moveAmp=25+Math.random()*35;p.moveSpeed=.025+Math.random()*.025;}
  return p;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLLISION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkCollision(){
  if(bird.y+22>=H-GH||bird.y-22<=0)return true;
  for(const p of pipes){
    if(activeMega>0)continue; // mega-cuke passes through
    const yOff=p.props.moveAmp?Math.sin(p.phase)*p.props.moveAmp:0;
    const pTop=p.top+yOff;
    if(bird.x+15>p.x&&bird.x-15<p.x+62){if(bird.y-17<pTop||bird.y+17>pTop+GAP)return true;}
  }
  for(const b of boxes){
    if(!b.intact)continue;
    if(bird.x+12>b.x&&bird.x-12<b.x+b.w&&bird.y+12>b.y&&bird.y-12<b.y+b.h)return true;
  }
  for(const wp of woodPlanks){
    if(!wp.intact)continue;
    if(bird.x+14>wp.x&&bird.x-14<wp.x+wp.w&&bird.y+14>wp.y&&bird.y-14<wp.y+wp.h)return true;
  }
  if(gameMode==='zen'){
    for(const o of zenObstacles){if(Math.hypot(bird.x-o.x,bird.y-o.y)<o.r+15)return true;}
  }
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW BACKGROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawBg(hue=0){
  const W2=getWorld();
  const bg=ctx.createLinearGradient(0,0,0,H);
  if((gameMode==='crazy'||gameMode==='flip')&&gameState==='playing'){
    const h1=`hsl(${hue},80%,8%)`,h2=`hsl(${(hue+60)%360},80%,12%)`;
    bg.addColorStop(0,h1);bg.addColorStop(.5,h2);bg.addColorStop(1,h1);
  } else if(gameMode==='zen'){
    bg.addColorStop(0,'#061a18');bg.addColorStop(.5,'#0d2b24');bg.addColorStop(1,'#061a18');
  } else {
    bg.addColorStop(0,W2.bg[0]);bg.addColorStop(.5,W2.bg[1]);bg.addColorStop(1,W2.bg[2]);
  }
  ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

  // Stars / particles in bg
  bgStars.forEach(s=>{s.x-=s.sp;if(s.x<0){s.x=W;s.y=Math.random()*(H-GH);}s.tw+=.02;
    const a=.3+Math.abs(Math.sin(s.tw))*.5;
    if((gameMode==='crazy'||gameMode==='flip')&&gameState==='playing'){ctx.fillStyle=`hsla(${(hue+s.tw*20)%360},100%,75%,${a})`;}
    else{ctx.fillStyle=W2.star.replace('{a}',a);}
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  });

  // Distant mountains / horizon elements
  if(gameState!=='playing'||(gameMode!=='crazy'&&gameMode!=='flip')){
    const mountainColor=W2.bg[1]+'aa';
    ctx.fillStyle=mountainColor;
    const off2=(Date.now()/200*(speed||2.5))%200;
    for(let i=0;i<8;i++){const mx=((i*180-off2+W+200)%W+W)%W-100;const mh=60+((i*37+11)%50);
      ctx.beginPath();ctx.moveTo(mx,H-GH);ctx.lineTo(mx+50,H-GH-mh);ctx.lineTo(mx+100,H-GH);ctx.fill();}
  }

  // Ground with grass
  const gg=ctx.createLinearGradient(0,H-GH,0,H);gg.addColorStop(0,W2.ground);gg.addColorStop(1,W2.ground);ctx.fillStyle=gg;ctx.fillRect(0,H-GH,W,GH);
  ctx.fillStyle=W2.groundTop;ctx.fillRect(0,H-GH,W,4);
  // Ground highlight
  const gsh=ctx.createLinearGradient(0,H-GH,0,H-GH+8);gsh.addColorStop(0,'rgba(255,255,255,.12)');gsh.addColorStop(1,'transparent');ctx.fillStyle=gsh;ctx.fillRect(0,H-GH,W,8);
  // Animated grass tufts
  const off=(Date.now()/40*(speed||2.5))%32;
  for(let i=0;i<W+32;i+=32){const gx=(i-off+W+32)%W-32;ctx.fillStyle=W2.groundTop+'bb';
    for(const[ox,oh] of[[-2,8],[3,10],[8,7],[14,9],[20,6],[26,8]])ctx.fillRect(gx+ox,H-GH-oh,3,oh);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW PIPE (enhanced with beautiful textures)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawPipe(p,W2){
  const yOff=p.props.moveAmp?Math.sin(p.phase)*p.props.moveAmp:0;
  const topH=p.top+yOff,botY=p.top+yOff+GAP,botH=H-GH-botY;
  const isMega=activeMega>0;
  ctx.globalAlpha=p.props.alpha||1;
  if(p.props.rotate){ctx.save();ctx.translate(p.x+31,p.top+yOff+GAP/2);ctx.rotate(Math.sin(gframe*.05)*.08);ctx.translate(-(p.x+31),-(p.top+yOff+GAP/2));}

  function body(y,h){
    if(h<=0)return;
    // Main gradient body
    const g=ctx.createLinearGradient(p.x,0,p.x+62,0);
    g.addColorStop(0,W2.pipe[0]);g.addColorStop(.28,W2.pipe[1]);g.addColorStop(.6,W2.pipe[2]);g.addColorStop(1,W2.pipe[3]);
    ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(p.x+5,y,52,h,3);ctx.fill();
    // Shine stripe
    const shine=ctx.createLinearGradient(p.x+5,0,p.x+20,0);
    shine.addColorStop(0,'rgba(255,255,255,.18)');shine.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=shine;ctx.beginPath();ctx.roundRect(p.x+7,y,10,h,2);ctx.fill();
    // Edge lines for 3D depth
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(p.x+5,y);ctx.lineTo(p.x+5,y+h);ctx.stroke();
    ctx.beginPath();ctx.moveTo(p.x+57,y);ctx.lineTo(p.x+57,y+h);ctx.stroke();
    // Rivets
    if(h>20){const riv=['rgba(0,0,0,.25)','rgba(255,255,255,.12)'];
      [[p.x+10,y+10],[p.x+52,y+10],[p.x+10,y+h-10],[p.x+52,y+h-10]].forEach(([rx,ry],ri)=>{
        ctx.fillStyle=riv[ri%2];ctx.beginPath();ctx.arc(rx,ry,3,0,Math.PI*2);ctx.fill();
      });
    }
  }

  function cap(y,top){
    if(isMega){ctx.shadowColor='#a78bfa';ctx.shadowBlur=20;}
    const cg=ctx.createLinearGradient(p.x,0,p.x+62,0);
    cg.addColorStop(0,W2.pipe[3]);cg.addColorStop(.4,W2.pipeCap);cg.addColorStop(1,W2.pipe[0]);
    ctx.fillStyle=cg;ctx.shadowColor=W2.pipeCap;ctx.shadowBlur=isMega?20:8;
    ctx.beginPath();ctx.roundRect(p.x,y,62,14,top?[6,6,0,0]:[0,0,6,6]);ctx.fill();
    // Cap highlight
    const csh=ctx.createLinearGradient(p.x,0,p.x+62,0);
    csh.addColorStop(0,'rgba(255,255,255,.22)');csh.addColorStop(.5,'rgba(255,255,255,.08)');csh.addColorStop(1,'rgba(255,255,255,.02)');
    ctx.fillStyle=csh;ctx.beginPath();ctx.roundRect(p.x+2,y+(top?1:7),58,6,2);ctx.fill();
    ctx.shadowBlur=0;
    // Cap border
    ctx.strokeStyle='rgba(0,0,0,.35)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.roundRect(p.x,y,62,14,top?[6,6,0,0]:[0,0,6,6]);ctx.stroke();
  }

  if(topH>14){body(0,topH-14);cap(topH-14,true);}
  cap(botY,false);if(botH>14)body(botY+14,botH);

  if(p.props.spiky){
    ctx.fillStyle='#ef4444';ctx.shadowColor='#ef4444';ctx.shadowBlur=4;
    for(let i=0;i<5;i++){const sx=p.x+5+i*11;
      ctx.beginPath();ctx.moveTo(sx,topH-14);ctx.lineTo(sx+5.5,topH-24);ctx.lineTo(sx+11,topH-14);ctx.fill();
      ctx.beginPath();ctx.moveTo(sx,botY+14);ctx.lineTo(sx+5.5,botY+24);ctx.lineTo(sx+11,botY+14);ctx.fill();
    }
    ctx.shadowBlur=0;
  }

  // flower trap
  if(p.flower&&!p.bird_scared){
    const fy=topH-28;ctx.font='18px serif';ctx.textAlign='center';ctx.fillText('ü™ª',p.x+31,fy);
    if(Math.hypot(bird.x-(p.x+31),bird.y-fy)<60&&!p.bird_scared){p.bird_scared=true;setTimeout(()=>{p.flower=false;},1200);}
  } else if(p.flower&&p.bird_scared){
    ctx.font='18px serif';ctx.textAlign='center';ctx.fillText('ü¶ú',p.x+31+Math.random()*20-10,topH-50);
  }

  if(p.props.rotate)ctx.restore();
  ctx.globalAlpha=1;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLLECT COINS + COMBO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function collectCoins(){
  const magnetRange=120+(getUpgradeEffect('u_magnet_range')*30);
  coins.forEach(c=>{
    if(c.collected)return;
    const dist=Math.hypot(bird.x-c.x,bird.y-c.y);
    if(activeMagnet>0&&dist<magnetRange){c.x+=(bird.x-c.x)*.09;c.y+=(bird.y-c.y)*.09;}
    if(dist<28){
      c.collected=true;
      if(c.gold){goldCukes++;showToast('‚ú® –ó–æ–ª–æ—Ç–æ–π –æ–≥—É—Ä—á–∏–∫!');playCombo();}
      else{cucumbers++;totalCoins++;playCoinChime();}
      save();document.getElementById('hud-cukes').textContent=cucumbers;document.getElementById('hud-gold').textContent=goldCukes;
      for(let i=0;i<4;i++)coinFX.push({x:c.x,y:c.y,vx:(Math.random()-.5)*3.5,vy:-Math.random()*3.5-1,life:22,max:22,gold:c.gold});
      // combo tracking
      const isConsecutive=Math.abs(c.x-lastCoinX)<200;
      if(isConsecutive){comboStreak++;}else{comboStreak=1;}
      lastCoinX=c.x;
      if(comboStreak>=5&&!comboActive){
        comboActive=true;comboTimer=600;combosActivated++;
        playCombo();showComboLabel();
      }
    }
  });
  coins=coins.filter(c=>c.x>-30);
}

function showComboLabel(){
  const el=document.getElementById('hud-combo');
  el.textContent='üå∂Ô∏è –û–ì–£–†–ï–ß–ù–ê–Ø –õ–ò–•–û–†–ê–î–ö–ê! x2';el.style.opacity='1';
  setTimeout(()=>{if(!comboActive)el.style.opacity='0';},10000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEEDS / SHOOT / BOXES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shoot(){
  if(gameState!=='playing')return;
  bullets.push({x:bird.x+20,y:bird.y,vx:8,life:60});
  playShoot();
}

function updateBullets(){
  bullets=bullets.filter(b=>b.life>0&&b.x<W+20);
  bullets.forEach(b=>{
    b.x+=b.vx;b.life--;
    // draw bullet
    ctx.save();ctx.fillStyle='#86efac';ctx.shadowColor='#4ade80';ctx.shadowBlur=8;
    ctx.beginPath();ctx.ellipse(b.x,b.y,6,3,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;ctx.restore();
    // hit boxes
    boxes.forEach(bx=>{
      if(!bx.intact)return;
      if(b.x+6>bx.x&&b.x-6<bx.x+bx.w&&b.y+3>bx.y&&b.y-3<bx.y+bx.h){
        b.life=0;bx.hp--;
        if(bx.hp<=0){
          bx.intact=false;boxesDestroyed++;
          // loot
          const loot=3+Math.floor(Math.random()*5);
          cucumbers+=loot;save();
          for(let i=0;i<6;i++)particles.push({x:bx.x+14,y:bx.y+14,vx:(Math.random()-.5)*5,vy:-Math.random()*5-2,life:40,max:40,r:4+Math.random()*5,color:'#92400e'});
          coinFX.push({x:bx.x+14,y:bx.y-10,vx:0,vy:-2,life:30,max:30,txt:`+${loot}ü•í`,gold:false});
          showToast(`üì¶ –Ø—â–∏–∫! +${loot}ü•í`);
        }
      }
    });
    // hit wood planks
    woodPlanks.forEach(wp=>{
      if(!wp.intact)return;
      if(b.x+6>wp.x&&b.x-6<wp.x+wp.w&&b.y+4>wp.y&&b.y-4<wp.y+wp.h){
        b.life=0;wp.hp--;
        if(wp.hp<=0){
          wp.intact=false;
          const loot=2+Math.floor(Math.random()*4);
          cucumbers+=loot;save();
          for(let i=0;i<8;i++)particles.push({x:wp.x+wp.w/2,y:wp.y+wp.h/2,vx:(Math.random()-.5)*6,vy:-Math.random()*6-1,life:35,max:35,r:3+Math.random()*5,color:['#92400e','#b45309','#d97706'][Math.floor(Math.random()*3)]});
          coinFX.push({x:wp.x+wp.w/2,y:wp.y-10,vx:0,vy:-2,life:30,max:30,txt:`üí•+${loot}ü•í`,gold:false});
          tone(300,'sawtooth',.08,.2);tone(150,'sawtooth',.12,.15,.06);
        }
      }
    });
  });
  boxes=boxes.filter(b=>b.x>-50);
}

function drawBox(b){
  if(!b.intact)return;
  ctx.save();
  ctx.fillStyle='#92400e';ctx.strokeStyle='#78350f';ctx.lineWidth=2;
  ctx.beginPath();ctx.roundRect(b.x,b.y,b.w,b.h,4);ctx.fill();ctx.stroke();
  ctx.strokeStyle='rgba(255,255,255,.15)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(b.x,b.y+b.h/2);ctx.lineTo(b.x+b.w,b.y+b.h/2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(b.x+b.w/2,b.y);ctx.lineTo(b.x+b.w/2,b.y+b.h);ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,.5)';ctx.font='10px serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('üì¶',b.x+b.w/2,b.y+b.h/2);
  // hp indicator
  ctx.fillStyle=b.hp>=2?'#4ade80':'#ef4444';ctx.fillRect(b.x,b.y-5,b.w*(b.hp/2),3);
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WOOD PLANK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawWoodPlank(b){
  if(!b.intact)return;
  ctx.save();ctx.translate(b.x+b.w/2,b.y+b.h/2);ctx.rotate(b.angle||0);
  const w=b.w,h=b.h;
  // Wood gradient
  const wg=ctx.createLinearGradient(-w/2,-h/2,w/2,h/2);
  wg.addColorStop(0,'#d97706');wg.addColorStop(.25,'#b45309');wg.addColorStop(.5,'#92400e');wg.addColorStop(.75,'#b45309');wg.addColorStop(1,'#78350f');
  ctx.shadowColor='rgba(0,0,0,.5)';ctx.shadowBlur=6;ctx.shadowOffsetY=3;
  ctx.fillStyle=wg;ctx.beginPath();ctx.roundRect(-w/2,-h/2,w,h,3);ctx.fill();
  ctx.shadowBlur=0;ctx.shadowOffsetY=0;
  // Wood grain lines
  ctx.strokeStyle='rgba(0,0,0,.18)';ctx.lineWidth=1;
  for(let i=1;i<4;i++){const x=-w/2+w*i/4;ctx.beginPath();ctx.moveTo(x,-h/2+2);ctx.lineTo(x,h/2-2);ctx.stroke();}
  // Nail holes
  ctx.fillStyle='rgba(0,0,0,.4)';[[-(w/2-6),0],[(w/2-6),0]].forEach(([nx,ny])=>{ctx.beginPath();ctx.arc(nx,ny,2,0,Math.PI*2);ctx.fill();});
  // Wood grain texture horizontal
  ctx.strokeStyle='rgba(120,53,15,.25)';ctx.lineWidth=1;
  for(let i=1;i<3;i++){const y=-h/2+h*i/3;ctx.beginPath();ctx.moveTo(-w/2+3,y);ctx.lineTo(w/2-3,y);ctx.stroke();}
  // HP bar
  ctx.fillStyle='rgba(0,0,0,.3)';ctx.fillRect(-w/2,-h/2-6,w,4);
  ctx.fillStyle='#a16207';ctx.fillRect(-w/2,-h/2-6,w*(b.hp/1),4);
  ctx.restore();
}
function drawPortal(p,hue=0){
  p.phase+=.07;
  ctx.save();ctx.translate(p.x,p.y);
  const r=26+Math.sin(p.phase*1.5)*4;
  // Outer glow rings
  for(let ring=3;ring>=0;ring--){
    ctx.globalAlpha=.08-ring*.015;
    ctx.fillStyle=`hsl(${hue},100%,60%)`;
    ctx.beginPath();ctx.arc(0,0,r+ring*12,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
  // Swirling energy
  for(let i=0;i<8;i++){
    const a=p.phase+i*Math.PI/4;
    const x2=Math.cos(a)*r*.7,y2=Math.sin(a)*r*.7;
    ctx.shadowColor=`hsl(${(hue+i*20)%360},100%,70%)`;ctx.shadowBlur=8;
    ctx.fillStyle=`hsl(${(hue+i*20)%360},100%,75%)`;
    ctx.beginPath();ctx.arc(x2,y2,3+Math.sin(p.phase*2+i)*1.5,0,Math.PI*2);ctx.fill();
  }
  // Main circles
  ctx.shadowColor=`hsl(${hue},100%,60%)`;ctx.shadowBlur=20;
  ctx.strokeStyle=`hsl(${hue},100%,75%)`;ctx.lineWidth=3;
  ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.stroke();
  ctx.strokeStyle=`hsl(${(hue+120)%360},100%,70%)`;ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(0,0,r*.65,p.phase*1.3,p.phase*1.3+Math.PI*1.5);ctx.stroke();
  ctx.strokeStyle=`hsl(${(hue+240)%360},100%,70%)`;ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(0,0,r*.45,-p.phase*1.5,-p.phase*1.5+Math.PI);ctx.stroke();
  // Center fill
  const cg=ctx.createRadialGradient(0,0,0,0,0,r*.5);
  cg.addColorStop(0,`hsla(${hue},100%,80%,.4)`);cg.addColorStop(1,`hsla(${hue},100%,50%,.1)`);
  ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,0,r*.5,0,Math.PI*2);ctx.fill();
  // Portal label
  ctx.shadowBlur=0;ctx.globalAlpha=.8+Math.sin(p.phase*3)*.2;
  ctx.fillStyle='#fff';ctx.font='bold 13px Nunito';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText('üåÄ',0,0);
  ctx.globalAlpha=1;ctx.shadowBlur=0;ctx.restore();
}

function checkPortals(){
  portals.forEach(p=>{
    if(Math.hypot(bird.x-p.x,bird.y-p.y)<32){
      score+=10;portalsUsed++;
      const bonus=5+Math.floor(Math.random()*8);cucumbers+=bonus;save();
      playPortal();showToast(`üåÄ –ü–æ—Ä—Ç–∞–ª! +10 –æ—á–∫–æ–≤ +${bonus}ü•í –£–°–ö–û–†–ï–ù–ò–ï!`);
      // Speed boost from portal
      speed=Math.min(speed*1.2,speed+1.5);
      bird.vy=JUMP_VEL*gravDir*.6;
      p.x=-200;
      for(let i=0;i<16;i++)particles.push({x:bird.x,y:bird.y,vx:(Math.random()-.5)*8,vy:(Math.random()-.5)*8,life:50,max:50,r:5+Math.random()*8,color:`hsl(${Math.random()*360},100%,70%)`});
    }
  });
  portals=portals.filter(p=>p.x>-100);
}

function checkFlipPortals(){
  flipPortals.forEach(fp=>{
    if(Math.hypot(bird.x-fp.x,bird.y-fp.y)<fp.r){
      gravDir*=-1;fp.x=-200;playPortal();
      showLabel('üîÑ –ì–†–ê–í–ò–¢–ê–¶–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ê!','#38bdf8');
    }
  });
  flipPortals=flipPortals.filter(fp=>fp.x>-100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOSS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnBoss(){
  if(bossActive)return;
  const bt=BOSS_TYPES[Math.floor(Math.random()*BOSS_TYPES.length)];
  bossTypeIdx=BOSS_TYPES.indexOf(bt);bossActive=true;bossHP=bossMaxHP=bt.hp;bossX=W+90;bossY=H/2;bossVY=2;
  showLabel(`üëπ –ë–û–°–°: ${bt.name}!`,'#ef4444');
}

function updateBoss(){
  if(!bossActive)return;
  const bt=BOSS_TYPES[bossTypeIdx];
  bossX-=speed*.4;bossY+=bossVY;
  if(bossY<80||bossY>H-100)bossVY*=-1;
  ctx.save();
  const s=bt.size/2;
  ctx.shadowColor=bt.color;ctx.shadowBlur=25;

  if(bossTypeIdx===0){
    // –ì–ò–ì–ê–ù–¢ ü¶ñ - dinosaur-like
    ctx.fillStyle='#dc2626';ctx.beginPath();ctx.ellipse(bossX,bossY,s,s*.8,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fca5a5';ctx.beginPath();ctx.ellipse(bossX+s*.2,bossY-s*.1,s*.55,s*.5,-.2,0,Math.PI*2);ctx.fill();
    // eyes
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(bossX+s*.3,bossY-s*.25,s*.2,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';ctx.beginPath();ctx.arc(bossX+s*.35,bossY-s*.22,s*.1,0,Math.PI*2);ctx.fill();
    // teeth
    ctx.fillStyle='#fff';for(let i=0;i<3;i++){ctx.beginPath();ctx.moveTo(bossX+s*.1+i*s*.12,bossY+s*.3);ctx.lineTo(bossX+s*.17+i*s*.12,bossY+s*.5);ctx.lineTo(bossX+s*.24+i*s*.12,bossY+s*.3);ctx.fill();}
    // spine
    ctx.fillStyle='#7f1d1d';for(let i=0;i<4;i++){ctx.beginPath();ctx.arc(bossX-s*.4+i*s*.22,bossY-s*.7-i*.05,s*.1,0,Math.PI*2);ctx.fill();}
  } else if(bossTypeIdx===1){
    // –ü–†–ò–ó–†–ê–ö üëª
    const wave=Math.sin(gframe*.05)*5;
    ctx.fillStyle='rgba(180,180,255,.75)';ctx.beginPath();ctx.arc(bossX,bossY-wave,s,Math.PI,0);ctx.lineTo(bossX+s,bossY+s*.5-wave);
    for(let i=3;i>=0;i--){const gx=bossX+s-i*s*.67;ctx.quadraticCurveTo(gx,bossY+s*.9+Math.sin(gframe*.08+i)*6-wave,gx-s*.33,bossY+s*.5-wave);}
    ctx.closePath();ctx.fill();
    ctx.fillStyle='rgba(0,0,80,.8)';ctx.beginPath();ctx.ellipse(bossX-s*.3,bossY-s*.1-wave,s*.18,s*.22,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(bossX+s*.3,bossY-s*.1-wave,s*.18,s*.22,0,0,Math.PI*2);ctx.fill();
    ctx.shadowColor='#818cf8';
  } else if(bossTypeIdx===2){
    // –ö–û–†–û–õ–¨ üëë
    ctx.fillStyle='#ca8a04';ctx.beginPath();ctx.ellipse(bossX,bossY,s,s*.9,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.ellipse(bossX,bossY-s*.1,s*.7,s*.65,0,0,Math.PI*2);ctx.fill();
    // Crown
    ctx.fillStyle='#FFD700';ctx.shadowColor='#FFD700';ctx.shadowBlur=12;
    const cw=s*.9,cy=bossY-s*.7;
    ctx.beginPath();ctx.moveTo(bossX-cw,cy+s*.3);ctx.lineTo(bossX-cw,cy);ctx.lineTo(bossX-cw*.5,cy+s*.15);ctx.lineTo(bossX,cy-s*.1);ctx.lineTo(bossX+cw*.5,cy+s*.15);ctx.lineTo(bossX+cw,cy);ctx.lineTo(bossX+cw,cy+s*.3);ctx.closePath();ctx.fill();
    ctx.shadowBlur=0;
    // gems in crown
    ['#ef4444','#22c55e','#38bdf8'].forEach((g,i)=>{ctx.fillStyle=g;ctx.beginPath();ctx.arc(bossX-cw*.5+i*cw*.5,cy+s*.1,s*.07,0,Math.PI*2);ctx.fill();});
    // eyes
    ctx.fillStyle='#000';ctx.beginPath();ctx.arc(bossX-s*.3,bossY-s*.1,s*.14,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(bossX+s*.3,bossY-s*.1,s*.14,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(bossX-s*.27,bossY-s*.14,s*.06,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(bossX+s*.33,bossY-s*.14,s*.06,0,Math.PI*2);ctx.fill();
  } else {
    // –î–†–ê–ö–û–ù üêâ
    ctx.fillStyle='#15803d';ctx.beginPath();ctx.ellipse(bossX,bossY,s,s*.85,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#4ade80';ctx.beginPath();ctx.ellipse(bossX+s*.15,bossY-s*.15,s*.65,s*.58,-.15,0,Math.PI*2);ctx.fill();
    // Wings
    ctx.fillStyle='rgba(21,128,61,.6)';
    ctx.beginPath();ctx.moveTo(bossX-s*.2,bossY-s*.3);ctx.quadraticCurveTo(bossX-s*1.4,bossY-s*1.1,bossX-s*.8,bossY+s*.1);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(bossX+s*.2,bossY-s*.3);ctx.quadraticCurveTo(bossX+s*1.4,bossY-s*1.1,bossX+s*.8,bossY+s*.1);ctx.closePath();ctx.fill();
    // Eyes (glowing)
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(bossX+s*.2,bossY-s*.25,s*.18,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f97316';ctx.beginPath();ctx.arc(bossX+s*.24,bossY-s*.22,s*.1,0,Math.PI*2);ctx.fill();
    // Spines
    ctx.fillStyle='#052e16';for(let i=0;i<5;i++){ctx.beginPath();ctx.moveTo(bossX-s*.3+i*s*.15,bossY-s*.7);ctx.lineTo(bossX-s*.22+i*s*.15,bossY-s*1.0);ctx.lineTo(bossX-s*.15+i*s*.15,bossY-s*.7);ctx.fill();}
    // Fire breath
    if(gframe%60<20){const fphase=gframe*.18;ctx.shadowColor='#f97316';ctx.shadowBlur=16;
      for(let i=0;i<4;i++){const fg=ctx.createRadialGradient(bossX+s,bossY+i*s*.08,0,bossX+s+s*.4,bossY+i*s*.08,s*.5);fg.addColorStop(0,'rgba(254,215,0,.9)');fg.addColorStop(.5,'rgba(249,115,22,.6)');fg.addColorStop(1,'transparent');ctx.fillStyle=fg;ctx.beginPath();ctx.ellipse(bossX+s+s*.4+Math.sin(fphase+i)*s*.2,bossY+i*s*.08,s*.5,s*.12,Math.sin(fphase+i)*.3,0,Math.PI*2);ctx.fill();}
      ctx.shadowBlur=0;
    }
  }

  // HP bar
  const bw=bt.size*1.6;
  ctx.fillStyle='rgba(0,0,0,.55)';ctx.beginPath();ctx.roundRect(bossX-bw/2,bossY-bt.size/2-20,bw,9,4);ctx.fill();
  const hpPct=bossHP/bossMaxHP;
  const hpColor=hpPct>.6?'#4ade80':hpPct>.3?'#fbbf24':'#ef4444';
  ctx.fillStyle=hpColor;ctx.shadowColor=hpColor;ctx.shadowBlur=6;
  ctx.beginPath();ctx.roundRect(bossX-bw/2,bossY-bt.size/2-20,bw*hpPct,9,4);ctx.fill();ctx.shadowBlur=0;
  ctx.fillStyle='#fff';ctx.font='bold 10px Nunito';ctx.textAlign='center';ctx.fillText(bt.name,bossX,bossY-bt.size/2-26);
  ctx.restore();

  if(Math.hypot(bird.x-bossX,bird.y-bossY)<bt.size/2+18){
    bossHP--;
    if(bossHP<=0){
      bossActive=false;bossesDefeated++;cucumbers+=bt.reward;addXP(bt.xpReward);save();
      localStorage.setItem('fc_bosses',bossesDefeated);
      showLabel(`üíÄ –ë–û–°–° –ü–û–ë–ï–ñ–î–Å–ù! +${bt.reward}ü•í`,'#4ade80');
      for(let i=0;i<15;i++)particles.push({x:bossX,y:bossY,vx:(Math.random()-.5)*8,vy:Math.random()*-8-2,life:60,max:60,r:8+Math.random()*10,color:bt.color});
    } else if(activeShield){activeShield=false;showToast('üõ°Ô∏è –©–∏—Ç —Å–ª–æ–º–∞–Ω –æ—Ç –±–æ—Å—Å–∞!');}
    else{
      if(getUpgradeEffect('u_lucky_save')>0&&Math.random()<.01*getUpgradeEffect('u_lucky_save')){showToast('üçÄ –ü–æ–≤–µ–∑–ª–æ!');return;}
      gameState='dead';playDeath();stopMusic();spawnDeathFX();showGameOverDelayed();return;
    }
    bossX=W+90;
  }
  if(bossX<-100)bossActive=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEATH + PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnDeathFX(){for(let i=0;i<20;i++){const a=Math.random()*Math.PI*2,sp=2+Math.random()*6;particles.push({x:bird.x,y:bird.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-3,life:55,max:70,r:4+Math.random()*8,color:['#4ade80','#22c55e','#86efac','#dcfce7'][Math.floor(Math.random()*4)]});}}

// ‚îÄ‚îÄ‚îÄ Trail emit (called every frame during play) ‚îÄ‚îÄ‚îÄ
function spawnTrail(x,y){
  const t=TRAILS.find(t=>t.id===selectedTrail);if(!t||!t.color)return;
  // Emit 2-3 particles per frame for richer trail
  const count=selectedTrail==='rainbow'||selectedTrail==='candy'?3:2;
  for(let k=0;k<count;k++){
    const col=t.color[Math.floor(Math.random()*t.color.length)];
    const isB=t.id==='bubbles';
    const isStar=t.id==='stars';
    const isGhost=t.id==='ghost';
    const baseR=isB?4+Math.random()*5:isStar?3+Math.random()*4:2+Math.random()*3;
    trailParts.push({
      x:x+(Math.random()-.5)*10,y:y+(Math.random()-.5)*8,
      vx:(Math.random()-.5)*(isB?.5:1.8)-1.2,
      vy:(Math.random()-.5)*1.5-(isGhost?.3:0),
      life:isB?40:isStar?35:25,max:isB?40:isStar?35:25,
      r:baseR,color:col,
      bubble:isB,star:isStar,ghost:isGhost,
      rot:Math.random()*Math.PI*2,rotV:(Math.random()-.5)*.2
    });
  }
}
function drawTrail(){
  trailParts=trailParts.filter(p=>p.life>0);
  trailParts.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.life--;
    if(p.rot!==undefined)p.rot+=p.rotV;
    const alpha=(p.life/p.max)*.85;
    ctx.save();ctx.globalAlpha=alpha;
    if(p.bubble){
      ctx.strokeStyle=p.color;ctx.lineWidth=1.8;
      ctx.shadowColor=p.color;ctx.shadowBlur=5;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.stroke();
    } else if(p.star){
      ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=8;
      ctx.translate(p.x,p.y);ctx.rotate(p.rot);
      ctx.beginPath();
      for(let i=0;i<5;i++){const a=i*Math.PI*.4-Math.PI/2,a2=a+Math.PI*.2;ctx.lineTo(Math.cos(a)*p.r,Math.sin(a)*p.r);ctx.lineTo(Math.cos(a2)*p.r*.45,Math.sin(a2)*p.r*.45);}
      ctx.closePath();ctx.fill();
    } else if(p.ghost){
      ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=10;
      ctx.beginPath();ctx.arc(p.x,p.y-p.r*.3,p.r*.7,Math.PI,0);
      ctx.quadraticCurveTo(p.x+p.r*.7,p.y+p.r*.4,p.x+p.r*.35,p.y+p.r*.1);
      ctx.quadraticCurveTo(p.x,p.y+p.r*.5,p.x-p.r*.35,p.y+p.r*.1);
      ctx.quadraticCurveTo(p.x-p.r*.7,p.y+p.r*.4,p.x-p.r*.7,p.y-p.r*.3);
      ctx.fill();
    } else {
      ctx.fillStyle=p.color;ctx.shadowColor=p.color;ctx.shadowBlur=7;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    }
    ctx.restore();
  });
  ctx.globalAlpha=1;ctx.shadowBlur=0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOW LABEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLabel(msg,color='#fbbf24'){
  const el=document.getElementById('game-label');
  el.textContent=msg;el.style.color=color;el.style.textShadow=`0 0 24px ${color}`;
  el.style.animation='none';void el.offsetWidth;el.style.animation='labelPop 1.4s forwards';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ZEN MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addZenObs(){
  const y=60+Math.random()*(H-190);
  const r=22+Math.random()*20;
  const types=['spike','skull','fire','electric'];
  const type=types[Math.floor(Math.random()*types.length)];
  zenObstacles.push({x:W+r+10,y,r,vY:(Math.random()-.5)*1.8,phase:Math.random()*Math.PI*2,type});
}
function drawZenObs(o){
  ctx.save();ctx.translate(o.x,o.y);
  const pulse=1+Math.sin(o.phase+=.06)*.12;
  ctx.scale(pulse,pulse);

  if(o.type==='skull'){
    // Red glowing skull
    ctx.shadowColor='#ef4444';ctx.shadowBlur=20;
    ctx.fillStyle='#dc2626';ctx.beginPath();ctx.arc(0,-o.r*.1,o.r*.75,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#7f1d1d';ctx.beginPath();ctx.ellipse(0,o.r*.35,o.r*.45,o.r*.3,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(-o.r*.28,-o.r*.18,o.r*.22,o.r*.25,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(o.r*.28,-o.r*.18,o.r*.22,o.r*.25,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ef4444';
    ctx.beginPath();ctx.ellipse(-o.r*.28,-o.r*.18,o.r*.12,o.r*.14,0,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.ellipse(o.r*.28,-o.r*.18,o.r*.12,o.r*.14,0,0,Math.PI*2);ctx.fill();
    // teeth
    ctx.fillStyle='#fff';
    for(let i=-1;i<=1;i++){ctx.beginPath();ctx.moveTo(i*o.r*.22,o.r*.28);ctx.lineTo(i*o.r*.22-o.r*.1,o.r*.55);ctx.lineTo(i*o.r*.22+o.r*.1,o.r*.55);ctx.closePath();ctx.fill();}
    // WARNING text
    ctx.shadowBlur=0;ctx.fillStyle='#fef2f2';ctx.font=`bold ${Math.floor(o.r*.35)}px Nunito`;ctx.textAlign='center';ctx.textBaseline='middle';
  } else if(o.type==='spike'){
    // Orange/red spiked ball
    ctx.shadowColor='#f97316';ctx.shadowBlur=18;
    ctx.fillStyle='#c2410c';ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ea580c';ctx.beginPath();ctx.arc(0,0,o.r*.5,0,Math.PI*2);ctx.fill();
    // spikes
    ctx.fillStyle='#9a3412';
    for(let i=0;i<10;i++){
      const a=i*Math.PI/5+o.phase*.2;
      ctx.save();ctx.rotate(a);
      ctx.beginPath();ctx.moveTo(0,o.r*.65);ctx.lineTo(-o.r*.1,o.r*.45);ctx.lineTo(o.r*.1,o.r*.45);ctx.closePath();ctx.fill();
      ctx.restore();
    }
    // ‚ö† symbol
    ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.font=`bold ${Math.floor(o.r*.6)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ö†Ô∏è',0,0);
  } else if(o.type==='fire'){
    // Blue fire/electric ball (danger)
    ctx.shadowColor='#ef4444';ctx.shadowBlur=22;
    const fg=ctx.createRadialGradient(0,0,0,0,0,o.r*.7);
    fg.addColorStop(0,'#fef08a');fg.addColorStop(.4,'#ef4444');fg.addColorStop(1,'#7f1d1d');
    ctx.fillStyle=fg;ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.fill();
    // flame tongues
    for(let i=0;i<6;i++){
      const a=i*Math.PI/3+o.phase*.3;
      const fx=Math.cos(a)*o.r*.5,fy=Math.sin(a)*o.r*.5;
      const flg=ctx.createRadialGradient(fx,fy,0,fx,fy,o.r*.4);
      flg.addColorStop(0,'rgba(254,240,138,.8)');flg.addColorStop(.5,'rgba(239,68,68,.5)');flg.addColorStop(1,'transparent');
      ctx.fillStyle=flg;ctx.beginPath();ctx.arc(fx,fy,o.r*.35,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.font=`bold ${Math.floor(o.r*.55)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('üî•',0,0);
  } else {
    // electric
    ctx.shadowColor='#a855f7';ctx.shadowBlur=22;
    ctx.fillStyle='#4c1d95';ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#c4b5fd';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,o.r*.7,0,Math.PI*2);ctx.stroke();
    // lightning bolts
    ctx.strokeStyle='#fde68a';ctx.lineWidth=1.5;
    for(let i=0;i<4;i++){
      const a=i*Math.PI/2+o.phase*.4;
      ctx.save();ctx.rotate(a);
      ctx.beginPath();ctx.moveTo(0,o.r*.15);ctx.lineTo(-o.r*.08,o.r*.4);ctx.lineTo(o.r*.04,o.r*.4);ctx.lineTo(-o.r*.06,o.r*.7);ctx.stroke();
      ctx.restore();
    }
    ctx.shadowBlur=0;ctx.fillStyle='#fde68a';ctx.font=`bold ${Math.floor(o.r*.55)}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ö°',0,0);
  }

  // Red WARNING ring pulsing
  ctx.shadowColor='#ef4444';ctx.shadowBlur=10;
  ctx.strokeStyle=`rgba(239,68,68,${.4+Math.sin(o.phase*4)*.3})`;ctx.lineWidth=2.5;
  ctx.beginPath();ctx.arc(0,0,o.r+6,0,Math.PI*2);ctx.stroke();
  ctx.shadowBlur=0;ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gameLoop(){
  if(gameState!=='playing')return;
  gframe++;
  const mp=getModeParams();
  const W2=getWorld();

  // Shake
  const shakeAmt=(gameMode==='insane')?1.5:(gameMode==='crazy'||gameMode==='flip')?2.5:0;
  shakeX=(Math.random()-.5)*shakeAmt*2;shakeY=(Math.random()-.5)*shakeAmt*2;

  // Crazy hue
  if(gameMode==='crazy'||gameMode==='flip')crazyHue=(crazyHue+2)%360;
  // Crazy gravity flip timer
  if(gameMode==='crazy'){
    crazyTimer++;
    if(crazyTimer%180===0){gravDir*=-1;showLabel('üåÄ –ì–†–ê–í–ò–¢–ê–¶–ò–Ø –ü–ï–†–ï–í–ï–†–ù–£–õ–ê–°–¨!','#ff00ff');}
  }

  ctx.save();if(shakeX||shakeY)ctx.translate(shakeX,shakeY);
  ctx.clearRect(-10,-10,W+20,H+20);
  drawBg(crazyHue);

  // Combo flash
  if(comboActive){
    comboTimer--;if(comboTimer<=0){comboActive=false;comboStreak=0;document.getElementById('hud-combo').style.opacity='0';}
    if(gframe%15<7){ctx.fillStyle='rgba(255,100,0,.06)';ctx.fillRect(0,0,W,H);}
  }

  // ZEN mode
  if(gameMode==='zen'){
    zenSecondsThisRun+=1/60;
    if(zenSecondsThisRun>zenSeconds){zenSeconds=zenSecondsThisRun;save();}
    pipeTimer++;if(pipeTimer%200===0){addZenObs();pipeTimer=0;}
    // add coins frequently
    if(gframe%60===0)coins.push({x:W+30,y:60+Math.random()*(H-200),collected:false,gold:Math.random()<.015});
    zenObstacles.forEach(o=>{o.x-=speed;o.y+=o.vY;if(o.y<60||o.y>H-100)o.vY*=-1;drawZenObs(o);});
    zenObstacles=zenObstacles.filter(o=>o.x>-50);
  } else {
    // Normal pipe spawning
    pipeTimer++;if(pipeTimer>=90){addPipe();pipeTimer=0;}
    // flip mode portals
    if(gameMode==='flip'&&gframe%150===0)addFlipPortal();
    // process pipes
    pipes.forEach(p=>{
      p.x-=speed;if(p.props.moveSpeed)p.phase+=p.props.moveSpeed;
      if(!p.scored&&p.x+62<bird.x){
        p.scored=true;
        const pts=comboActive?2:1;score+=pts;
        playScore();
        document.getElementById('hud-score').textContent=score;
        const speedMult=gameMode==='hard'?.12:gameMode==='insane'?.15:.07;
        speed=mp.speed+score*speedMult;
        if(gameMode==='crazy'&&score>crazySurvived){crazySurvived=score;save();}
        if(score>0&&score%25===0&&score!==lastBossScore){lastBossScore=score;spawnBoss();}
        // no-jump streak
        if(Date.now()-lastJumpTime>2000)noJumpStreak++;else noJumpStreak=0;
        if(noJumpStreak>sessionMaxNoJump){sessionMaxNoJump=noJumpStreak;if(sessionMaxNoJump>maxNoJump){maxNoJump=sessionMaxNoJump;save();}}
      }
    });
    pipes=pipes.filter(p=>p.x+62>-20);
    pipes.forEach(p=>drawPipe(p,W2));
    // portals (bonus)
    portals.forEach(p=>{p.x-=speed;drawPortal(p,gframe*2);});
    checkPortals();
    // flip portals
    if(gameMode==='flip'){flipPortals.forEach(fp=>{fp.x-=speed;fp.phase+=.06;drawPortal(fp,180);});checkFlipPortals();}
    // boxes
    boxes.forEach(b=>{b.x-=speed;drawBox(b);});
    // wooden planks
    woodPlanks.forEach(wp=>{wp.x-=speed;drawWoodPlank(wp);});
    woodPlanks=woodPlanks.filter(wp=>wp.x+wp.w>-20);
    // boss
    if(gameMode!=='flip'&&gameMode!=='zen')updateBoss();
    // mega-cuke smash
    if(activeMega>0){
      pipes.forEach(p=>{if(!p.smashed&&p.x<bird.x+80&&p.x+62>bird.x-50){
        p.smashed=true;p.x=-500;megaPipesSmashed++;score++;
        document.getElementById('hud-score').textContent=score;
        for(let i=0;i<10;i++)particles.push({x:bird.x,y:bird.y,vx:(Math.random()-.5)*9,vy:-Math.random()*7-1,life:45,max:45,r:5+Math.random()*7,color:'#a78bfa'});
        coinFX.push({x:bird.x,y:bird.y-20,vx:0,vy:-2,life:28,max:28,txt:'üí•+1',gold:false});
      }});
      pipes=pipes.filter(p=>!p.smashed||p.x>-400);
    }
  }

  // Coins
  coins.forEach(c=>c.x-=speed);
  coins.forEach(c=>{
    if(c.collected)return;ctx.save();ctx.translate(c.x,c.y);
    const pulse=1+Math.sin(gframe*.1)*.08;ctx.scale(pulse,pulse);
    if(c.gold){
      ctx.shadowColor='#FFD700';ctx.shadowBlur=14;
      const cg=ctx.createRadialGradient(0,0,1,0,0,11);cg.addColorStop(0,'#fff9c4');cg.addColorStop(.4,'#FFD700');cg.addColorStop(1,'#f59e0b');
      ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,0,11,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.7)';ctx.font='bold 8px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚ú®',0,0);
    } else {
      ctx.shadowColor='#4ade80';ctx.shadowBlur=11;
      const cg=ctx.createRadialGradient(0,0,1,0,0,10);cg.addColorStop(0,'#dcfce7');cg.addColorStop(.4,'#86efac');cg.addColorStop(1,'#4ade80');
      ctx.fillStyle=cg;ctx.beginPath();ctx.arc(0,0,10,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowBlur=0;ctx.restore();
  });
  collectCoins();

  // Bird physics
  const effGrav=.48*(1-getUpgradeEffect('u_low_gravity')*.08)*gravDir;
  bird.vy+=effGrav;bird.y+=bird.vy;

  // Trail
  if(gframe%2===0)spawnTrail(bird.x-10,bird.y);
  drawTrail();

  const angle=Math.min(Math.max(bird.vy*.05*gravDir,-.45),.85);

  // Shield visual
  if(activeShield){ctx.save();ctx.strokeStyle='#38bdf8';ctx.lineWidth=2.5;ctx.shadowColor='#38bdf8';ctx.shadowBlur=16;ctx.globalAlpha=.55+Math.sin(gframe*.2)*.25;ctx.beginPath();ctx.arc(bird.x,bird.y,30,0,Math.PI*2);ctx.stroke();ctx.strokeStyle='rgba(56,189,248,.3)';ctx.lineWidth=5;ctx.beginPath();ctx.arc(bird.x,bird.y,38,0,Math.PI*2);ctx.stroke();ctx.restore();}
  if(activeMagnet>0){ctx.save();ctx.strokeStyle='#fbbf24';ctx.lineWidth=1;ctx.shadowColor='#fbbf24';ctx.shadowBlur=6;ctx.globalAlpha=.15+Math.sin(gframe*.1)*.08;ctx.beginPath();ctx.arc(bird.x,bird.y,120+(getUpgradeEffect('u_magnet_range')*30),0,Math.PI*2);ctx.stroke();ctx.restore();activeMagnet--;if(activeMagnet===0)showToast('üß≤ –ú–∞–≥–Ω–∏—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');}
  if(activeTurbo>0){ctx.save();ctx.globalAlpha=.35;ctx.strokeStyle='#fb923c';ctx.lineWidth=1.5;for(let i=0;i<5;i++){const ly=bird.y+(i-2)*9;ctx.beginPath();ctx.moveTo(bird.x-40-Math.random()*15,ly);ctx.lineTo(bird.x-18,ly);ctx.stroke();}ctx.restore();activeTurbo--;if(activeTurbo===0){speed=preTurboSpeed||speed/1.35;showToast('‚ö° –¢—É—Ä–±–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å');}}
  if(activeMega>0){
    ctx.save();ctx.strokeStyle='#a78bfa';ctx.lineWidth=3;ctx.shadowColor='#a78bfa';ctx.shadowBlur=22;ctx.globalAlpha=.45+Math.sin(gframe*.3)*.3;ctx.beginPath();ctx.arc(bird.x,bird.y,38,0,Math.PI*2);ctx.stroke();ctx.lineWidth=1.5;ctx.globalAlpha=.25;ctx.beginPath();ctx.arc(bird.x,bird.y,52,0,Math.PI*2);ctx.stroke();ctx.restore();
    activeMega--;if(activeMega===0)showToast('üí• –ú–µ–≥–∞-–æ–≥—É—Ä–µ—Ü –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');
  }

  drawCucumber(ctx,bird.x,bird.y,52,selectedSkin,angle,gframe);
  drawGamePet();

  // Bullets
  updateBullets();

  // Particles
  particles=particles.filter(p=>p.life>0);
  particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r/2,0,Math.PI*2);ctx.fill();});
  ctx.globalAlpha=1;

  // Coin FX
  coinFX=coinFX.filter(p=>p.life>0);
  coinFX.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life--;ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.gold?'#FFD700':'#4ade80';ctx.font='bold 14px Nunito';ctx.textAlign='center';ctx.fillText(p.txt||'+1',p.x,p.y);});
  ctx.globalAlpha=1;

  ctx.restore();
  updateBoosterHUD();

  // Collision
  if(checkCollision()){
    if(activeShield){
      activeShield=false;showToast('üõ°Ô∏è –©–∏—Ç –∑–∞—â–∏—Ç–∏–ª!');
      bird.vy=JUMP_VEL*.6*gravDir;
      // push bird to safe zone
      if(bird.y+22>=H-GH)bird.y=H-GH-25;
      if(bird.y-22<=0)bird.y=25;
      playBoost();
    }
    else if(getUpgradeEffect('u_lucky_save')>0&&Math.random()<.01*getUpgradeEffect('u_lucky_save')){showToast('üçÄ –°—á–∞—Å—Ç–ª–∏–≤—á–∏–∫!');}
    else{gameState='dead';playDeath();stopMusic();spawnDeathFX();showGameOverDelayed();return;}
  }
  requestAnimationFrame(gameLoop);
}

const JUMP_VEL=-10;
function jump(){
  if(gameState!=='playing')return;
  bird.vy=JUMP_VEL*gravDir;
  lastJumpTime=Date.now();
  playJump();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME OVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showGameOverDelayed(){
  function finalF(){
    ctx.clearRect(0,0,W,H);drawBg(crazyHue);
    pipes.forEach(p=>drawPipe(p,getWorld()));
    particles=particles.filter(p=>p.life>0);
    particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r/2,0,Math.PI*2);ctx.fill();});
    ctx.globalAlpha=1;
    if(particles.some(p=>p.life>0))requestAnimationFrame(finalF);else setTimeout(showGameOver,200);
  }
  requestAnimationFrame(finalF);
}

function showGameOver(){
  const secret=!ownedSkins.includes('secret')&&score>=50;
  if(score>bestScore)bestScore=score;
  const mp=getModeParams();
  const earned=Math.floor(score/10*mp.mult);
  const xpEarned=score*5+(gameMode==='crazy'?score*8:0)+(gameMode==='zen'?Math.floor(zenSecondsThisRun/2):0);
  cucumbers+=earned;
  if(secret){ownedSkins.push('secret');}
  totalGames++;
  addXP(xpEarned);
  save();updateLeaderboard();checkAchievements();checkStickers();

  document.getElementById('go-score').textContent=score;
  document.getElementById('go-best').textContent='–†–ï–ö–û–†–î: '+bestScore;
  document.getElementById('go-earned').textContent=earned>0?`+${earned} ü•í  +${xpEarned} XP`:'';
  const rank=getRank();
  document.getElementById('go-rank').textContent=rank.icon+' '+rank.name;
  document.getElementById('go-rank').style.color=rank.color;
  const ul=document.getElementById('go-unlock');
  if(secret){ul.textContent='‚ú® DIVINE –°–ö–ò–ù –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù!';ul.style.display='block';}
  else if(!ownedSkins.includes('secret')){ul.textContent=`üîí DIVINE: ${score}/50 –±–∞—à–µ–Ω`;ul.style.display='block';}
  else ul.style.display='none';
  const dc=document.getElementById('dead-canvas'),dctx=dc.getContext('2d');
  dctx.clearRect(0,0,38,60);drawCucumber(dctx,19,30,56,selectedSkin,.2,0);
  dctx.fillStyle='#ef4444';dctx.font='bold 9px sans-serif';dctx.textAlign='center';dctx.fillText('√ó',14,22);dctx.fillText('√ó',24,22);
  document.getElementById('gameover-screen').classList.remove('hidden');
  updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREENS NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
  document.getElementById('hud-cukes').textContent=cucumbers;
  document.getElementById('hud-gold').textContent=goldCukes;
  document.getElementById('main-cukes').textContent=cucumbers;
  document.getElementById('main-gold').textContent=goldCukes;
  document.getElementById('main-xp').textContent=playerXP;
  const lp=getLevelProgress();
  const rank=getRank();
  document.getElementById('hud-lvl-text').textContent=`LVL ${lp.level+1}`;
  document.getElementById('hud-xpfill').style.width=(lp.progress/lp.need*100)+'%';
  document.getElementById('player-rank-display').textContent=rank.icon+' '+rank.name;
  document.getElementById('player-rank-display').style.color=rank.color;
  const pct=(lp.progress/lp.need*100)+'%';
  const mxpf=document.getElementById('menu-xp-fill');if(mxpf)mxpf.style.width=pct;
  const mxpfg=document.getElementById('menu-xp-fill-glow');if(mxpfg)mxpfg.style.width=pct;
  const mxpl=document.getElementById('menu-xp-label');
  if(mxpl)mxpl.textContent=`${lp.progress} / ${lp.need} XP ¬∑ –£—Ä–æ–≤–µ–Ω—å ${lp.level+1}`;
  updateChestDisplay();
  updateBoosterHUD();
}
function updateBoosterHUD(){
  if(!boosters)return;
  document.getElementById('cnt-shield').textContent=boosters.shield||0;
  document.getElementById('cnt-magnet').textContent=boosters.magnet||0;
  document.getElementById('cnt-turbo').textContent=boosters.turbo||0;
  const cntMega=document.getElementById('cnt-mega');if(cntMega)cntMega.textContent=boosters.mega||0;
  const bs=document.getElementById('btn-shield'),bm=document.getElementById('btn-magnet'),bt=document.getElementById('btn-turbo'),bmg=document.getElementById('btn-mega');
  bs.className='hud-boost-btn'+(activeShield?' on-shield':'');
  bm.className='hud-boost-btn'+(activeMagnet>0?' on-magnet':'');
  bt.className='hud-boost-btn'+(activeTurbo>0?' on-turbo':'');
  if(bmg)bmg.className='hud-boost-btn'+(activeMega>0?' on-turbo':'');
}
let preTurboSpeed=0;
function useBooster(type){
  if(gameState!=='playing')return;
  if(!boosters[type]||boosters[type]<=0){showToast('–ù–µ—Ç –±—É—Å—Ç–µ—Ä–∞!');return;}
  boosters[type]--;save();playBoost();
  if(type==='shield'){activeShield=true;showToast('üõ°Ô∏è –©–∏—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');}
  else if(type==='magnet'){activeMagnet=600;showToast('üß≤ –ú–∞–≥–Ω–∏—Ç!');}
  else if(type==='turbo'){if(activeTurbo<=0){preTurboSpeed=speed;speed=speed*1.35;}activeTurbo=480;showToast('‚ö° –¢—É—Ä–±–æ!');}
  else if(type==='mega'){activeMega=300;showToast('üí• –ú–µ–≥–∞-–æ–≥—É—Ä–µ—Ü! –†—É—à–∏—à—å —Ç—Ä—É–±—ã!');}
  updateBoosterHUD();
}
function buyBooster(type){
  const prices={shield:50,magnet:75,turbo:60,mega:150};
  if(cucumbers<prices[type]){showToast(`–ù—É–∂–Ω–æ ü•í${prices[type]}`);return;}
  cucumbers-=prices[type];boosters[type]=(boosters[type]||0)+1;save();
  document.getElementById('sh-n').textContent=boosters.shield||0;
  document.getElementById('mg-n').textContent=boosters.magnet||0;
  document.getElementById('tb-n').textContent=boosters.turbo||0;
  document.getElementById('mega-n').textContent=boosters.mega||0;
  document.getElementById('boost-cukes').textContent=cucumbers;
  showToast(`‚úÖ –ö—É–ø–ª–µ–Ω!`);playScore();
}

function showPets(){
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('pets-gold').textContent=goldCukes;
  renderPets();
  document.getElementById('pets-screen').classList.remove('hidden');
}
function closePets(){document.getElementById('pets-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');updateHUD();}
function renderPets(){
  document.getElementById('pets-gold').textContent=goldCukes;
  const grid=document.getElementById('pets-grid');
  grid.innerHTML=PETS.map(p=>{
    const owned=ownedPets.includes(p.id);
    const sel=selectedPet===p.id;
    let cls='pet-card';if(sel)cls+=' selected';else if(owned)cls+=' owned';
    let priceHtml='';
    if(sel)priceHtml=`<div class="pet-price sel">‚úì –í–´–ë–†–ê–ù</div>`;
    else if(owned)priceHtml=`<div class="pet-price owned-lbl">–ù–ê–ñ–ú–ò –í–´–ë–†–ê–¢–¨</div>`;
    else if(p.priceGold===0)priceHtml=`<div class="pet-price" style="color:#4ade80;">–ë–ï–°–ü–õ–ê–¢–ù–û</div>`;
    else priceHtml=`<div class="pet-price">‚ú® ${p.priceGold} –∑–æ–ª–æ—Ç–∞</div>`;
    const canvasId=`pet-canvas-${p.id}`;
    return`<div class="${cls}" onclick="petAction('${p.id}')">
      ${p.id==='none'?`<span class="pet-emoji">‚ùå</span>`:`<canvas id="${canvasId}" width="60" height="60" style="display:block;margin:0 auto 4px;"></canvas>`}
      <div class="pet-name">${p.name}</div>
      <div class="pet-effect">${p.desc}</div>
      ${priceHtml}
    </div>`;
  }).join('');
  // Animate pet canvases
  let pf=0;
  function animPets(){
    if(!document.getElementById('pets-screen').classList.contains('hidden')){
      PETS.forEach(p=>{if(p.id==='none')return;const c=document.getElementById(`pet-canvas-${p.id}`);if(c){drawPetOnCanvas(c.getContext('2d'),p.id,pf,60,60);}});
      pf++;requestAnimationFrame(animPets);
    }
  }
  animPets();
}
function petAction(id){
  const p=PETS.find(p=>p.id===id);if(!p)return;
  if(ownedPets.includes(id)){selectedPet=id;save();renderPets();showToast(`üêæ ${p.name} –≤—ã–±—Ä–∞–Ω!`);return;}
  if(p.priceGold===0){ownedPets.push(id);selectedPet=id;save();renderPets();showToast(`üêæ ${p.name} –ø–æ–ª—É—á–µ–Ω!`);return;}
  if(goldCukes<p.priceGold){showToast(`–ù—É–∂–Ω–æ ‚ú®${p.priceGold} –∑–æ–ª–æ—Ç–∞`);return;}
  goldCukes-=p.priceGold;ownedPets.push(id);selectedPet=id;save();
  document.getElementById('pets-gold').textContent=goldCukes;
  renderPets();showToast(`üêæ ${p.name} –∫—É–ø–ª–µ–Ω!`);
}

function showModeSelect(){document.getElementById('start-screen').classList.add('hidden');document.getElementById('mode-screen').classList.remove('hidden');}
function closeModeSelect(){document.getElementById('mode-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}

function startGame(mode='normal'){
  gameMode=mode;initAudio();
  startMusic(mode);
  resetGame();gameState='playing';
  document.getElementById('mode-screen').classList.add('hidden');
  document.getElementById('gameover-screen').classList.add('hidden');
  const show=['hud-score','hud-currency','hud-lvl-wrap','hud-boosters','hud-shoot'];
  show.forEach(id=>document.getElementById(id).classList.remove('hidden'));
  document.getElementById('hud-chest').classList.add('hidden');
  updateHUD();
  // Motivational phrase
  const phrases=['üí™ –¢–´ –ú–û–ñ–ï–®–¨!','üî• –ñ–ì–ò!','ü•í –õ–ï–¢–ò, –û–ì–£–†–ï–¶!','‚ö° –°–ö–û–†–û–°–¢–¨!','üèÜ –ü–û–ë–ï–ô –†–ï–ö–û–†–î!','üåü –í–ï–†–Æ –í –¢–ï–ë–Ø!','üéØ –¶–ï–õ–¨–°–Ø –í –ü–û–ë–ï–î–£!','üíö –ó–ï–õ–Å–ù–ê–Ø –ú–ê–®–ò–ù–ê!','üöÄ –ü–û–ï–•–ê–õ–ò!','üß† –£–ú–ù–´–ô –û–ì–£–†–ï–¶!'];
  const p=phrases[Math.floor(Math.random()*phrases.length)];
  setTimeout(()=>showLabel(p,'#4ade80'),300);
  gameLoop();
}
function restartGame(){
  initAudio();startMusic(gameMode);
  resetGame();gameState='playing';
  document.getElementById('gameover-screen').classList.add('hidden');
  updateHUD();gameLoop();
}
function goToMenu(){
  gameState='menu';
  const hide=['gameover-screen','hud-score','hud-currency','hud-lvl-wrap','hud-boosters','hud-shoot','hud-combo'];
  hide.forEach(id=>document.getElementById(id).classList.add('hidden'));
  const gl=document.getElementById('game-label');gl.style.animation='none';gl.style.opacity='0';
  document.getElementById('start-screen').classList.remove('hidden');
  updateHUD();drawBg();
}

function shareToTelegram(){
  const rank=getRank();
  const mn={easy:'–õ—ë–≥–∫–æ–º',normal:'–û–±—ã—á–Ω–æ–º',hard:'–°–ª–æ–∂–Ω–æ–º',insane:'–ë–µ–∑—É–º–∏–∏',crazy:'–•–∞–æ—Å–µ',flip:'–í–≤–µ—Ä—Ö —Ç–æ—Ä–º–∞—à–∫–∞–º–∏',zen:'–î–∑–µ–Ω'};
  const txt=`ü•í Flappy Cucumber!\n–°—á—ë—Ç: ${score} (${mn[gameMode]||''})\n–†–µ–∫–æ—Ä–¥: ${bestScore}\n–†–∞–Ω–≥: ${rank.icon} ${rank.name}\nXP: ${playerXP}\n\n–ü–æ–±–µ–π –º–æ–π —Ä–µ–∫–æ—Ä–¥!`;
  window.open(`https://t.me/share/url?url=https://flappycucumber.app&text=${encodeURIComponent(txt)}`,'_blank');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let carIdx=0,shopTab='skins';
function showShop(){document.getElementById('start-screen').classList.add('hidden');shopTab='skins';carIdx=0;renderShopTabs();renderCarousel();document.getElementById('shop-screen').classList.remove('hidden');}
function closeShop(){document.getElementById('shop-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');updateHUD();}
function setShopTab(t){shopTab=t;carIdx=0;resetCarouselVpOverflow();renderShopTabs();renderCarousel();}
function renderShopTabs(){['skins','worlds','trails','upg'].forEach(t=>{const el=document.getElementById(`stab-${t}`);if(el)el.className='shop-tab'+(shopTab===(t==='upg'?'upgrades':t)?' active':'');});}

function renderCarousel(){
  document.getElementById('shop-cukes').textContent=cucumbers;
  document.getElementById('shop-gold').textContent=goldCukes;
  const track=document.getElementById('carousel-track');track.innerHTML='';
  const isUpgrade=shopTab==='upgrades';
  if(isUpgrade){renderUpgradesInCarousel(track);document.getElementById('shop-action-btn').style.display='none';return;}
  document.getElementById('shop-action-btn').style.display='';
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  items.forEach(item=>{
    const ownedArr=shopTab==='skins'?ownedSkins:shopTab==='worlds'?ownedWorlds:ownedTrails;
    const selId=shopTab==='skins'?selectedSkin:shopTab==='worlds'?selectedWorld:selectedTrail;
    const owned=ownedArr.includes(item.id),sel=selId===item.id;
    const slide=document.createElement('div');slide.className='carousel-slide';
    let cls='skin-card';if(sel)cls+=' selected';else if(owned)cls+=' owned';
    const card=document.createElement('div');card.className=cls;
    if(shopTab==='skins'){
      const wrap=document.createElement('div');wrap.className='skin-canvas-wrap';
      const mc=document.createElement('canvas');mc.width=68;mc.height=105;
      const mctx=mc.getContext('2d');
      if(item.secret&&!owned){mctx.fillStyle='rgba(167,139,250,.15)';mctx.beginPath();mctx.arc(34,52,30,0,Math.PI*2);mctx.fill();mctx.fillStyle='#a78bfa';mctx.font='bold 36px Nunito';mctx.textAlign='center';mctx.textBaseline='middle';mctx.fillText('?',34,52);}
      else drawCucumber(mctx,34,52,98,item.id,0,0);
      wrap.appendChild(mc);card.appendChild(wrap);
    } else if(shopTab==='worlds'){
      const wp=document.createElement('div');wp.style.cssText='width:100%;height:75px;border-radius:9px;margin-bottom:7px;overflow:hidden;';
      const wc=document.createElement('canvas');wc.width=190;wc.height=75;wc.style.cssText='width:100%;height:100%;';
      const wctx=wc.getContext('2d');const wg=wctx.createLinearGradient(0,0,0,75);wg.addColorStop(0,item.bg[0]);wg.addColorStop(.5,item.bg[1]);wg.addColorStop(1,item.bg[2]);wctx.fillStyle=wg;wctx.fillRect(0,0,190,75);
      wctx.fillStyle=item.pipeCap;wctx.shadowColor=item.pipeCap;wctx.shadowBlur=5;
      [[28,0,22,26],[28,50,22,25],[105,0,22,17],[105,58,22,17]].forEach(([x,y,w,h])=>{wctx.beginPath();wctx.roundRect(x,y,w,h,3);wctx.fill();});
      wctx.shadowBlur=0;wctx.fillStyle=item.groundTop;wctx.fillRect(0,68,190,3);
      wp.appendChild(wc);card.appendChild(wp);
    } else {
      // trail preview
      const tc=document.createElement('canvas');tc.width=100;tc.height=145;
      const tctx=tc.getContext('2d');
      if(item.color){const pts=26;for(let i=0;i<pts;i++){const x=50+Math.sin(i*.35)*22,y=12+i*3.5;tctx.globalAlpha=(i/pts)*.95;tctx.fillStyle=item.color[i%item.color.length];tctx.shadowColor=item.color[i%item.color.length];tctx.shadowBlur=7;tctx.beginPath();tctx.arc(x,y,4.5,0,Math.PI*2);tctx.fill();tctx.shadowBlur=0;}tctx.globalAlpha=1;}
      else{tctx.fillStyle='#475569';tctx.font='bold 14px Nunito';tctx.textAlign='center';tctx.textBaseline='middle';tctx.fillText('–Ω–µ—Ç',50,50);}
      drawCucumber(tctx,50,112,65,selectedSkin,0,0);
      tc.style.cssText='display:block;margin:0 auto 7px;';card.appendChild(tc);
    }
    const nm=document.createElement('div');nm.className='skin-name';nm.textContent=(item.secret&&!owned)?'???':item.name;card.appendChild(nm);
    const pr=document.createElement('div');
    if(sel){pr.className='skin-price lbl-selected';pr.textContent='‚úì –í–´–ë–†–ê–ù';}
    else if(owned){pr.className='skin-price lbl-owned';pr.textContent='–ù–ê–ñ–ú–ò –í–´–ë–†–ê–¢–¨';}
    else if(item.secret){pr.className='skin-price';pr.style.color='#a78bfa';pr.textContent='–ù–ê–ë–ï–ô 50 –ë–ê–®–ï–ù';}
    else if(item.goldOnly){pr.className='skin-price';pr.style.color='#FFD700';pr.textContent=`‚ú® ${item.priceGold} –∑–æ–ª–æ—Ç–∞`;}
    else if(item.price===0){pr.className='skin-price';pr.textContent='–ë–ï–°–ü–õ–ê–¢–ù–û';}
    else{pr.className='skin-price';pr.textContent=`ü•í ${item.price}`;}
    card.appendChild(pr);
    if(item.id==='king'){const b=document.createElement('div');b.className='skin-badge';b.style.background='#ef4444';b.textContent='–•–ò–¢';card.appendChild(b);}
    if(item.goldOnly){const b=document.createElement('div');b.className='skin-badge';b.style.background='#FFD700';b.style.color='#000';b.textContent='–ó–û–õ–û–¢–û';card.appendChild(b);}
    slide.appendChild(card);track.appendChild(slide);
  });
  updCarPos();updDots();updShopBtn();
}

function renderUpgradesInCarousel(track){
  // For upgrades: use a scrollable grid, bypass carousel transform
  const outer=document.getElementById('shop-carr-outer');
  outer.querySelector('.carousel-vp').style.overflow='visible';
  const slide=document.createElement('div');slide.className='carousel-slide';
  slide.style.cssText='min-width:100%;display:block;padding:0 4px;';
  const grid=document.createElement('div');
  grid.style.cssText='display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;';
  UPGRADES.forEach(u=>{
    const lv=upgradelevels[u.id]||0,maxed=lv>=u.maxLevel,cost=getUpgradeCost(u.id);
    const card=document.createElement('div');
    card.className='upgrade-card'+(maxed?' maxed':'');
    card.style.cssText='cursor:pointer;';
    card.innerHTML=`<span class="upg-icon">${u.icon}</span>
      <div class="upg-name" style="font-size:12px;font-weight:800;">${u.name}</div>
      <div class="upg-desc" style="font-size:11px;">${u.desc}</div>
      <div class="upg-level" style="font-size:13px;margin:4px 0;">${'‚òÖ'.repeat(lv)}${'‚òÜ'.repeat(u.maxLevel-lv)}</div>
      <div class="upg-price" style="font-size:13px;">${maxed?'‚úÖ –ú–ê–ö–°':('ü•í '+cost)}</div>`;
    if(!maxed)card.onclick=()=>{
      if(cucumbers<cost){showToast(`–ù—É–∂–Ω–æ ü•í${cost}`);return;}
      cucumbers-=cost;upgradelevels[u.id]=(upgradelevels[u.id]||0)+1;save();
      showToast(`‚úÖ ${u.name} —É–ª—É—á—à–µ–Ω!`);playScore();renderCarousel();
    };
    grid.appendChild(card);
  });
  slide.appendChild(grid);track.appendChild(slide);
  document.getElementById('carousel-dots').innerHTML='';
  // Ensure carousel track is at position 0 for upgrades
  const tr=document.getElementById('carousel-track');if(tr)tr.style.transform='translateX(0)';
}
function resetCarouselVpOverflow(){
  const outer=document.getElementById('shop-carr-outer');
  if(outer)outer.querySelector('.carousel-vp').style.overflow='hidden';
}

function updCarPos(){const tr=document.getElementById('carousel-track');if(tr)tr.style.transform=`translateX(-${carIdx*100}%)`;}
function updDots(){
  const dots=document.getElementById('carousel-dots');dots.innerHTML='';
  if(shopTab==='upgrades')return;
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  items.forEach((_,i)=>{const d=document.createElement('div');d.className='dot'+(i===carIdx?' active':'');d.onclick=()=>{carIdx=i;updCarPos();updDots();updShopBtn();};dots.appendChild(d);});
}
function updShopBtn(){
  if(shopTab==='upgrades')return;
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  const item=items[carIdx];if(!item)return;
  const btn=document.getElementById('shop-action-btn');
  const ownedArr=shopTab==='skins'?ownedSkins:shopTab==='worlds'?ownedWorlds:ownedTrails;
  const selId=shopTab==='skins'?selectedSkin:shopTab==='worlds'?selectedWorld:selectedTrail;
  const owned=ownedArr.includes(item.id),sel=selId===item.id;
  if(sel){btn.textContent='‚úì –í–´–ë–†–ê–ù';btn.style.opacity='.5';}
  else if(owned){btn.textContent='–í–´–ë–†–ê–¢–¨';btn.style.opacity='1';}
  else if(item.secret){btn.textContent='üîí 50 –ë–ê–®–ï–ù';btn.style.opacity='.7';}
  else if(item.goldOnly){btn.textContent=`‚ú® ${item.priceGold} –∑–æ–ª–æ—Ç–∞`;btn.style.opacity='1';}
  else if(item.price===0){btn.textContent='–ü–û–õ–£–ß–ò–¢–¨';btn.style.opacity='1';}
  else{btn.textContent=`–ö–£–ü–ò–¢–¨ ü•í${item.price}`;btn.style.opacity='1';}
}
function carPrev(){if(carIdx>0){carIdx--;updCarPos();updDots();updShopBtn();}}
function carNext(){const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;const len=shopTab==='upgrades'?0:items.length;if(carIdx<len-1){carIdx++;updCarPos();updDots();updShopBtn();}}
function shopAction(){
  if(shopTab==='upgrades')return;
  const items=shopTab==='skins'?SKINS:shopTab==='worlds'?WORLDS:TRAILS;
  const item=items[carIdx];if(!item)return;
  const ownedArr=shopTab==='skins'?ownedSkins:shopTab==='worlds'?ownedWorlds:ownedTrails;
  if(item.secret&&!ownedArr.includes(item.id)){showToast('üîí –ù–∞–±–µ–π 50 –±–∞—à–µ–Ω!');return;}
  if(ownedArr.includes(item.id)){
    if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;else selectedTrail=item.id;
    save();renderCarousel();showToast('‚úÖ –í—ã–±—Ä–∞–Ω–æ!');return;
  }
  if(item.goldOnly){
    if(goldCukes<item.priceGold){showToast(`–ù—É–∂–Ω–æ ‚ú®${item.priceGold} –∑–æ–ª–æ—Ç–∞`);return;}
    goldCukes-=item.priceGold;ownedArr.push(item.id);
    if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;
    save();renderCarousel();playScore();showToast(`‚úÖ ${item.name} –∫—É–ø–ª–µ–Ω –∑–∞ –∑–æ–ª–æ—Ç–æ!`);return;
  }
  if(item.price===0){ownedArr.push(item.id);if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;else selectedTrail=item.id;save();renderCarousel();playScore();return;}
  if(cucumbers<item.price){showToast(`–ù—É–∂–Ω–æ ü•í${item.price}`);return;}
  cucumbers-=item.price;ownedArr.push(item.id);
  if(shopTab==='skins')selectedSkin=item.id;else if(shopTab==='worlds')selectedWorld=item.id;else selectedTrail=item.id;
  save();renderCarousel();playScore();showToast(`‚úÖ ${item.name} –∫—É–ø–ª–µ–Ω!`);
}
let swipeStart=0;
document.getElementById('carousel-track').addEventListener('touchstart',e=>{swipeStart=e.touches[0].clientX;},{passive:true});
document.getElementById('carousel-track').addEventListener('touchend',e=>{const dx=swipeStart-e.changedTouches[0].clientX;if(dx>40)carNext();else if(dx<-40)carPrev();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOST SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showBoostShop(){document.getElementById('start-screen').classList.add('hidden');document.getElementById('boost-cukes').textContent=cucumbers;document.getElementById('sh-n').textContent=boosters.shield||0;document.getElementById('mg-n').textContent=boosters.magnet||0;document.getElementById('tb-n').textContent=boosters.turbo||0;document.getElementById('mega-n').textContent=boosters.mega||0;document.getElementById('boost-screen').classList.remove('hidden');}
function closeBoostShop(){document.getElementById('boost-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');updateHUD();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STICKERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkStickers(){
  let newS=[];
  STICKERS.forEach(s=>{if(!unlockedStickers.includes(s.id)&&s.check()){unlockedStickers.push(s.id);newS.push(s);}});
  if(newS.length){save();newS.forEach((s,i)=>setTimeout(()=>showStickerNotif(s),i*1800));}
}
function showStickerNotif(s){
  const el=document.getElementById('sticker-notif');
  el.innerHTML=`${s.emoji}<br>–ù–∞–∫–ª–µ–π–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞!<br>${s.name}`;
  el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2500);
}
function showStickers(){document.getElementById('start-screen').classList.add('hidden');renderStickers();document.getElementById('sticker-screen').classList.remove('hidden');}
function closeStickers(){document.getElementById('sticker-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}
function renderStickers(){
  const grid=document.getElementById('sticker-grid');
  grid.innerHTML=STICKERS.map(s=>{const got=unlockedStickers.includes(s.id);return`<div class="sticker-card ${got?'got':'locked'}"><span class="sticker-emoji">${got?s.emoji:'‚ùì'}</span><div class="sticker-name">${got?s.name:'???'}</div><div class="sticker-req">${s.req}</div></div>`;}).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL LEADERBOARD (shared across all players)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LB_KEY='fc_v4_global_leaderboard';
let globalLBCache=null;

async function loadGlobalLB(){
  try{
    const res=await window.storage?.get(LB_KEY,true);
    if(res&&res.value){globalLBCache=JSON.parse(res.value);return globalLBCache;}
  }catch(e){}
  // fallback to localStorage
  try{const d=localStorage.getItem('fc_global_lb');if(d){globalLBCache=JSON.parse(d);return globalLBCache;}}catch(e){}
  return [];
}

async function saveGlobalLB(lb){
  globalLBCache=lb;
  const json=JSON.stringify(lb);
  try{await window.storage?.set(LB_KEY,json,true);}catch(e){}
  try{localStorage.setItem('fc_global_lb',json);}catch(e){}
}

async function submitScore(){
  if(!playerNickname||bestScore<=0)return;
  const myId=tgUserId?String(tgUserId):('g_'+(playerNickname.toLowerCase().replace(/\s/g,'_')));
  let lb=await loadGlobalLB()||[];
  const existing=lb.find(e=>e.uid===myId);
  const entry={uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon,ts:Date.now()};
  if(existing){if(bestScore>=existing.score)Object.assign(existing,entry);}
  else lb.push(entry);
  lb.sort((a,b)=>b.score-a.score);lb=lb.slice(0,100);
  await saveGlobalLB(lb);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LEADERBOARD SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateLeaderboard(){save();submitScore();}
function showLeaderboard(){
  document.getElementById('start-screen').classList.add('hidden');
  renderLeaderboard();
  document.getElementById('leaderboard-screen').classList.remove('hidden');
}
function closeLeaderboard(){document.getElementById('leaderboard-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}

async function renderLeaderboard(){
  const listEl=document.getElementById('lb-list');
  listEl.innerHTML='<div style="text-align:center;color:#4ade80;padding:20px;font-size:14px;font-weight:800;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  let lb=await loadGlobalLB()||[];
  // Ensure current player is included
  const myId=tgUserId?String(tgUserId):('g_'+(playerNickname||'').toLowerCase().replace(/\s/g,'_'));
  if(playerNickname&&bestScore>0){
    const ex=lb.find(e=>e.uid===myId);
    if(!ex)lb.push({uid:myId,name:playerNickname,score:bestScore,skin:selectedSkin,rank:getRank().icon,ts:Date.now()});
    else if(bestScore>ex.score){ex.score=bestScore;ex.skin=selectedSkin;ex.rank=getRank().icon;}
  }
  lb.sort((a,b)=>b.score-a.score);
  // Remove demo/bot entries - only real players
  lb=lb.filter(e=>!String(e.uid).startsWith('_d'));
  if(lb.length===0){
    listEl.innerHTML='<div style="text-align:center;color:#64748b;padding:30px;font-size:13px;font-weight:700;">ü•í –ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤.<br>–°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—É—é –∏–≥—Ä—É –∏ –ø–æ–ø–∞–¥–∏ –≤ —Ä–µ–π—Ç–∏–Ω–≥!</div>';
    return;
  }
  lb=lb.slice(0,20);
  const medals=['ü•á','ü•à','ü•â'],cls=['r1','r2','r3'];
  listEl.innerHTML=lb.map((e,i)=>{
    const isMe=e.uid===myId;
    return`<div class="lb-entry${isMe?' me':''}">
      <div class="lb-rank ${cls[i]||''}">${i<3?medals[i]:'#'+(i+1)}</div>
      <div class="lb-sp" id="lbsp${i}"><canvas width="26" height="26"></canvas></div>
      <div class="lb-name">${e.name}${isMe?' <span style="color:#38bdf8;font-size:11px">‚Üê –í–´</span>':''} <span style="color:#a78bfa;font-size:11px">${e.rank||''}</span></div>
      <div class="lb-score">${e.score}</div>
    </div>`;
  }).join('');
  lb.forEach((e,i)=>{
    const w=document.getElementById(`lbsp${i}`);
    if(w)drawCucumber(w.querySelector('canvas').getContext('2d'),13,13,24,e.skin||'default',0,0);
  });
  // Change nick button
  const lbEl=document.getElementById('leaderboard-screen');
  if(!document.getElementById('lb-nick-btn')){
    const nb=document.createElement('button');nb.id='lb-nick-btn';
    nb.className='btn blue';nb.style.cssText='margin-top:8px;width:100%;max-width:340px;flex-shrink:0;';
    nb.textContent='‚úèÔ∏è –ò–ó–ú–ï–ù–ò–¢–¨ –ù–ò–ö';
    nb.onclick=()=>{document.getElementById('nick-input').value=playerNickname||'';document.getElementById('nick-modal').classList.remove('hidden');};
    const closeBtn=lbEl.querySelector('button[onclick="closeLeaderboard()"]');
    if(closeBtn)lbEl.insertBefore(nb,closeBtn);else lbEl.appendChild(nb);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACHIEVEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ACHIEVS=[
  {id:'first_blood',icon:'ü•í',name:'–ü–µ—Ä–≤—ã–π –ø–æ–ª—ë—Ç',   desc:'–°—ã–≥—Ä–∞–π –ø–µ—Ä–≤—É—é –∏–≥—Ä—É',    reward:10, check:()=>totalGames>=1},
  {id:'score10',    icon:'üéØ',name:'–ù–æ–≤–∏—á–æ–∫',         desc:'–ü—Ä–æ–π–¥–∏ 10 –±–∞—à–µ–Ω',       reward:20, check:()=>bestScore>=10},
  {id:'score25',    icon:'üî•',name:'–ì–æ—Ä—è—á–æ!',          desc:'–ü—Ä–æ–π–¥–∏ 25 –±–∞—à–µ–Ω',       reward:50, check:()=>bestScore>=25},
  {id:'score50',    icon:'üíé',name:'–ú–∞—Å—Ç–µ—Ä',           desc:'–ü—Ä–æ–π–¥–∏ 50 –±–∞—à–µ–Ω',       reward:100,check:()=>bestScore>=50},
  {id:'score100',   icon:'üëë',name:'–õ–µ–≥–µ–Ω–¥–∞',          desc:'–ü—Ä–æ–π–¥–∏ 100 –±–∞—à–µ–Ω',      reward:300,check:()=>bestScore>=100},
  {id:'coins50',    icon:'üí∞',name:'–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',     desc:'50 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',        reward:30, check:()=>totalCoins>=50},
  {id:'coins200',   icon:'ü§ë',name:'–ë–æ–≥–∞—á',             desc:'200 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',       reward:80, check:()=>totalCoins>=200},
  {id:'coins500',   icon:'üíé',name:'–°–æ–∫—Ä–æ–≤–∏—â–µ',        desc:'500 –º–æ–Ω–µ—Ç –≤—Å–µ–≥–æ',       reward:200,check:()=>totalCoins>=500},
  {id:'games10',    icon:'üéÆ',name:'–ó–∞–≤—Å–µ–≥–¥–∞—Ç–∞–π',      desc:'–°—ã–≥—Ä–∞–π 10 –∏–≥—Ä',         reward:40, check:()=>totalGames>=10},
  {id:'all_skins',  icon:'üåà',name:'–ö–æ–ª–ª–µ–∫—Ü–∏—è',        desc:'–ö—É–ø–∏ 4 —Å–∫–∏–Ω–∞',           reward:150,check:()=>ownedSkins.length>=4},
  {id:'divine',     icon:'‚ú®',name:'–ò–∑–±—Ä–∞–Ω–Ω—ã–π',         desc:'–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π Divine',    reward:200,check:()=>ownedSkins.includes('secret')},
  {id:'level5',     icon:'‚≠ê',name:'–ü—Ä–æ—Ñ–∏',             desc:'5 —É—Ä–æ–≤–µ–Ω—å',             reward:100,check:()=>playerLevel>=5},
  {id:'boss_kill',  icon:'üëπ',name:'–£–±–∏–π—Ü–∞ –±–æ—Å—Å–æ–≤',    desc:'–ü–æ–±–µ–¥–∏ 3 –±–æ—Å—Å–æ–≤',       reward:150,check:()=>bossesDefeated>=3},
  {id:'box_shooter',icon:'üì¶',name:'–°–Ω–∞–π–ø–µ—Ä',          desc:'–†–∞–∑—Ä—É—à–∏ 10 —è—â–∏–∫–æ–≤',     reward:80, check:()=>boxesDestroyed>=10},
  {id:'combo_king', icon:'üå∂Ô∏è',name:'–ö–æ–º–±–æ-–ö–∏–Ω–≥',       desc:'–ê–∫—Ç–∏–≤–∏—Ä—É–π –∫–æ–º–±–æ',       reward:60, check:()=>combosActivated>=1},
  {id:'zen30',      icon:'üçÉ',name:'–î–∑–µ–Ω-–Ω–æ–≤–∏—á–æ–∫',     desc:'30 —Å–µ–∫ –≤ –î–∑–µ–Ω-—Ä–µ–∂–∏–º–µ',  reward:50, check:()=>zenSeconds>=30},
];
function checkAchievements(){
  let newO=[];
  ACHIEVS.forEach(a=>{if(!unlockedAchievs.includes(a.id)&&a.check()){unlockedAchievs.push(a.id);cucumbers+=a.reward;newO.push(a);}});
  if(newO.length){save();setTimeout(()=>newO.forEach((a,i)=>setTimeout(()=>showToast(`üèÖ ${a.name}! +${a.reward}ü•í`),i*1400)),500);}
}
function showAchievements(){document.getElementById('start-screen').classList.add('hidden');document.getElementById('achiev-grid').innerHTML=ACHIEVS.map(a=>{const d=unlockedAchievs.includes(a.id);return`<div class="achiev-card ${d?'unlocked':'locked'}"><span class="achiev-icon">${a.icon}</span><div class="achiev-name">${a.name}</div><div class="achiev-desc">${a.desc}</div><div class="achiev-reward">+${a.reward}ü•í</div>${d?'<div class="achiev-done">‚úÖ</div>':''}</div>`;}).join('');document.getElementById('achiev-screen').classList.remove('hidden');}
function closeAchievements(){document.getElementById('achiev-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RANKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showRanks(){document.getElementById('start-screen').classList.add('hidden');const cur=getRank();document.getElementById('ranks-list').innerHTML=RANKS.map(r=>{const done=playerXP>=r.xpRequired,isCur=r.name===cur.name;return`<div class="rank-entry ${isCur?'cur':done?'done':''}" style="opacity:${done?1:.4}"><div class="rank-ico">${r.icon}</div><div><div class="rank-nm" style="color:${r.color}">${r.name}</div><div class="rank-xpreq">XP: ${r.xpRequired}</div></div>${isCur?'<div style="font-size:7px;color:#fbbf24;">‚Üê –í–´</div>':done?'<div style="font-size:10px;">‚úÖ</div>':'<div style="font-size:7px;color:#475569;">üîí</div>'}</div>`;}).join('');document.getElementById('ranks-screen').classList.remove('hidden');}
function closeRanks(){document.getElementById('ranks-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORTUNE WHEEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WHEEL_PRIZES=[
  {label:'10 ü•í',value:10,type:'cukes',color:'#22c55e'},{label:'25 ü•í',value:25,type:'cukes',color:'#16a34a'},
  {label:'50 XP',value:50,type:'xp',color:'#fbbf24'},{label:'5 ü•í',value:5,type:'cukes',color:'#4ade80'},
  {label:'100ü•í',value:100,type:'cukes',color:'#ef4444'},{label:'üõ°Ô∏è',value:0,type:'boost_shield',color:'#38bdf8'},
  {label:'–°–ö–ò–ù!',value:0,type:'skin',color:'#a78bfa'},{label:'30 ü•í',value:30,type:'cukes',color:'#15803d'},
  {label:'üß≤',value:0,type:'boost_magnet',color:'#fbbf24'},{label:'‚ú®1',value:1,type:'gold',color:'#FFD700'},
];
let wheelAngle=0,wheelSpinning=false;
function drawWheel(){
  const wc=document.getElementById('wheel-canvas');if(!wc)return;const wctx=wc.getContext('2d');
  const cx=150,cy=150,r=138,n=WHEEL_PRIZES.length,arc=Math.PI*2/n;
  wctx.clearRect(0,0,300,300);
  // Outer gold ring shadow
  wctx.shadowColor='rgba(255,215,0,.6)';wctx.shadowBlur=24;
  wctx.strokeStyle='#FFD700';wctx.lineWidth=6;
  wctx.beginPath();wctx.arc(cx,cy,r+3,0,Math.PI*2);wctx.stroke();
  wctx.shadowBlur=0;
  // Segments
  WHEEL_PRIZES.forEach((p,i)=>{
    const a=arc*i+wheelAngle;
    // Gradient per segment
    const grd=wctx.createLinearGradient(cx+Math.cos(a+arc/2)*r*.3,cy+Math.sin(a+arc/2)*r*.3,cx+Math.cos(a+arc/2)*r,cy+Math.sin(a+arc/2)*r);
    grd.addColorStop(0,lighten(p.color,.25));grd.addColorStop(1,darken(p.color,.2));
    wctx.beginPath();wctx.moveTo(cx,cy);wctx.arc(cx,cy,r,a,a+arc);wctx.closePath();
    wctx.fillStyle=grd;wctx.fill();
    // Gold separator lines
    wctx.strokeStyle='rgba(255,215,0,.6)';wctx.lineWidth=2;wctx.stroke();
    // Outer gold border per segment
    wctx.beginPath();wctx.arc(cx,cy,r,a,a+arc);wctx.strokeStyle='rgba(255,215,0,.35)';wctx.lineWidth=3;wctx.stroke();
    // Label
    wctx.save();wctx.translate(cx,cy);wctx.rotate(a+arc/2);
    wctx.fillStyle='#fff';wctx.font='bold 12px Nunito';wctx.textAlign='center';wctx.textBaseline='middle';
    wctx.shadowColor='rgba(0,0,0,.6)';wctx.shadowBlur=4;
    wctx.fillText(p.label,r*.66,0);wctx.shadowBlur=0;wctx.restore();
  });
  // Decorative inner gold ring
  wctx.strokeStyle='rgba(255,215,0,.4)';wctx.lineWidth=1.5;
  wctx.beginPath();wctx.arc(cx,cy,r*.78,0,Math.PI*2);wctx.stroke();
  // Gold gem dots at segment edges
  WHEEL_PRIZES.forEach((_,i)=>{
    const a=arc*i+wheelAngle;
    const gx=cx+Math.cos(a)*r,gy=cy+Math.sin(a)*r;
    wctx.fillStyle='#FFD700';wctx.shadowColor='#FFD700';wctx.shadowBlur=6;
    wctx.beginPath();wctx.arc(gx,gy,4,0,Math.PI*2);wctx.fill();wctx.shadowBlur=0;
  });
  // Center hub - gold
  const cg=wctx.createRadialGradient(cx,cy,0,cx,cy,28);
  cg.addColorStop(0,'#fff9c4');cg.addColorStop(.3,'#FFD700');cg.addColorStop(.7,'#d97706');cg.addColorStop(1,'#92400e');
  wctx.shadowColor='rgba(255,215,0,.8)';wctx.shadowBlur=14;
  wctx.fillStyle=cg;wctx.beginPath();wctx.arc(cx,cy,28,0,Math.PI*2);wctx.fill();wctx.shadowBlur=0;
  // Center star pattern
  wctx.strokeStyle='rgba(255,255,255,.6)';wctx.lineWidth=1.5;
  for(let i=0;i<8;i++){const a=i*Math.PI/4+wheelAngle*.5;wctx.beginPath();wctx.moveTo(cx+Math.cos(a)*8,cy+Math.sin(a)*8);wctx.lineTo(cx+Math.cos(a)*22,cy+Math.sin(a)*22);wctx.stroke();}
  wctx.fillStyle='#1e293b';wctx.font='bold 11px Nunito';wctx.textAlign='center';wctx.textBaseline='middle';wctx.fillText('FC',cx,cy);
}
function spinWheel(){
  const today=new Date().toDateString();if(lastWheelDate===today){showToast('–ó–∞–≤—Ç—Ä–∞!');return;}
  if(wheelSpinning)return;wheelSpinning=true;document.getElementById('wheel-spin-btn').disabled=true;document.getElementById('wheel-result').textContent='';
  const totalRot=Math.PI*2*(6+Math.floor(Math.random()*4))+Math.random()*Math.PI*2;
  const dur=3500,start=performance.now(),startA=wheelAngle;
  function f(now){const t=Math.min((now-start)/dur,1),ease=1-Math.pow(1-t,4);wheelAngle=startA+totalRot*ease;drawWheel();if(t<1){requestAnimationFrame(f);return;}
    const n=WHEEL_PRIZES.length,arc=Math.PI*2/n,norm=(((-wheelAngle-Math.PI/2)%(Math.PI*2))+Math.PI*2)%(Math.PI*2);
    const idx=Math.floor(norm/arc)%n,prize=WHEEL_PRIZES[idx];wheelSpinning=false;lastWheelDate=today;save();
    if(prize.type==='cukes'){cucumbers+=prize.value;save();updateHUD();document.getElementById('wheel-result').textContent=`üéâ +${prize.value} ü•í!`;}
    else if(prize.type==='xp'){addXP(prize.value);document.getElementById('wheel-result').textContent=`üéâ +${prize.value} XP!`;}
    else if(prize.type==='gold'){goldCukes+=prize.value;save();updateHUD();document.getElementById('wheel-result').textContent=`üéâ +${prize.value} ‚ú® –ó–æ–ª–æ—Ç–æ!`;}
    else if(prize.type==='boost_shield'){boosters.shield=(boosters.shield||0)+1;save();document.getElementById('wheel-result').textContent='üéâ –©–ò–¢!';}
    else if(prize.type==='boost_magnet'){boosters.magnet=(boosters.magnet||0)+1;save();document.getElementById('wheel-result').textContent='üéâ –ú–ê–ì–ù–ò–¢!';}
    else if(prize.type==='skin'){const u=SKINS.filter(s=>!s.secret&&!ownedSkins.includes(s.id));if(u.length){const s=u[Math.floor(Math.random()*u.length)];ownedSkins.push(s.id);save();document.getElementById('wheel-result').textContent=`üéâ ${s.name}!`;}else{cucumbers+=50;save();updateHUD();document.getElementById('wheel-result').textContent='üéâ +50 ü•í';}}
    document.getElementById('wheel-info').textContent='–°–ª–µ–¥—É—é—â–∏–π —à–∞–Ω—Å –∑–∞–≤—Ç—Ä–∞';checkAchievements();
  }
  requestAnimationFrame(f);
}
function showWheel(){document.getElementById('start-screen').classList.add('hidden');const today=new Date().toDateString();document.getElementById('wheel-spin-btn').disabled=lastWheelDate===today;document.getElementById('wheel-info').textContent=lastWheelDate===today?'–°–ª–µ–¥—É—é—â–∏–π —à–∞–Ω—Å –∑–∞–≤—Ç—Ä–∞':'–†–∞–∑ –≤ –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ';document.getElementById('wheel-result').textContent='';drawWheel();document.getElementById('wheel-screen').classList.remove('hidden');}
function closeWheel(){document.getElementById('wheel-screen').classList.add('hidden');document.getElementById('start-screen').classList.remove('hidden');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHEST (4-HOUR)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHEST_INTERVAL=4*60*60*1000; // 4 hours
function getChestReady(){return Date.now()-lastChestTime>=CHEST_INTERVAL;}
function getChestCountdown(){
  const remain=CHEST_INTERVAL-(Date.now()-lastChestTime);
  if(remain<=0)return'–ì–û–¢–û–í!';
  const h=Math.floor(remain/3600000),m=Math.floor((remain%3600000)/60000),s=Math.floor((remain%60000)/1000);
  return`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function updateChestDisplay(){
  const ready=getChestReady();
  const mi=document.getElementById('menu-chest-info');if(mi)mi.textContent=ready?'üì¶ –°—É–Ω–¥—É–∫ –≥–æ—Ç–æ–≤! –û—Ç–∫—Ä–æ–π!':'‚è∞ –°–ª–µ–¥—É—é—â–∏–π: '+getChestCountdown();
  const ht=document.getElementById('chest-timer-txt');if(ht)ht.textContent=ready?'OPEN!':getChestCountdown();
}
setInterval(updateChestDisplay,1000);
function openChestModal(){
  const ready=getChestReady();
  const btn=document.getElementById('chest-open-btn');
  const icon=document.getElementById('chest-anim-icon');
  const txt=document.getElementById('chest-reward-text');
  btn.style.display=ready?'':'none';
  icon.textContent='üì¶';
  txt.textContent=ready?'–û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É–∫!':'–ï—â—ë —Ä–∞–Ω–æ... '+getChestCountdown();
  document.getElementById('chest-modal').classList.remove('hidden');
}
function closeChestModal(){document.getElementById('chest-modal').classList.add('hidden');}
function claimChest(){
  if(!getChestReady()){showToast('–ï—â—ë —Ä–∞–Ω–æ!');return;}
  lastChestTime=Date.now();chestsOpened++;
  const reward=15+Math.floor(Math.random()*36);
  const goldBonus=Math.random()<.1?1:0;
  cucumbers+=reward;if(goldBonus)goldCukes+=goldBonus;
  addXP(20);save();checkStickers();checkAchievements();
  document.getElementById('chest-anim-icon').textContent='üéÅ';
  document.getElementById('chest-reward-text').textContent=`+${reward} ü•í${goldBonus?' +1 ‚ú®':''}!`;
  document.getElementById('chest-open-btn').style.display='none';
  showToast(`üì¶ –°—É–Ω–¥—É–∫! +${reward}ü•í${goldBonus?' +1‚ú®':''}`);
  updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleTap(){
  if(gameState!=='playing')return;
  const now=Date.now();
  if(now-lastTapTime<300){shoot();} // double tap = shoot
  lastTapTime=now;
  jump();
}
document.addEventListener('keydown',e=>{
  if(e.code==='Space'){e.preventDefault();jump();}
  if(e.code==='KeyF'){shoot();}
});
canvas.addEventListener('click',handleTap);
canvas.addEventListener('touchstart',e=>{e.preventDefault();handleTap();},{passive:false});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastQueue=[],toastShowing=false;
function showToast(msg){
  toastQueue.push(msg);if(!toastShowing)processToast();
}
function processToast(){
  if(!toastQueue.length){toastShowing=false;return;}
  toastShowing=true;const t=document.getElementById('toast');t.textContent=toastQueue.shift();t.classList.add('show');
  setTimeout(()=>{t.classList.remove('show');setTimeout(processToast,300);},2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ANIMATED START SCREEN BACKGROUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const startBg=document.getElementById('start-bg-canvas');
const sbCtx=startBg.getContext('2d');
let sbW=0,sbH=0,sbFrame=0;
const sbParticles=Array.from({length:60},()=>({
  x:Math.random()*800,y:Math.random()*1200,
  vx:(Math.random()-.5)*.4,vy:-Math.random()*.6-.2,
  r:Math.random()*3+.5,
  hue:Math.random()<.5?120+Math.random()*30:60+Math.random()*20,
  alpha:Math.random()*.7+.3,
  tw:Math.random()*Math.PI*2
}));
const sbPipes=Array.from({length:4},(_,i)=>({x:200+i*220,speed:.4+i*.15,hue:120+i*10}));

function resizeStartBg(){
  sbW=startBg.width=window.innerWidth;
  sbH=startBg.height=window.innerHeight;
}
resizeStartBg();
window.addEventListener('resize',resizeStartBg);

function animateStartBg(){
  if(gameState!=='menu'){requestAnimationFrame(animateStartBg);return;}
  sbFrame++;
  sbCtx.clearRect(0,0,sbW,sbH);

  // Gradient background
  const bg=sbCtx.createLinearGradient(0,0,0,sbH);
  bg.addColorStop(0,'#020d07');bg.addColorStop(.4,'#061a10');bg.addColorStop(.7,'#0d2b1a');bg.addColorStop(1,'#020d07');
  sbCtx.fillStyle=bg;sbCtx.fillRect(0,0,sbW,sbH);

  // Radial glow center
  const rg=sbCtx.createRadialGradient(sbW/2,sbH*.35,0,sbW/2,sbH*.35,sbW*.6);
  rg.addColorStop(0,'rgba(74,222,128,.06)');rg.addColorStop(.5,'rgba(34,197,94,.03)');rg.addColorStop(1,'transparent');
  sbCtx.fillStyle=rg;sbCtx.fillRect(0,0,sbW,sbH);

  // Animated pipes in background
  sbPipes.forEach(p=>{
    p.x-=p.speed;if(p.x<-70)p.x=sbW+70;
    const gp=sbCtx.createLinearGradient(p.x-35,0,p.x+35,0);
    gp.addColorStop(0,'rgba(5,46,22,.5)');gp.addColorStop(.4,'rgba(74,222,128,.2)');gp.addColorStop(1,'rgba(5,46,22,.5)');
    sbCtx.fillStyle=gp;
    // top pipe
    sbCtx.beginPath();sbCtx.roundRect(p.x-30,0,60,sbH*.2,3);sbCtx.fill();
    sbCtx.fillStyle='rgba(74,222,128,.15)';
    sbCtx.beginPath();sbCtx.roundRect(p.x-35,sbH*.2,70,12,4);sbCtx.fill();
    // bottom pipe
    sbCtx.fillStyle=gp;
    sbCtx.beginPath();sbCtx.roundRect(p.x-30,sbH*.65,60,sbH*.35,3);sbCtx.fill();
    sbCtx.fillStyle='rgba(74,222,128,.15)';
    sbCtx.beginPath();sbCtx.roundRect(p.x-35,sbH*.65-12,70,12,[0,0,4,4]);sbCtx.fill();
  });

  // Floating particles
  sbParticles.forEach(p=>{
    p.x+=p.vx;p.y+=p.vy;p.tw+=.02;
    if(p.y<-10){p.y=sbH+10;p.x=Math.random()*sbW;}
    if(p.x<-10||p.x>sbW+10){p.x=Math.random()*sbW;}
    const a=p.alpha*(0.5+Math.abs(Math.sin(p.tw))*.5);
    sbCtx.fillStyle=`hsla(${p.hue},80%,65%,${a})`;
    sbCtx.shadowColor=`hsl(${p.hue},80%,65%)`;sbCtx.shadowBlur=8;
    sbCtx.beginPath();sbCtx.arc(p.x,p.y,p.r,0,Math.PI*2);sbCtx.fill();
    sbCtx.shadowBlur=0;
  });

  // Grid lines (subtle)
  sbCtx.strokeStyle='rgba(74,222,128,.03)';sbCtx.lineWidth=1;
  const gridOff=(sbFrame*.5)%60;
  for(let x=gridOff;x<sbW;x+=60){sbCtx.beginPath();sbCtx.moveTo(x,0);sbCtx.lineTo(x,sbH);sbCtx.stroke();}
  for(let y=gridOff;y<sbH;y+=60){sbCtx.beginPath();sbCtx.moveTo(0,y);sbCtx.lineTo(sbW,y);sbCtx.stroke();}

  requestAnimationFrame(animateStartBg);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
updateHUD();drawBg();animateHero();animateStartBg();animateStartPet();
checkNicknameOnStart();
</script>

</body>
</html>